]</div>
<!-- VisualManager.html - Oracle Analytics Narrative (Postfix) -->
<!-- PV controls:
     - PV_VM_ShowTitlebarManager: 1/0 show/hide titlebar Visual Manager button
     - PV_VM_ShowVisualSettingsIcon: 1/0 show/hide per-visual settings (gear) button
-->
<div data-vm-host="1">
  <div id="vm-params" style="display:none"
    data-show-titlebar-manager="@{PV_VM_ShowTitlebarManager}{1}"
    data-show-visual-settings="@{PV_VM_ShowVisualSettingsIcon}{1}"
    data-show-business-controls="@{PV_VM_ShowBusinessControls}{1}"
    data-show-status-pill="@{PV_VM_ShowStatusPill}{0}"
    data-show-visual-header-text="@{PV_VM_ShowVisualHeaderText}{1}"
    data-persistence="@{PV_VM_Persistence}{1}"
    data-clear-persistence-onload="@{PV_VM_ClearPersistenceOnLoad}{0}"
    data-theme-default="@{PV_VM_Theme}{light}"
    data-grid-gap="@{PV_VM_GridGap}{10}"
    data-visuals-per-row="@{PV_VM_VisualsPerRow}{2}"
    data-card-height="@{PV_VM_CardHeight}{320}"
    data-report-title="@{PV_VM_ReportTitle}{Visual Manager}"
    data-report-subtitle="@{PV_VM_ReportSubtitle}{Registry-driven Plotly visuals � per-visual settings (mapping/aggregation/filter)}"
  ></div>
  <style>
    /* Light theme defaults */
    [data-vm-host]{
      --vm-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --vm-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --vm-gap:10px;
      --vm-radius:14px;
      --vm-shadow: 0 8px 28px rgba(0,0,0,.16);
      --vm-focus: 0 0 0 3px rgba(2,132,199,0.25);

      --vm-bg:#ffffff;
      --vm-card:#ffffff;
      --vm-card2:#f8fafc;
      --vm-border:rgba(0,0,0,.12);
      --vm-text:#111827;
      --vm-sub:rgba(17,24,39,.70);
      --vm-accent:#0284c7;
      --vm-accent2:#7c3aed;
      --vm-bad:#dc2626;
      --vm-good:#16a34a;
      --vm-warn:#d97706;
      --vm-input:#ffffff;
      --vm-input2:#f3f4f6;
      --vm-overlay: rgba(0,0,0,.55);
    }

    [data-vm-host][data-theme="dark"]{
      --vm-bg:#0b1220;
      --vm-card:#0f1a2f;
      --vm-card2:#101f39;
      --vm-border:rgba(255,255,255,.10);
      --vm-text:rgba(255,255,255,.92);
      --vm-sub:rgba(255,255,255,.70);
      --vm-accent:#7dd3fc;
      --vm-accent2:#a78bfa;
      --vm-bad:#fb7185;
      --vm-good:#34d399;
      --vm-warn:#fbbf24;
      --vm-input:#0b1730;
      --vm-input2:#0a1428;
      --vm-shadow: 0 8px 28px rgba(0,0,0,.28);
      --vm-focus: 0 0 0 3px rgba(125, 211, 252, 0.25);
      --vm-overlay: rgba(0,0,0,.55);
    }

    [data-vm-host][data-theme="paper"]{
      --vm-bg:#f8fafc;
      --vm-card:#ffffff;
      --vm-card2:#f8fafc;
      --vm-border:rgba(0,0,0,.14);
      --vm-text:#111827;
      --vm-sub:rgba(17,24,39,.70);
      --vm-input:#ffffff;
      --vm-input2:#f3f4f6;
    }

    [data-vm-host]{
      font-family:var(--vm-sans);
      color:var(--vm-text);
      background: var(--vm-bg);
      border: none;
      border-radius: 0;
      padding: 0;
    }

    [data-vm-host][data-theme="dark"]{
      background: var(--vm-bg);
    }

    [data-vm-host] .vm-wrap{width:100%;max-width:none;margin:0;}

    .vm-titlebar{
      position:sticky; top:0; z-index:30;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:6px 8px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--vm-border);
      border-radius:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--vm-shadow);
    }
    [data-vm-host][data-theme="dark"] .vm-titlebar{ background:rgba(11,18,32,.70); }
    .vm-title{display:flex; align-items:center; gap:12px; min-width:0; flex-wrap:wrap;}
    .vm-title img{height:40px; width:auto; max-width:80px; border-radius:var(--vm-radius, 8px); object-fit:cover;}
    .vm-title-text{display:flex; flex-direction:column; gap:1px; min-width:200px;}
    .vm-title-text h1{margin:0;font-size:14px;letter-spacing:.2px;}
    .vm-title-text .sub{font-size:11px;color:var(--vm-sub)}

    .vm-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}

    .btn{
      appearance:none; border:1px solid var(--vm-border);
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.92));
      color:var(--vm-text);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{border-color:rgba(0,0,0,.18)}
    .btn:focus{outline:none; box-shadow: var(--vm-focus)}
    .btn.primary{border-color: rgba(125,211,252,.35);}
    .btn.danger{border-color: rgba(251,113,133,.35); color:#dc2626;}
    .btn.danger:hover{background:rgba(251,113,133,.08); border-color:rgba(251,113,133,.5);}
    [data-vm-host][data-theme="dark"] .btn.danger{color:#fb7185;}
    [data-vm-host][data-theme="dark"] .btn{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); }
    [data-vm-host][data-theme="dark"] .btn:hover{ border-color:rgba(255,255,255,.20); }

    .btn.ico{width:30px;height:30px;padding:0;justify-content:center;gap:0;}
    .btn.ico.small{width:28px;height:28px;}

    .icon{width:16px;height:16px;display:inline-block;}

    .pill{
      font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--vm-border);
      background:rgba(255,255,255,.05);
      color:var(--vm-sub);
    }

    .grid{
      margin-top: var(--vm-top-gap, 6px);
      display:grid;
      grid-template-columns: repeat(var(--vm-cols,2), minmax(0, 1fr));
      gap: var(--vm-gap);
    }

    .card{
      border:1px solid var(--vm-border);
      border-radius: var(--vm-radius);
      background:var(--vm-card);
      overflow:hidden;
      position:relative;
      height: var(--vm-card-h, 220px);
      min-height: var(--vm-card-h, 220px);
      display:flex; flex-direction:column;
    }
    .card .hdr{
      display:flex; align-items:center; justify-content:space-between;
      overflow:visible; /* Changed to allow icons to be clickable if they shift */
      gap:8px;
      padding:4px 8px;
      background:transparent;
      border-bottom:none;
      min-height:0;width:100%;
      height:36px;
      z-index: 100;
      pointer-events: auto;
    }
    .card .hdr .left{display:flex;align-items:center;gap:8px;min-width:0;flex:1 1 auto;}
    .card .hdr .type{font-family:var(--vm-mono);font-size:10px;color:var(--vm-sub);border:1px solid var(--vm-border);padding:2px 6px;border-radius:999px;background:rgba(0,0,0,.04)}
    .card .hdr .title{font-size:13px;font-weight:500;white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-shrink:1; flex-grow:0; min-width:0;}
    .card .hdr .right{display:flex;align-items:center;justify-content:flex-end;gap:6px;height:100%;flex-shrink:0;position:relative;max-width:62%;overflow:hidden;} /* Settings button and settings buttons */
    .card .hdr .right .vm-modebar-buttons{display:flex;gap:3px;align-items:center;height:100%;flex-shrink:0;flex-wrap:nowrap;padding:0 2px;}
    
    /* Table modebar buttons - exact match with Plotly modebar styling */
    .vm-modebar-btn{
      width:26px;height:26px;padding:0;min-width:26px;min-height:26px;
      border:1px solid rgba(0,0,0,.08);border-radius:4px;
      background:rgba(255,255,255,.85);backdrop-filter:blur(8px);
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all 0.15s;flex-shrink:0;min-width:26px;
    }
    .vm-modebar-btn svg{width:16px;height:16px;fill:#111827;transition:fill 0.15s}
    .vm-modebar-btn:hover{background:rgba(255,255,255,.98);border-color:rgba(0,0,0,.15);box-shadow:0 1px 3px rgba(0,0,0,.1)}

    /* Custom per-visual header toolbar (Plotly-like, but fully controlled) */
    .vm-vtb{display:flex;align-items:center;gap:4px;flex-wrap:nowrap;padding:0 2px;max-width:100%;overflow:hidden;}
    .vm-vtb .vm-tb-btn{
      width:22px;height:22px;min-width:22px;min-height:22px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      transition:transform .08s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .vm-vtb .vm-tb-btn:hover{background:#fff;border-color:rgba(0,0,0,.18);box-shadow:0 2px 10px rgba(0,0,0,.10);transform:translateY(-1px);}
    .vm-vtb .vm-tb-btn:active{transform:translateY(0px);box-shadow:0 1px 4px rgba(0,0,0,.12);}
    .vm-vtb .vm-tb-btn[aria-pressed="true"]{border-color:var(--vm-accent);box-shadow:0 0 0 3px rgba(2,132,199,0.18);}
    .vm-vtb svg{width:18px;height:18px;stroke:#111827;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
    .vm-vtb .vm-dot{width:4px;height:4px;border-radius:999px;background:#111827;display:inline-block;}
    .vm-menu{
      position:absolute;top:40px;right:8px;
      min-width:220px;
      background:#fff;border:1px solid rgba(0,0,0,.12);
      border-radius:12px;box-shadow:0 12px 34px rgba(0,0,0,.18);
      padding:6px;
      z-index:99999;
      display:none;
    }
    .vm-menu.open{display:block;}
    .vm-menu .mi{display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-radius:10px;cursor:pointer;color:#111827;font-size:13px;
    }
    .vm-menu .mi:hover{background:rgba(2,132,199,.08);}
    .vm-menu .mi .k{font-family:var(--vm-mono);font-size:12px;color:rgba(17,24,39,.7)}
    /* Per-visual popover panels (enterprise modebar menus) */
    .vm-pop{
      position:fixed;
      z-index:10000;
      min-width:260px;
      max-width:min(360px, calc(100vw - 16px));
      background:var(--vm-bg);
      border:1px solid var(--vm-border);
      border-radius:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.22);
      padding:10px 10px 8px;
      z-index:100000;
      display:none;
    }
    .vm-pop.open{display:block;}
    .vm-pop .pop-h{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .vm-pop .pop-h .t{font-weight:600;font-size:13px;color:var(--vm-text);}
    .vm-pop .pop-h .x{border:1px solid var(--vm-border);background:transparent;border-radius:10px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .vm-pop .pop-h .x:hover{background:rgba(2,132,199,.08)}
    .vm-pop .sec{margin:8px 0;}
    .vm-pop .sec .lbl{font-size:11px;color:var(--vm-sub);margin:0 0 6px 2px;}
    .vm-pop .row{display:flex;flex-wrap:wrap;gap:6px;}
    .vm-pop .chip{
      padding:6px 10px;border-radius:999px;border:1px solid var(--vm-border);
      background:rgba(0,0,0,.02);cursor:pointer;font-size:12px;color:var(--vm-text);
      user-select:none;
    }
    .vm-pop .chip:hover{background:rgba(2,132,199,.08)}
    .vm-pop .chip.on{background:rgba(2,132,199,.14);border-color:rgba(2,132,199,.35)}
    .vm-pop select,.vm-pop input{
      width:100%;
      padding:7px 10px;border-radius:12px;border:1px solid var(--vm-border);
      background:var(--vm-input);color:var(--vm-text);font-size:12px;
      outline:none;
    }
    .vm-pop .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}
    .vm-pop .btn-sm{
      padding:6px 10px;border-radius:12px;border:1px solid var(--vm-border);
      background:rgba(2,132,199,.10);color:var(--vm-text);cursor:pointer;font-size:12px;
    }
    .vm-pop .btn-sm:hover{background:rgba(2,132,199,.16)}
    .vm-pop .btn-sm.ghost{background:transparent}

        .vm-modebar-btn:active{background:rgba(255,255,255,1);transform:scale(0.95)}
    [data-theme="dark"] .vm-modebar-btn{background:rgba(15,23,42,.85);border-color:rgba(255,255,255,.12)}
    [data-theme="dark"] .vm-modebar-btn svg{fill:#e5e7eb}
    [data-theme="dark"] .vm-modebar-btn:hover{background:rgba(15,23,42,.98);border-color:rgba(255,255,255,.2)}
    [data-theme="dark"] .vm-modebar-btn:active{background:rgba(31,41,55,1)}

    /* Plotly modebar positioning - outside plot area top-right */
    .card{position:relative;}
    .card .hdr{position:relative;overflow:hidden;}
    .card .body{position:relative;overflow:hidden;}
    .plot{position:relative;overflow:hidden;}
    .js-plotly-plot{position:relative!important;overflow:visible!important;}
    .js-plotly-plot .modebar{display:none!important;}
    .js-plotly-plot .modebar-group{
      margin:0!important;padding:0!important;background:transparent!important;
      display:flex!important;gap:2px!important;align-items:center!important;
    }
    .js-plotly-plot .modebar-btn{
      width:24px!important;height:24px!important;margin:0!important;padding:0!important;
      background:rgba(255,255,255,.88)!important;
      border:1px solid rgba(0,0,0,.10)!important;
      border-radius:6px!important;
      cursor:pointer!important;
      transition:all .15s ease!important;
      display:flex!important;align-items:center!important;justify-content:center!important;
      color:#111827!important;
    }
    .js-plotly-plot .modebar-btn svg{width:16px!important;height:16px!important;display:block!important;filter:none!important}
    .js-plotly-plot .modebar-btn svg path{fill:currentColor!important;stroke:currentColor!important}
    .js-plotly-plot .modebar-btn:hover{
      background:rgba(255,255,255,.98)!important;
      border-color:rgba(0,0,0,.18)!important;
      box-shadow:0 1px 3px rgba(0,0,0,.12)!important
    }
    .js-plotly-plot .modebar-btn:active{transform:scale(.96)!important}
    [data-theme="dark"] .js-plotly-plot .modebar-btn{
      background:rgba(15,23,42,.86)!important;
      border-color:rgba(255,255,255,.14)!important;
      color:#e5e7eb!important;
    }
    [data-theme="dark"] .js-plotly-plot .modebar-btn:hover{
      background:rgba(15,23,42,.98)!important;
      border-color:rgba(255,255,255,.22)!important
    }
.toolbtn{width:30px;height:30px;padding:0;justify-content:center;gap:0;font-size:12px;}
    .toolbtn[aria-pressed="true"]{border-color: rgba(125,211,252,.40); background:rgba(125,211,252,.10)}

    .group-body{display:flex;flex-direction:column;gap:10px;flex:1 1 auto;min-height:0;padding:8px 10px;}
    .subvis{border:1px solid var(--vm-border);border-radius:14px;background:rgba(255,255,255,.02);overflow:hidden;display:flex;flex-direction:column;min-height:0;position:relative}
    .subvis .subhdr{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:4px 6px;border-bottom:1px solid var(--vm-border);background:rgba(255,255,255,.02);min-height:0;width:100%;}
    .subvis .subhdr .left{display:flex;align-items:center;gap:10px;min-width:0;flex:1 1 auto;}
    .subvis .subhdr .right{display:none}
    .subvis .subhdr .type{font-family:var(--vm-mono);font-size:11px;color:var(--vm-sub);border:1px solid var(--vm-border);padding:2px 7px;border-radius:999px;background:rgba(0,0,0,.06)}
    .subvis .subhdr .title{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* Modebar popup menus - Modern UI with scrolling */
    .oas-pop{
      position:fixed;z-index:2147483646;
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(252,253,255,.96));
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:0;
      box-shadow:0 20px 60px -12px rgba(0,0,0,.15), 0 0 1px rgba(0,0,0,.1);
      min-width:220px;max-width:380px;
      max-height:calc(100vh - 40px);
      display:flex;flex-direction:column;
      overflow:hidden;
    }
    [data-theme="dark"] .oas-pop{
      background:linear-gradient(180deg, rgba(23,37,63,.98), rgba(15,23,42,.96));
      border-color:#2b3447;
      box-shadow:0 20px 60px -12px rgba(0,0,0,.35), 0 0 1px rgba(0,0,0,.2);
      color:#e5e7eb;
    }
    .oas-pop, .oas-pop *{box-sizing:border-box}
    .oas-pop .hdr{font-weight:700;margin-bottom:0;width:100%;padding:14px 16px;border-bottom:1px solid #f0f0f0;flex-shrink:0;}
    [data-theme="dark"] .oas-pop .hdr{border-bottom-color:#2b3447}
    .oas-pop .hdr.hdr-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0;padding:14px 16px;}
    .oas-pop .hdr.hdr-top .ttl{flex:1;min-width:0;font-size:14px;font-weight:600}
    .oas-pop .xbtn{width:28px!important;height:28px;line-height:28px;padding:0;border-radius:8px;text-align:center;font-weight:700;display:inline-flex;align-items:center;justify-content:center;border:none;background:transparent;color:var(--vm-sub);cursor:pointer;transition:all 0.2s}
    .oas-pop .xbtn:hover{background:rgba(0,0,0,.08);color:var(--vm-text)}
    [data-theme="dark"] .oas-pop .xbtn:hover{background:rgba(255,255,255,.08);color:#e5e7eb}
    .oas-pop .body-inner{
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      scrollbar-width:thin;
      scrollbar-color:var(--vm-border) rgba(0,0,0,.02);
    }
    .oas-pop .body-inner::-webkit-scrollbar{width:7px}
    .oas-pop .body-inner::-webkit-scrollbar-track{background:rgba(0,0,0,.02)}
    .oas-pop .body-inner::-webkit-scrollbar-thumb{background:var(--vm-border);border-radius:3px}
    .oas-pop .body-inner::-webkit-scrollbar-thumb:hover{background:var(--vm-text);opacity:.6}
    [data-theme="dark"] .oas-pop .body-inner::-webkit-scrollbar-track{background:rgba(255,255,255,.02)}
    .oas-pop .group{display:flex;flex-direction:column;gap:10px;padding:0 16px}
    .oas-pop .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:0 16px}
    .oas-pop .group:first-of-type{padding-top:12px}
    .oas-pop .group:last-of-type,.oas-pop .row:last-of-type{padding-bottom:12px}
    .oas-pop input[type="text"], .oas-pop input[type="number"], .oas-pop input[type="range"]{
      width:100%;max-width:100%;
      padding:8px 10px;
      border:1px solid #e0e0e0;
      border-radius:8px;
      background:rgba(255,255,255,.8);
      color:var(--vm-text);
      font:12px/1.4 system-ui;
    }
    [data-theme="dark"] .oas-pop input{border-color:#395080;background:rgba(15,23,42,.6)}
    .oas-pop button{padding:7px 12px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;cursor:pointer;font:12px/1.4 system-ui;color:var(--vm-text);transition:all 0.2s}
    .oas-pop button:hover{background:#f8f9fa;border-color:#d0d0d0}
    [data-theme="dark"] .oas-pop button{background:#1f2937;border-color:#395080;color:#e5e7eb}
    [data-theme="dark"] .oas-pop button:hover{background:#263555;border-color:#4b5d7f}
    .oas-pop label{display:flex;align-items:center;gap:6px;font-size:12px}
    .oas-pop label.seg{display:inline-flex;align-items:center;gap:0}
    .oas-pop label.seg input{position:absolute;opacity:0;pointer-events:none}
    .oas-pop label.seg span{
      display:inline-block;padding:6px 11px;
      border:1px solid #d0d0d0;
      border-radius:7px;
      background:#f8f9fa;
      cursor:pointer;white-space:nowrap;
      font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#374151;
      transition:all 0.2s;
    }
    .oas-pop label.seg span:hover{background:#f0f0f0;border-color:#999}
    .oas-pop label.seg input:checked + span{background:#3b82f6;border-color:#2563eb;color:#fff;font-weight:600}
    [data-theme="dark"] .oas-pop label.seg span{background:#263555;border-color:#395080;color:#e5e7eb}
    [data-theme="dark"] .oas-pop label.seg span:hover{background:#2d3f5b;border-color:#4b5d7f}
    [data-theme="dark"] .oas-pop label.seg input:checked + span{background:#2563eb;border-color:#1d4ed8;color:#fff}

    /* BoxPlot_v2-style vertical list menus */
    .oas-pop.vlist{padding:0;overflow:hidden;min-width:220px}
    .oas-pop.vlist .hdr{margin:0;padding:10px 10px 6px 10px}
    .oas-pop.vlist button{width:100%;text-align:left;border:0;border-top:1px solid #e5e7eb;border-radius:0;background:transparent;padding:10px 12px}
    .oas-pop.vlist button:hover{background:#f3f4f6}
    [data-theme="dark"] .oas-pop.vlist button{border-top-color:#2b3447}
    [data-theme="dark"] .oas-pop.vlist button:hover{background:#111827}

    .vm-tb{display:flex;align-items:center;gap:4px;}
    .vm-tb svg{width:15px;height:15px;display:block;}
    .vm-tb .toolbtn{width:28px;height:28px}
    .subvis .subbody{flex:1 1 auto;min-height:0;padding:6px 8px;}
    .subvis .subbody .plot{min-height:0;}

    .card .body{padding:2px 2px 2px 2px;flex:1 1 auto;min-height:0;position:relative;overflow:hidden;}
    .plot{width:100%;height:100%;min-height:0;position:relative;}
    /* Remove Plotly's default border that creates duplicate border effect */
    .js-plotly-plot{border:none!important;overflow:hidden;}
    .card.vm-full{position:fixed!important;top:0;left:0;right:0;bottom:0;width:100vw!important;height:100vh!important;z-index:9999;max-width:none!important;max-height:none!important;margin:0!important;border-radius:0!important}
    .card.vm-full .body{padding:10px 12px 12px}
    .card.vm-full .body{padding:2px 2px 2px 2px;}
    [data-vm-host]:fullscreen{overflow-y:auto!important;overflow-x:hidden}

    .vm-section{grid-column:1/-1; display:flex; flex-direction:column; gap:var(--vm-section-gap, 4px);}
    .vm-section-title{font-size:14px;font-weight:700;color:var(--vm-text);padding:4px 8px;border-radius:10px;background:transparent;border:1px solid var(--vm-border)}
    .vm-subgrid{width:100%}
    
    /* NEW FEATURES: Data group separators and group title/subtitle styling */
    .vm-group-separator{grid-column:1/-1;margin:16px 0;padding-top:12px;border-top:2px solid #d1d5db}
    .vm-group-separator .vm-group-title{font-weight:600;font-size:14px;color:var(--vm-text);margin-bottom:2px}
    .vm-group-separator .vm-group-subtitle{font-size:12px;color:var(--vm-sub)}
    .vm-group-toggle{appearance:none;border:1px solid var(--vm-border);background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.92));color:var(--vm-text);border-radius:6px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all 0.2s ease}
    .vm-group-toggle:hover{border-color:rgba(0,0,0,.18);background:rgba(0,0,0,.03)}
    .vm-group-toggle.collapsed{color:var(--vm-sub)}
    [data-vm-host][data-theme="dark"] .vm-group-toggle{background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03))}
    [data-vm-host][data-theme="dark"] .vm-group-toggle:hover{border-color:rgba(255,255,255,.20)}
    
    .vm-row{grid-column:1/-1; display:flex; gap:var(--vm-gap); align-items:stretch; flex-wrap:wrap;}
    .vm-row > .card{flex:1 1 0; min-width:260px;}

    .vm-dg{position:relative;border:1px solid var(--vm-border);border-radius:8px;overflow:hidden;min-height:160px;margin:8px 0;background:var(--vm-card2)}
    .vm-dt{position:absolute;border:2px solid rgba(125,211,252,.5);border-radius:6px;background:rgba(125,211,252,.08);user-select:none;display:flex;flex-direction:column;overflow:hidden;z-index:2;box-sizing:border-box}
    .vm-dt:hover{border-color:rgba(125,211,252,.85)}
    .vm-dt.active{opacity:.7;z-index:10}
    .vm-dt .dt-h{padding:2px 6px;font-size:10px;font-weight:600;color:var(--vm-text);background:rgba(125,211,252,.15);cursor:grab;display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden}
    .vm-dt .dt-b{flex:1;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:rgba(125,211,252,.3);pointer-events:none}
    .vm-dt .dt-r{position:absolute;bottom:0;right:0;width:12px;height:12px;cursor:nwse-resize;background:linear-gradient(135deg,transparent 50%,rgba(125,211,252,.5) 50%)}
    .vm-dt .dt-x{cursor:pointer;margin-left:auto;font-size:12px;color:var(--vm-sub)}
    .vm-dt .dt-x:hover{color:#f87171}

    .vm-mini{display:flex;align-items:center;gap:6px;border:1px solid var(--vm-border);border-radius:12px;padding:0 8px;height:30px;background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(248,250,252,.92));}
    .vm-mini .lbl{font-size:12px;font-weight:500;color:var(--vm-text);white-space:nowrap;}
    .vm-mini select{height:26px;border:none;background:transparent;color:var(--vm-text);font-size:12px;outline:none;cursor:pointer;min-width:35px;padding:0 2px;}
    .vm-mini select option{background:white;color:#111827;}
    [data-vm-host][data-theme="dark"] .vm-mini select option{background:#1f2937;color:#e5e7eb;}
    [data-vm-host][data-theme="dark"] .vm-mini{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); }

    .vm-table-wrap{width:100%;height:100%;max-height:100%;overflow:auto;background:var(--vm-card)}
    .vm-table{width:100%;border-collapse:collapse;font-size:12px;color:var(--vm-text)}
    .vm-table th,.vm-table td{border:1px solid var(--vm-border);padding:6px 10px;vertical-align:top;overflow-wrap:break-word;word-break:break-word}
    .vm-table th{position:sticky;top:0;background:var(--vm-card2);z-index:2;text-align:left;font-weight:600;white-space:normal}
    .vm-table .vm-tr-stripe td{background:rgba(0,0,0,.025)}
    [data-vm-host][data-theme="dark"] .vm-table .vm-tr-stripe td{background:rgba(255,255,255,.035)}
    .vm-table-compact th,.vm-table-compact td{padding:3px 6px;font-size:11px}

    .empty{
      padding:22px 12px;
      border:1px dashed var(--vm-border);
      border-radius: 14px;
      color:var(--vm-sub);
      background:rgba(0,0,0,.02);
      text-align:center;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; z-index:10000;
      display:none;
      background: var(--vm-overlay, rgba(0,0,0,.55));
      backdrop-filter: blur(6px);
    }
    .modal{
      position:fixed;
      left:50%; top:50%; transform: translate(-50%,-50%);
      width:min(980px, calc(100vw - 24px));
      max-height: calc(100vh - 24px);
      overflow:hidden;
      border:1px solid var(--vm-border);
      border-radius: 16px;
      background: var(--vm-card);
      box-shadow: var(--vm-shadow);
      z-index:10001;
    
    }

    [data-vm-host][data-theme="dark"] .modal{ background:linear-gradient(180deg, rgba(18,30,56,.96), rgba(10,16,30,.96)); }
    .modal .m-hdr{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid #f0f0f0;
      background:linear-gradient(180deg, rgba(255,255,255,.5), rgba(248,250,252,.3));
    }
    [data-vm-host][data-theme="dark"] .modal .m-hdr{
      border-bottom-color:#2b3447;
      background:linear-gradient(180deg, rgba(30,46,77,.5), rgba(18,28,50,.3));
    }
    .modal .m-hdr .ttl{font-size:15px; font-weight:600; flex:1; letter-spacing:-0.3px;}
    .modal .m-hdr .btn{width:32px!important;height:32px;padding:0;border:none;background:transparent;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;font-size:20px;color:var(--vm-sub);transition:all 0.2s ease}
    .modal .m-hdr .btn:hover{background:rgba(0,0,0,.08);color:var(--vm-text)}
    [data-vm-host][data-theme="dark"] .modal .m-hdr .btn:hover{background:rgba(255,255,255,.08)}
    .modal .m-body{
      padding:18px;
      overflow-y:auto;
      overflow-x:hidden;
      flex:1 1 auto;
      max-height: calc(100vh - 220px);
      scrollbar-width: thin;
      scrollbar-color: var(--vm-border) rgba(0,0,0,.05);
    }
    .modal .m-body::-webkit-scrollbar{
      width: 8px;
    }
    .modal .m-body::-webkit-scrollbar-track{
      background: rgba(0,0,0,.02);
    }
    .modal .m-body::-webkit-scrollbar-thumb{
      background: var(--vm-border);
      border-radius: 4px;
    }
    .modal .m-body::-webkit-scrollbar-thumb:hover{
      background: var(--vm-text);
    }
    [data-vm-host][data-theme="dark"] .modal .m-body::-webkit-scrollbar-track{
      background: rgba(255,255,255,.02);
    }
    .modal .m-ftr{
      display:flex; gap:10px; justify-content:flex-end;
      padding:14px 18px;
      border-top:1px solid #f0f0f0;
      background:linear-gradient(180deg, rgba(248,250,252,.5), rgba(248,250,252,.3));
      flex-shrink:0;
    }
    [data-vm-host][data-theme="dark"] .modal .m-ftr{
      border-top-color:#2b3447;
      background:linear-gradient(180deg, rgba(30,46,77,.3), rgba(18,28,50,.2));
    }

    .form{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:10px 12px;
      align-items:center;
    }
    .form .lbl{font-size:12px;color:var(--vm-sub)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    select,input,textarea{
      font-family: var(--vm-sans);
      font-size:12px;
      color:var(--vm-text);
      background: var(--vm-input);
      border:1px solid var(--vm-border);
      border-radius: 12px;
      padding:8px 10px;
      outline:none;
    }
    select:focus,input:focus,textarea:focus{box-shadow: var(--vm-focus);border-color:rgba(125,211,252,.35)}

    /* Fix: dropdown options can render on white background in Windows */
    select option{ color:#111827; background:#ffffff; }
    [data-vm-host][data-theme="dark"] select option{ color:#e5e7eb; background:#0f172a; }

    textarea{min-height:110px;width:100%;font-family:var(--vm-mono);font-size:11px;}

    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
    .tab{padding:7px 10px;border-radius:12px;border:1px solid var(--vm-border);background:rgba(0,0,0,.03);cursor:pointer;font-size:12px;color:var(--vm-text);opacity:.88}
    .tab.active{border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.10)}
    
    .vm-cb-label:hover{background:rgba(0,0,0,.03)}
    [data-vm-host][data-theme="dark"] .vm-cb-label:hover{background:rgba(255,255,255,.05)}

    .sep{height:1px;background:var(--vm-border);margin:10px 0;}

    .section-hdr{display:flex;align-items:center;gap:8px;padding:8px 0 4px;cursor:pointer;user-select:none;font-size:13px;font-weight:600;color:var(--vm-text);border-bottom:1px solid var(--vm-border);margin:6px 0 8px}
    .section-hdr .arrow{font-size:10px;color:var(--vm-sub);transition:transform .2s}
    .section-hdr.collapsed .arrow{transform:rotate(-90deg)}
    .section-hdr .s-badge{font-size:10px;color:var(--vm-sub);font-weight:400;margin-left:auto;font-family:var(--vm-mono)}
    .section-body{overflow:hidden;transition:max-height .25s ease}
    .section-body.collapsed{max-height:0!important;overflow:hidden;padding:0}

    .color-row{display:flex;gap:8px;align-items:center}
    .color-row input[type="color"]{width:36px;height:30px;padding:2px;border-radius:8px;border:1px solid var(--vm-border);cursor:pointer;background:var(--vm-input)}
    .color-row input[type="text"]{width:90px;font-family:var(--vm-mono);font-size:11px}

    .list{display:flex;flex-direction:column;gap:8px;}
    .list-item{border:1px solid var(--vm-border);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
    .list-item .top{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .list-item .top .name{font-weight:600;font-size:12px}
    .list-item .top .muted{font-size:11px;color:var(--vm-sub);font-family:var(--vm-mono)}
    .list-item .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .note{font-size:12px;color:var(--vm-sub);line-height:1.35}
    .warn{color: var(--vm-warn)}
    
    /* Column selection checkbox hover effect */
    .col-checkbox-label:hover{background:rgba(0,0,0,.04)!important}
    [data-theme="dark"] .col-checkbox-label:hover{background:rgba(255,255,255,.06)!important}

    /* Scrollbar styling for modals */
    .m-body::-webkit-scrollbar{width:6px}
    .m-body::-webkit-scrollbar-thumb{background:rgba(125,211,252,.25);border-radius:6px}
    .m-body::-webkit-scrollbar-track{background:transparent}

    .badge{font-family:var(--vm-mono);font-size:11px;color:var(--vm-sub);padding:2px 7px;border:1px solid var(--vm-border);border-radius:999px;background:rgba(0,0,0,.06)}

    /* tablets & small screens */
    @media (max-width:1024px){
      [data-vm-host] .vm-wrap{--vm-cols:2;}
    }

    /* tablets */
    @media (max-width:768px){
      .vm-title h1{font-size:24px;margin:0 0 4px 0;}
      .vm-title .sub{font-size:12px;}
      .card{padding:12px;}
      .card .hdr{padding:8px;}
      .grid{margin:12px 0;gap:8px;}
      [data-vm-host] .vm-wrap{--vm-cols:1;--vm-gap:8px;}
      .vm-section{margin-bottom:16px;}
      .vm-section-title{font-size:13px;padding:3px 6px;}
    }

    /* mobile phones */
    @media (max-width:480px){
      .vm-titlebar{flex-direction:column;gap:12px;}
      .vm-title h1{font-size:20px;}
      .vm-actions{width:100%;}
      .vm-actions button{font-size:12px;padding:6px 10px;}
      .card{padding:10px;border-radius:8px;}
      .card .hdr{padding:6px;gap:6px;}
      .card .hdr .left{gap:4px;}
      .card .hdr .title{font-size:12px;}
      .card .body{padding:8px;}
      .plot{min-height:240px;}
      .grid{margin:8px 0;gap:6px;padding:0 8px;}
      [data-vm-host] .vm-wrap{--vm-cols:1;--vm-gap:6px;--vm-border-radius:8px;padding:0;}
      .form{grid-template-columns:1fr;gap:12px;}
      .form .lbl{font-size:12px;}
      .form select, .form input{font-size:13px;padding:6px;}
      .note{font-size:11px;}
      .vm-section{margin-bottom:12px;padding:0 8px;}
      .vm-section-title{font-size:12px;padding:3px 4px;}
    }

    /* tiny screens */
    @media (max-width: 840px){
      .form{grid-template-columns: 1fr;}
      .vm-title{min-width:0}
      .grid{grid-template-columns:1fr;}
    }
  
/* --- V13 fixes: keep toolbars inside cards + prevent header collapse --- */
.card{overflow:hidden;}
.card .hdr{overflow:hidden; width:100%;}
.card .hdr .right{
  max-width:55%;
  display:flex;
  justify-content:flex-end;
  flex-wrap:nowrap;
  gap:6px;
  overflow:hidden;
}
.vm-vtb{max-width:100%; overflow:hidden;}
/* compact toolbar buttons */
.vm-tb-btn{width:22px;height:22px; box-sizing:border-box;}
.vm-tb-btn svg{width:14px;height:14px;}
/* popover z-index above plot */
.oas-pop{z-index:9999;}

/* --- V14 fixes: keep modebar inside card and pinned right even when title hidden --- */
.card{overflow:hidden;}
.card .hdr{box-sizing:border-box; justify-content:space-between;}
.card .hdr .left{flex:1 1 auto; min-width:0;}
.card .hdr .right{flex:0 0 auto; margin-left:auto; max-width:70%; min-width:0; padding-right:4px; box-sizing:border-box;}
.card .hdr .right .vm-vtb{flex-wrap:nowrap; overflow:hidden; max-width:100%; padding-right:6px; box-sizing:border-box;}
.card .hdr .right .vm-vtb .vm-tb-btn{flex:0 0 auto;}
</style>
  <div class="vm-wrap">
    <div class="vm-titlebar">
      <div class="vm-title">
        <img id="vm-report-image" style="display:none;" alt="Report logo" />
        <div class="vm-title-text">
          <h1 id="vm-report-title">Visual Manager</h1>
          <div class="sub" id="vm-report-sub">Registry-driven Plotly visuals � per-visual settings (mapping/aggregation/filter)</div>
        </div>
      </div>
      <div class="vm-actions">
        <span class="pill" id="vm-pill" style="display:none">0</span>
        <div class="vm-mini" title="Visuals per row" id="vm-cols-control">
          <span class="lbl">Cols</span>
          <select id="vm-vpr" aria-label="Visuals per row">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>
        </div>
        <button class="btn ico" id="vm-btn-theme" title="Theme (light/dark/paper)">&#9680;</button>
        <button class="btn ico" id="vm-btn-download" title="Downloads">&#8615;</button>
        <button class="btn ico" id="vm-btn-fullscreen" title="Full screen">&#9974;</button>
        <button class="btn ico" id="vm-btn-manager" title="Visual Manager">&#9638;</button>
      </div>
    </div>

    <div class="grid" id="vm-grid"></div>
    <div id="vm-pop" class="vm-pop" aria-hidden="true"></div>


    <div class="sep"></div>
  </div>

  <!-- Modal: Global Visual Manager -->
  <div class="modal-backdrop" id="vm-manager-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="m-hdr">
        <div class="ttl">Visual Manager</div>
        <button class="btn" id="vm-manager-close">Close</button>
      </div>
      <div class="m-body">
        <div class="tabs" id="vm-mgr-tabs">
          <div class="tab active" data-tab="layout">Layout</div>
          <div class="tab" data-tab="visuals">Visuals</div>
          <div class="tab" data-tab="data">Data</div>
          <div class="tab" data-tab="help">Help</div>
        </div>

        <div id="vm-mgr-body"></div>
      </div>
      <div class="m-ftr">
        <button class="btn" id="vm-manager-cancel">Cancel</button>
        <button class="btn primary" id="vm-manager-apply">Apply</button>
      </div>
    </div>
  </div>

  <!-- Modal: Per-visual settings -->
  <div class="modal-backdrop" id="vm-visual-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="m-hdr">
        <div class="ttl" id="vm-vis-ttl">Visual Settings</div>
        <button class="btn" id="vm-visual-close">Close</button>
      </div>
      <div class="m-body">
        <div class="tabs" id="vm-vis-tabs">
          <div class="tab active" data-tab="mapping">Mapping</div>
          <div class="tab" data-tab="options">Options</div>
          <div class="tab" data-tab="filter">Filter</div>
          <div class="tab" data-tab="advanced">Advanced</div>
        </div>
        <div id="vm-vis-body"></div>
      </div>
      <div class="m-ftr">
        <button class="btn" id="vm-visual-cancel">Cancel</button>
        <button class="btn primary" id="vm-visual-apply">Apply</button>
      </div>
    </div>
  </div>

</div>

<script>
  (function(){
    'use strict';

    var HOST = (function(){
      var s = document.currentScript;
      var h = s ? s.previousElementSibling : null;
      if(h && h.getAttribute && h.getAttribute('data-vm-host')==='1') return h;
      return document.querySelector('[data-vm-host="1"]');
    })();
    if(!HOST) HOST=document.body;
    function q(sel){ return HOST.querySelector(sel); }
    function qa(sel){ return Array.prototype.slice.call(HOST.querySelectorAll(sel)); }

    var PARAMS = q('#vm-params');
    function pvStr(attr, defVal){
      var raw = PARAMS ? String(PARAMS.getAttribute(attr)||'').trim() : '';
      return raw ? raw : String(defVal==null?'':defVal);
    }
    function pvBool(attr, defVal){
      var raw = pvStr(attr, '');
      if(!raw) return !!defVal;
      var v = raw.toLowerCase();
      if(v==='0' || v==='false' || v==='no' || v==='off') return false;
      return true;
    }
    function pvNum(attr, defVal){
      var raw = pvStr(attr, '');
      if(!raw) return defVal;
      var m = raw.match(/-?\d+(?:\.\d+)?/g);
      if(!m || !m.length) return defVal;
      var n = parseFloat(m[m.length-1]);
      return isFinite(n) ? n : defVal;
    }
    function pvInt(attr, defVal){
      var n = pvNum(attr, defVal);
      return isFinite(n) ? Math.trunc(n) : defVal;
    }

    var SHOW_TITLEBAR_MANAGER = pvBool('data-show-titlebar-manager', true);
    var SHOW_VISUAL_SETTINGS_ICON = pvBool('data-show-visual-settings', true);
    var SHOW_BUSINESS_CONTROLS = pvBool('data-show-business-controls', true);
    var SHOW_STATUS_PILL = pvBool('data-show-status-pill', false);
    var SHOW_VISUAL_HEADER_TEXT = pvBool('data-show-visual-header-text', true);
    var PERSISTENCE_ENABLED = pvBool('data-persistence', true);
    var CLEAR_PERSISTENCE_ONLOAD = pvBool('data-clear-persistence-onload', false);

    var PV_THEME_DEFAULT = (pvStr('data-theme-default', 'light') || 'light').toLowerCase();
    if(PV_THEME_DEFAULT!=='dark' && PV_THEME_DEFAULT!=='paper') PV_THEME_DEFAULT='light';
    HOST.setAttribute('data-theme', PV_THEME_DEFAULT);

    function ensureScriptOnce(key, urls){
      return new Promise(function(resolve, reject){
        if(key && window[key]) return resolve();

        var attr = 'data-vm-lib-'+String(key||'script');
        var existing = document.querySelector('script['+attr+'="1"]');
        if(existing){
          existing.addEventListener('load', function(){ resolve(); });
          existing.addEventListener('error', function(){ reject(new Error('Failed to load '+key)); });
          return;
        }

        var i=0;
        function tryNext(){
          if(i>=urls.length) return reject(new Error('Failed to load '+key+' from all configured paths'));
          var src = urls[i++];
          var s = document.createElement('script');
          s.src = src;
          s.async = true;
          s.setAttribute(attr,'1');
          s.onload = function(){ resolve(); };
          s.onerror = function(){
            try{ s.remove(); }catch(e){}
            tryNext();
          };
          (document.head || document.body || document.documentElement).appendChild(s);
        }
        tryNext();
      });
    }

    function ensurePlotly(){
      if(window.Plotly && window.Plotly.newPlot) return Promise.resolve();
      return ensureScriptOnce('Plotly', [
        '/analyticsRes/vendor/plotly/plotly.min.js',
        '/analyticsRes/custom/plotly.min.js',
      ]);
    }

    // ---------------------------
    // Utilities
    function closestAttr(el, attr){
      while(el && el!==document){
        if(el.getAttribute && el.getAttribute(attr)!=null) return el;
        el = el.parentNode;
      }
      return null;
    }

    // ---------------------------
    function uid(){
      return 'v_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
    }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function cssEscape(str){ return String(str||'').replace(/"/g,'\\"').replace(/\\/g,'\\\\'); }
function escapeHtml(s){
      return String(s==null?'':s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function normalizeJsonText(text){
      var t = String(text==null?'':text);
      t = t.replace(/^\uFEFF/, '');
      t = t.replace(/\u0000/g, '');
      // tolerate trailing commas: ",]" or ",}"
      t = t.replace(/,\s*([}\]])/g, '$1');
      return t;
    }
    function tryJsonParse(text){
      try{ return JSON.parse(text); }catch(e){}
      var cleaned = normalizeJsonText(text);
      if(cleaned!==text){
        try{ return JSON.parse(cleaned); }catch(e2){}
      }
      return null;
    }

    function isFiniteNumber(x){ return typeof x==='number' && isFinite(x); }
    function toNumber(x){
      if(x==null || x==='') return null;
      if(typeof x==='number') return isFinite(x)?x:null;
      var s = String(x).trim();
      if(!s) return null;
      // strip commas
      s = s.replace(/,/g,'');
      var n = Number(s);
      return isFinite(n)?n:null;
    }

    function fmtDec(val, dec){
      if(dec == null || dec === '' || !isFinite(dec)) return val;
      var n = toNumber(val);
      return isFinite(n) ? Number(n.toFixed(clamp(parseInt(dec,10)||0, 0, 10))) : val;
    }

    function asString(x){ return (x==null)?'':String(x); }

    function objAssign(dst, src){
      dst = dst || {};
      if(!src) return dst;
      Object.keys(src).forEach(function(k){ dst[k]=src[k]; });
      return dst;
    }

    function plotTheme(){
      var t = String(HOST.getAttribute('data-theme')||STATE.globals.theme||PV_THEME_DEFAULT||'light').toLowerCase();
      if(t==='dark'){
        return {
          font:'rgba(255,255,255,.86)',
          grid:'rgba(255,255,255,.10)',
          accent:'rgba(125,211,252,.85)',
          accent2:'rgba(167,139,250,.85)'
        };
      }
      // light/paper
      return {
        font:'#111827',
        grid:'rgba(0,0,0,.10)',
        accent:'rgba(2,132,199,.90)',
        accent2:'rgba(124,58,237,.90)'
      };
    }

    function layoutBase(extra){
      var th = plotTheme();
      var base = {
        paper_bgcolor:'rgba(0,0,0,0)',
        plot_bgcolor:'rgba(0,0,0,0)',
        font:{color: th.font},
        xaxis:{gridcolor: th.grid, zerolinecolor: th.grid},
        yaxis:{gridcolor: th.grid, zerolinecolor: th.grid}
      };
      if(extra){
        Object.keys(extra).forEach(function(k){
          if(k==='xaxis' || k==='yaxis') base[k]=objAssign(base[k], extra[k]);
          else base[k]=extra[k];
        });
      }
      return base;
    }

    function vmFormatLabel(val, opts){
      if(!isFinite(val)) return '';
      opts = opts || {};
      var dec = (opts.labelDecimals != null && opts.labelDecimals !== '') ? parseInt(opts.labelDecimals,10) : null;
      var v = (dec != null && isFinite(dec)) ? Number(val).toFixed(dec) : String(val);
      var pre = opts.labelPrefix || '';
      var suf = opts.labelSuffix || '';
      return pre + v + suf;
    }

    function vmPassThreshold(val, op, thr){
      var v = Number(val);
      var t = Number(thr);
      if(!isFinite(v) || !isFinite(t)) return false;
      op = String(op||'');
      if(op==='gt') return v > t;
      if(op==='gte') return v >= t;
      if(op==='lt') return v < t;
      if(op==='lte') return v <= t;
      if(op==='eq') return v === t;
      if(op==='neq') return v !== t;
      return false;
    }

    function vmHexToRgba(hex, alpha){
      var h = String(hex||'').replace('#','');
      if(h.length===3){ h = h[0]+h[0]+h[1]+h[1]+h[2]+h[2]; }
      if(h.length!==6) return 'rgba(220,38,38,'+(alpha||0.2)+')';
      var r = parseInt(h.slice(0,2),16);
      var g = parseInt(h.slice(2,4),16);
      var b = parseInt(h.slice(4,6),16);
      return 'rgba('+r+','+g+','+b+','+(alpha||0.2)+')';
    }

    function vmAvgForCol(rows, colKey){
      var sum = 0, cnt = 0;
      for(var i=0;i<rows.length;i++){
        var v = Number(rows[i] ? rows[i][colKey] : NaN);
        if(isFinite(v)){ sum += v; cnt++; }
      }
      return cnt ? (sum / cnt) : null;
    }

    function vmParsePalette(raw){
      var s = String(raw||'').trim();
      if(!s) return [];
      return s.split(/[,;\n]+/).map(function(x){ return x.trim(); }).filter(Boolean);
    }

    function vmGetPalette(v){
      var opts = (v && v.options) ? v.options : {};
      var theme = String(HOST.getAttribute('data-theme')||STATE.globals.theme||PV_THEME_DEFAULT||'light').toLowerCase();
      var pal = vmParsePalette(opts.palette);
      if(pal.length) return pal;
      if(theme==='dark') pal = vmParsePalette(STATE.globals.paletteDark);
      else pal = vmParsePalette(STATE.globals.paletteLight);
      if(pal.length) return pal;
      return ['#2563eb','#059669','#f59e0b','#ef4444','#7c3aed','#0ea5e9','#22c55e','#f97316'];
    }

    function vmSortRows(rows, sortBy, sortDir, xKey, yKey){
      if(!rows || !rows.length) return rows;
      sortBy = String(sortBy||'none');
      sortDir = String(sortDir||'asc');
      if(sortBy==='none') return rows;
      var dir = (sortDir==='desc') ? -1 : 1;
      var key = (sortBy==='y') ? yKey : xKey;
      return rows.slice().sort(function(a,b){
        var av = a ? a[key] : null;
        var bv = b ? b[key] : null;
        var an = Number(av); var bn = Number(bv);
        if(isFinite(an) && isFinite(bn)) return (an-bn)*dir;
        var ad = (av instanceof Date) ? av.getTime() : new Date(av).getTime();
        var bd = (bv instanceof Date) ? bv.getTime() : new Date(bv).getTime();
        if(isFinite(ad) && isFinite(bd)) return (ad-bd)*dir;
        var as = String(av==null?'':av); var bs = String(bv==null?'':bv);
        return as.localeCompare(bs) * dir;
      });
    }

    function vmAddTargetsToLayout(layout, v, ctx, rows){
      if(!layout || !v || !isCartesianType(v.type)) return;
      var opts = v.options || {};
      var mode = String(opts.targetMode || 'manual');
      var minVal = opts.targetMin;
      var maxVal = opts.targetMax;
      if(mode === 'columns'){
        if(opts.targetMinCol) minVal = vmAvgForCol(rows, opts.targetMinCol);
        if(opts.targetMaxCol) maxVal = vmAvgForCol(rows, opts.targetMaxCol);
      }
      var hasMin = isFinite(minVal);
      var hasMax = isFinite(maxVal);
      if(!hasMin && !hasMax) return;

      var color = opts.targetColor || '#dc2626';
      var dash = opts.targetDash || 'dash';
      var style = opts.targetStyle || 'line';

      layout.shapes = layout.shapes || [];

      if(style === 'band' && hasMin && hasMax){
        var y0 = Math.min(minVal, maxVal);
        var y1 = Math.max(minVal, maxVal);
        layout.shapes.push({
          type:'rect', xref:'paper', x0:0, x1:1,
          yref:'y', y0:y0, y1:y1,
          fillcolor: vmHexToRgba(color, 0.15),
          line:{color: color, width: 1.2, dash: dash},
          layer:'below'
        });
      } else {
        if(hasMin){
          layout.shapes.push({
            type:'line', xref:'paper', x0:0, x1:1,
            yref:'y', y0:minVal, y1:minVal,
            line:{color: color, width: 1.5, dash: dash}
          });
        }
        if(hasMax && (!hasMin || maxVal !== minVal)){
          layout.shapes.push({
            type:'line', xref:'paper', x0:0, x1:1,
            yref:'y', y0:maxVal, y1:maxVal,
            line:{color: color, width: 1.5, dash: dash}
          });
        }
      }
    }

    function vmAddReferenceLinesToLayout(layout, v){
      if(!layout || !v || !isCartesianType(v.type)) return;
      var opts = v.options || {};
      var refs = Array.isArray(opts.refLines) ? opts.refLines : [];
      if(!refs.length) return;
      layout.shapes = layout.shapes || [];
      layout.annotations = layout.annotations || [];
      refs.forEach(function(r){
        if(!r || !isFinite(r.value)) return;
        var color = r.color || '#111827';
        var dash = r.dash || 'dash';
        layout.shapes.push({
          type:'line', xref:'paper', x0:0, x1:1,
          yref:'y', y0:r.value, y1:r.value,
          line:{color: color, width: 1.3, dash: dash}
        });
        if(r.label){
          layout.annotations.push({
            xref:'paper', x:1, yref:'y', y:r.value,
            text:String(r.label), showarrow:false, xanchor:'left', font:{size:10,color:color}
          });
        }
      });
    }

    
    // ---------------------------
    // Runtime options application (legend/hover/axis titles etc.)
    // Applied after each visual render so menus actually work even if renderers ignore options.
    // ---------------------------
    function vmColLabel(ctx, key){
      if(!ctx || !ctx.cols || !key) return String(key||'');
      for(var i=0;i<ctx.cols.length;i++){
        var c=ctx.cols[i];
        if(!c) continue;
        if(c.key===key || c.name===key) return String(c.label||c.title||c.name||c.key||key);
      }
      return String(key);
    }
    function vmLegendLayoutFor(pos){
      pos = String(pos||'auto');
      if(pos==='top') return {orientation:'h', x:0, y:1.08, xanchor:'left', yanchor:'bottom'};
      if(pos==='bottom') return {orientation:'h', x:0, y:-0.18, xanchor:'left', yanchor:'top'};
      if(pos==='left') return {orientation:'v', x:-0.02, y:1, xanchor:'right', yanchor:'top'};
      if(pos==='right') return {orientation:'v', x:1.02, y:1, xanchor:'left', yanchor:'top'};
      return {}; // auto
    }
    function vmApplyRuntimeOptions(v, pel, ctx){
      try{
        if(!window.Plotly) return;
        var gd = pel && (pel.querySelector('.js-plotly-plot') || pel.querySelector('.plotly') || pel);
        if(!gd || !gd.classList || !gd.classList.contains('js-plotly-plot')) return;

        var opts = v && v.options ? v.options : {};
        var updates = {};
        // legend
        if(opts){
          if(typeof opts.showLegend === 'boolean') updates.showlegend = opts.showLegend;
          if(opts.legendPos && String(opts.legendPos)!=='auto'){
            updates.legend = objAssign({}, vmLegendLayoutFor(opts.legendPos));
          }
          if(opts.hoverMode) updates.hovermode = String(opts.hoverMode);
        }

        // axis titles default to mapped columns (if not set)
        var m = v && v.mapping ? v.mapping : {};
        var meas = v && v.measures ? v.measures : {};
        var xKey = m.x || m.category || m.label || '';
        var yKey = '';
        if(meas && meas.y && meas.y.colKey) yKey = meas.y.colKey;
        else if(m.y) yKey = m.y;
        // allow custom titles
        var xTitle = (opts && opts.xTitle) ? String(opts.xTitle) : (xKey ? vmColLabel(ctx, xKey) : '');
        var yTitle = (opts && opts.yTitle) ? String(opts.yTitle) : (yKey ? vmColLabel(ctx, yKey) : '');

        if(xTitle){
          updates['xaxis.title.text'] = xTitle;
        }
        if(yTitle){
          updates['yaxis.title.text'] = yTitle;
        }

        // apply font options if present
        if(opts && opts.axisTitleFontSize){
          var fs = parseInt(opts.axisTitleFontSize||0);
          if(fs>0){
            updates['xaxis.title.font.size'] = fs;
            updates['yaxis.title.font.size'] = fs;
          }
        }
        if(opts && opts.axisTitleFontColor){
          updates['xaxis.title.font.color'] = String(opts.axisTitleFontColor);
          updates['yaxis.title.font.color'] = String(opts.axisTitleFontColor);
        }
        // dragMode
        if(opts && opts.dragMode){
          updates.dragmode = String(opts.dragMode);
        }

        // Axis scaling / ranges
        var yMode = opts ? String(opts.yScaleMode||'auto') : 'auto';
        if(yMode==='log') updates['yaxis.type'] = 'log';
        else updates['yaxis.type'] = 'linear';
        if(yMode==='zero') updates['yaxis.rangemode'] = 'tozero';
        else updates['yaxis.rangemode'] = null;
        if(Number.isFinite(opts.yMin) || Number.isFinite(opts.yMax)){
          var yMin = Number.isFinite(opts.yMin) ? opts.yMin : null;
          var yMax = Number.isFinite(opts.yMax) ? opts.yMax : null;
          if(yMin!=null || yMax!=null){
            var r0 = (yMin!=null)?yMin:null;
            var r1 = (yMax!=null)?yMax:null;
            if(r0!=null && r1!=null && r0>r1){ var tmp=r0; r0=r1; r1=tmp; }
            updates['yaxis.autorange'] = false;
            updates['yaxis.range'] = [r0!=null?r0:null, r1!=null?r1:null].filter(function(x){return x!=null;}).length===2 ? [r0,r1] : null;
          }
        }
        // apply to y2 if present
        if(gd.layout && gd.layout.yaxis2){
          if(yMode==='log') updates['yaxis2.type'] = 'log'; else updates['yaxis2.type'] = 'linear';
          if(yMode==='zero') updates['yaxis2.rangemode'] = 'tozero'; else updates['yaxis2.rangemode'] = null;
        }

        // Tick formatting and density
        var xType = opts.xTickType || 'none';
        var xDec = opts.xTickDecimals;
        if(xType !== 'none'){
          var xFmt = '';
          if(xType === 'number') xFmt = (xDec != null) ? '.' + xDec + 'f' : 'f';
          else if(xType === 'percent') xFmt = (xDec != null) ? '.' + xDec + '%' : '%';
          else if(xType === 'si') xFmt = (xDec != null) ? '.' + xDec + 's' : 's';
          else if(xType === 'date') xFmt = opts.xTickFormat || '%Y-%m-%d';
          if(xFmt) updates['xaxis.tickformat'] = xFmt;
        } else if(opts.xTickFormat){
          updates['xaxis.tickformat'] = String(opts.xTickFormat);
        }

        var yType = opts.yTickType || 'none';
        var yDec = opts.yTickDecimals;
        if(yType !== 'none'){
          var yFmt = '';
          if(yType === 'number') yFmt = (yDec != null) ? '.' + yDec + 'f' : 'f';
          else if(yType === 'percent') yFmt = (yDec != null) ? '.' + yDec + '%' : '%';
          else if(yType === 'si') yFmt = (yDec != null) ? '.' + yDec + 's' : 's';
          if(yFmt) updates['yaxis.tickformat'] = yFmt;
        } else if(opts.yTickFormat){
          updates['yaxis.tickformat'] = String(opts.yTickFormat);
        }

        if(isFinite(parseInt(opts.xTickCount,10))) updates['xaxis.nticks'] = parseInt(opts.xTickCount,10);
        if(isFinite(parseInt(opts.yTickCount,10))) updates['yaxis.nticks'] = parseInt(opts.yTickCount,10);
        if(isFinite(parseInt(opts.xTickAngle,10))) updates['xaxis.tickangle'] = parseInt(opts.xTickAngle,10);
        
        if(Object.keys(updates).length){
          Plotly.relayout(gd, updates);
        }
      }catch(e){}
    }

// ---------------------------
    // Data + schema inference
    // ---------------------------
    function decodeHtmlEntities(str){
      var s = String(str==null?'':str);
      if(s.indexOf('&')<0) return s;
      // Robust decode (handles &amp;quot; etc via repeated decode)
      try{
        var ta = document.createElement('textarea');
        for(var i=0;i<3;i++){
          if(s.indexOf('&')<0) break;
          ta.innerHTML = s;
          var next = ta.value;
          if(next === s) break;
          s = next;
        }
        return s;
      }catch(e){
        // fallback for common entities
        s = s.replace(/&quot;/g,'"').replace(/&#34;/g,'"')
             .replace(/&apos;/g,"'").replace(/&#39;/g,"'")
             .replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
        return s;
      }
    }

    function getNarrativeRows(){
      // OAS narrative templates commonly use: <div id="box-data" style="display:none">[ ... ]</div>
      var ids = ['box-data','box_data','vm-data','oas-data','data'];
      var el = null;
      for(var i=0;i<ids.length;i++){
        el = document.getElementById(ids[i]);
        if(el) break;
      }
      if(!el){
        // try: first hidden div that looks like it contains a JSON array
        var cands = document.querySelectorAll('div[style*="display"],div[hidden]');
        for(var j=0;j<cands.length;j++){
          var t = String(cands[j].textContent||'').trim();
          if(!t) continue;
          if(t.indexOf('&')>=0) t = decodeHtmlEntities(t);
          var looksArray = (t.indexOf('[')>=0 && t.indexOf('{')>=0 && t.indexOf(']')>=0);
          var tt = t.replace(/^\s+/,'');
          var looksObj = (tt.charAt(0)==='{') && (tt.lastIndexOf('}')>tt.indexOf(':'));
          if(looksArray || looksObj){ el=cands[j]; break; }
        }
      }
      if(!el) return [];
      var txt = String(el.textContent||'').trim();
      if(!txt) return [];
      // OAS can HTML-encode quotes (sometimes nested)
      if(txt.indexOf('&')>=0) txt = decodeHtmlEntities(txt);
      // be defensive: extract the outermost JSON array
      var s = txt.indexOf('[');
      var e = txt.lastIndexOf(']');
      if(s>=0 && e>s) txt = txt.slice(s, e+1);
      var parsed = tryJsonParse(txt);
      if(Array.isArray(parsed)) return parsed;
      // Some Narrative setups output a single object like {"Col1":"@1",...}
      // Wrap it so we can infer columns and allow mapping.
      if(parsed && typeof parsed==='object') return [parsed];
      return [];
    }

    function getRawRows(){
      // Priority: OAS narrative injected rows
      var oas = getNarrativeRows();
      if(Array.isArray(oas) && oas.length) return oas;
      // Secondary: for local/browser testing
      if(Array.isArray(window.VM_DATA)) return window.VM_DATA;
      return [];
    }

    function inferColumns(rows){
      var cols = [];
      if(!rows || !rows.length) return cols;
      // Build a union of keys from the first N rows (Narrative can omit keys on the first row).
      var keySet = Object.create(null);
      var scanN = Math.min(rows.length, 30);
      for(var r0=0;r0<scanN;r0++){
        var row = rows[r0];
        if(row && typeof row==='object'){
          Object.keys(row).forEach(function(k){ keySet[k]=1; });
        }
      }
      var keys = Object.keys(keySet);
      for(var i=0;i<keys.length;i++){
        var k = keys[i];
        var kind = 'string';
        var numericCount=0, nonNull=0;
        for(var r=0;r<Math.min(rows.length, 50);r++){
          var v = rows[r][k];
          if(v==null || v==='') continue;
          nonNull++;
          var n = toNumber(v);
          if(n!=null) numericCount++;
        }
        if(nonNull>0 && numericCount/nonNull > 0.8) kind='number';
        cols.push({ key:k, label:k, kind:kind });
      }
      return cols;
    }

    var colOptionsCache = {};
    function colOptionsHtml(cols, selectedKey, allowBlank){
      var ck = (cols?cols.length:0) + '|' + (selectedKey||'') + '|' + (allowBlank?'1':'0');
      if(colOptionsCache[ck]) return colOptionsCache[ck];
      var html='';
      if(allowBlank) html += '<option value="">(none)</option>';
      for(var i=0;i<cols.length;i++){
        var c = cols[i];
        var sel = (String(selectedKey||'')===String(c.key)) ? 'selected' : '';
        html += '<option value="'+escapeHtml(c.key)+'" '+sel+'>'+escapeHtml(c.label)+'</option>';
      }
      colOptionsCache[ck] = html;
      return html;
    }

    function colOptionsHtmlMulti(cols, selectedKeys){
      var sk = Array.isArray(selectedKeys) ? selectedKeys.join(',') : String(selectedKeys||'');
      var ck = (cols?cols.length:0) + '|' + sk + '|multi';
      if(colOptionsCache[ck]) return colOptionsCache[ck];
      var set = Object.create(null);
      (selectedKeys||[]).forEach(function(k){ set[String(k)]=1; });
      var html='';
      for(var i=0;i<cols.length;i++){
        var c=cols[i];
        var sel = set[String(c.key)] ? 'selected' : '';
        html += '<option value="'+escapeHtml(c.key)+'" '+sel+'>'+escapeHtml(c.label)+'</option>';
      }
      colOptionsCache[ck] = html;
      return html;
    }

    // ---------------------------
    // Aggregations
    // Count = non-null count (as requested)
    // StdDev supports two variants: sample / population
    // ---------------------------
    var Agg = {
      none: { label:'null', needsNumeric:false },
      avg: { label:'Avg', needsNumeric:true },
      sum: { label:'Sum', needsNumeric:true },
      min: { label:'Min', needsNumeric:false },
      max: { label:'Max', needsNumeric:false },
      stddev_s: { label:'StdDev (Sample)', needsNumeric:true },
      stddev_p: { label:'StdDev (Population)', needsNumeric:true },
      count: { label:'Count (Non-null)', needsNumeric:false },
      countDistinct: { label:'CountDistinct (Non-null)', needsNumeric:false }
    };

    function aggOptionsHtml(selected){
      var html='';
      var keys = Object.keys(Agg);
      var sel = String(selected||'').trim();
      for(var i=0;i<keys.length;i++){
        var k = keys[i];
        var isSelected = (sel===k || (sel==='' && k==='none'));
        html += '<option value="'+k+'" '+(isSelected?'selected':'')+'>'+escapeHtml(Agg[k].label)+'</option>';
      }
      return html;
    }

    function computeAgg(aggKey, values){
      // values is array of raw values (may include null/empty)
      if(aggKey==='none') return values.length > 0 ? values[0] : null;
      var nonNull = [];
      for(var i=0;i<values.length;i++){
        var v = values[i];
        if(v==null || v==='') continue;
        nonNull.push(v);
      }
      if(aggKey==='count') return nonNull.length;
      if(aggKey==='countDistinct'){
        var set = Object.create(null);
        var c=0;
        for(var j=0;j<nonNull.length;j++){
          var key = String(nonNull[j]);
          if(!set[key]){ set[key]=1; c++; }
        }
        return c;
      }

      // numeric conversions
      var nums=[];
      for(var k=0;k<nonNull.length;k++){
        var n = toNumber(nonNull[k]);
        if(n!=null) nums.push(n);
      }
      if(!nums.length) return null;

      if(aggKey==='sum'){
        var s=0; for(var a=0;a<nums.length;a++) s+=nums[a];
        return s;
      }
      if(aggKey==='avg'){
        var ss=0; for(var b=0;b<nums.length;b++) ss+=nums[b];
        return ss/nums.length;
      }
      if(aggKey==='min'){
        var mn=nums[0]; for(var c2=1;c2<nums.length;c2++) if(nums[c2]<mn) mn=nums[c2];
        return mn;
      }
      if(aggKey==='max'){
        var mx=nums[0]; for(var d=1;d<nums.length;d++) if(nums[d]>mx) mx=nums[d];
        return mx;
      }
      if(aggKey==='stddev_s' || aggKey==='stddev_p'){
        var mean=0; for(var e=0;e<nums.length;e++) mean+=nums[e];
        mean/=nums.length;
        var v2=0; for(var f=0;f<nums.length;f++) v2+=Math.pow(nums[f]-mean,2);
        var denom = (aggKey==='stddev_s') ? Math.max(1, nums.length-1) : nums.length;
        return Math.sqrt(v2/denom);
      }
      return null;
    }

    function firstNonNullInRows(rows, colKey){
      rows = Array.isArray(rows) ? rows : [];
      for(var i=0;i<rows.length;i++){
        var v = rows[i] ? rows[i][colKey] : null;
        if(v==null || v==='') continue;
        return v;
      }
      return null;
    }

    function groupKey(row, keys){
      var parts=[];
      for(var i=0;i<keys.length;i++){
        parts.push(String(row[keys[i]]==null?'':row[keys[i]]));
      }
      return parts.join('\u001f');
    }

    // KDE (Kernel Density Estimation) - adapted from BoxPlot_v2
    function kde1d(vals, gridCount, minX, maxX){
      vals = (Array.isArray(vals) ? vals : []).filter(function(v){ return v!=null && isFinite(v); });
      if(!vals.length) return {x:[], y:[]};
      
      gridCount = gridCount || 100;
      if(!isFinite(minX)) minX = Math.min.apply(null, vals);
      if(!isFinite(maxX)) maxX = Math.max.apply(null, vals);
      
      if(minX >= maxX) return {x:[], y:[]};
      
      var range = maxX - minX;
      var h = range / (Math.pow(vals.length, 0.25) * 4);
      if(h < 1e-6) h = range * 0.01;
      
      var grid = [];
      var step = (maxX - minX) / (gridCount - 1);
      for(var i = 0; i < gridCount; i++){
        grid.push(minX + i * step);
      }
      
      var density = [];
      for(var j = 0; j < grid.length; j++){
        var x = grid[j];
        var sum = 0;
        for(var k = 0; k < vals.length; k++){
          var u = (x - vals[k]) / h;
          // Gaussian kernel
          sum += Math.exp(-0.5 * u * u);
        }
        density.push(sum / (vals.length * h * Math.sqrt(2 * Math.PI)));
      }
      
      return {x: grid, y: density};
    }

    function calculateQuartiles(vals){
      vals = (Array.isArray(vals) ? vals : []).filter(function(v){ return v!=null && isFinite(v); });
      if(!vals.length) return null;
      
      vals.sort(function(a,b){ return a - b; });
      var n = vals.length;
      var q1Idx = Math.floor((n - 1) * 0.25);
      var q2Idx = Math.floor((n - 1) * 0.5);
      var q3Idx = Math.floor((n - 1) * 0.75);
      
      return {
        min: vals[0],
        q1: vals[q1Idx],
        median: vals[q2Idx],
        q3: vals[q3Idx],
        max: vals[n - 1],
        mean: vals.reduce(function(a,b){ return a + b; }, 0) / n
      };
    }

    function aggregateRows(rows, transform, extraCols){
      // transform: {mode:'raw'|'aggregate', groupBy:[colKey], measures:[{colKey, agg, asKey}]}
      if(!transform || transform.mode!=='aggregate') return rows;
      var gb = Array.isArray(transform.groupBy) ? transform.groupBy.filter(Boolean) : [];
      var measures = Array.isArray(transform.measures) ? transform.measures : [];
      if(!gb.length || !measures.length) return rows;

      var map = Object.create(null);
      var order = [];
      for(var i=0;i<rows.length;i++){
        var r = rows[i];
        var k = groupKey(r, gb);
        var bucket = map[k];
        if(!bucket){
          bucket = { __rows: [], __first: r };
          map[k]=bucket;
          order.push(k);
        }
        bucket.__rows.push(r);
      }

      var out=[];
      for(var oi=0;oi<order.length;oi++){
        var kk = order[oi];
        var b = map[kk];
        var base = {};
        // group-by fields from first row
        for(var g=0;g<gb.length;g++) base[gb[g]] = b.__first[gb[g]];
        // measures
        for(var m=0;m<measures.length;m++){
          var ms = measures[m]||{};
          var col = ms.colKey;
          var aggKey = ms.agg || 'sum';
          var outKey = ms.asKey || (col + '|' + aggKey);
          var vals=[];
          for(var ri=0;ri<b.__rows.length;ri++) vals.push(b.__rows[ri][col]);
          base[outKey] = computeAgg(aggKey, vals);
        }

        // extra columns: carry a representative value per group (for hover tooltips, etc.)
        if(Array.isArray(extraCols) && extraCols.length){
          for(var xc=0;xc<extraCols.length;xc++){
            var xcol = extraCols[xc];
            if(!xcol) continue;
            if(base.hasOwnProperty(xcol)) continue;
            if(gb.indexOf(xcol)>=0) continue;
            base[xcol] = firstNonNullInRows(b.__rows, xcol);
          }
        }
        out.push(base);
      }
      return out;
    }

    // ---------------------------
    // Filtering (per visual)
    // v.filter: { logic:'and'|'or', clauses:[{colKey,op,value,value2}] }
    // ---------------------------
    var FilterOps = [
      {key:'eq', label:'='},
      {key:'neq', label:'!='},
      {key:'gt', label:'>'},
      {key:'gte', label:'>='},
      {key:'lt', label:'<'},
      {key:'lte', label:'<='},
      {key:'contains', label:'contains'},
      {key:'starts', label:'starts with'},
      {key:'between', label:'between'},
      {key:'isnull', label:'is null'},
      {key:'notnull', label:'is not null'},
      {key:'rank', label:'rank (top N)'},
      {key:'rankBottom', label:'rank (bottom N)'}
    ];

    function evalClause(row, clause){
      if(!clause || !clause.colKey) return true;
      var op = clause.op || 'eq';
      var v = row[clause.colKey];
      var s = (v==null)?'':String(v);
      var n = toNumber(v);

      if(op==='isnull') return (v==null || v==='');
      if(op==='notnull') return !(v==null || v==='');

      var val = clause.value;
      var val2 = clause.value2;
      var sval = (val==null)?'':String(val);
      var sval2 = (val2==null)?'':String(val2);
      var nval = toNumber(val);
      var nval2 = toNumber(val2);

      if(op==='contains') return s.toLowerCase().indexOf(sval.toLowerCase())>=0;
      if(op==='starts') return s.toLowerCase().indexOf(sval.toLowerCase())===0;

      // numeric comparisons when both parse
      var canNum = (n!=null && nval!=null);
      if(op==='between'){
        if(canNum && nval2!=null){
          var lo = Math.min(nval,nval2), hi=Math.max(nval,nval2);
          return n>=lo && n<=hi;
        }
        // string between
        var loS = sval, hiS=sval2;
        if(loS>hiS){ var tmp=loS; loS=hiS; hiS=tmp; }
        return s>=loS && s<=hiS;
      }

      if(op==='eq') return canNum ? (n===nval) : (s===sval);
      if(op==='neq') return canNum ? (n!==nval) : (s!==sval);
      if(op==='gt') return canNum ? (n>nval) : (s>sval);
      if(op==='gte') return canNum ? (n>=nval) : (s>=sval);
      if(op==='lt') return canNum ? (n<nval) : (s<sval);
      if(op==='lte') return canNum ? (n<=nval) : (s<=sval);
      return true;
    }

    function applyFilter(rows, filter){
      if(!filter || !Array.isArray(filter.clauses) || !filter.clauses.length) return rows;
      var logic = (filter.logic==='or') ? 'or' : 'and';
      var clauses = filter.clauses.filter(function(c){ return c && c.colKey && c.op; });
      if(!clauses.length) return rows;
      
      // Separate rank clauses from other clauses
      var rankClauses = clauses.filter(function(c){ return c.op === 'rank' || c.op === 'rankBottom'; });
      var normalClauses = clauses.filter(function(c){ return c.op !== 'rank' && c.op !== 'rankBottom'; });
      
      // First apply normal filter clauses
      var out=[];
      if(normalClauses.length > 0){
        for(var i=0;i<rows.length;i++){
          var r = rows[i];
          var pass = (logic==='and');
          for(var c=0;c<normalClauses.length;c++){
            var ok = evalClause(r, normalClauses[c]);
            if(logic==='and') pass = pass && ok;
            else pass = pass || ok;
          }
          if(pass) out.push(r);
        }
      } else {
        out = rows.slice(); // copy all rows if no normal clauses
      }
      
      // Then apply rank clauses (top N or bottom N by column value)
      for(var ri=0;ri<rankClauses.length;ri++){
        var rc = rankClauses[ri];
        var colKey = rc.colKey;
        var n = parseInt(rc.value, 10);
        if(!isFinite(n) || n <= 0) continue;
        
        var isBottom = (rc.op === 'rankBottom');
        
        // Sort by column
        var sorted = out.slice().sort(function(a, b){
          var av = toNumber(a[colKey]);
          var bv = toNumber(b[colKey]);
          if(av == null && bv == null) return 0;
          if(av == null) return 1;  // nulls last
          if(bv == null) return -1;
          // For bottom N, sort ascending; for top N, sort descending
          return isBottom ? (av - bv) : (bv - av);
        });
        
        // Take top/bottom N
        out = sorted.slice(0, n);
      }
      
      return out;
    }

    /* ---------------------------
     * Conditional Formatting Evaluator
     * Supports operators: gt, gte, lt, lte, eq, neq, between,
     *   contains, notcontains, startswith, endswith, isblank, notblank
     * Returns {bg, fg} of first matching rule, or null.
     * --------------------------- */
    function vmEvalCFRule(rule, value){
      if(!rule || !rule.op) return false;
      var op = String(rule.op);
      // isblank / notblank don't need val1
      if(op==='isblank') return (value==null || String(value).trim()==='');
      if(op==='notblank') return (value!=null && String(value).trim()!=='');
      var sVal = String(value!=null?value:'').toLowerCase();
      var sV1 = String(rule.val1!=null?rule.val1:'').toLowerCase();
      if(op==='contains') return sVal.indexOf(sV1)>=0;
      if(op==='notcontains') return sVal.indexOf(sV1)<0;
      if(op==='startswith') return sVal.indexOf(sV1)===0;
      if(op==='endswith') return sVal.length>=sV1.length && sVal.substring(sVal.length-sV1.length)===sV1;
      // numeric operators
      var nVal = parseFloat(value);
      var nV1 = parseFloat(rule.val1);
      if(!isFinite(nVal)) return false;
      if(op==='eq') return nVal===nV1;
      if(op==='neq') return nVal!==nV1;
      if(!isFinite(nV1)) return false;
      if(op==='gt') return nVal>nV1;
      if(op==='gte') return nVal>=nV1;
      if(op==='lt') return nVal<nV1;
      if(op==='lte') return nVal<=nV1;
      if(op==='between'){
        var nV2 = parseFloat(rule.val2);
        return isFinite(nV2) && nVal>=nV1 && nVal<=nV2;
      }
      return false;
    }

    /**
     * Evaluate CF rules for a single data point.
     * @param {Array} cfRules - array of {col, op, val1, val2, bg, fg, icon1, icon2, applyTo}
     * @param {Object} row - the data row
     * @param {string} [targetCol] - optional: only match rules for this column
     * @returns {Object|null} {bg, fg, icon1, icon2, applyTo} of first matching rule, or null
     */
    function vmEvalCF(cfRules, row, targetCol){
      if(!cfRules || !cfRules.length || !row) return null;
      for(var i=0;i<cfRules.length;i++){
        var rule = cfRules[i];
        if(!rule || !rule.col) continue;
        if(targetCol && rule.col !== targetCol) continue;
        var cellVal = row[rule.col];
        if(vmEvalCFRule(rule, cellVal)){
          return {bg: rule.bg||'#fca5a5', fg: rule.fg||'#111827', icon1: rule.icon1||'', icon2: rule.icon2||'', applyTo: rule.applyTo||'cell'};
        }
      }
      return null;
    }

    /**
     * Build per-point color arrays for Plotly traces based on CF rules.
     * @param {Array} cfRules
     * @param {Array} rows - data rows
     * @param {string} defaultColor - fallback color
     * @returns {Array} array of color strings per data point
     */
    function vmBuildCFColors(cfRules, rows, defaultColor){
      var colors = [];
      for(var i=0;i<rows.length;i++){
        var match = vmEvalCF(cfRules, rows[i]);
        colors.push(match ? match.bg : (defaultColor||''));
      }
      return colors;
    }

    // ---------------------------
    // Visual registry
    // Each type provides:
    // - label
    // - implemented
    // - defaultVisual()
    // - buildMappingUI(visual, ctx)
    // - buildOptionsUI(visual, ctx)
    // - render(visual, rows, ctx, targetEl)
    // ---------------------------

    function renderEmptyWithModebar(el, message, vObj){
      /* Render container with message + Plotly chart to always show modebar */
      el.innerHTML = '';
      
      /* Container for empty message */
      var msg = document.createElement('div');
      msg.className = 'empty';
      msg.textContent = message || 'Configure mapping';
      msg.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:1;';
      el.appendChild(msg);
      
      /* Create Plotly chart - positioned to fill container  */
      var plotDiv = document.createElement('div');
      plotDiv.className = 'js-plotly-plot';
      plotDiv.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;';
      el.style.position = 'relative';  /* Ensure relative positioning for children */
      el.appendChild(plotDiv);
      
      /* Ensure min height for rendering */
      if(!el.style.minHeight || el.style.minHeight === '') {
        el.style.minHeight = '200px';
      }
      
      /* Render Plotly chart */
      try{
        var layout = {
          margin: {l:50, r:50, t:40, b:50},
          showlegend: false,
          plot_bgcolor: 'transparent',
          paper_bgcolor: 'transparent',
          font: {size:11},
          xaxis: {showticklabels:false, showgrid:false, zeroline:false},
          yaxis: {showticklabels:false, showgrid:false, zeroline:false}
        };
        
        var config = plotlyCfg(vObj);
        config.displayModeBar = false;
        config.displaylogo = false;
        config.responsive = true;
        
        /* Create chart with minimal data to ensure modebar renders */
        var data = [{
          type: 'scatter',
          mode: 'markers',
          x: [0],
          y: [0],
          marker: {size: 0, opacity: 0},
          showlegend: false,
          hoverinfo: 'none'
        }];
        
        Plotly.newPlot(plotDiv, data, layout, config);
      }catch(e){
        /* Silent fail - message will still display */
      }
    }

    function defaultFilter(){
      return { logic:'and', clauses:[] };
    }

    function defaultTransform(mode){
      return { mode: mode||'raw', groupBy:[], measures:[] };
    }

    var Registry = Object.create(null);

    function reg(type, def){ Registry[type]=def; }

    // Common mapping helpers
    function mappingField(label, keyName, cols, selectedKey, allowBlank){
      return ''
        + '<div class="lbl">'+escapeHtml(label)+'</div>'
        + '<div><select data-map="'+escapeHtml(keyName)+'">'
        + colOptionsHtml(cols, selectedKey, !!allowBlank)
        + '</select></div>';
    }

    function hoverColsField(v, cols){
      v.mapping = v.mapping || {};
      v.mapping.hoverCols = Array.isArray(v.mapping.hoverCols) ? v.mapping.hoverCols : [];
      return mappingFieldMulti('Extra hover columns', 'hoverCols', cols, v.mapping.hoverCols, false, 
        'Adds these columns to hover tooltips. In Aggregated mode, values use the first non-null per group (not added to group-by).');
    }

    function mappingFieldMulti(label, keyName, cols, selectedKeys, allowBlank, note){
      selectedKeys = Array.isArray(selectedKeys) ? selectedKeys : (selectedKeys ? [selectedKeys] : []);
      var selectedSet = {};
      for(var i=0; i<selectedKeys.length; i++){
        selectedSet[selectedKeys[i]] = true;
      }
      var html = '';
      html += '<div class="lbl">'+escapeHtml(label)+'</div>';
      html += '<div>';
      
      // Selected items summary (badges) - always create container for dynamic updates
      var badgeStyle = selectedKeys.length > 0 ? 'display:flex;' : 'display:none;';
      html += '<div style="'+badgeStyle+'flex-wrap:wrap;gap:4px;margin-bottom:6px;padding:6px;border:1px solid var(--vm-border);border-radius:8px;background:rgba(125,211,252,.06);min-height:32px">';
      if(selectedKeys.length > 0){
        for(var si=0; si<selectedKeys.length; si++){
          var sk = selectedKeys[si];
          var sLabel = sk;
          for(var ci=0; ci<cols.length; ci++){
            if(cols[ci].key === sk){ sLabel = cols[ci].label; break; }
          }
          html += '<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.3);border-radius:6px;font-size:11px;font-weight:600;color:var(--vm-text)">';
          html += '✓ '+escapeHtml(sLabel);
          html += '</span>';
        }
      }
      html += '</div>';
      
      // Scrollable checkbox list
      html += '<div style="border:1px solid var(--vm-border);border-radius:8px;padding:6px;max-height:180px;overflow-y:auto;background:var(--vm-input)">';
      if(allowBlank){
        html += '<label style="display:flex;align-items:center;gap:6px;padding:4px;cursor:pointer;border-radius:4px;font-size:12px" class="vm-cb-label">';
        html += '<input type="checkbox" data-map-multi="'+escapeHtml(keyName)+'" value="" style="margin:0;width:16px;height:16px"> <span>(none)</span>';
        html += '</label>';
      }
      for(var j=0; j<cols.length; j++){
        var c = cols[j];
        var isChecked = selectedSet[c.key] ? 'checked' : '';
        html += '<label style="display:flex;align-items:center;gap:6px;padding:4px;cursor:pointer;border-radius:4px;font-size:12px" class="vm-cb-label">';
        html += '<input type="checkbox" data-map-multi="'+escapeHtml(keyName)+'" value="'+escapeHtml(c.key)+'" '+isChecked+' style="margin:0;width:16px;height:16px">';
        html += '<span style="font-weight:'+(selectedSet[c.key]?'600':'400')+'">'+escapeHtml(c.label)+'</span>';
        html += '</label>';
      }
      html += '</div>';
      if(note) html += '<div class="note" style="margin-top:6px">'+note+'</div>';
      html += '</div>';
      return html;
    }

    function measureField(label, keyName, cols, measure){
      var colKey = measure && measure.colKey ? measure.colKey : '';
      var agg = (measure && measure.agg) ? String(measure.agg) : 'none';
      if(!agg || agg.trim() === '') agg = 'none';
      var dec = (measure && measure.decimals != null) ? measure.decimals : '';
      var clr = (measure && measure.color) ? measure.color : '';
      var ncols = (cols||[]).filter(function(c){ return c && c.kind==='number'; });
      if(!ncols.length) ncols = cols || [];
      return ''
        + '<div class="lbl">'+escapeHtml(label)+'</div>'
        + '<div class="row">'
        + '<select data-measure="'+escapeHtml(keyName)+'" data-part="col" style="min-width:220px">'
        + colOptionsHtml(ncols, colKey, true)
        + '</select>'
        + '<select data-measure="'+escapeHtml(keyName)+'" data-part="agg" style="min-width:190px">'
        + aggOptionsHtml(agg)
        + '</select>'
        + '<input data-measure="'+escapeHtml(keyName)+'" data-part="dec" type="number" min="" max="10" step="1" value="'+escapeHtml(String(dec))+'" placeholder="Dec" title="Decimal places (blank = auto)" style="width:58px" />'
        + '<input data-measure="'+escapeHtml(keyName)+'" data-part="color" type="color" value="'+(clr||'#000000')+'" title="Series Color (optional)" style="width:32px;height:28px;padding:0;cursor:pointer;border:1px solid var(--vm-border);border-radius:4px;margin-left:4px;background:none" />'
        + '</div>';
    }

    function ensureMeasure(v, key){
      v.measures = v.measures || {};
      v.measures[key] = v.measures[key] || { colKey:'', agg:'none' };
      return v.measures[key];
    }

    // Starter visuals
    reg('line', {
      label:'Line (Trend)',
      category:'Trends & Distribution',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'line',
          title:'Line',
          show:true,
          mapping:{ x:[], series:[] },
          measures:{ y:{ colKey:'', agg:'none' }, y2:{ colKey:'', agg:'none' }, y3:{ colKey:'', agg:'none' }, y4:{ colKey:'', agg:'none' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{ style:'line', mode:'lines+markers', shape:'spline', dash:'solid', hovermode:'closest', connectgaps:false, xScrollbar:false, maxPoints:1500, perMeasureModes:false, style_y:'', style_y3:'', style_y4:'', trellisOn:false, trellisCols:3, statsMode:'none', includeOutliers:false }
        };
      },
      buildMappingUI:function(v, ctx){
        var cols = ctx.cols;
        ensureMeasure(v,'y');
        ensureMeasure(v,'y2');
        ensureMeasure(v,'y3');
        ensureMeasure(v,'y4');
        v.mapping = v.mapping || {};
        v.mapping.x = Array.isArray(v.mapping.x) ? v.mapping.x : (v.mapping.x ? [v.mapping.x] : []);
        v.mapping.series = Array.isArray(v.mapping.series) ? v.mapping.series : (v.mapping.series ? [v.mapping.series] : []);
        return ''
          + '<div class="form">'
          + mappingFieldMulti('X (category/date)', 'x', cols, v.mapping.x, true, 'Select one or more columns. Multiple columns are combined as a composite key.')
          + mappingFieldMulti('Series (color split)', 'series', cols, v.mapping.series, true, 'Optional. Splits data into separate traces by unique values.')
          + hoverColsField(v, cols)
          + measureField('Y (measure)', 'y', cols, v.measures.y)
          + measureField('Y2 (optional measure)', 'y2', cols, v.measures.y2)
          + measureField('Y3 (optional overlay)', 'y3', cols, v.measures.y3)
          + measureField('Y4 (optional overlay)', 'y4', cols, v.measures.y4)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return ''
          + '<div class="form">'
          + '<div class="lbl">Style</div>'
          + '<div><select data-opt="style">'
          + '<option value="line" '+((v.options.style||'line')==='line'?'selected':'')+'>Line</option>'
          + '<option value="area" '+((v.options.style||'line')==='area'?'selected':'')+'>Area</option>'
          + '<option value="bar" '+((v.options.style||'line')==='bar'?'selected':'')+'>Bar</option>'
          + '</select></div>'
          + '<div class="lbl">Per-measure modes</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="perMeasureModes" '+(v.options.perMeasureModes?'checked':'')+'> Enable per-measure style overrides (Y/Y3/Y4)</label></div>'
          + '<div class="lbl">Y style override</div>'
          + '<div><select data-opt="style_y">'
          + '<option value="" '+((v.options.style_y||'')===''?'selected':'')+'>Inherit</option>'
          + '<option value="line" '+((v.options.style_y||'')==='line'?'selected':'')+'>Line</option>'
          + '<option value="area" '+((v.options.style_y||'')==='area'?'selected':'')+'>Area</option>'
          + '<option value="bar" '+((v.options.style_y||'')==='bar'?'selected':'')+'>Bar</option>'
          + '</select></div>'
          + '<div class="lbl">Y3 style override</div>'
          + '<div><select data-opt="style_y3">'
          + '<option value="" '+((v.options.style_y3||'')===''?'selected':'')+'>Inherit</option>'
          + '<option value="line" '+((v.options.style_y3||'')==='line'?'selected':'')+'>Line</option>'
          + '<option value="area" '+((v.options.style_y3||'')==='area'?'selected':'')+'>Area</option>'
          + '<option value="bar" '+((v.options.style_y3||'')==='bar'?'selected':'')+'>Bar</option>'
          + '</select></div>'
          + '<div class="lbl">Y4 style override</div>'
          + '<div><select data-opt="style_y4">'
          + '<option value="" '+((v.options.style_y4||'')===''?'selected':'')+'>Inherit</option>'
          + '<option value="line" '+((v.options.style_y4||'')==='line'?'selected':'')+'>Line</option>'
          + '<option value="area" '+((v.options.style_y4||'')==='area'?'selected':'')+'>Area</option>'
          + '<option value="bar" '+((v.options.style_y4||'')==='bar'?'selected':'')+'>Bar</option>'
          + '</select></div>'
          + '<div class="lbl">Hover</div>'
          + '<div><select data-opt="hovermode">'
          + '<option value="closest" '+((v.options.hovermode||'closest')==='closest'?'selected':'')+'>Focused (closest)</option>'
          + '<option value="x" '+((v.options.hovermode||'closest')==='x'?'selected':'')+'>Compare (x)</option>'
          + '<option value="x unified" '+((v.options.hovermode||'closest')==='x unified'?'selected':'')+'>Unified (x)</option>'
          + '</select></div>'
          + '<div class="lbl">Trace mode</div>'
          + '<div><select data-opt="mode">'
          + '<option value="lines" '+(v.options.mode==='lines'?'selected':'')+'>Lines</option>'
          + '<option value="markers" '+(v.options.mode==='markers'?'selected':'')+'>Markers</option>'
          + '<option value="lines+markers" '+(v.options.mode==='lines+markers'?'selected':'')+'>Lines + markers</option>'
          + '</select></div>'
          + '<div class="lbl">Line shape</div>'
          + '<div><select data-opt="shape">'
          + '<option value="linear" '+((v.options.shape||'spline')==='linear'?'selected':'')+'>Straight</option>'
          + '<option value="spline" '+((v.options.shape||'spline')==='spline'?'selected':'')+'>Curved</option>'
          + '</select></div>'
          + '<div class="lbl">Dash</div>'
          + '<div><select data-opt="dash">'
          + '<option value="solid" '+((v.options.dash||'solid')==='solid'?'selected':'')+'>Solid</option>'
          + '<option value="dash" '+((v.options.dash||'solid')==='dash'?'selected':'')+'>Dash</option>'
          + '<option value="dot" '+((v.options.dash||'solid')==='dot'?'selected':'')+'>Dot</option>'
          + '<option value="dashdot" '+((v.options.dash||'solid')==='dashdot'?'selected':'')+'>DashDot</option>'
          + '</select></div>'
          + '<div class="lbl">Gaps</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="connectgaps" '+(v.options.connectgaps?'checked':'')+'> Connect gaps</label></div>'
          + '<div class="lbl">X scrollbar</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="xScrollbar" '+(v.options.xScrollbar?'checked':'')+'> Show range slider</label></div>'
          + '<div class="lbl">Downsample (raw)</div>'
          + '<div class="row">'
          + '<input data-opt="maxPoints" type="number" min="200" max="50000" step="100" value="'+escapeHtml(String(v.options.maxPoints||1500))+'" style="width:140px" />'
          + '<span class="note">Max points per trace in Raw mode</span>'
          + '</div>'
          + '<div class="lbl">Trellis Mode</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="trellisOn" '+(v.options.trellisOn?'checked':'')+'> Enable faceted subplots</label></div>'
          + '<div class="lbl">Trellis Columns</div>'
          + '<div><select data-opt="trellisCols" style="min-width:140px">'
          + '<option value="1" '+(String(v.options.trellisCols||3)==='1'?'selected':'')+'>1 column</option>'
          + '<option value="2" '+(String(v.options.trellisCols||3)==='2'?'selected':'')+'>2 columns</option>'
          + '<option value="3" '+(String(v.options.trellisCols||3)==='3'?'selected':'')+'>3 columns</option>'
          + '<option value="4" '+(String(v.options.trellisCols||3)==='4'?'selected':'')+'>4 columns</option>'
          + '</select></div>'
          + '<div class="lbl">Statistics Overlay</div>'
          + '<div><select data-opt="statsMode" style="min-width:140px">'
          + '<option value="none" '+(String(v.options.statsMode||'none')==='none'?'selected':'')+'>null</option>'
          + '<option value="quartiles" '+(String(v.options.statsMode||'none')==='quartiles'?'selected':'')+'>Quartiles</option>'
          + '<option value="kde" '+(String(v.options.statsMode||'none')==='kde'?'selected':'')+'>KDE (density)</option>'
          + '</select></div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var map = v.mapping||{};
        var xKeys = Array.isArray(map.x) ? map.x.filter(function(k){return !!k;}) : (map.x ? [map.x] : []);
        var xKey = xKeys.length === 1 ? xKeys[0] : (xKeys.length > 0 ? '__xComposite' : '');
        var yM = (v.measures||{}).y || {colKey:'',agg:'sum'};
        var y2M = (v.measures||{}).y2 || {colKey:'',agg:'sum'};
        var y3M = (v.measures||{}).y3 || {colKey:'',agg:'sum'};
        var y4M = (v.measures||{}).y4 || {colKey:'',agg:'sum'};
        var hasY2 = !!(y2M && y2M.colKey);
        var hasY3 = !!(y3M && y3M.colKey);
        var hasY4 = !!(y4M && y4M.colKey);
        if(!xKeys.length || !yM.colKey){
          renderEmptyWithModebar(el, 'Map X and Y to render this visual.', v);
          return;
        }

        var filtered = applyFilter(rows, v.filter);
        var seriesArr = Array.isArray(map.series) ? map.series.filter(function(k){return !!k;}) : (map.series ? [map.series] : []);
        var seriesKeys = seriesArr;
        var seriesKey = seriesArr.length === 1 ? seriesArr[0] : (seriesArr.length > 0 ? '__seriesComposite' : '');

        var hoverKeys = Array.isArray(map.hoverCols) ? map.hoverCols.filter(function(k){return !!k;}) : [];
        var useHover = (hoverKeys.length>0);
        var hoverTemplate = null;
        if(useHover){
          var ht='X: %{x}<br>Value: %{y}';
          for(var hk=0;hk<hoverKeys.length;hk++) ht += '<br>'+escapeHtml(hoverKeys[hk])+': %{customdata['+hk+']}';
          ht += '<extra></extra>';
          hoverTemplate = ht;
        }

        var t = v.transform || {mode:'aggregate'};
        var groupBy = [];
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) groupBy.push(ctx.sections.splitCol);
        if(xKeys.length > 1){
          for(var xi=0;xi<xKeys.length;xi++) groupBy.push(xKeys[xi]);
        } else if(xKey) {
          groupBy.push(xKey);
        }
        if(seriesArr.length > 1){
          for(var si=0;si<seriesArr.length;si++) groupBy.push(seriesArr[si]);
        } else if(seriesKey) {
          groupBy.push(seriesKey);
        }

        var measures = [{ colKey: yM.colKey, agg: yM.agg, asKey:'__y' }];
        if(hasY2) measures.push({ colKey: y2M.colKey, agg: y2M.agg, asKey:'__y2' });
        if(hasY3) measures.push({ colKey: y3M.colKey, agg: y3M.agg, asKey:'__y3' });
        if(hasY4) measures.push({ colKey: y4M.colKey, agg: y4M.agg, asKey:'__y4' });
        var dataRows = (t.mode==='aggregate') ? aggregateRows(filtered, {mode:'aggregate', groupBy:groupBy, measures:measures}, hoverKeys) : filtered;

        // Create composite keys if multiple columns selected
        if(xKeys.length > 1){
          for(var ri=0;ri<dataRows.length;ri++){
            var parts = [];
            for(var xki=0;xki<xKeys.length;xki++) parts.push(asString(dataRows[ri][xKeys[xki]]));
            dataRows[ri].__xComposite = parts.join(' | ');
          }
        }
        if(seriesArr.length > 1){
          for(var ri2=0;ri2<dataRows.length;ri2++){
            var sparts = [];
            for(var ski=0;ski<seriesArr.length;ski++) sparts.push(asString(dataRows[ri2][seriesArr[ski]]));
            dataRows[ri2].__seriesComposite = sparts.join(' \u2022 ');
          }
        }

        // Optional sort (x or y)
        var sortKey = (v.transform.mode==='aggregate') ? '__y' : yM.colKey;
        if(v.options && v.options.sortBy){
          dataRows = vmSortRows(dataRows, v.options.sortBy, v.options.sortDir, xKey, sortKey);
        }

        // --- Remove-point filtering (per-visual state) ---
        if(v.options && Array.isArray(v.options.removedPoints) && v.options.removedPoints.length){
           var rmSet = new Set(v.options.removedPoints);
           var keyCols = {x:xKey, y:(t.mode==='aggregate'?'__y':yM.colKey), s:seriesKey || '__series'};
           dataRows = dataRows.filter(function(r){
             var kx = r[keyCols.x];
             var ky = r[keyCols.y];
             var ks = seriesKey ? asString(r[seriesKey]) : '';
             var key = JSON.stringify([kx, ky, ks || 0]);
             return !rmSet.has(key);
           });
        }

        // --- Outlier Removal Logic ---
        if(v.options && v.options.excludeOutliers && dataRows.length > 4){
           try{
             var ys = [];
             var key = (t.mode==='aggregate') ? '__y' : yM.colKey;
             for(var i=0;i<dataRows.length;i++){
               var val = Number(dataRows[i][key]);
               if(isFinite(val)) ys.push(val);
             }
             if(ys.length > 4){
               ys.sort(function(a,b){return a-b;});
               var q1 = ys[Math.floor(ys.length*0.25)];
               var q3 = ys[Math.floor(ys.length*0.75)];
               var iqr = q3-q1;
               var min = q1 - 1.5*iqr;
               var max = q3 + 1.5*iqr;
               // Filter rows
               var initialLen = dataRows.length;
               dataRows = dataRows.filter(function(r){
                 var val = Number(r[key]);
                 // Keep nulls/NaNs (gaps), filter out finite values outside bounds
                 if(!isFinite(val)) return true;
                 return (val >= min && val <= max);
               });
               console.log('[VM] Outlier removal: filtered', initialLen, 'to', dataRows.length, 'rows (Bounds:', min, max, ')');
             }
           }catch(e){ console.error('Outlier filter error:',e); }
        }

        // Optional sort (x or y)
        var sortKey = (t.mode==='aggregate') ? '__y' : yM.colKey;
        if(v.options && v.options.sortBy){
          dataRows = vmSortRows(dataRows, v.options.sortBy, v.options.sortDir, xKey, sortKey);
        }

        var maxPts = clamp(parseInt((v.options||{}).maxPoints||1500,10)||1500, 200, 50000);
        function downsampleXY(xs, ys, cds){
          if(!xs || xs.length<=maxPts) return {x:xs,y:ys,cd:cds};
          var step = Math.ceil(xs.length / maxPts);
          var dx=[], dy=[], dc=[];
          for(var ii=0;ii<xs.length;ii+=step){
            dx.push(xs[ii]);
            dy.push(ys[ii]);
            if(cds) dc.push(cds[ii]);
          }
          return {x:dx,y:dy,cd:dc};
        }

        // Build traces
        var bySeries = Object.create(null);
        for(var i=0;i<dataRows.length;i++){
          var r = dataRows[i];
          var s = seriesKey ? asString(r[seriesKey]) : 'Series';
          if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
            s = asString(r[ctx.sections.splitCol]) + (seriesKey?(' � '+s):'');
          }
          var bucket = (bySeries[s] = bySeries[s] || { x:[], m:{y:[],y2:[],y3:[],y4:[]}, cd:[] });
          bucket.x.push(r[xKey]);
          var yVal = (t.mode==='aggregate') ? r.__y : r[yM.colKey];
          bucket.m.y.push(toNumber(yVal));
          if(hasY2){
            var y2Val = (t.mode==='aggregate') ? r.__y2 : r[y2M.colKey];
            bucket.m.y2.push(toNumber(y2Val));
          }
          if(hasY3){
            var y3Val = (t.mode==='aggregate') ? r.__y3 : r[y3M.colKey];
            bucket.m.y3.push(toNumber(y3Val));
          }
          if(hasY4){
            var y4Val = (t.mode==='aggregate') ? r.__y4 : r[y4M.colKey];
            bucket.m.y4.push(toNumber(y4Val));
          }
          if(useHover){
            var cd=[];
            for(var h=0;h<hoverKeys.length;h++) cd.push(r[hoverKeys[h]]);
            bucket.cd.push(cd);
          }
        }

        var traces=[];
        var globalStyle = (v.options && v.options.style) ? String(v.options.style) : 'line';
        var perMeas = !!(v.options && v.options.perMeasureModes);
        var pointsMode = (v.options && v.options.pointsMode) ? String(v.options.pointsMode) : 'auto';
        var labelsOn = !!(v.options && v.options.labelsOn);
        var gapMode = (v.options && v.options.gapMode) ? String(v.options.gapMode) : 'break';
        
        console.log('[VM] Line render - pointsMode:', pointsMode, 'labelsOn:', labelsOn, 'gapMode:', gapMode);
        function styleFor(measureKey){
          if(!perMeas) return globalStyle;
          if(measureKey==='y') return String((v.options && v.options.style_y) || '') || globalStyle;
          if(measureKey==='y3') return String((v.options && v.options.style_y3) || '') || globalStyle;
          if(measureKey==='y4') return String((v.options && v.options.style_y4) || '') || globalStyle;
          return globalStyle;
        }

        var anyBar = false;
        var showMeasureInName = (hasY2 || hasY3 || hasY4);
        var palette = vmGetPalette(v);
        var palIdx = 0;

        Object.keys(bySeries).forEach(function(seriesName){
          var base = bySeries[seriesName];
          var baseX = base.x;
          var baseCd = useHover ? base.cd : null;

          function pushTrace(measureKey, label, ys, axis){
            var palColor = palette.length ? palette[palIdx % palette.length] : null;
            palIdx++;
            var xs = baseX;
            var cds = baseCd;
            if(t.mode==='raw'){
              var ds = downsampleXY(xs, ys, cds);
              xs = ds.x; ys = ds.y; cds = ds.cd;
            }
            var st = styleFor(measureKey);
            var tr=null;
            if(st==='bar'){
              anyBar = true;
              tr={type:'bar', name:label, x:xs, y:ys};
            }else{
              // Determine mode based on pointsMode option
              var mode = v.options.mode || 'lines+markers';
              if(pointsMode==='none') mode = 'lines';
              else if(pointsMode==='all') mode = 'lines+markers';
              // pointsMode==='auto' keeps the original mode
              
              tr={
                type:'scatter',
                mode: mode,
                name:label,
                x: xs,
                y: ys,
                connectgaps: (gapMode==='connect' || gapMode==='interp'),
                line:{ shape: (v.options.shape||'spline'), dash: (v.options.dash||'solid') }
              };
              if(st==='area') tr.fill = 'tozeroy';
              
              // Add text labels if enabled
              if(labelsOn && (mode.indexOf('markers')>=0)){
                tr.text = ys.map(function(y){ return vmFormatLabel(y, v.options); });
                var cfOp = v.options.labelCfOp;
                var cfVal = v.options.labelCfVal;
                var cfColor = v.options.labelCfColor || '#ef4444';
                if(cfOp && cfVal!=='' && cfVal!=null){
                  tr.textfont = {size:10, color: ys.map(function(y){ return vmPassThreshold(y, cfOp, cfVal) ? cfColor : (v.options.labelColor || '#111827'); })};
                } else {
                  tr.textfont = {size:10};
                }
                tr.textposition = 'top center';
              }
            }
            if(axis==='y2'){
              tr.yaxis = 'y2';
              if(tr.type==='scatter') tr.line.dash = 'dot';
            }
            // Build per-trace hovertemplate with decimal formatting
            var mObj = v.measures[measureKey] || {};
            
            /* Apply color if set */
            if(mObj.color){
              tr.marker = tr.marker || {};
              tr.marker.color = mObj.color;
              if(tr.line){ tr.line = tr.line || {}; tr.line.color = mObj.color; }
            } else if(palColor){
              tr.marker = tr.marker || {};
              tr.marker.color = palColor;
              if(tr.line){ tr.line = tr.line || {}; tr.line.color = palColor; }
            }

            var dec = mObj.decimals;
            var yFmt = (dec != null && isFinite(dec)) ? ('%{y:,.'+dec+'f}') : '%{y}';
            var trHt = 'X: %{x}<br>'+escapeHtml(mObj.colKey||measureKey)+': '+yFmt;
            if(useHover){
              for(var hk=0;hk<hoverKeys.length;hk++) trHt += '<br>'+escapeHtml(hoverKeys[hk])+': %{customdata['+hk+']}';
              tr.customdata = cds;
            }
            trHt += '<extra></extra>';
            tr.hovertemplate = trHt;
            traces.push(tr);
          }

          pushTrace('y', showMeasureInName ? (seriesName + ' � ' + (yM.colKey||'Y')) : seriesName, base.m.y, 'y');
          if(hasY3) pushTrace('y3', seriesName + ' � ' + (y3M.colKey||'Y3'), base.m.y3, 'y');
          if(hasY4) pushTrace('y4', seriesName + ' � ' + (y4M.colKey||'Y4'), base.m.y4, 'y');
          if(hasY2) pushTrace('y2', seriesName + ' � ' + (y2M.colKey||'Y2'), base.m.y2, 'y2');
        });

        var layout = layoutBase({
          margin:{l:48,r:18,t:28,b:42}
        });

        if(anyBar) layout.barmode = 'group';

        // Apply hoverMode from menu options
        layout.hovermode = (v.options && v.options.hoverMode) ? String(v.options.hoverMode) : ((v.options && v.options.hovermode) ? String(v.options.hovermode) : 'closest');
        console.log('[VM] Applied hovermode:', layout.hovermode);
        
        // Apply dragMode
        if(v.options && v.options.dragMode){
          layout.dragmode = v.options.dragMode;
          console.log('[VM] Applied dragMode:', layout.dragmode);
        }

        if(v.options && v.options.xScrollbar){
          layout.xaxis = layout.xaxis || {};
          layout.xaxis.rangeslider = {visible:true};
        }

        // Apply legend settings from menu options
        if(v.options && typeof v.options.showLegend === 'boolean'){
          layout.showlegend = v.options.showLegend;
          console.log('[VM] Applied showLegend:', layout.showlegend);
          if(v.options.showLegend && v.options.legendPos && v.options.legendPos !== 'auto'){
            layout.legend = layout.legend || {};
            if(v.options.legendPos === 'top') { layout.legend.x = 0.5; layout.legend.y = 1.1; layout.legend.xanchor = 'center'; layout.legend.yanchor = 'bottom'; }
            else if(v.options.legendPos === 'bottom') { layout.legend.x = 0.5; layout.legend.y = -0.1; layout.legend.xanchor = 'center'; layout.legend.yanchor = 'top'; }
            else if(v.options.legendPos === 'left') { layout.legend.x = -0.1; layout.legend.y = 0.5; layout.legend.xanchor = 'right'; layout.legend.yanchor = 'middle'; }
            else if(v.options.legendPos === 'right') { layout.legend.x = 1.1; layout.legend.y = 0.5; layout.legend.xanchor = 'left'; layout.legend.yanchor = 'middle'; }
            console.log('[VM] Applied legendPos:', v.options.legendPos);
          }
        }

        if(hasY2){
          layout.yaxis2 = {overlaying:'y', side:'right', showgrid:false, zeroline:false, title:{text: y2M.colKey || 'Y2'}};
        }

        // --- Statistics Overlay Logic ---
        if(v.options && v.options.statsMode && v.options.statsMode !== 'none'){
           try{
             // 1. Gather all numerical Y values for basic stats
             var allY = [];
             traces.forEach(function(tr){
               if(tr.y && tr.y.length){
                 for(var i=0;i<tr.y.length;i++){ 
                    var val = parseFloat(tr.y[i]);
                    if(isFinite(val)) allY.push(val); 
                 }
               }
             });

             if(allY.length > 1){
               var sum = 0; 
               for(var k=0;k<allY.length;k++) sum+=allY[k];
               var mean = sum / allY.length;
               
               allY.sort(function(a,b){ return a-b; });
               var median = allY[Math.floor(allY.length/2)];
               
               if(v.options.statsMode==='mean'){
                  layout.shapes = layout.shapes || [];
                  layout.shapes.push({
                    type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: mean, y1: mean,
                    line: { color: 'rgba(255,0,0,0.7)', width: 2, dash: 'dash' }
                  });
                  layout.annotations = layout.annotations || [];
                  layout.annotations.push({
                    xref: 'paper', x: 1, yref: 'y', y: mean, text: 'Mean: '+mean.toFixed(2), 
                    showarrow: false, xanchor: 'left', font:{color:'red', size:10}
                  });
               }
               else if(v.options.statsMode==='median'){
                  layout.shapes = layout.shapes || [];
                  layout.shapes.push({
                    type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: median, y1: median,
                    line: { color: 'rgba(0,0,255,0.7)', width: 2, dash: 'dot' }
                  });
                  layout.annotations = layout.annotations || [];
                  layout.annotations.push({
                    xref: 'paper', x: 1, yref: 'y', y: median, text: 'Median: '+median.toFixed(2), 
                    showarrow: false, xanchor: 'left', font:{color:'blue', size:10}
                  });
               }
               else if(v.options.statsMode==='ci'){
                  // Mean +/- 2SD (approx 95% CI)
                  var sqSum = 0; 
                  for(var k=0;k<allY.length;k++) sqSum += Math.pow(allY[k]-mean, 2);
                  var sd = Math.sqrt(sqSum / allY.length);
                  var upper = mean + 2*sd;
                  var lower = mean - 2*sd;
                  
                  layout.shapes = layout.shapes || [];
                  // Mean line
                  layout.shapes.push({ 
                    type: 'line', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: mean, y1: mean, 
                    line: { color: 'rgba(0,128,0,0.8)', width: 1.5 } 
                  });
                  // 2SD Band
                  layout.shapes.push({
                    type: 'rect', xref: 'paper', x0: 0, x1: 1, yref: 'y', y0: lower, y1: upper,
                    fillcolor: 'rgba(0,128,0,0.1)', line: { width: 0 }, layer: 'below'
                  });
                  layout.annotations = layout.annotations || [];
                  layout.annotations.push({ xref: 'paper', x: 1, yref: 'y', y: upper, text: '+2SD', showarrow:false, xanchor:'left', font:{size:9,color:'green'}});
                  layout.annotations.push({ xref: 'paper', x: 1, yref: 'y', y: lower, text: '-2SD', showarrow:false, xanchor:'left', font:{size:9,color:'green'}});
               }
               else if(v.options.statsMode==='regression'){
                  // Simple Linear Regression on valid (x,y) pairs
                  // We need numerical X.
                  var n=0, sx=0, sy=0, sxy=0, sx2=0;
                  var regPts = [];
                  
                  traces.forEach(function(tr){
                     if(tr.x && tr.y && tr.type==='scatter'){
                        for(var i=0;i<Math.min(tr.x.length, tr.y.length);i++){
                           var valY = parseFloat(tr.y[i]);
                           var valX = tr.x[i]; 
                           var numX = NaN;
                           if(typeof valX==='number') numX = valX;
                           else if(valX instanceof Date) numX = valX.getTime();
                           else {
                             // Try parse date string
                             var d = new Date(valX);
                             if(!isNaN(d.getTime())) numX = d.getTime();
                           }
                           
                           if(isFinite(numX) && isFinite(valY)){
                             regPts.push({x:numX, y:valY});
                           }
                        }
                     }
                  });
                  
                  if(regPts.length > 2){
                     regPts.forEach(function(p){ sx+=p.x; sy+=p.y; sxy+=p.x*p.y; sx2+=p.x*p.x; n++; });
                     var tm = (n*sxy - sx*sy) / (n*sx2 - sx*sx);
                     var tb = (sy - tm*sx) / n;
                     
                     // Create regression line trace
                     // Find min/max X of data to draw line
                     var minX=regPts[0].x, maxX=regPts[0].x;
                     for(var k=1;k<regPts.length;k++){ 
                       if(regPts[k].x<minX) minX=regPts[k].x; 
                       if(regPts[k].x>maxX) maxX=regPts[k].x; 
                     }
                     
                     var y1 = tm*minX + tb;
                     var y2 = tm*maxX + tb;
                     
                     // We need to convert back to Date if inputs were dates? 
                     // Or just rely on Plotly handling numbers on Date axis? 
                     // Plotly usually handles timestamps fine if axis type is date.
                     
                     traces.push({
                        type: 'scatter', mode: 'lines', name: 'Trend (Linear)',
                        x: [minX, maxX], y: [y1, y2],
                        line: { color: 'orange', width: 3, dash: 'dot' },
                        hoverinfo: 'skip'
                     });
                  }
               }
             }
           }catch(e){ console.error('Stats Calc Error:',e); }
        }

          // --- Target Lines / Bands ---
          try{ vmAddTargetsToLayout(layout, v, ctx, dataRows); }catch(_){ }
          try{ vmAddReferenceLinesToLayout(layout, v); }catch(_){ }

        if(v.title){ layout.margin = layout.margin || {}; layout.margin.t = 4; }
        Plotly.newPlot(el, traces, layout, plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('bar', {
      label:'Bar',
      category:'Comparisons',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'bar',
          title:'Bar',
          show:true,
          mapping:{ x:[], series:[] },
          measures:{ y:{ colKey:'', agg:'none' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{ barmode:'group', trellisOn:false, trellisCols:3, statsMode:'none' }
        };
      },
      buildMappingUI:function(v, ctx){
        var cols = ctx.cols;
        ensureMeasure(v,'y');
        v.mapping = v.mapping || {};
        v.mapping.x = Array.isArray(v.mapping.x) ? v.mapping.x : (v.mapping.x ? [v.mapping.x] : []);
        v.mapping.series = Array.isArray(v.mapping.series) ? v.mapping.series : (v.mapping.series ? [v.mapping.series] : []);
        return ''
          + '<div class="form">'
          + mappingFieldMulti('X (category)', 'x', cols, v.mapping.x, true, 'Select one or more columns. Multiple columns are combined as a composite key.')
          + mappingFieldMulti('Series (color split)', 'series', cols, v.mapping.series, true, 'Optional. Splits data into separate traces.')
          + hoverColsField(v, cols)
          + measureField('Y (measure)', 'y', cols, v.measures.y)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return ''
          + '<div class="form">'
          + '<div class="lbl">Bar mode</div>'
          + '<div><select data-opt="barmode">'
          + '<option value="group" '+(v.options.barmode==='group'?'selected':'')+'>Grouped</option>'
          + '<option value="stack" '+(v.options.barmode==='stack'?'selected':'')+'>Stacked</option>'
          + '<option value="relative" '+(v.options.barmode==='relative'?'selected':'')+'>Relative</option>'
          + '</select></div>'
          + '<div class="lbl">Trellis Mode</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="trellisOn" '+(v.options.trellisOn?'checked':'')+'> Enable faceted subplots</label></div>'
          + '<div class="lbl">Trellis Columns</div>'
          + '<div><select data-opt="trellisCols" style="min-width:140px">'
          + '<option value="1" '+(String(v.options.trellisCols||3)==='1'?'selected':'')+'>1 column</option>'
          + '<option value="2" '+(String(v.options.trellisCols||3)==='2'?'selected':'')+'>2 columns</option>'
          + '<option value="3" '+(String(v.options.trellisCols||3)==='3'?'selected':'')+'>3 columns</option>'
          + '<option value="4" '+(String(v.options.trellisCols||3)==='4'?'selected':'')+'>4 columns</option>'
          + '</select></div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var map=v.mapping||{};
        var xKeys = Array.isArray(map.x) ? map.x.filter(function(k){return !!k;}) : (map.x ? [map.x] : []);
        var xKey = xKeys.length === 1 ? xKeys[0] : (xKeys.length > 0 ? '__xComposite' : '');
        var yM=(v.measures||{}).y || {colKey:'',agg:'sum'};
        if(!xKeys.length || !yM.colKey){
          renderEmptyWithModebar(el, 'Map X and Y to render this visual.', v);
          return;
        }

        var filtered = applyFilter(rows, v.filter);
        var seriesArr = Array.isArray(map.series) ? map.series.filter(function(k){return !!k;}) : (map.series ? [map.series] : []);
        var seriesKey = seriesArr.length === 1 ? seriesArr[0] : (seriesArr.length > 0 ? '__seriesComposite' : '');

        var hoverKeys = Array.isArray(map.hoverCols) ? map.hoverCols.filter(function(k){return !!k;}) : [];
        var useHover = (hoverKeys.length>0);
        var hoverTemplate = null;
        if(useHover){
          var ht='X: %{x}<br>Y: %{y}';
          for(var hk=0;hk<hoverKeys.length;hk++) ht += '<br>'+escapeHtml(hoverKeys[hk])+': %{customdata['+hk+']}';
          ht += '<extra></extra>';
          hoverTemplate = ht;
        }

        var groupBy=[];
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) groupBy.push(ctx.sections.splitCol);
        if(xKeys.length > 1){
          for(var xi=0;xi<xKeys.length;xi++) groupBy.push(xKeys[xi]);
        } else if(xKey) {
          groupBy.push(xKey);
        }
        if(seriesArr.length > 1){
          for(var si=0;si<seriesArr.length;si++) groupBy.push(seriesArr[si]);
        } else if(seriesKey) {
          groupBy.push(seriesKey);
        }

        var dataRows = (v.transform.mode==='aggregate')
          ? aggregateRows(filtered, {mode:'aggregate', groupBy:groupBy, measures:[{colKey:yM.colKey, agg:yM.agg, asKey:'__y'}]}, hoverKeys)
          : filtered;

        // Create composite keys if multiple columns selected
        if(xKeys.length > 1){
          for(var ri=0;ri<dataRows.length;ri++){
            var parts = [];
            for(var xki=0;xki<xKeys.length;xki++) parts.push(asString(dataRows[ri][xKeys[xki]]));
            dataRows[ri].__xComposite = parts.join(' | ');
          }
        }
        if(seriesArr.length > 1){
          for(var ri2=0;ri2<dataRows.length;ri2++){
            var sparts = [];
            for(var ski=0;ski<seriesArr.length;ski++) sparts.push(asString(dataRows[ri2][seriesArr[ski]]));
            dataRows[ri2].__seriesComposite = sparts.join(' \u2022 ');
          }
        }

        var bySeries = Object.create(null);
        var cfRules = Array.isArray((v.options||{}).cfRules) ? v.options.cfRules : [];
        var hasCF = cfRules.length > 0;
        for(var i=0;i<dataRows.length;i++){
          var r=dataRows[i];
          var name = seriesKey ? asString(r[seriesKey]) : 'Series';
          if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
            name = asString(r[ctx.sections.splitCol]) + (seriesKey?(' \u2022 '+name):'');
          }
          var grp = (bySeries[name]=bySeries[name]||{x:[],y:[],cd:[],cfBg:[]});
          grp.x.push(r[xKey]);
          var yVal=(v.transform.mode==='aggregate') ? r.__y : r[yM.colKey];
          grp.y.push(toNumber(yVal));
          if(hasCF){
            var cfMatch = vmEvalCF(cfRules, r);
            grp.cfBg.push(cfMatch ? cfMatch.bg : null);
          }
          if(useHover){
            var cd=[];
            for(var h=0;h<hoverKeys.length;h++) cd.push(r[hoverKeys[h]]);
            grp.cd.push(cd);
          }
        }

        var traces=[];
        var palette = vmGetPalette(v);
        var palIdx = 0;
        Object.keys(bySeries).forEach(function(name){
          var tr={type:'bar', name:name, x:bySeries[name].x, y:bySeries[name].y};
          if(hasCF){
            var cfColors = bySeries[name].cfBg;
            var hasAny = cfColors.some(function(c){return c!=null;});
            if(hasAny) tr.marker = {color: cfColors.map(function(c){return c||'';})};
          }
          if((!tr.marker || !tr.marker.color) && palette.length){
            tr.marker = tr.marker || {};
            tr.marker.color = palette[palIdx % palette.length];
          }
          palIdx++;
          var yMDec = yM.decimals;
          var yFmt = (yMDec != null && isFinite(yMDec)) ? ('%{y:,.'+yMDec+'f}') : '%{y}';
          var trHt = 'X: %{x}<br>'+escapeHtml(yM.colKey||'Y')+': '+yFmt;
          if(useHover){
            for(var hk2=0;hk2<hoverKeys.length;hk2++) trHt += '<br>'+escapeHtml(hoverKeys[hk2])+': %{customdata['+hk2+']}';
            tr.customdata = bySeries[name].cd;
          }
          trHt += '<extra></extra>';
          tr.hovertemplate = trHt;
          traces.push(tr);
        });

        var layout = layoutBase({
          barmode: v.options.barmode || 'group',
          margin:{l:48,r:18,t:4,b:42}
        });
        try{ vmAddTargetsToLayout(layout, v, ctx, dataRows); }catch(_){ }
        try{ vmAddReferenceLinesToLayout(layout, v); }catch(_){ }
        if(v.title){ layout.margin.t = 4; }
        Plotly.newPlot(el, traces, layout, plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('pie', {
      label:'Pie',
      category:'Parts of Whole',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'pie',
          title:'Pie',
          show:true,
          mapping:{ label:'' },
          measures:{ value:{ colKey:'', agg:'none' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{ hole:0 }
        };
      },
      buildMappingUI:function(v, ctx){
        var cols = ctx.cols;
        ensureMeasure(v,'value');
        v.mapping = v.mapping || {};
        v.mapping.series = Array.isArray(v.mapping.series) ? v.mapping.series : (v.mapping.series ? [v.mapping.series] : []);
        return ''
          + '<div class="form">'
          + mappingField('Label', 'label', cols, v.mapping.label, true)
          + mappingFieldMulti('Series (split into pies)', 'series', cols, v.mapping.series, true, 'Optional. Creates separate pie for each unique value.')
          + measureField('Value (measure)', 'value', cols, v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        var isDonut = (v.options.hole && Number(v.options.hole)>0);
        return ''
          + '<div class="form">'
          + '<div class="lbl">Style</div>'
          + '<div class="row">'
          + '<label class="note"><input type="checkbox" data-opt="donut" '+(isDonut?'checked':'')+'> Donut</label>'
          + '<span class="note">(Uses a hole in the center)</span>'
          + '</div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var labelKey = (v.mapping||{}).label;
        var m=(v.measures||{}).value || {colKey:'',agg:'sum'};
        if(!labelKey || !m.colKey){
          renderEmptyWithModebar(el, 'Map Label and Value to render this visual.', v);
          return;
        }

        var filtered=applyFilter(rows, v.filter);

        var groupBy=[];
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) groupBy.push(ctx.sections.splitCol);
        groupBy.push(labelKey);
        var dataRows=aggregateRows(filtered, {mode:'aggregate', groupBy:groupBy, measures:[{colKey:m.colKey, agg:m.agg, asKey:'__v'}]});

        // If sectioned, render first section only for now (simple MVP)
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec = ctx.sections.current || null;
          if(sec && sec!=='All'){
            dataRows = dataRows.filter(function(r){ return asString(r[ctx.sections.splitCol])===sec; });
          }
        }

        // Optional sort (x or y)
        if(v.options && v.options.sortBy){
          dataRows = vmSortRows(dataRows, v.options.sortBy, v.options.sortDir, xKey, yKey);
        }

        var labels=[], values=[];
        for(var i=0;i<dataRows.length;i++){
          labels.push(asString(dataRows[i][labelKey]));
          values.push(toNumber(dataRows[i].__v));
        }

        var hole = (v.options && v.options.hole) ? Number(v.options.hole) : 0;
        var trace={type:'pie', labels:labels, values:values, hole:hole, textinfo:'label+percent'};
        var layout = layoutBase({
          margin:{l:12,r:12,t:22,b:12},
          showlegend:true
        });
        if(v.title){ layout.margin = layout.margin || {}; layout.margin.t = 4; }
        Plotly.newPlot(el, [trace], layout, plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('box', {
      label:'Box (7-view)',
      category:'Data Display',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'box',
          title:'Boxplot',
          show:true,
          mapping:{ x:'' },
          measures:{ y:{ colKey:'', agg:'avg' } },
          transform: defaultTransform('raw'),
          filter: defaultFilter(),
          options:{ view:'box', points:'outliers', targetsEnabled:false, targets:'' }
        };
      },
      buildMappingUI:function(v, ctx){
        var cols=ctx.cols;
        ensureMeasure(v,'y');
        return ''
          + '<div class="form">'
          + mappingField('Group (optional)', 'x', cols, v.mapping.x, true)
          + measureField('Y (value)', 'y', cols, v.measures.y)
        v.mapping = v.mapping || {};
        v.mapping.x = Array.isArray(v.mapping.x) ? v.mapping.x : (v.mapping.x ? [v.mapping.x] : []);
        return ''
          + '<div class="form">'
          + mappingFieldMulti('Group (optional)', 'x', cols, v.mapping.x, true, 'Select one or more columns to group by.')
          + measureField('Y (value)', 'y', cols, v.measures.y)
          + '<div class="form">'
          + '<div class="lbl">View</div>'
          + '<div><select data-opt="view">'
          + '<option value="box" '+((v.options.view||'box')==='box'?'selected':'')+'>Box</option>'
          + '<option value="violin" '+((v.options.view||'box')==='violin'?'selected':'')+'>Violin</option>'
          + '<option value="strip" '+((v.options.view||'box')==='strip'?'selected':'')+'>Strip</option>'
          + '<option value="swarm" '+((v.options.view||'box')==='swarm'?'selected':'')+'>Swarm (approx)</option>'
          + '<option value="raincloud" '+((v.options.view||'box')==='raincloud'?'selected':'')+'>Raincloud</option>'
          + '<option value="kde" '+((v.options.view||'box')==='kde'?'selected':'')+'>KDE</option>'
          + '<option value="ecdf" '+((v.options.view||'box')==='ecdf'?'selected':'')+'>ECDF</option>'
          + '</select></div>'
          + '<div class="lbl">Points</div>'
          + '<div><select data-opt="points">'
          + '<option value="outliers" '+(v.options.points==='outliers'?'selected':'')+'>Outliers</option>'
          + '<option value="all" '+(v.options.points==='all'?'selected':'')+'>All</option>'
          + '<option value="false" '+(String(v.options.points)==='false'?'selected':'')+'>null</option>'
          + '</select></div>'
          + '<div class="lbl">Targets</div>'
          + '<div class="row">'
          + '<label class="note"><input type="checkbox" data-opt="targetsEnabled" '+(v.options.targetsEnabled?'checked':'')+'> Show target lines</label>'
          + '<input type="text" data-opt="targets" value="'+escapeHtml(String(v.options.targets||''))+'" placeholder="e.g. 10, 12.5" style="min-width:240px" />'
          + '</div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var xKey=(v.mapping||{}).x;
        var yM=(v.measures||{}).y || {colKey:'',agg:'avg'};
        if(!yM.colKey){
          renderEmptyWithModebar(el, 'Map Y to render this visual.', v);
          return;
        }
        var filtered=applyFilter(rows, v.filter);

        var dataRows = filtered;
        if(v.transform && v.transform.mode==='aggregate'){
          // Aggregate by X (+ section) into a single value per group.
          var gb=[];
          if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) gb.push(ctx.sections.splitCol);
          if(xKey) gb.push(xKey);
          dataRows = aggregateRows(filtered, {mode:'aggregate', groupBy:gb, measures:[{colKey:yM.colKey, agg:yM.agg, asKey:'__y'}]});
        }

        // group into traces by X (and section)
        var byGroup = Object.create(null);
        for(var i=0;i<dataRows.length;i++){
          var r=dataRows[i];
          var gx = xKey ? asString(r[xKey]) : 'All';
          var secPrefix='';
          if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
            secPrefix = asString(r[ctx.sections.splitCol]) + ' � ';
          }
          var name = secPrefix + gx;
          (byGroup[name]=byGroup[name]||[]).push( toNumber((v.transform.mode==='aggregate')?r.__y:r[yM.colKey]) );
        }

        function computeKDE(values){
          var xs = (values||[]).filter(isFiniteNumber);
          if(xs.length < 2) return null;
          var n = xs.length;

          var mean = 0;
          for(var i=0;i<n;i++) mean += xs[i];
          mean /= n;
          var v2 = 0;
          for(var j=0;j<n;j++){
            var d = xs[j] - mean;
            v2 += d*d;
          }
          var std = Math.sqrt(v2 / Math.max(1,(n-1)));
          var h = 1.06 * std * Math.pow(n, -0.2);
          if(!isFiniteNumber(h) || h<=0){
            h = (Math.max.apply(null,xs) - Math.min.apply(null,xs)) / 20;
          }
          if(!isFiniteNumber(h) || h<=0) h = 1;

          var minX = Math.min.apply(null, xs);
          var maxX = Math.max.apply(null, xs);
          if(minX === maxX){ minX -= 1; maxX += 1; }

          var steps = 140;
          var grid = [];
          for(var k=0;k<steps;k++) grid.push(minX + (maxX-minX) * k / (steps-1));

          var invS = 1 / (Math.sqrt(2*Math.PI) * h * n);
          var ys = [];
          for(var g=0;g<grid.length;g++){
            var x0 = grid[g];
            var sum = 0;
            for(var p=0;p<n;p++){
              var z = (x0 - xs[p]) / h;
              sum += Math.exp(-0.5*z*z);
            }
            ys.push(invS * sum);
          }
          return {xs:grid, ys:ys};
        }

        function computeECDF(values){
          var xs = (values||[]).filter(isFiniteNumber).slice().sort(function(a,b){return a-b;});
          var n = xs.length;
          if(!n) return null;
          var ys=[];
          for(var i=0;i<n;i++) ys.push((i+1)/n);
          return {xs:xs, ys:ys};
        }

        var view = (v.options && v.options.view) ? String(v.options.view) : 'box';
        var pts = (v.options.points==='false') ? false : v.options.points;
        var traces=[];

        Object.keys(byGroup).forEach(function(name){
          var vals = byGroup[name];

          if(view==='kde'){
            var kde = computeKDE(vals);
            if(kde){
              traces.push({type:'scatter', mode:'lines', name:name, x:kde.xs, y:kde.ys, line:{width:2}});
            }
            return;
          }
          if(view==='ecdf'){
            var ec = computeECDF(vals);
            if(ec){
              traces.push({type:'scatter', mode:'lines', name:name, x:ec.xs, y:ec.ys, line:{width:2}});
            }
            return;
          }

          if(view==='violin'){
            traces.push({type:'violin', name:name, y:vals, points: pts, box:{visible:true}, meanline:{visible:false}});
            return;
          }

          if(view==='raincloud'){
            traces.push({
              type:'violin',
              name:name,
              y:vals,
              side:'positive',
              points: (pts===false) ? false : 'all',
              jitter: 0.25,
              pointpos: 0,
              box:{visible:true},
              meanline:{visible:false}
            });
            return;
          }

          if(view==='strip' || view==='swarm'){
            // Plotly doesn't provide true beeswarm; we use jittered points via a box trace with hidden box.
            var jit = (view==='swarm') ? 0.12 : 0.35;
            traces.push({
              type:'box',
              name:name,
              y:vals,
              boxpoints: (pts===false) ? false : 'all',
              jitter: jit,
              pointpos: 0,
              fillcolor:'rgba(0,0,0,0)',
              line:{width:0},
              whiskerwidth: 0.0001,
              marker:{size:(view==='swarm')?6:7, opacity:0.75}
            });
            return;
          }

          // default: box
          traces.push({type:'box', name:name, y:vals, boxpoints: pts});
        });

        var layout = layoutBase({
          margin:{l:48,r:18,t:28,b:42}
        });

        if(view==='kde'){
          layout.xaxis = layout.xaxis || {};
          layout.yaxis = layout.yaxis || {};
          layout.xaxis.title = {text: yM.colKey || 'Value'};
          layout.yaxis.title = {text: 'Density'};
        }
        if(view==='ecdf'){
          layout.xaxis = layout.xaxis || {};
          layout.yaxis = layout.yaxis || {};
          layout.xaxis.title = {text: yM.colKey || 'Value'};
          layout.yaxis.title = {text: 'ECDF'};
          layout.yaxis.range = [0,1];
        }

        var targetsRelevant = (view!=='kde' && view!=='ecdf');
        if(targetsRelevant && v.options && v.options.targetsEnabled && v.options.targets){
          var nums = String(v.options.targets||'').split(/[,;\s]+/)
            .map(function(s){return s.trim();})
            .filter(Boolean)
            .map(function(s){return Number(s);})
            .filter(isFiniteNumber);
          if(nums.length){
            layout.shapes = layout.shapes || [];
            for(var ti=0;ti<nums.length;ti++){
              layout.shapes.push({
                type:'line',
                xref:'paper', x0:0, x1:1,
                yref:'y', y0:nums[ti], y1:nums[ti],
                line:{color:'rgba(220,38,38,.9)', width:1.5, dash:'dash'}
              });
            }
          }
        }
        if(v.title){ layout.margin = layout.margin || {}; layout.margin.t = 4; }
        Plotly.newPlot(el, traces, layout, plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('scatter', {
      label:'Scatter (Regression optional)',
      category:'Trends & Distribution',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'scatter',
          title:'Scatter',
          show:true,
          mapping:{ x:'', y:'', color:'' },
          measures:{},
          transform: defaultTransform('raw'),
          filter: defaultFilter(),
          options:{ mode:'markers', showTrend:false }
        };
      },
      buildMappingUI:function(v, ctx){
        var cols=ctx.cols;
        var ncols = cols.filter(function(c){ return c && c.kind==='number'; });
        if(!ncols.length) ncols = cols;
        v.mapping = v.mapping || {};
        v.mapping.color = v.mapping.color || '';
        return ''
          + '<div class="form">'
          + mappingField('X (measure)', 'x', ncols, v.mapping.x, true)
          + mappingField('Y (measure)', 'y', ncols, v.mapping.y, true)
          + mappingField('Color (optional)', 'color', cols, v.mapping.color, true)
          + hoverColsField(v, cols)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return ''
          + '<div class="form">'
          + '<div class="lbl">Renderer</div>'
          + '<div><select data-opt="renderer">'
          + '<option value="auto" '+(((v.options.renderer||'auto')==='auto')?'selected':'')+'>Auto</option>'
          + '<option value="scatter" '+(((v.options.renderer||'auto')==='scatter')?'selected':'')+'>SVG (scatter)</option>'
          + '<option value="scattergl" '+(((v.options.renderer||'auto')==='scattergl')?'selected':'')+'>WebGL (scattergl)</option>'
          + '</select></div>'
          + '<div class="lbl">Mode</div>'
          + '<div><select data-opt="mode">'
          + '<option value="markers" '+(v.options.mode==='markers'?'selected':'')+'>Markers</option>'
          + '<option value="lines+markers" '+(v.options.mode==='lines+markers'?'selected':'')+'>Lines + markers</option>'
          + '</select></div>'
          + '<div class="lbl">Trendline</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="showTrend" '+(v.options.showTrend?'checked':'')+'> Show simple linear trendline</label></div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var map=v.mapping||{};
        if(!map.x || !map.y){
          renderEmptyWithModebar(el, 'Map X and Y to render this visual.', v);
          return;
        }

        var filtered=applyFilter(rows, v.filter);
        var xKey=map.x, yKey=map.y, cKey=map.color||'';

        var hoverKeys = Array.isArray(map.hoverCols) ? map.hoverCols.filter(function(k){return !!k;}) : [];
        var useHover = (hoverKeys.length>0);
        var hoverTemplate = null;
        if(useHover){
          var ht='X: %{x}<br>Y: %{y}';
          for(var hk=0;hk<hoverKeys.length;hk++) ht += '<br>'+escapeHtml(hoverKeys[hk])+': %{customdata['+hk+']}';
          ht += '<extra></extra>';
          hoverTemplate = ht;
        }

        var dataRows = filtered;
        if(v.transform && v.transform.mode==='aggregate'){
          var groupBy=[];
          if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) groupBy.push(ctx.sections.splitCol);
          groupBy.push(xKey);
          if(cKey) groupBy.push(cKey);
          dataRows = aggregateRows(filtered, {mode:'aggregate', groupBy:groupBy, measures:[{colKey:yKey, agg:'avg', asKey:'__y'}]}, hoverKeys);
        }

        // section filter (MVP)
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec = ctx.sections.current || null;
          if(sec && sec!=='All'){
            dataRows = dataRows.filter(function(r){ return asString(r[ctx.sections.splitCol])===sec; });
          }
        }

        var traces=[];
        var renderer = (v.options && v.options.renderer) ? String(v.options.renderer) : 'auto';
        function pickScatterType(pointCount){
          if(renderer==='scattergl') return 'scattergl';
          if(renderer==='scatter') return 'scatter';
          return (pointCount>3000) ? 'scattergl' : 'scatter';
        }
        var cfRules = Array.isArray((v.options||{}).cfRules) ? v.options.cfRules : [];
        var hasCF = cfRules.length > 0;
        if(cKey){
          var by = Object.create(null);
          for(var i=0;i<dataRows.length;i++){
            var r=dataRows[i];
            var name=asString(r[cKey]);
            var grp=(by[name]=by[name]||{x:[],y:[],cd:[],cfBg:[]});
            grp.x.push(toNumber(r[xKey]));
            var yy = (v.transform.mode==='aggregate')?r.__y:r[yKey];
            grp.y.push(toNumber(yy));
            if(hasCF){ var cfm=vmEvalCF(cfRules,r); grp.cfBg.push(cfm?cfm.bg:null); }
            if(useHover){
              var cd=[];
              for(var h=0;h<hoverKeys.length;h++) cd.push(r[hoverKeys[h]]);
              grp.cd.push(cd);
            }
          }
          var palette = vmGetPalette(v);
          var palIdx = 0;
          Object.keys(by).forEach(function(name){
            var tr={type:pickScatterType(by[name].x.length), mode:v.options.mode||'markers', name:name, x:by[name].x, y:by[name].y};
            if(hasCF){ var anyC=by[name].cfBg.some(function(c){return c!=null;}); if(anyC) tr.marker={color:by[name].cfBg.map(function(c){return c||'';})}; }
            if((!tr.marker || !tr.marker.color) && palette.length){ tr.marker = tr.marker || {}; tr.marker.color = palette[palIdx % palette.length]; }
            palIdx++;
            if(useHover){ tr.customdata = by[name].cd; tr.hovertemplate = hoverTemplate; }
            traces.push(tr);
          });
        }else{
          var xs=[], ys=[], cds=[], cfBgs=[];
          for(var j=0;j<dataRows.length;j++){
            xs.push(toNumber(dataRows[j][xKey]));
            var yv=(v.transform.mode==='aggregate')?dataRows[j].__y:dataRows[j][yKey];
            ys.push(toNumber(yv));
            if(hasCF){ var cfm2=vmEvalCF(cfRules,dataRows[j]); cfBgs.push(cfm2?cfm2.bg:null); }
            if(useHover){
              var cd2=[];
              for(var h2=0;h2<hoverKeys.length;h2++) cd2.push(dataRows[j][hoverKeys[h2]]);
              cds.push(cd2);
            }
          }
          var tr0={type:pickScatterType(xs.length), mode:v.options.mode||'markers', name:'Data', x:xs, y:ys};
          if(hasCF){ var anyC2=cfBgs.some(function(c){return c!=null;}); if(anyC2) tr0.marker={color:cfBgs.map(function(c){return c||'';})}; }
          if((!tr0.marker || !tr0.marker.color)){
            var pal = vmGetPalette(v);
            if(pal.length){ tr0.marker = tr0.marker || {}; tr0.marker.color = pal[0]; }
          }
          if(useHover){ tr0.customdata = cds; tr0.hovertemplate = hoverTemplate; }
          traces.push(tr0);
        }

        // simple trendline on first trace only
        if(v.options.showTrend && traces.length && traces[0].x && traces[0].x.length>=2){
          var x=traces[0].x, y=traces[0].y;
          var n=0, sx=0, sy=0, sxx=0, sxy=0;
          for(var k=0;k<x.length;k++){
            if(x[k]==null || y[k]==null) continue;
            n++; sx+=x[k]; sy+=y[k]; sxx+=x[k]*x[k]; sxy+=x[k]*y[k];
          }
          if(n>=2){
            var denom = (n*sxx - sx*sx);
            if(Math.abs(denom)>1e-12){
              var b = (n*sxy - sx*sy)/denom;
              var a = (sy - b*sx)/n;
              var minX=Math.min.apply(null,x.filter(isFiniteNumber));
              var maxX=Math.max.apply(null,x.filter(isFiniteNumber));
              traces.push({type:'scatter', mode:'lines', name:'Trend', x:[minX,maxX], y:[a+b*minX,a+b*maxX], line:{color:'rgba(125,211,252,.85)', width:2}});
            }
          }
        }

        var layout = layoutBase({
          margin:{l:52,r:18,t:28,b:44}
        });
        try{ vmAddTargetsToLayout(layout, v, ctx, dataRows); }catch(_){ }
        try{ vmAddReferenceLinesToLayout(layout, v); }catch(_){ }
        if(v.title){ layout.margin.t = 4; }
        Plotly.newPlot(el, traces, layout, plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('histogram', {
      label:'Histogram (Bins/KDE)',
      category:'Trends & Distribution',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'histogram',
          title:'Histogram',
          show:true,
          mapping:{ value:'', series:'' },
          measures:{},
          transform: defaultTransform('raw'),
          filter: defaultFilter(),
          options:{ nbins: 30, barmode:'overlay', opacity:0.75, showKDE:false, statsMode:'none' }
        };
      },
      buildMappingUI:function(v, ctx){
        var cols = ctx.cols;
        var ncols = cols.filter(function(c){ return c && c.kind==='number'; });
        if(!ncols.length) ncols = cols;
        v.mapping = v.mapping || {};
        v.mapping.series = v.mapping.series || '';
        return ''
          + '<div class="form">'
          + mappingField('Value (measure)', 'value', ncols, v.mapping.value, true)
          + mappingField('Series (optional)', 'series', cols, v.mapping.series, true)
          + hoverColsField(v, cols)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return ''
          + '<div class="form">'
          + '<div class="lbl">Bins</div>'
          + '<div class="row">'
          + '<input data-opt="nbins" type="number" min="5" max="400" step="1" value="'+escapeHtml(String(v.options.nbins||30))+'" style="width:120px" />'
          + '<span class="note">Approx number of bins</span>'
          + '</div>'
          + '<div class="lbl">Mode</div>'
          + '<div><select data-opt="barmode">'
          + '<option value="overlay" '+(v.options.barmode==='overlay'?'selected':'')+'>Overlay</option>'
          + '<option value="stack" '+(v.options.barmode==='stack'?'selected':'')+'>Stack</option>'
          + '</select></div>'
          + '<div class="lbl">KDE</div>'
          + '<div class="row"><label class="note"><input type="checkbox" data-opt="showKDE" '+(v.options.showKDE?'checked':'')+'> Show density curve (hist+kde)</label></div>'
          + '<div class="lbl">Statistics Overlay</div>'
          + '<div><select data-opt="statsMode" style="min-width:140px">'
          + '<option value="none" '+(String(v.options.statsMode||'none')==='none'?'selected':'')+'>null</option>'
          + '<option value="quartiles" '+(String(v.options.statsMode||'none')==='quartiles'?'selected':'')+'>Quartiles (median, Q1/Q3)</option>'
          + '<option value="full" '+(String(v.options.statsMode||'none')==='full'?'selected':'')+'>Full (min/max/mean/quartiles)</option>'
          + '</select></div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var map=v.mapping||{};
        var valKey = map.value;
        if(!valKey){ renderEmptyWithModebar(el, 'Map Value to render this visual.', v); return; }
        var filtered = applyFilter(rows, v.filter);
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec=ctx.sections.current; if(sec&&sec!=='All') filtered = filtered.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }

        var seriesKey = map.series || '';
        var hoverKeys = Array.isArray(map.hoverCols) ? map.hoverCols.filter(function(k){return !!k;}) : [];
        var useHover = (hoverKeys.length>0);
        var hoverTemplate = null;
        if(useHover){
          var ht='Value: %{x}';
          for(var hk=0;hk<hoverKeys.length;hk++) ht += '<br>'+escapeHtml(hoverKeys[hk])+': %{customdata['+hk+']}';
          ht += '<extra></extra>';
          hoverTemplate = ht;
        }

        var traces=[];
        if(seriesKey){
          var by = Object.create(null);
          for(var i=0;i<filtered.length;i++){
            var r=filtered[i];
            var name = asString(r[seriesKey]);
            (by[name]=by[name]||{x:[],cd:[]}).x.push(toNumber(r[valKey]));
            if(useHover){
              var cd=[]; for(var h=0;h<hoverKeys.length;h++) cd.push(r[hoverKeys[h]]);
              by[name].cd.push(cd);
            }
          }
          Object.keys(by).forEach(function(name){
            var tr={type:'histogram', name:name, x:by[name].x, nbinsx: clamp(parseInt(v.options.nbins||30,10)||30, 5, 400), opacity: Number(v.options.opacity||0.75)};
            if(useHover){ tr.customdata = by[name].cd; tr.hovertemplate = hoverTemplate; }
            traces.push(tr);
          });
        }else{
          var xs=[], cds=[];
          for(var j=0;j<filtered.length;j++){
            xs.push(toNumber(filtered[j][valKey]));
            if(useHover){
              var cd2=[]; for(var h2=0;h2<hoverKeys.length;h2++) cd2.push(filtered[j][hoverKeys[h2]]);
              cds.push(cd2);
            }
          }
          var tr0={type:'histogram', name:'Data', x:xs, nbinsx: clamp(parseInt(v.options.nbins||30,10)||30, 5, 400), opacity:Number(v.options.opacity||0.75)};
          if(useHover){ tr0.customdata = cds; tr0.hovertemplate = hoverTemplate; }
          traces.push(tr0);
        }

        function computeKDE(values){
          var xs = (values||[]).filter(isFiniteNumber);
          if(xs.length < 2) return null;
          var n = xs.length;

          var mean = 0;
          for(var i=0;i<n;i++) mean += xs[i];
          mean /= n;
          var v2 = 0;
          for(var j=0;j<n;j++){
            var d = xs[j] - mean;
            v2 += d*d;
          }
          var std = Math.sqrt(v2 / Math.max(1,(n-1)));
          var h = 1.06 * std * Math.pow(n, -0.2);
          if(!isFiniteNumber(h) || h<=0){
            h = (Math.max.apply(null,xs) - Math.min.apply(null,xs)) / 20;
          }
          if(!isFiniteNumber(h) || h<=0) h = 1;

          var minX = Math.min.apply(null, xs);
          var maxX = Math.max.apply(null, xs);
          if(minX === maxX){ minX -= 1; maxX += 1; }

          var steps = 120;
          var grid = [];
          for(var k=0;k<steps;k++) grid.push(minX + (maxX-minX) * k / (steps-1));

          var invS = 1 / (Math.sqrt(2*Math.PI) * h * n);
          var ys = [];
          for(var g=0;g<grid.length;g++){
            var x0 = grid[g];
            var sum = 0;
            for(var p=0;p<n;p++){
              var z = (x0 - xs[p]) / h;
              sum += Math.exp(-0.5*z*z);
            }
            ys.push(invS * sum);
          }
          return {xs:grid, ys:ys};
        }

        var layout = layoutBase({
          barmode: v.options.barmode || 'overlay',
          margin:{l:56,r:18,t:28,b:46}
        });

        if(v.options && v.options.showKDE){
          // hist+kde: align histogram and KDE on density scale
          var add=[];
          for(var t=0;t<traces.length;t++){
            if(traces[t].type==='histogram'){
              traces[t].histnorm = 'probability density';
              var kde = computeKDE(traces[t].x);
              if(kde){
                add.push({
                  type:'scatter',
                  mode:'lines',
                  name:'Density ' + String(traces[t].name||''),
                  x:kde.xs,
                  y:kde.ys,
                  yaxis:'y2',
                  line:{width:2}
                });
              }
            }
          }
          if(add.length) traces = traces.concat(add);

          layout.yaxis2 = {overlaying:'y', side:'right', showgrid:false, zeroline:false, title:{text:'Density'}};
        }

        // Add statistical annotations based on statsMode
        if(v.options && v.options.statsMode && v.options.statsMode !== 'none'){
          var allValues = [];
          for(var t=0;t<traces.length;t++){
            if(traces[t].x && Array.isArray(traces[t].x)){
              for(var tv=0;tv<traces[t].x.length;tv++){
                if(isFiniteNumber(traces[t].x[tv])) allValues.push(traces[t].x[tv]);
              }
            }
          }
          if(allValues.length > 1){
            var stats = calculateQuartiles(allValues);
            var shapes = layout.shapes || [];
            var colors = {median:'rgba(255,0,0,0.6)', mean:'rgba(0,0,255,0.6)', q1:'rgba(100,150,200,0.4)', q3:'rgba(100,150,200,0.4)', min:'rgba(100,100,100,0.3)', max:'rgba(100,100,100,0.3)'};
            
            if(v.options.statsMode === 'quartiles'){
              // Show quartile lines
              if(stats.q1 != null) shapes.push({type:'line',xref:'x',x0:stats.q1,x1:stats.q1,yref:'paper',y0:0,y1:1,line:{color:colors.q1,width:2,dash:'dot'}});
              if(stats.median != null) shapes.push({type:'line',xref:'x',x0:stats.median,x1:stats.median,yref:'paper',y0:0,y1:1,line:{color:colors.median,width:2}});
              if(stats.q3 != null) shapes.push({type:'line',xref:'x',x0:stats.q3,x1:stats.q3,yref:'paper',y0:0,y1:1,line:{color:colors.q3,width:2,dash:'dot'}});
            } else if(v.options.statsMode === 'full'){
              // Show all lines
              if(stats.min != null) shapes.push({type:'line',xref:'x',x0:stats.min,x1:stats.min,yref:'paper',y0:0,y1:1,line:{color:colors.min,width:1.5,dash:'dashdot'}});
              if(stats.q1 != null) shapes.push({type:'line',xref:'x',x0:stats.q1,x1:stats.q1,yref:'paper',y0:0,y1:1,line:{color:colors.q1,width:2,dash:'dot'}});
              if(stats.median != null) shapes.push({type:'line',xref:'x',x0:stats.median,x1:stats.median,yref:'paper',y0:0,y1:1,line:{color:colors.median,width:2.5}});
              if(stats.mean != null) shapes.push({type:'line',xref:'x',x0:stats.mean,x1:stats.mean,yref:'paper',y0:0,y1:1,line:{color:colors.mean,width:2,dash:'dot'}});
              if(stats.q3 != null) shapes.push({type:'line',xref:'x',x0:stats.q3,x1:stats.q3,yref:'paper',y0:0,y1:1,line:{color:colors.q3,width:2,dash:'dot'}});
              if(stats.max != null) shapes.push({type:'line',xref:'x',x0:stats.max,x1:stats.max,yref:'paper',y0:0,y1:1,line:{color:colors.max,width:1.5,dash:'dashdot'}});
            }
            if(shapes.length > 0) layout.shapes = shapes;
          }
        }

        if(v.title){ layout.margin = layout.margin || {}; layout.margin.t = 4; }
        Plotly.newPlot(el, traces, layout, plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('table', {
      label:'Table',
      category:'Data Display',
      implemented:true,
      defaultVisual:function(){
        return {
          id: uid(),
          type:'table',
          title:'Table',
          show:true,
          mapping:{ cols:[] },
          measures:{},
          transform: defaultTransform('raw'),
          filter: defaultFilter(),
          options:{ limit: 200, wrap:false, colWidths:{}, cfRules:[], striped:true, compact:false, headerBg:'', headerColor:'' }
        };
      },
      buildMappingUI:function(v, ctx){
        v.mapping = v.mapping || {};
        v.mapping.cols = Array.isArray(v.mapping.cols) ? v.mapping.cols : [];
        return ''
          + '<div class="form">'
          + mappingFieldMulti('Columns', 'cols', ctx.cols, v.mapping.cols, false, 
              'Select 1+ columns to display. If none selected, all columns are shown.')
          + '</div>';
      },
      buildOptionsUI:function(v, ctx){
        v.options = v.options || {};
        var cols = (v.mapping && Array.isArray(v.mapping.cols) && v.mapping.cols.length)
          ? v.mapping.cols
          : (ctx && ctx.cols ? ctx.cols : []);
        var cw = (v.options.colWidths && typeof v.options.colWidths==='object') ? v.options.colWidths : {};

        var out = '';
        out += '<div class="form">'
          + '<div class="lbl">Row limit</div>'
          + '<div class="row">'
          + '<input data-opt="limit" type="number" min="0" max="5000" step="10" value="'+escapeHtml(String(v.options.limit==null?200:v.options.limit))+'" style="width:140px" />'
          + '<span class="note">0 = render all rows (scrollbar appears)</span>'
          + '</div>'
          + '<div class="lbl">Display</div>'
          + '<div class="row" style="gap:16px">'
          + '  <label class="note"><input data-opt="wrap" type="checkbox" '+(v.options.wrap?'checked':'')+'> Wrap text</label>'
          + '  <label class="note"><input data-opt="striped" type="checkbox" '+(v.options.striped!==false?'checked':'')+'> Striped rows</label>'
          + '  <label class="note"><input data-opt="compact" type="checkbox" '+(v.options.compact?'checked':'')+'> Compact</label>'
          + '</div>';

        out += '<div class="lbl">Header style</div>'
          + '<div class="row" style="gap:8px">'
          + '  <span class="note">Background</span>'
          + '  <input data-opt="headerBg" type="color" value="'+(v.options.headerBg||'#0284c7')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
          + '  <span class="note">Text</span>'
          + '  <input data-opt="headerColor" type="color" value="'+(v.options.headerColor||'#ffffff')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
          + '</div>';

        out += '<div class="lbl">Column widths (px)</div>'
          + '<div class="note" style="margin-bottom:6px">Set per-column width. Blank = auto.</div>';

        if(cols && cols.length){
          for(var i=0;i<cols.length;i++){
            var k = String(cols[i]||'');
            if(!k) continue;
            var val = (cw && cw[k]!=null && cw[k]!=='' ) ? String(cw[k]) : '';
            out += ''
              + '<div class="row">'
              + '  <span class="badge" style="min-width:110px">'+escapeHtml(k)+'</span>'
              + '  <input type="number" min="40" max="1200" step="10" data-opt-colw="'+escapeHtml(k)+'" value="'+escapeHtml(val)+'" style="width:140px" placeholder="auto" />'
              + '</div>';
          }
        }else{
          out += '<div class="note">Pick columns in Mapping to configure widths.</div>';
        }

        /* NEW: Column Alignments */
        out += '<div class="lbl" style="margin-top:12px">Column Alignments</div>'
          + '<div class="note" style="margin-bottom:6px">Set per-column alignment. Default = left.</div>';

        if(cols && cols.length){
          var ca = (v.options.colAligns && typeof v.options.colAligns==='object') ? v.options.colAligns : {};
          for(var i=0;i<cols.length;i++){
            var k = String(cols[i]||'');
            if(!k) continue;
            var val = (ca && ca[k]) ? String(ca[k]) : '';
            out += ''
              + '<div class="row" style="margin-bottom:4px">'
              + '  <span class="badge" style="min-width:110px">'+escapeHtml(k)+'</span>'
              + '  <select data-opt-colalign="'+escapeHtml(k)+'" style="width:100px">'
              + '    <option value="" '+(val===''?'selected':'')+'>Auto</option>'
              + '    <option value="left" '+(val==='left'?'selected':'')+'>Left</option>'
              + '    <option value="center" '+(val==='center'?'selected':'')+'>Center</option>'
              + '    <option value="right" '+(val==='right'?'selected':'')+'>Right</option>'
              + '  </select>'
              + '</div>';
          }
        }

        // Conditional Formatting
        var cfRules = Array.isArray(v.options.cfRules) ? v.options.cfRules : [];
        out += '<div style="border-top:1px solid var(--vm-border);margin:14px 0 8px;padding-top:10px">'
          + '<div class="lbl" style="font-size:13px;font-weight:700">Conditional Formatting</div>'
          + '<div class="note" style="margin-bottom:8px">Color cells or rows based on conditions. Supports text and numeric columns.</div>';

        for(var ri=0;ri<cfRules.length;ri++){
          var rule = cfRules[ri]||{};
          out += '<div class="list-item" data-cf-rule="'+ri+'" style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;padding:6px 8px;margin:0 0 4px;border:1px solid var(--vm-border);border-radius:8px;background:var(--vm-input2)">'
            + '<select data-cf="col" style="min-width:120px">'
            + '<option value="">Column\u2026</option>';
          for(var ci=0;ci<cols.length;ci++){
            out += '<option value="'+escapeHtml(cols[ci])+'" '+(rule.col===cols[ci]?'selected':'')+'>'+escapeHtml(cols[ci])+'</option>';
          }
          out += '</select>'
            + '<select data-cf="op" style="width:90px">'
            + '<option value="gt" '+(rule.op==='gt'?'selected':'')+'>&gt;</option>'
            + '<option value="gte" '+(rule.op==='gte'?'selected':'')+'>&ge;</option>'
            + '<option value="lt" '+(rule.op==='lt'?'selected':'')+'>&lt;</option>'
            + '<option value="lte" '+(rule.op==='lte'?'selected':'')+'>&le;</option>'
            + '<option value="eq" '+(rule.op==='eq'?'selected':'')+'>=</option>'
            + '<option value="neq" '+(rule.op==='neq'?'selected':'')+'>&ne;</option>'
            + '<option value="between" '+(rule.op==='between'?'selected':'')+'>Between</option>'
            + '<option value="contains" '+(rule.op==='contains'?'selected':'')+'>Contains</option>'
            + '<option value="notcontains" '+(rule.op==='notcontains'?'selected':'')+'>Not Contains</option>'
            + '<option value="startswith" '+(rule.op==='startswith'?'selected':'')+'>Starts With</option>'
            + '<option value="endswith" '+(rule.op==='endswith'?'selected':'')+'>Ends With</option>'
            + '<option value="isblank" '+(rule.op==='isblank'?'selected':'')+'>Is Blank</option>'
            + '<option value="notblank" '+(rule.op==='notblank'?'selected':'')+'>Not Blank</option>'
            + '</select>'
            + '<input data-cf="val1" type="text" value="'+escapeHtml(String(rule.val1!=null?rule.val1:''))+'" placeholder="value" style="width:80px;display:'+(rule.op==='isblank'||rule.op==='notblank'?'none':'')+'" />'
            + '<input data-cf="val2" type="text" value="'+escapeHtml(String(rule.val2!=null?rule.val2:''))+'" placeholder="value2" style="width:80px;display:'+(rule.op==='between'?'':'none')+'" />'
            + '<span class="note">Bg</span>'
            + '<input data-cf="bg" type="color" value="'+(rule.bg||'#fca5a5')+'" style="width:30px;height:24px;cursor:pointer;border:1px solid var(--vm-border);border-radius:4px" />'
            + '<span class="note">Text</span>'
            + '<input data-cf="fg" type="color" value="'+(rule.fg||'#111827')+'" style="width:30px;height:24px;cursor:pointer;border:1px solid var(--vm-border);border-radius:4px" />'
            + '<span class="note">Icon1</span>'
            + '<select data-cf="icon1" style="width:70px">'
            + '<option value="">null</option>'
            + '<option value="up" '+(rule.icon1==='up'?'selected':'')+'>↑ Up</option>'
            + '<option value="down" '+(rule.icon1==='down'?'selected':'')+'>↓ Down</option>'
            + '<option value="right" '+(rule.icon1==='right'?'selected':'')+'>→ Right</option>'
            + '<option value="left" '+(rule.icon1==='left'?'selected':'')+'>← Left</option>'
            + '<option value="check" '+(rule.icon1==='check'?'selected':'')+'>✓ Check</option>'
            + '<option value="cross" '+(rule.icon1==='cross'?'selected':'')+'>✗ Cross</option>'
            + '</select>'
            + '<span class="note">Icon2</span>'
            + '<select data-cf="icon2" style="width:70px">'
            + '<option value="">null</option>'
            + '<option value="up" '+(rule.icon2==='up'?'selected':'')+'>↑ Up</option>'
            + '<option value="down" '+(rule.icon2==='down'?'selected':'')+'>↓ Down</option>'
            + '<option value="right" '+(rule.icon2==='right'?'selected':'')+'>→ Right</option>'
            + '<option value="left" '+(rule.icon2==='left'?'selected':'')+'>← Left</option>'
            + '<option value="check" '+(rule.icon2==='check'?'selected':'')+'>✓ Check</option>'
            + '<option value="cross" '+(rule.icon2==='cross'?'selected':'')+'>✗ Cross</option>'
            + '</select>'
            + '<span class="note">Apply</span>'
            + '<select data-cf="applyTo" style="width:60px">'
            + '<option value="cell" '+(rule.applyTo==='cell'||!rule.applyTo?'selected':'')+'>Cell</option>'
            + '<option value="row" '+(rule.applyTo==='row'?'selected':'')+'>Row</option>'
            + '</select>'
            + '<button class="btn danger" data-act="del-cf" style="padding:2px 8px;font-size:11px" title="Remove rule">&#10005;</button>'
            + '</div>';
        }

        out += '<button class="btn" data-act="add-cf" style="margin-top:4px;font-size:12px">+ Add Rule</button>'
          + '</div>';

        out += '</div>';
        return out;
      },
      render:function(v, rows, ctx, el){
        var filtered = applyFilter(rows, v.filter);
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec=ctx.sections.current; if(sec&&sec!=='All') filtered = filtered.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }
        
        /* Apply sorting if specified */
        var sortCol = (v.options && v.options.sortCol) ? String(v.options.sortCol) : '';
        var sortDir = (v.options && v.options.sortDir) ? String(v.options.sortDir) : 'asc';
        if(sortCol){
          filtered = filtered.slice().sort(function(a, b){
            var aVal = a[sortCol];
            var bVal = b[sortCol];
            var aNum = toNumber(aVal);
            var bNum = toNumber(bVal);
            var cmp = 0;
            if(aNum != null && bNum != null){
              cmp = aNum - bNum;
            } else {
              var aStr = asString(aVal).toLowerCase();
              var bStr = asString(bVal).toLowerCase();
              cmp = aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
            }
            return sortDir === 'asc' ? cmp : -cmp;
          });
        }
        
        var limitRaw = parseInt((v.options||{}).limit==null?200:(v.options||{}).limit, 10);
        if(!isFinite(limitRaw)) limitRaw = 200;
        var limit = clamp(limitRaw, 0, 5000);
        var cols = (v.mapping && Array.isArray(v.mapping.cols) && v.mapping.cols.length)
          ? v.mapping.cols.slice()
          : (filtered[0] ? Object.keys(filtered[0]) : []);
        if(!cols.length){ renderEmptyWithModebar(el, 'No rows/columns available.', v); return; }

        var cw = (v.options && v.options.colWidths && typeof v.options.colWidths==='object') ? v.options.colWidths : {};
        var wrap = !!(v.options && v.options.wrap);
        var striped = v.options.striped !== false;
        var compact = !!(v.options && v.options.compact);
        var headerBg = v.options.headerBg || '';
        var headerColor = v.options.headerColor || '';
        var cfRules = Array.isArray(v.options.cfRules) ? v.options.cfRules : [];

        // Build CF lookup per column — supports all operators
        function evalCF(colKey, val, row){
          for(var ri=0;ri<cfRules.length;ri++){
            var rule = cfRules[ri];
            if(!rule || rule.col !== colKey) continue;
            if(vmEvalCFRule(rule, val)){
              return {bg:rule.bg||'', fg:rule.fg||'', icon1:rule.icon1||'', icon2:rule.icon2||'', applyTo:rule.applyTo||'cell', row:row};
            }
          }
          return null;
        }

        var cellPad = compact ? '3px 6px' : '6px 10px';

        var out='';
        out += '<div class="vm-table-wrap">';
        out += '<table class="vm-table'+(compact?' vm-table-compact':'')+'" data-vid="'+escapeHtml(v.id)+'" data-table-sort-col="'+escapeHtml(sortCol)+'" data-table-sort-dir="'+escapeHtml(sortDir)+'">';
        // THEAD
        var thStyle = '';
        if(headerBg) thStyle += 'background:'+headerBg+';';
        if(headerColor) thStyle += 'color:'+headerColor+';';
        out += '<thead><tr'+(thStyle?' style="'+thStyle+'"':'')+'>';
        for(var c=0;c<cols.length;c++){
          var ck = String(cols[c]||'');
          var wpx = (cw && cw[ck]!=null && cw[ck]!=='' ) ? parseInt(cw[ck],10) : 0;
          var st = compact ? 'padding:'+cellPad+';' : '';
          
          /* Apply alignment */
          var al = (v.options.colAligns && v.options.colAligns[ck]) ? v.options.colAligns[ck] : '';
          if(al) st += 'text-align:'+al+';';
          
          if(wpx>0) st += 'width:'+wpx+'px;max-width:'+wpx+'px;';
          if(headerBg) st += 'background:'+headerBg+';';
          if(headerColor) st += 'color:'+headerColor+';';
          var isSorted = (sortCol === ck);
          var sortIndicator = isSorted ? (sortDir === 'asc' ? ' ↑' : ' ↓') : '';
          out += '<th data-col="'+escapeHtml(ck)+'" '+(st?' style="'+st+'"':'')+' style="cursor:pointer;user-select:none" title="Click to sort">' + escapeHtml(ck) + sortIndicator + '</th>';
        }
        out += '</tr></thead><tbody>';
        var n = (limit===0) ? filtered.length : Math.min(filtered.length, limit);
        for(var i=0;i<n;i++){
          var r=filtered[i]||{};
          var rowCls = (striped && i%2===1) ? ' class="vm-tr-stripe"' : '';
          // Pre-check row-level CF: if any rule with applyTo='row' matches any column in this row
          var rowCFStyle = '';
          if(cfRules.length>0){
            for(var rc=0;rc<cols.length;rc++){
              var rcMatch = evalCF(String(cols[rc]||''), r[String(cols[rc]||'')], r);
              if(rcMatch && rcMatch.applyTo==='row'){
                rowCFStyle = '';
                if(rcMatch.bg) rowCFStyle += 'background:'+rcMatch.bg+';';
                if(rcMatch.fg) rowCFStyle += 'color:'+rcMatch.fg+';';
                break;
              }
            }
          }
          out += '<tr'+rowCls+(rowCFStyle?' style="'+rowCFStyle+'"':'')+'>';
          for(var j=0;j<cols.length;j++){
            var k = String(cols[j]||'');
            var wpx2 = (cw && cw[k]!=null && cw[k]!=='' ) ? parseInt(cw[k],10) : 0;
            var s = '';
            
            /* Apply alignment */
            var al2 = (v.options.colAligns && v.options.colAligns[k]) ? v.options.colAligns[k] : '';
            if(al2) s += 'text-align:'+al2+';';
            
            if(compact) s += 'padding:'+cellPad+';';
            if(wpx2>0) s += 'width:'+wpx2+'px;max-width:'+wpx2+'px;';
            if(wrap) s += 'white-space:normal;word-break:break-word;';
            // Conditional formatting (cell level)
            var cfMatch = null;
            if(!rowCFStyle){
              cfMatch = (cfRules.length>0) ? evalCF(k, r[k], r) : null;
              if(cfMatch && cfMatch.applyTo!=='row'){
                if(cfMatch.bg) s += 'background:'+cfMatch.bg+';';
                if(cfMatch.fg) s += 'color:'+cfMatch.fg+';';
              }
            }
            var stAll = s ? (' style="'+s+'"') : '';
            var cellContent = escapeHtml(r[k]);
            if(cfMatch){
              var iconSymbols = {up:'↑', down:'↓', right:'→', left:'←', check:'✓', cross:'✗'};
              if(cfMatch.icon1) cellContent = '<span style="margin-right:3px;">'+iconSymbols[cfMatch.icon1]+'</span>'+cellContent;
              if(cfMatch.icon2) cellContent = cellContent + '<span style="margin-left:3px;">'+iconSymbols[cfMatch.icon2]+'</span>';
            }
            out += '<td'+stAll+'>'+cellContent+'</td>';
          }
          out += '</tr>';
        }
        out += '</tbody></table></div>';
        
        /* Simple render - no Plotly overlay needed, modebar is in card header */
        el.innerHTML = out;
        
        /* Add click handlers to column headers for sorting */
        var tableEl = el.querySelector('table');
        var thEls = tableEl ? tableEl.querySelectorAll('thead th') : [];
        for(var h=0;h<thEls.length;h++){
          (function(th){
            th.onclick = function(){
              var colName = th.getAttribute('data-col');
              var vid = tableEl.getAttribute('data-vid');
              if(!colName || !vid) return;
              var curSortCol = tableEl.getAttribute('data-table-sort-col');
              var curSortDir = tableEl.getAttribute('data-table-sort-dir') || 'asc';
              /* Toggle: same col -> switch direction, new col -> set to asc */
              var newDir = (colName === curSortCol && curSortDir === 'asc') ? 'desc' : 'asc';
              /* Find visual and update options */
              if(STATE && STATE.visuals){
                for(var vi=0;vi<STATE.visuals.length;vi++){
                  var vis = STATE.visuals[vi];
                  if(vis && vis.id === vid){
                    vis.options = vis.options || {};
                    vis.options.sortCol = colName;
                    vis.options.sortDir = newDir;
                    saveState();
                    renderGrid();
                    return;
                  }
                }
              }
            };
          })(thEls[h]);
        }
      }
    });

    // Some additional implemented Plotly types (basic MVP)
    reg('heatmap', {
      label:'Heatmap',
      category:'Relationships',
      implemented:true,
      defaultVisual:function(){
        return {
          id:uid(), type:'heatmap', title:'Heatmap', show:true,
          mapping:{ x:'', y:'' },
          measures:{ z:{ colKey:'', agg:'avg' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{}
        };
      },
      buildMappingUI:function(v, ctx){
        ensureMeasure(v,'z');
        return ''
          + '<div class="form">'
          + mappingField('X (category)', 'x', ctx.cols, v.mapping.x, true)
          + mappingField('Y (category)', 'y', ctx.cols, v.mapping.y, true)
          + measureField('Z (measure)', 'z', ctx.cols, v.measures.z)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">No additional options yet.</div>'; },
      render:function(v, rows, ctx, el){
        var xKey=v.mapping.x, yKey=v.mapping.y;
        var m=(v.measures||{}).z||{colKey:'',agg:'avg'};
        if(!xKey||!yKey||!m.colKey){ renderEmptyWithModebar(el, 'Map X, Y, and Z to render this visual.', v); return; }
        var filtered=applyFilter(rows, v.filter);
        var gb=[];
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) gb.push(ctx.sections.splitCol);
        gb.push(xKey); gb.push(yKey);
        var dataRows=aggregateRows(filtered, {mode:'aggregate', groupBy:gb, measures:[{colKey:m.colKey, agg:m.agg, asKey:'__z'}]});
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec=ctx.sections.current; if(sec&&sec!=='All') dataRows=dataRows.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }

        var xs=[], ys=[], grid=Object.create(null);
        for(var i=0;i<dataRows.length;i++){
          var r=dataRows[i];
          var xv=asString(r[xKey]); var yv=asString(r[yKey]);
          if(xs.indexOf(xv)<0) xs.push(xv);
          if(ys.indexOf(yv)<0) ys.push(yv);
          grid[yv+'\u001f'+xv] = toNumber(r.__z);
        }
        var z=[];
        for(var yi=0;yi<ys.length;yi++){
          var rowZ=[];
          for(var xi=0;xi<xs.length;xi++) rowZ.push(grid[ys[yi]+'\u001f'+xs[xi]]);
          z.push(rowZ);
        }

        Plotly.newPlot(el, [{type:'heatmap', x:xs, y:ys, z:z, colorscale:'Viridis'}], layoutBase({
          margin:{l:60,r:18,t:28,b:46}
        }), plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('waterfall', {
      label:'Waterfall',
      category:'Parts of Whole',
      implemented:true,
      defaultVisual:function(){
        return { id:uid(), type:'waterfall', title:'Waterfall', show:true,
          mapping:{ x:'' },
          measures:{ y:{ colKey:'', agg:'sum' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{}
        };
      },
      buildMappingUI:function(v, ctx){ ensureMeasure(v,'y');
        return ''
          + '<div class="form">'
          + mappingField('X (category)', 'x', ctx.cols, v.mapping.x, true)
          + measureField('Y (delta/measure)', 'y', ctx.cols, v.measures.y)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">No additional options yet.</div>'; },
      render:function(v, rows, ctx, el){
        var xKey=v.mapping.x; var m=(v.measures||{}).y||{colKey:'',agg:'sum'};
        if(!xKey||!m.colKey){ renderEmptyWithModebar(el, 'Map X and Y to render this visual.', v); return; }
        var filtered=applyFilter(rows, v.filter);
        var gb=[];
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) gb.push(ctx.sections.splitCol);
        gb.push(xKey);
        var dataRows=aggregateRows(filtered, {mode:'aggregate', groupBy:gb, measures:[{colKey:m.colKey, agg:m.agg, asKey:'__y'}]});
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec=ctx.sections.current; if(sec&&sec!=='All') dataRows=dataRows.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }
        var x=[], y=[];
        for(var i=0;i<dataRows.length;i++){ x.push(asString(dataRows[i][xKey])); y.push(toNumber(dataRows[i].__y)); }
        Plotly.newPlot(el, [{type:'waterfall', x:x, y:y}], layoutBase({
          margin:{l:56,r:18,t:28,b:46}
        }), plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('treemap', {
      label:'Treemap',
      category:'Parts of Whole',
      implemented:true,
      defaultVisual:function(){
        return { id:uid(), type:'treemap', title:'Treemap', show:true,
          mapping:{ label:'', parent:'' },
          measures:{ value:{ colKey:'', agg:'sum' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{}
        };
      },
      buildMappingUI:function(v, ctx){ ensureMeasure(v,'value');
        return ''
          + '<div class="form">'
          + mappingField('Label', 'label', ctx.cols, v.mapping.label, true)
          + mappingField('Parent (optional)', 'parent', ctx.cols, v.mapping.parent, true)
          + measureField('Value', 'value', ctx.cols, v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">No additional options yet.</div>'; },
      render:function(v, rows, ctx, el){
        var labelKey=v.mapping.label;
        var parentKey=v.mapping.parent || '';
        var m=(v.measures||{}).value||{colKey:'',agg:'sum'};
        if(!labelKey||!m.colKey){ renderEmptyWithModebar(el, 'Map Label and Value to render this visual.', v); return; }
        var filtered=applyFilter(rows, v.filter);
        var gb=[];
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false) gb.push(ctx.sections.splitCol);
        gb.push(labelKey);
        if(parentKey) gb.push(parentKey);
        var dataRows=aggregateRows(filtered, {mode:'aggregate', groupBy:gb, measures:[{colKey:m.colKey, agg:m.agg, asKey:'__v'}]});
        if(ctx.sections.enabled && ctx.sections.splitCol && v.options.useSections!==false){
          var sec=ctx.sections.current; if(sec&&sec!=='All') dataRows=dataRows.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }
        var labels=[], parents=[], values=[];
        for(var i=0;i<dataRows.length;i++){
          labels.push(asString(dataRows[i][labelKey]));
          parents.push(parentKey ? asString(dataRows[i][parentKey]) : '');
          values.push(toNumber(dataRows[i].__v));
        }
        Plotly.newPlot(el, [{type:'treemap', labels:labels, parents:parents, values:values}], layoutBase({
          margin:{l:10,r:10,t:28,b:10},
          xaxis:{}, yaxis:{}
        }), plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('kpi', {
      label:'KPI / Indicator',
      category:'Performance Metrics',
      implemented:true,
      defaultVisual:function(){
        return { id:uid(), type:'kpi', title:'KPI', show:true,
          mapping:{},
          measures:{ value:{ colKey:'', agg:'sum' } },
          transform: defaultTransform('aggregate'),
          filter: defaultFilter(),
          options:{ variant:'number', prefix:'', suffix:'', target:'', goodAbove:true, warnThreshold:'', badThreshold:'' }
        };
      },
      buildMappingUI:function(v, ctx){ ensureMeasure(v,'value');
        return ''
          + '<div class="form">'
          + measureField('Value', 'value', ctx.cols, v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return ''
          + '<div class="form">'
          + '<div class="lbl">Variant</div>'
          + '<div><select data-opt="variant">'
          + '<option value="number" '+(v.options.variant==='number'?'selected':'')+'>Number</option>'
          + '<option value="gauge" '+(v.options.variant==='gauge'?'selected':'')+'>Gauge</option>'
          + '<option value="bullet" '+(v.options.variant==='bullet'?'selected':'')+'>Bullet</option>'
          + '<option value="progress" '+(v.options.variant==='progress'?'selected':'')+'>Progress</option>'
          + '</select></div>'
          + '<div class="lbl">Prefix</div>'
          + '<div><input data-opt="prefix" value="'+escapeHtml(v.options.prefix||'')+'" placeholder="$" /></div>'
          + '<div class="lbl">Suffix</div>'
          + '<div><input data-opt="suffix" value="'+escapeHtml(v.options.suffix||'')+'" placeholder="%" /></div>'
          + '<div style="grid-column:1/-1;border-top:1px solid var(--vm-border);margin:8px 0;padding-top:8px"><b style="font-size:12px">Conditional Color</b></div>'
          + '<div class="lbl">Target value</div>'
          + '<div class="row"><input data-opt="target" type="number" step="any" value="'+escapeHtml(v.options.target||'')+'" placeholder="optional" style="width:120px" />'
          + '<span class="note">Reference for gauge range</span></div>'
          + '<div class="lbl">Direction</div>'
          + '<div><label class="note"><input data-opt="goodAbove" type="checkbox" '+(v.options.goodAbove!==false?'checked':'')+'> Higher is better (green above threshold)</label></div>'
          + '<div class="lbl">Warning threshold</div>'
          + '<div><input data-opt="warnThreshold" type="number" step="any" value="'+escapeHtml(v.options.warnThreshold||'')+'" placeholder="e.g. 70" style="width:120px" /></div>'
          + '<div class="lbl">Bad threshold</div>'
          + '<div><input data-opt="badThreshold" type="number" step="any" value="'+escapeHtml(v.options.badThreshold||'')+'" placeholder="e.g. 50" style="width:120px" /></div>'
          + '</div>';
      },
      render:function(v, rows, ctx, el){
        var m=(v.measures||{}).value||{colKey:'',agg:'sum'};
        if(!m.colKey){ renderEmptyWithModebar(el, 'Map Value to render this visual.', v); return; }
        var filtered=applyFilter(rows, v.filter);
        var dataRows=aggregateRows(filtered, {mode:'aggregate', groupBy:[], measures:[{colKey:m.colKey, agg:m.agg, asKey:'__v'}]});
        var val = (dataRows && dataRows[0]) ? dataRows[0].__v : null;
        val = toNumber(val);

        var prefix = v.options.prefix||'';
        var suffix = v.options.suffix||'';
        var variant = v.options.variant||'number';

        var th = plotTheme();

        // Conditional color
        var kpiColor = th.accent;
        var warnTh = parseFloat(v.options.warnThreshold);
        var badTh = parseFloat(v.options.badThreshold);
        var goodAbove = v.options.goodAbove !== false;
        if(val != null && isFinite(warnTh)){
          if(goodAbove){
            if(isFinite(badTh) && val <= badTh) kpiColor = '#dc2626';
            else if(val <= warnTh) kpiColor = '#d97706';
            else kpiColor = '#16a34a';
          }else{
            if(isFinite(badTh) && val >= badTh) kpiColor = '#dc2626';
            else if(val >= warnTh) kpiColor = '#d97706';
            else kpiColor = '#16a34a';
          }
        }

        var indicator = {type:'indicator', mode:'number', value: val==null?0:val, number:{prefix:prefix, suffix:suffix, font:{color:kpiColor}}};
        var targetVal = parseFloat(v.options.target);
        if(variant==='gauge'){
          indicator.mode='gauge+number';
          var gaugeMax = isFinite(targetVal) ? targetVal * 1.2 : undefined;
          indicator.gauge={axis:{visible:true, range:gaugeMax?[0,gaugeMax]:undefined}, bar:{color:kpiColor}};
        }else if(variant==='bullet'){
          indicator.mode='number+gauge';
          indicator.gauge={shape:'bullet', axis:{visible:true}, bar:{color:kpiColor}};
          if(isFinite(targetVal)) indicator.gauge.threshold = {line:{color:'#111',width:2}, thickness:0.75, value:targetVal};
        }else if(variant==='progress'){
          indicator.mode='gauge+number';
          indicator.gauge={axis:{range:[0,100]}, bar:{color:kpiColor}};
          indicator.value = clamp(val==null?0:val, 0, 100);
          indicator.number={suffix:'%', font:{color:kpiColor}};
        }

        Plotly.newPlot(el, [indicator], layoutBase({
          margin:{l:24,r:24,t:34,b:20},
          xaxis:{}, yaxis:{}
        }), plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    // ---------------------------
    // Implemented visual types: donut, funnel, sunburst, bubble, stackedArea, stackedBar,
    // gauge, bullet, progress, scorecard, lineBar, radar, candlestick, ohlc
    // ---------------------------

    reg('donut', {
      label:'Donut',
      category:'Parts of Whole',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'donut', title:'Donut', show:true,
          mapping:{label:'', series:[]}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{hole:0.45}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + mappingField('Label','label',ctx.cols,v.mapping.label,true)
          + measureField('Value','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Hole size</div>'
          + '<div class="row"><input data-opt="hole" type="number" min="0" max="0.9" step="0.05" value="'+(v.options.hole||0.45)+'" style="width:100px" /></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var vm=(v.measures||{}).value||{colKey:'',agg:'sum'};
        if(!m.label||!vm.colKey){renderEmptyWithModebar(el, 'Map Label and Value.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.label],measures:[{colKey:vm.colKey,agg:vm.agg,asKey:'__v'}]},[]);
        var labels=[],vals=[];
        for(var i=0;i<data.length;i++){labels.push(asString(data[i][m.label]));vals.push(toNumber(data[i].__v)||0);}
        Plotly.newPlot(el,[{type:'pie',labels:labels,values:vals,hole:parseFloat(v.options.hole)||0.45,textinfo:'percent+label'}],
          layoutBase({margin:{l:18,r:18,t:34,b:18},showlegend:true}),plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('funnel', {
      label:'Funnel',
      category:'Parts of Whole',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'funnel', title:'Funnel', show:true,
          mapping:{stage:''}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + mappingField('Stage','stage',ctx.cols,v.mapping.stage,true)
          + measureField('Value','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">No additional options.</div>'; },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var vm=(v.measures||{}).value||{};
        if(!m.stage||!vm.colKey){renderEmptyWithModebar(el, 'Map Stage and Value.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.stage],measures:[{colKey:vm.colKey,agg:vm.agg,asKey:'__v'}]},[]);
        var labels=[],vals=[];
        for(var i=0;i<data.length;i++){labels.push(asString(data[i][m.stage]));vals.push(toNumber(data[i].__v)||0);}
        Plotly.newPlot(el,[{type:'funnel',y:labels,x:vals,textinfo:'value+percent initial',connector:{line:{color:'rgba(125,211,252,.3)',width:1}}}],
          layoutBase({margin:{l:110,r:18,t:34,b:18},funnelmode:'stack'}),plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('sunburst', {
      label:'Sunburst',
      category:'Parts of Whole',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'sunburst', title:'Sunburst', show:true,
          mapping:{labels:'',parents:''}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + mappingField('Labels','labels',ctx.cols,v.mapping.labels,true)
          + mappingField('Parents','parents',ctx.cols,v.mapping.parents,true)
          + measureField('Value','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">No additional options.</div>'; },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var vm=(v.measures||{}).value||{};
        if(!m.labels||!vm.colKey){renderEmptyWithModebar(el, 'Map Labels and Value.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.labels,m.parents].filter(Boolean),measures:[{colKey:vm.colKey,agg:vm.agg,asKey:'__v'}]},[]);
        var labels=[],parents=[],vals=[];
        for(var i=0;i<data.length;i++){
          labels.push(asString(data[i][m.labels]));
          parents.push(m.parents?asString(data[i][m.parents]):'');
          vals.push(toNumber(data[i].__v)||0);
        }
        Plotly.newPlot(el,[{type:'sunburst',labels:labels,parents:parents,values:vals,branchvalues:'total',textinfo:'label+percent entry'}],
          layoutBase({margin:{l:12,r:12,t:34,b:12}}),plotlyCfg(v));
      }
    });

    reg('bubble', {
      label:'Bubble',
      category:'Trends & Distribution',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'bubble', title:'Bubble', show:true,
          mapping:{x:'',series:[]}, measures:{y:{colKey:'',agg:'none'},size:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{maxBubble:40}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'y');ensureMeasure(v,'size');
        return '<div class="form">'
          + mappingField('X','x',ctx.cols,v.mapping.x,true)
          + mappingFieldMulti('Series','series',ctx.cols,v.mapping.series,true)
          + measureField('Y','y',ctx.cols,v.measures.y)
          + measureField('Size','size',ctx.cols,v.measures.size)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form"><div class="lbl">Max bubble px</div><div><input data-opt="maxBubble" type="number" min="10" max="100" value="'+(v.options.maxBubble||40)+'" style="width:80px" /></div></div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var yM=(v.measures||{}).y||{};var sM=(v.measures||{}).size||{};
        if(!m.x||!yM.colKey){renderEmptyWithModebar(el, 'Map X and Y.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var seriesArr=Array.isArray(m.series)?m.series.filter(Boolean):(m.series?[m.series]:[]);
        var seriesKey=seriesArr.length===1?seriesArr[0]:(seriesArr.length>1?'__sComp':'');
        var gb=[m.x];if(seriesKey)gb.push(seriesKey);
        var meas=[{colKey:yM.colKey,agg:yM.agg,asKey:'__y'}];
        if(sM.colKey) meas.push({colKey:sM.colKey,agg:sM.agg,asKey:'__sz'});
        var data=(v.transform.mode==='aggregate')?aggregateRows(filtered,{mode:'aggregate',groupBy:gb,measures:meas},[]):filtered;
        if(seriesArr.length>1){
          for(var ri=0;ri<data.length;ri++){var ps=[];for(var sk=0;sk<seriesArr.length;sk++)ps.push(asString(data[ri][seriesArr[sk]]));data[ri].__sComp=ps.join(' \u2022 ');}
        }
        var bySeries=Object.create(null);
        for(var i=0;i<data.length;i++){
          var r=data[i];var name=seriesKey?asString(r[seriesKey]):'Data';
          var b=(bySeries[name]=bySeries[name]||{x:[],y:[],sz:[]});
          b.x.push(r[m.x]);
          b.y.push(toNumber(v.transform.mode==='aggregate'?r.__y:r[yM.colKey])||0);
          b.sz.push(sM.colKey?Math.abs(toNumber(v.transform.mode==='aggregate'?r.__sz:r[sM.colKey])||1):10);
        }
        var traces=[];var maxBub=parseInt(v.options.maxBubble,10)||40;
        Object.keys(bySeries).forEach(function(name){
          var d=bySeries[name];var maxSz=Math.max.apply(null,d.sz)||1;
          var szNorm=d.sz.map(function(s){return clamp(s/maxSz*maxBub,4,maxBub);});
          traces.push({type:'scatter',mode:'markers',name:name,x:d.x,y:d.y,marker:{size:szNorm,sizemode:'diameter'},hovertemplate:'X: %{x}<br>Y: %{y}<extra>'+escapeHtml(name)+'</extra>'});
        });
        Plotly.newPlot(el,traces,layoutBase({margin:{l:48,r:18,t:34,b:42}}),plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('stackedArea', {
      label:'Stacked Area',
      category:'Trends & Distribution',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'stackedArea', title:'Stacked Area', show:true,
          mapping:{x:'',series:[]}, measures:{y:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{normalize:false}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'y');
        return '<div class="form">'
          + mappingField('X','x',ctx.cols,v.mapping.x,true)
          + mappingFieldMulti('Series','series',ctx.cols,v.mapping.series,true)
          + measureField('Y','y',ctx.cols,v.measures.y)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form"><div class="lbl">Normalize (100%)</div><div><label class="note"><input data-opt="normalize" type="checkbox" '+(v.options.normalize?'checked':'')+' /> Stack to 100%</label></div></div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var yM=(v.measures||{}).y||{};
        if(!m.x||!yM.colKey){renderEmptyWithModebar(el, 'Map X and Y.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var seriesArr=Array.isArray(m.series)?m.series.filter(Boolean):(m.series?[m.series]:[]);
        var seriesKey=seriesArr.length===1?seriesArr[0]:(seriesArr.length>1?'__sComp':'');
        var gb=[m.x];if(seriesKey)gb.push(seriesKey);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:gb,measures:[{colKey:yM.colKey,agg:yM.agg,asKey:'__y'}]},[]);
        if(seriesArr.length>1){for(var ri=0;ri<data.length;ri++){var ps=[];for(var sk=0;sk<seriesArr.length;sk++)ps.push(asString(data[ri][seriesArr[sk]]));data[ri].__sComp=ps.join(' \u2022 ');}}
        var bySeries=Object.create(null);
        for(var i=0;i<data.length;i++){var r=data[i];var name=seriesKey?asString(r[seriesKey]):'Series';(bySeries[name]=bySeries[name]||{x:[],y:[]}).x.push(r[m.x]);bySeries[name].y.push(toNumber(r.__y)||0);}
        var traces=[];var grp=v.options.normalize?'stack100':'stack1';var norm=v.options.normalize?'percent':undefined;
        Object.keys(bySeries).forEach(function(name){
          var d=bySeries[name];
          traces.push({type:'scatter',mode:'lines',name:name,x:d.x,y:d.y,stackgroup:grp,groupnorm:norm,fill:'tonexty'});
        });
        var layout=layoutBase({margin:{l:48,r:18,t:4,b:42}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('stackedBar', {
      label:'Stacked Bar',
      category:'Comparisons',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'stackedBar', title:'Stacked Bar', show:true,
          mapping:{x:'',series:[]}, measures:{y:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{orientation:'v',normalize:false}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'y');
        return '<div class="form">'
          + mappingField('X','x',ctx.cols,v.mapping.x,true)
          + mappingFieldMulti('Series','series',ctx.cols,v.mapping.series,true)
          + measureField('Y','y',ctx.cols,v.measures.y)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Orientation</div>'
          + '<div><select data-opt="orientation"><option value="v" '+(v.options.orientation!=='h'?'selected':'')+'>Vertical</option><option value="h" '+(v.options.orientation==='h'?'selected':'')+'>Horizontal</option></select></div>'
          + '<div class="lbl">Normalize (100%)</div>'
          + '<div><label class="note"><input data-opt="normalize" type="checkbox" '+(v.options.normalize?'checked':'')+' /> Normalize to 100%</label></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var yM=(v.measures||{}).y||{};
        if(!m.x||!yM.colKey){renderEmptyWithModebar(el, 'Map X and Y.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var seriesArr=Array.isArray(m.series)?m.series.filter(Boolean):(m.series?[m.series]:[]);
        var seriesKey=seriesArr.length===1?seriesArr[0]:(seriesArr.length>1?'__sComp':'');
        var gb=[m.x];if(seriesKey)gb.push(seriesKey);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:gb,measures:[{colKey:yM.colKey,agg:yM.agg,asKey:'__y'}]},[]);
        if(seriesArr.length>1){for(var ri=0;ri<data.length;ri++){var ps=[];for(var sk=0;sk<seriesArr.length;sk++)ps.push(asString(data[ri][seriesArr[sk]]));data[ri].__sComp=ps.join(' \u2022 ');}}
        var bySeries=Object.create(null);
        for(var i=0;i<data.length;i++){var r=data[i];var name=seriesKey?asString(r[seriesKey]):'Series';(bySeries[name]=bySeries[name]||{x:[],y:[]}).x.push(r[m.x]);bySeries[name].y.push(toNumber(r.__y)||0);}
        var traces=[];var horiz=(v.options.orientation==='h');
        Object.keys(bySeries).forEach(function(name){
          var d=bySeries[name];
          var tr={type:'bar',name:name};
          if(horiz){tr.y=d.x;tr.x=d.y;tr.orientation='h';}else{tr.x=d.x;tr.y=d.y;}
          traces.push(tr);
        });
        var layout=layoutBase({barmode:'stack',barnorm:v.options.normalize?'percent':undefined,margin:{l:horiz?110:48,r:18,t:4,b:42}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('gauge', {
      label:'Gauge',
      category:'Performance Metrics',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'gauge', title:'Gauge', show:true,
          mapping:{}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(),
          options:{min:0,max:100,suffix:'',thresholdGood:70,thresholdBad:30}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + measureField('Value','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Min</div><div><input data-opt="min" type="number" value="'+(v.options.min||0)+'" style="width:80px" /></div>'
          + '<div class="lbl">Max</div><div><input data-opt="max" type="number" value="'+(v.options.max||100)+'" style="width:80px" /></div>'
          + '<div class="lbl">Suffix</div><div><input data-opt="suffix" value="'+escapeHtml(v.options.suffix||'')+'" style="width:100px" /></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var vm=(v.measures||{}).value||{};
        if(!vm.colKey){renderEmptyWithModebar(el, 'Map a Value measure.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var vals=[];for(var i=0;i<filtered.length;i++){var n=toNumber(filtered[i][vm.colKey]);if(n!=null)vals.push(n);}
        var val=computeAgg(vm.agg||'sum',vals);if(val==null)val=0;
        var th=plotTheme();var mn=parseFloat(v.options.min)||0;var mx=parseFloat(v.options.max)||100;
        Plotly.newPlot(el,[{type:'indicator',mode:'gauge+number',value:val,
          number:{suffix:v.options.suffix||''},
          gauge:{axis:{range:[mn,mx],tickcolor:th.font},bar:{color:th.accent},
            bgcolor:'rgba(0,0,0,.04)',borderwidth:1,bordercolor:th.grid,
            steps:[{range:[mn,(mx-mn)*0.3+mn],color:'rgba(220,38,38,.12)'},{range:[(mx-mn)*0.3+mn,(mx-mn)*0.7+mn],color:'rgba(217,119,6,.10)'},{range:[(mx-mn)*0.7+mn,mx],color:'rgba(22,163,74,.10)'}]
          }}],layoutBase({margin:{l:24,r:24,t:40,b:10}}),plotlyCfg(v));
      }
    });

    reg('bullet', {
      label:'Bullet',
      category:'Performance Metrics',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'bullet', title:'Bullet', show:true,
          mapping:{}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(),
          options:{max:100,target:80}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'+measureField('Value','value',ctx.cols,v.measures.value)+'</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Max</div><div><input data-opt="max" type="number" value="'+(v.options.max||100)+'" style="width:80px" /></div>'
          + '<div class="lbl">Target</div><div><input data-opt="target" type="number" value="'+(v.options.target||80)+'" style="width:80px" /></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var vm=(v.measures||{}).value||{};
        if(!vm.colKey){renderEmptyWithModebar(el, 'Map a Value measure.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var vals=[];for(var i=0;i<filtered.length;i++){var n=toNumber(filtered[i][vm.colKey]);if(n!=null)vals.push(n);}
        var val=computeAgg(vm.agg||'sum',vals);if(val==null)val=0;
        var th=plotTheme();var mx=parseFloat(v.options.max)||100;var tgt=parseFloat(v.options.target)||80;
        Plotly.newPlot(el,[{type:'indicator',mode:'number+gauge',value:val,
          gauge:{shape:'bullet',axis:{range:[0,mx]},bar:{color:th.accent2},threshold:{line:{color:th.font,width:3},thickness:0.8,value:tgt},
            steps:[{range:[0,mx*0.5],color:'rgba(0,0,0,.06)'},{range:[mx*0.5,mx*0.75],color:'rgba(0,0,0,.03)'}]
          }}],layoutBase({margin:{l:24,r:24,t:40,b:10}}),plotlyCfg(v));
      }
    });

    reg('progress', {
      label:'Progress Bar',
      category:'Performance Metrics',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'progress', title:'Progress', show:true,
          mapping:{}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'+measureField('Value','value',ctx.cols,v.measures.value)+'</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">Shows value as 0�100% progress.</div>'; },
      render:function(v,rows,ctx,el){
        var vm=(v.measures||{}).value||{};
        if(!vm.colKey){renderEmptyWithModebar(el, 'Map a Value measure.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var vals=[];for(var i=0;i<filtered.length;i++){var n=toNumber(filtered[i][vm.colKey]);if(n!=null)vals.push(n);}
        var val=clamp(computeAgg(vm.agg||'sum',vals)||0,0,100);
        var th=plotTheme();
        Plotly.newPlot(el,[{type:'indicator',mode:'gauge+number',value:val,
          number:{suffix:'%'},
          gauge:{axis:{range:[0,100]},bar:{color:val>=70?th.accent:(val>=40?'#d97706':'#dc2626')},bgcolor:'rgba(0,0,0,.04)'}
        }],layoutBase({margin:{l:24,r:24,t:40,b:10}}),plotlyCfg(v));
      }
    });

    reg('scorecard', {
      label:'Scorecard',
      category:'Performance Metrics',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'scorecard', title:'Scorecard', show:true,
          mapping:{}, measures:{value:{colKey:'',agg:'none'},delta:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(),
          options:{prefix:'',suffix:'',deltaRef:0}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');ensureMeasure(v,'delta');
        return '<div class="form">'
          + measureField('Value','value',ctx.cols,v.measures.value)
          + measureField('Delta (comparison)','delta',ctx.cols,v.measures.delta)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Prefix</div><div><input data-opt="prefix" value="'+escapeHtml(v.options.prefix||'')+'" style="width:80px" /></div>'
          + '<div class="lbl">Suffix</div><div><input data-opt="suffix" value="'+escapeHtml(v.options.suffix||'')+'" style="width:80px" /></div>'
          + '<div class="lbl">Delta reference</div><div><input data-opt="deltaRef" type="number" value="'+(v.options.deltaRef||0)+'" style="width:100px" /><span class="note"> 0 = compare to delta measure</span></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var vm=(v.measures||{}).value||{};
        if(!vm.colKey){renderEmptyWithModebar(el, 'Map a Value measure.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var vals=[],dvals=[];
        var dm=(v.measures||{}).delta||{};
        for(var i=0;i<filtered.length;i++){
          var n=toNumber(filtered[i][vm.colKey]);if(n!=null)vals.push(n);
          if(dm.colKey){var d=toNumber(filtered[i][dm.colKey]);if(d!=null)dvals.push(d);}
        }
        var val=computeAgg(vm.agg||'sum',vals);if(val==null)val=0;
        var th=plotTheme();
        var ind={type:'indicator',mode:'number',value:val,number:{prefix:v.options.prefix||'',suffix:v.options.suffix||'',font:{size:36}}};
        if(dm.colKey && dvals.length){
          var dval=computeAgg(dm.agg||'sum',dvals);
          var ref=parseFloat(v.options.deltaRef)||0;
          if(ref===0) ref=dval;
          ind.mode='number+delta';
          ind.delta={reference:ref,relative:true,increasing:{color:'#16a34a'},decreasing:{color:'#dc2626'}};
        }
        Plotly.newPlot(el,[ind],layoutBase({margin:{l:18,r:18,t:34,b:10}}),plotlyCfg(v));
      }
    });

    reg('gaugePercent', {
      label:'Gauge (% Circular)',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'gaugePercent', title:'Gauge %', show:true,
          mapping:{}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(),
          options:{colorFilled:'#2563eb', colorEmpty:'#e5e7eb', showPercent:true}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + measureField('Percentage (0-100)','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Filled color</div><div><input type="color" data-opt="colorFilled" value="'+(v.options.colorFilled||'#2563eb')+'" style="width:60px;height:28px" /></div>'
          + '<div class="lbl">Empty color</div><div><input type="color" data-opt="colorEmpty" value="'+(v.options.colorEmpty||'#e5e7eb')+'" style="width:60px;height:28px" /></div>'
          + '<div class="lbl">Show %</div><div><label class="note"><input type="checkbox" data-opt="showPercent" '+(v.options.showPercent!==false?'checked':'')+'>Display percentage text</label></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var vm=(v.measures||{}).value||{};
        if(!vm.colKey){renderEmptyWithModebar(el, 'Map a percentage value (0-100).', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var vals=[];for(var i=0;i<filtered.length;i++){var n=toNumber(filtered[i][vm.colKey]);if(n!=null)vals.push(Math.min(100,Math.max(0,n)));}
        var pct=computeAgg(vm.agg||'sum',vals);if(pct==null)pct=0; pct=Math.min(100,Math.max(0,pct));
        var cf=v.options.colorFilled||'#2563eb';var ce=v.options.colorEmpty||'#e5e7eb';var sz=240;
        var svg='<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 240 240" style="display:block;margin:auto"><defs><style>.gp-text{text-anchor:middle;font-size:32px;font-weight:bold;fill:#111827}[data-theme="dark"] .gp-text{fill:#e6edf3}</style></defs>';
        // Draw background circle
        var rad=100;var cx=120;var cy=120;svg+='<circle cx="'+cx+'" cy="'+cy+'" r="'+rad+'" fill="none" stroke="'+ce+'" stroke-width="20"/>';
        // Draw filled arc
        var angle=Math.PI*2*(pct/100);
        var ex=cx+rad*Math.sin(angle);var ey=cy-rad*Math.cos(angle);
        var large=(pct>50)?1:0;
        svg+='<path d="M '+cx+' '+(cy-rad)+' A '+rad+' '+rad+' 0 '+large+' 1 '+ex+' '+ey+'" stroke="'+cf+'" stroke-width="20" fill="none" stroke-linecap="round"/>';
        if(v.options.showPercent!==false) svg+='<text x="'+cx+'" y="'+cy+'" dy="0.3em" class="gp-text">'+Math.round(pct)+'%</text>';
        svg+='</svg>';
        el.innerHTML=svg;
      }
    });

    reg('donutPercent', {
      label:'Donut (% Circular)',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'donutPercent', title:'Donut %', show:true,
          mapping:{}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(),
          options:{colorFilled:'#f97316', colorEmpty:'#e5e7eb', holeSize:0.6, showPercent:true}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + measureField('Percentage (0-100)','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Filled color</div><div><input type="color" data-opt="colorFilled" value="'+(v.options.colorFilled||'#f97316')+'" style="width:60px;height:28px" /></div>'
          + '<div class="lbl">Empty color</div><div><input type="color" data-opt="colorEmpty" value="'+(v.options.colorEmpty||'#e5e7eb')+'" style="width:60px;height:28px" /></div>'
          + '<div class="lbl">Show %</div><div><label class="note"><input type="checkbox" data-opt="showPercent" '+(v.options.showPercent!==false?'checked':'')+'>Display percentage text</label></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var vm=(v.measures||{}).value||{};
        if(!vm.colKey){renderEmptyWithModebar(el, 'Map a percentage value (0-100).', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var vals=[];for(var i=0;i<filtered.length;i++){var n=toNumber(filtered[i][vm.colKey]);if(n!=null)vals.push(Math.min(100,Math.max(0,n)));}
        var pct=computeAgg(vm.agg||'sum',vals);if(pct==null)pct=0; pct=Math.min(100,Math.max(0,pct));
        var cf=v.options.colorFilled||'#f97316';var ce=v.options.colorEmpty||'#e5e7eb';var sz=240;
        var svg='<svg width="'+sz+'" height="'+sz+'" viewBox="0 0 240 240" style="display:block;margin:auto"><defs><style>.dp-text{text-anchor:middle;font-size:28px;font-weight:bold;fill:#111827}[data-theme="dark"] .dp-text{fill:#e6edf3}</style></defs>';
        var rad=90;var cx=120;var cy=120;var hole=0.6;
        // Empty donut
        svg+='<circle cx="'+cx+'" cy="'+cy+'" r="'+rad+'" fill="none" stroke="'+ce+'" stroke-width="'+(1-hole)*rad*2+'"/>';
        svg+='<circle cx="'+cx+'" cy="'+cy+'" r="'+(hole*rad)+'" fill="white" style="opacity:0"/>';
        // Filled donut
        var angle=Math.PI*2*(pct/100);
        var ex=cx+rad*Math.sin(angle);var ey=cy-rad*Math.cos(angle);
        var large=(pct>50)?1:0;
        svg+='<path d="M '+cx+' '+(cy-rad)+' A '+rad+' '+rad+' 0 '+large+' 1 '+ex+' '+ey+' L '+
          (cx+hole*rad*Math.sin(angle))+' '+(cy-hole*rad*Math.cos(angle))+' A '+(hole*rad)+' '+(hole*rad)+' 0 '+large+' 0 '+cx+' '+(cy-hole*rad)+' Z" '+
          'stroke="none" fill="'+cf+'"/>';
        if(v.options.showPercent!==false) svg+='<text x="'+cx+'" y="'+cy+'" dy="0.3em" class="dp-text">'+Math.round(pct)+'%</text>';
        svg+='</svg>';
        el.innerHTML=svg;
      }
    });

    reg('lineBar', {
      label:'Line + Bar',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'lineBar', title:'Line + Bar', show:true,
          mapping:{x:''}, measures:{bar:{colKey:'',agg:'none'},line:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'bar');ensureMeasure(v,'line');
        return '<div class="form">'
          + mappingField('X','x',ctx.cols,v.mapping.x,true)
          + measureField('Bar measure','bar',ctx.cols,v.measures.bar)
          + measureField('Line measure','line',ctx.cols,v.measures.line)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">Bar on left Y-axis, line on right Y-axis.</div>'; },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var bM=(v.measures||{}).bar||{};var lM=(v.measures||{}).line||{};
        if(!m.x||!bM.colKey){renderEmptyWithModebar(el, 'Map X and Bar measure.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var meas=[{colKey:bM.colKey,agg:bM.agg,asKey:'__bar'}];
        if(lM.colKey) meas.push({colKey:lM.colKey,agg:lM.agg,asKey:'__line'});
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.x],measures:meas},[]);
        var xs=[],bv=[],lv=[];
        for(var i=0;i<data.length;i++){xs.push(asString(data[i][m.x]));bv.push(toNumber(data[i].__bar)||0);if(lM.colKey)lv.push(toNumber(data[i].__line)||0);}
        var traces=[{type:'bar',name:bM.colKey||'Bar',x:xs,y:bv}];
        if(lM.colKey&&lv.length){traces.push({type:'scatter',mode:'lines+markers',name:lM.colKey||'Line',x:xs,y:lv,yaxis:'y2'});}
        var th=plotTheme();
        var layout=layoutBase({margin:{l:48,r:48,t:4,b:42},barmode:'group',
          yaxis2:{overlaying:'y',side:'right',showgrid:false,gridcolor:th.grid,zerolinecolor:th.grid,automargin:true}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('radar', {
      label:'Radar / Spider',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'radar', title:'Radar', show:true,
          mapping:{theta:'',series:[]}, measures:{r:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{fill:true}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'r');
        return '<div class="form">'
          + mappingField('Theta (categories)','theta',ctx.cols,v.mapping.theta,true)
          + mappingFieldMulti('Series','series',ctx.cols,v.mapping.series,true)
          + measureField('R (value)','r',ctx.cols,v.measures.r)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form"><div class="lbl">Fill area</div><div><label class="note"><input data-opt="fill" type="checkbox" '+(v.options.fill!==false?'checked':'')+' /> Show filled area</label></div></div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var rM=(v.measures||{}).r||{};
        if(!m.theta||!rM.colKey){renderEmptyWithModebar(el, 'Map Theta and R.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var seriesArr=Array.isArray(m.series)?m.series.filter(Boolean):(m.series?[m.series]:[]);
        var seriesKey=seriesArr.length===1?seriesArr[0]:(seriesArr.length>1?'__sComp':'');
        var gb=[m.theta];if(seriesKey)gb.push(seriesKey);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:gb,measures:[{colKey:rM.colKey,agg:rM.agg,asKey:'__r'}]},[]);
        if(seriesArr.length>1){for(var ri=0;ri<data.length;ri++){var ps=[];for(var sk=0;sk<seriesArr.length;sk++)ps.push(asString(data[ri][seriesArr[sk]]));data[ri].__sComp=ps.join(' \u2022 ');}}
        var bySeries=Object.create(null);
        for(var i=0;i<data.length;i++){var r=data[i];var name=seriesKey?asString(r[seriesKey]):'Data';(bySeries[name]=bySeries[name]||{th:[],rv:[]}).th.push(asString(r[m.theta]));bySeries[name].rv.push(toNumber(r.__r)||0);}
        var traces=[];var doFill=v.options.fill!==false;
        Object.keys(bySeries).forEach(function(name){
          var d=bySeries[name];
          traces.push({type:'scatterpolar',mode:'lines+markers',name:name,theta:d.th,r:d.rv,fill:doFill?'toself':'none'});
        });
        Plotly.newPlot(el,traces,layoutBase({polar:{radialaxis:{visible:true,gridcolor:plotTheme().grid},angularaxis:{gridcolor:plotTheme().grid}},margin:{l:48,r:48,t:34,b:34},showlegend:true}),plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    reg('candlestick', {
      label:'Candlestick',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'candlestick', title:'Candlestick', show:true,
          mapping:{x:''},
          measures:{open:{colKey:'',agg:'avg'},high:{colKey:'',agg:'max'},low:{colKey:'',agg:'min'},close:{colKey:'',agg:'avg'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'open');ensureMeasure(v,'high');ensureMeasure(v,'low');ensureMeasure(v,'close');
        return '<div class="form">'
          + mappingField('X (date/category)','x',ctx.cols,v.mapping.x,true)
          + measureField('Open','open',ctx.cols,v.measures.open)
          + measureField('High','high',ctx.cols,v.measures.high)
          + measureField('Low','low',ctx.cols,v.measures.low)
          + measureField('Close','close',ctx.cols,v.measures.close)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">Standard candlestick chart.</div>'; },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var ms=v.measures||{};
        if(!m.x||!(ms.open||{}).colKey||!(ms.close||{}).colKey){renderEmptyWithModebar(el, 'Map X, Open, High, Low, Close.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var meas=[{colKey:ms.open.colKey,agg:ms.open.agg,asKey:'__o'},{colKey:ms.high.colKey,agg:ms.high.agg||'max',asKey:'__h'},{colKey:ms.low.colKey,agg:ms.low.agg||'min',asKey:'__l'},{colKey:ms.close.colKey,agg:ms.close.agg,asKey:'__c'}];
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.x],measures:meas},[]);
        var xs=[],op=[],hi=[],lo=[],cl=[];
        for(var i=0;i<data.length;i++){xs.push(data[i][m.x]);op.push(toNumber(data[i].__o)||0);hi.push(toNumber(data[i].__h)||0);lo.push(toNumber(data[i].__l)||0);cl.push(toNumber(data[i].__c)||0);}
        Plotly.newPlot(el,[{type:'candlestick',x:xs,open:op,high:hi,low:lo,close:cl,increasing:{line:{color:'#16a34a'}},decreasing:{line:{color:'#dc2626'}}}],
          layoutBase({margin:{l:48,r:18,t:34,b:42},xaxis:{rangeslider:{visible:false}}}),plotlyCfg(v));
      }
    });

    reg('ohlc', {
      label:'OHLC',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'ohlc', title:'OHLC', show:true,
          mapping:{x:''},
          measures:{open:{colKey:'',agg:'avg'},high:{colKey:'',agg:'max'},low:{colKey:'',agg:'min'},close:{colKey:'',agg:'avg'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'open');ensureMeasure(v,'high');ensureMeasure(v,'low');ensureMeasure(v,'close');
        return '<div class="form">'
          + mappingField('X (date/category)','x',ctx.cols,v.mapping.x,true)
          + measureField('Open','open',ctx.cols,v.measures.open)
          + measureField('High','high',ctx.cols,v.measures.high)
          + measureField('Low','low',ctx.cols,v.measures.low)
          + measureField('Close','close',ctx.cols,v.measures.close)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">Standard OHLC chart.</div>'; },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var ms=v.measures||{};
        if(!m.x||!(ms.open||{}).colKey||!(ms.close||{}).colKey){renderEmptyWithModebar(el, 'Map X, Open, High, Low, Close.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var meas=[{colKey:ms.open.colKey,agg:ms.open.agg,asKey:'__o'},{colKey:ms.high.colKey,agg:ms.high.agg||'max',asKey:'__h'},{colKey:ms.low.colKey,agg:ms.low.agg||'min',asKey:'__l'},{colKey:ms.close.colKey,agg:ms.close.agg,asKey:'__c'}];
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.x],measures:meas},[]);
        var xs=[],op=[],hi=[],lo=[],cl=[];
        for(var i=0;i<data.length;i++){xs.push(data[i][m.x]);op.push(toNumber(data[i].__o)||0);hi.push(toNumber(data[i].__h)||0);lo.push(toNumber(data[i].__l)||0);cl.push(toNumber(data[i].__c)||0);}
        Plotly.newPlot(el,[{type:'ohlc',x:xs,open:op,high:hi,low:lo,close:cl,increasing:{line:{color:'#16a34a'}},decreasing:{line:{color:'#dc2626'}}}],
          layoutBase({margin:{l:48,r:18,t:34,b:42},xaxis:{rangeslider:{visible:false}}}),plotlyCfg(v));
      }
    });

    reg('multiAxis', {
      label:'Multi Y-Axis',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'multiAxis', title:'Multi Y', show:true,
          mapping:{x:''}, measures:{y1:{colKey:'',agg:'none'},y2:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{y1type:'line',y2type:'line'}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'y1');ensureMeasure(v,'y2');
        return '<div class="form">'
          + mappingField('X','x',ctx.cols,v.mapping.x,true)
          + measureField('Y1 (left axis)','y1',ctx.cols,v.measures.y1)
          + measureField('Y2 (right axis)','y2',ctx.cols,v.measures.y2)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Y1 chart type</div><div><select data-opt="y1type"><option value="line" '+(v.options.y1type!=='bar'?'selected':'')+'>Line</option><option value="bar" '+(v.options.y1type==='bar'?'selected':'')+'>Bar</option></select></div>'
          + '<div class="lbl">Y2 chart type</div><div><select data-opt="y2type"><option value="line" '+(v.options.y2type!=='bar'?'selected':'')+'>Line</option><option value="bar" '+(v.options.y2type==='bar'?'selected':'')+'>Bar</option></select></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};var y1M=(v.measures||{}).y1||{};var y2M=(v.measures||{}).y2||{};
        if(!m.x||!y1M.colKey){renderEmptyWithModebar(el, 'Map X and at least Y1.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var meas=[{colKey:y1M.colKey,agg:y1M.agg,asKey:'__y1'}];
        if(y2M.colKey) meas.push({colKey:y2M.colKey,agg:y2M.agg,asKey:'__y2'});
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.x],measures:meas},[]);
        var xs=[],v1=[],v2=[];
        for(var i=0;i<data.length;i++){xs.push(asString(data[i][m.x]));v1.push(toNumber(data[i].__y1)||0);if(y2M.colKey)v2.push(toNumber(data[i].__y2)||0);}
        var t1Type=v.options.y1type==='bar'?'bar':'scatter';
        var t2Type=v.options.y2type==='bar'?'bar':'scatter';
        var traces=[{type:t1Type,name:y1M.colKey||'Y1',x:xs,y:v1}];
        if(t1Type==='scatter') traces[0].mode='lines+markers';
        if(y2M.colKey&&v2.length){
          var tr2={type:t2Type,name:y2M.colKey||'Y2',x:xs,y:v2,yaxis:'y2'};
          if(t2Type==='scatter') tr2.mode='lines+markers';
          traces.push(tr2);
        }
        var th=plotTheme();
        var layout=layoutBase({margin:{l:48,r:48,t:4,b:42},
          yaxis2:{overlaying:'y',side:'right',showgrid:false,gridcolor:th.grid,zerolinecolor:th.grid,automargin:true}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    // --- Implemented: regHist ---
    reg('regHist', {
      label:'Regression (Linear/Poly2 + Histogram)',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'regHist', title:'Regression', show:true,
          mapping:{}, measures:{x:{colKey:'',agg:'none'}, y:{colKey:'',agg:'none'}},
          transform:defaultTransform('raw'), filter:defaultFilter(),
          options:{mode:'scatter', showTrend:true, trendMethod:'linear', showHist:false}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'x'); ensureMeasure(v,'y');
        return '<div class="form">'
          + measureField('X (independent)','x',ctx.cols,v.measures.x)
          + measureField('Y (dependent)','y',ctx.cols,v.measures.y)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Mode</div><div><select data-opt="mode">'
          + '<option value="scatter" '+(v.options.mode==='scatter'?'selected':'')+'>Scatter</option>'
          + '<option value="histogram" '+(v.options.mode==='histogram'?'selected':'')+'>Histogram (Y)</option>'
          + '</select></div>'
          + '<div class="lbl">Show trend line</div><div><label class="note"><input data-opt="showTrend" type="checkbox" '+(v.options.showTrend!==false?'checked':'')+'> Overlay regression</label></div>'
          + '<div class="lbl">Trend method</div><div><select data-opt="trendMethod">'
          + '<option value="linear" '+(v.options.trendMethod==='linear'?'selected':'')+'>Linear</option>'
          + '<option value="poly2" '+(v.options.trendMethod==='poly2'?'selected':'')+'>Quadratic</option>'
          + '</select></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var xM=(v.measures||{}).x||{}; var yM=(v.measures||{}).y||{};
        if(!xM.colKey||!yM.colKey){renderEmptyWithModebar(el, 'Map X and Y measures.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        if(ctx.sections.enabled && ctx.sections.splitCol){
          var sec=ctx.sections.current; if(sec&&sec!=='All') filtered=filtered.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }
        var xs=[],ys=[];
        for(var i=0;i<filtered.length;i++){
          var xv=toNumber(filtered[i][xM.colKey]), yv=toNumber(filtered[i][yM.colKey]);
          if(xv!=null && yv!=null){xs.push(xv);ys.push(yv);}
        }
        if(!xs.length){renderEmptyWithModebar(el, 'No numeric data.', v);return;}

        var mode = v.options.mode||'scatter';
        var th=plotTheme();
        var traces=[];

        if(mode==='histogram'){
          traces.push({type:'histogram', x:ys, nbinsx:30, marker:{color:th.accent, opacity:0.7}, name:yM.colKey});
        }else{
          traces.push({type:'scatter', mode:'markers', x:xs, y:ys, marker:{size:5, color:th.accent, opacity:0.7}, name:'Data'});
          if(v.options.showTrend!==false && xs.length>=2){
            // Simple linear regression
            var n=xs.length, sx=0,sy=0,sxx=0,sxy=0;
            for(var j=0;j<n;j++){sx+=xs[j];sy+=ys[j];sxx+=xs[j]*xs[j];sxy+=xs[j]*ys[j];}
            var denom=n*sxx-sx*sx;
            if(Math.abs(denom)>1e-15){
              var slope=(n*sxy-sx*sy)/denom;
              var intercept=(sy-slope*sx)/n;
              var xMin=Math.min.apply(null,xs), xMax=Math.max.apply(null,xs);
              var lineX=[], lineY=[];
              for(var p=0;p<=50;p++){
                var xp=xMin+p*(xMax-xMin)/50;
                lineX.push(xp);
                if(v.options.trendMethod==='poly2'){
                  // quick poly2 via normal equations not trivial; fallback to linear
                  lineY.push(slope*xp+intercept);
                }else{
                  lineY.push(slope*xp+intercept);
                }
              }
              // R�
              var yMean=sy/n, ssTot=0, ssRes=0;
              for(var q=0;q<n;q++){var pred=slope*xs[q]+intercept;ssTot+=(ys[q]-yMean)*(ys[q]-yMean);ssRes+=(ys[q]-pred)*(ys[q]-pred);}
              var r2= ssTot>0 ? 1-ssRes/ssTot : 0;

              traces.push({type:'scatter', mode:'lines', x:lineX, y:lineY,
                line:{color:th.accent2, width:2.5, dash:'dash'},
                name:'Trend (R�='+r2.toFixed(3)+')'});
            }
          }
        }
        var layout=layoutBase({margin:{l:48,r:16,t:4,b:42}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    // --- Implemented: correlation ---
    reg('correlation', {
      label:'Correlation Matrix',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'correlation', title:'Correlation', show:true,
          mapping:{cols:[]}, measures:{},
          transform:defaultTransform('raw'), filter:defaultFilter(), options:{colorscale:'RdBu'}};
      },
      buildMappingUI:function(v,ctx){
        v.mapping=v.mapping||{}; v.mapping.cols=Array.isArray(v.mapping.cols)?v.mapping.cols:[];
        return '<div class="form">'
          + mappingFieldMulti('Numeric columns', 'cols', ctx.cols, v.mapping.cols, false, 'Select 2+ numeric columns to compute Pearson correlation.')
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Color scale</div><div><select data-opt="colorscale">'
          + '<option value="RdBu" '+(v.options.colorscale==='RdBu'?'selected':'')+'>RdBu</option>'
          + '<option value="Viridis" '+(v.options.colorscale==='Viridis'?'selected':'')+'>Viridis</option>'
          + '<option value="Blues" '+(v.options.colorscale==='Blues'?'selected':'')+'>Blues</option>'
          + '<option value="Hot" '+(v.options.colorscale==='Hot'?'selected':'')+'>Hot</option>'
          + '</select></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var cols=Array.isArray(v.mapping.cols)&&v.mapping.cols.length?v.mapping.cols:[];
        if(cols.length<2){renderEmptyWithModebar(el, 'Select 2+ numeric columns.', v);return;}
        var filtered=applyFilter(rows,v.filter);

        // Extract numeric columns
        var data={};
        for(var c=0;c<cols.length;c++) data[cols[c]]=[];
        for(var i=0;i<filtered.length;i++){
          for(var c2=0;c2<cols.length;c2++){
            var nv=toNumber(filtered[i][cols[c2]]);
            data[cols[c2]].push(nv!=null?nv:0);
          }
        }
        // Compute correlation matrix
        var n=cols.length;
        var matrix=[];
        var annots=[];
        for(var r2=0;r2<n;r2++){
          matrix[r2]=[];
          for(var c3=0;c3<n;c3++){
            var a=data[cols[r2]], b=data[cols[c3]];
            var len=a.length, sa=0,sb=0,sa2=0,sb2=0,sab=0;
            for(var k=0;k<len;k++){sa+=a[k];sb+=b[k];sa2+=a[k]*a[k];sb2+=b[k]*b[k];sab+=a[k]*b[k];}
            var denom2=Math.sqrt((len*sa2-sa*sa)*(len*sb2-sb*sb));
            var corr = denom2>1e-15 ? (len*sab-sa*sb)/denom2 : 0;
            matrix[r2][c3]=Math.round(corr*1000)/1000;
            annots.push({x:cols[c3],y:cols[r2],text:corr.toFixed(2),showarrow:false,font:{size:11,color:Math.abs(corr)>0.5?'#fff':'var(--vm-text)'}});
          }
        }

        var trace={type:'heatmap', z:matrix, x:cols, y:cols, colorscale:v.options.colorscale||'RdBu', zmin:-1, zmax:1, showscale:true};
        var layout=layoutBase({margin:{l:80,r:16,t:4,b:80},annotations:annots});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,[trace],layout,plotlyCfg(v));
      }
    });

    // --- Implemented: pivot ---
    reg('pivot', {
      label:'Pivot Table',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'pivot', title:'Pivot Table', show:true,
          mapping:{row:'', col:''}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{heatColor:true}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + mappingField('Row header','row',ctx.cols,v.mapping.row,true)
          + mappingField('Column header','col',ctx.cols,v.mapping.col,true)
          + measureField('Value','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Heat color</div><div><label class="note"><input data-opt="heatColor" type="checkbox" '+(v.options.heatColor!==false?'checked':'')+'> Color intensity by value</label></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{}; var valM=(v.measures||{}).value||{};
        if(!m.row||!m.col||!valM.colKey){renderEmptyWithModebar(el, 'Map Row, Column, and Value.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.row,m.col],measures:[{colKey:valM.colKey,agg:valM.agg,asKey:'__v'}]});

        // Build pivot
        var rowKeys={}, colKeys={}, cells={};
        for(var i=0;i<data.length;i++){
          var rk=asString(data[i][m.row]), ck=asString(data[i][m.col]);
          rowKeys[rk]=1; colKeys[ck]=1;
          cells[rk+'|||'+ck]=toNumber(data[i].__v);
        }
        var rks=Object.keys(rowKeys).sort();
        var cks=Object.keys(colKeys).sort();

        // Find min/max for heat color
        var allVals=Object.values(cells).filter(function(x){return x!=null;});
        var vMin=Math.min.apply(null,allVals), vMax=Math.max.apply(null,allVals);

        var out='<div class="vm-table-wrap"><table class="vm-table"><thead><tr><th>'+escapeHtml(m.row)+' \\ '+escapeHtml(m.col)+'</th>';
        for(var ci=0;ci<cks.length;ci++) out+='<th>'+escapeHtml(cks[ci])+'</th>';
        out+='</tr></thead><tbody>';
        for(var ri=0;ri<rks.length;ri++){
          out+='<tr><td style="font-weight:600">'+escapeHtml(rks[ri])+'</td>';
          for(var cj=0;cj<cks.length;cj++){
            var cv=cells[rks[ri]+'|||'+cks[cj]];
            var s='';
            if(v.options.heatColor!==false && cv!=null && vMax>vMin){
              var pct=(cv-vMin)/(vMax-vMin);
              var r2=Math.round(255-(pct*100)), g2=Math.round(200+pct*55), b2=Math.round(255-(pct*80));
              s='background:rgba('+clamp(r2,0,255)+','+clamp(g2,0,255)+','+clamp(b2,0,255)+',0.4)';
            }
            out+='<td'+(s?' style="'+s+'"':'')+'>'+(cv!=null?cv.toLocaleString():'')+'</td>';
          }
          out+='</tr>';
        }
        out+='</tbody></table></div>';
        el.innerHTML=out;
      }
    });

    // --- Implemented: control ---
    reg('control', {
      label:'Control Chart (SPC)',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'control', title:'Control Chart', show:true,
          mapping:{x:''}, measures:{y:{colKey:'',agg:'none'}},
          transform:defaultTransform('raw'), filter:defaultFilter(), options:{sigma:3}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'y');
        return '<div class="form">'
          + mappingField('X (time/sequence)','x',ctx.cols,v.mapping.x,true)
          + measureField('Y (measure)','y',ctx.cols,v.measures.y)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Sigma (control limits)</div>'
          + '<div><input data-opt="sigma" type="number" min="1" max="6" step="0.5" value="'+(v.options.sigma||3)+'" style="width:80px" /></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{}; var yM=(v.measures||{}).y||{};
        if(!yM.colKey){renderEmptyWithModebar(el, 'Map Y to render.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        if(ctx.sections.enabled && ctx.sections.splitCol){
          var sec=ctx.sections.current; if(sec&&sec!=='All') filtered=filtered.filter(function(r){return asString(r[ctx.sections.splitCol])===sec;});
        }
        var xs=[], ys=[];
        for(var i=0;i<filtered.length;i++){
          xs.push(m.x?asString(filtered[i][m.x]):String(i+1));
          var yv=toNumber(filtered[i][yM.colKey]);
          ys.push(yv!=null?yv:0);
        }
        if(!ys.length){renderEmptyWithModebar(el, 'No data.', v);return;}

        var n=ys.length, sum=0;
        for(var j=0;j<n;j++) sum+=ys[j];
        var mean=sum/n;
        var sumSq=0;
        for(var k=0;k<n;k++) sumSq+=(ys[k]-mean)*(ys[k]-mean);
        var std=Math.sqrt(sumSq/n);
        var sigma=parseFloat(v.options.sigma)||3;
        var ucl=mean+sigma*std, lcl=mean-sigma*std;

        var th=plotTheme();
        var traces=[
          {type:'scatter', mode:'lines+markers', x:xs, y:ys, name:'Data', marker:{size:4,color:th.accent}},
          {type:'scatter', mode:'lines', x:[xs[0],xs[xs.length-1]], y:[mean,mean], name:'Mean ('+mean.toFixed(2)+')', line:{color:th.accent2,width:2}},
          {type:'scatter', mode:'lines', x:[xs[0],xs[xs.length-1]], y:[ucl,ucl], name:'UCL ('+ucl.toFixed(2)+')', line:{color:'#dc2626',width:1.5,dash:'dash'}},
          {type:'scatter', mode:'lines', x:[xs[0],xs[xs.length-1]], y:[lcl,lcl], name:'LCL ('+lcl.toFixed(2)+')', line:{color:'#dc2626',width:1.5,dash:'dash'}}
        ];
        // Mark out-of-control points
        var oocX=[],oocY=[];
        for(var p=0;p<n;p++){if(ys[p]>ucl||ys[p]<lcl){oocX.push(xs[p]);oocY.push(ys[p]);}}
        if(oocX.length){
          traces.push({type:'scatter',mode:'markers',x:oocX,y:oocY,name:'Out of control',marker:{size:8,color:'#dc2626',symbol:'x'}});
        }
        var layout=layoutBase({margin:{l:48,r:16,t:4,b:42}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
        bindLegendHover(el);
      }
    });

    // --- Implemented: gantt ---
    reg('gantt', {
      label:'Gantt Chart',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'gantt', title:'Gantt', show:true,
          mapping:{task:'', start:'', end:'', group:''}, measures:{},
          transform:defaultTransform('raw'), filter:defaultFilter(), options:{}};
      },
      buildMappingUI:function(v,ctx){
        return '<div class="form">'
          + mappingField('Task name','task',ctx.cols,v.mapping.task,true)
          + mappingField('Start date','start',ctx.cols,v.mapping.start,true)
          + mappingField('End date','end',ctx.cols,v.mapping.end,true)
          + mappingField('Group (color)','group',ctx.cols,v.mapping.group||'',true)
          + '</div>';
      },
      buildOptionsUI:function(){ return '<div class="note">No additional options.</div>'; },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{};
        if(!m.task||!m.start||!m.end){renderEmptyWithModebar(el, 'Map Task, Start, and End columns.', v);return;}
        var filtered=applyFilter(rows,v.filter);

        // Build horizontal bar chart as gantt
        var th=plotTheme();
        var colorMap={}, colorIdx=0;
        var defColors=['#0284c7','#7c3aed','#16a34a','#d97706','#dc2626','#0891b2','#db2777','#4f46e5'];
        var traces=[];
        var tasks=[], starts=[], durations=[], colors=[];

        for(var i=filtered.length-1;i>=0;i--){
          var r=filtered[i];
          var task=asString(r[m.task]);
          var s=new Date(r[m.start]);
          var e=new Date(r[m.end]);
          if(isNaN(s.getTime())||isNaN(e.getTime())) continue;
          var dur = (e-s)/(1000*60*60*24); // days
          var grp = m.group ? asString(r[m.group]) : 'Tasks';
          if(!colorMap[grp]) colorMap[grp]=defColors[colorIdx++%defColors.length];
          tasks.push(task);
          starts.push(s.toISOString().slice(0,10));
          durations.push(Math.max(dur,0.5));
          colors.push(colorMap[grp]);
        }

        if(!tasks.length){renderEmptyWithModebar(el, 'No valid date rows.', v);return;}

        traces.push({
          type:'bar', orientation:'h',
          y:tasks, x:durations, base:starts,
          marker:{color:colors, opacity:0.85},
          hovertemplate:'<b>%{y}</b><br>Start: %{base}<br>Duration: %{x:.1f} days<extra></extra>'
        });

        var layout=layoutBase({
          margin:{l:120,r:16,t:4,b:42},
          xaxis:{type:'date'},
          barmode:'overlay'
        });
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,traces,layout,plotlyCfg(v));
      }
    });

    // --- Implemented: calendarHeatmap ---
    reg('calendarHeatmap', {
      label:'Calendar Heatmap',
      implemented:true,
      defaultVisual:function(){
        return {id:uid(), type:'calendarHeatmap', title:'Calendar Heatmap', show:true,
          mapping:{date:''}, measures:{value:{colKey:'',agg:'none'}},
          transform:defaultTransform('aggregate'), filter:defaultFilter(), options:{colorscale:'YlOrRd'}};
      },
      buildMappingUI:function(v,ctx){
        ensureMeasure(v,'value');
        return '<div class="form">'
          + mappingField('Date column','date',ctx.cols,v.mapping.date,true)
          + measureField('Value','value',ctx.cols,v.measures.value)
          + '</div>';
      },
      buildOptionsUI:function(v){
        return '<div class="form">'
          + '<div class="lbl">Color scale</div><div><select data-opt="colorscale">'
          + '<option value="YlOrRd" '+(v.options.colorscale==='YlOrRd'?'selected':'')+'>YlOrRd</option>'
          + '<option value="Viridis" '+(v.options.colorscale==='Viridis'?'selected':'')+'>Viridis</option>'
          + '<option value="Blues" '+(v.options.colorscale==='Blues'?'selected':'')+'>Blues</option>'
          + '<option value="Greens" '+(v.options.colorscale==='Greens'?'selected':'')+'>Greens</option>'
          + '</select></div>'
          + '</div>';
      },
      render:function(v,rows,ctx,el){
        var m=v.mapping||{}; var valM=(v.measures||{}).value||{};
        if(!m.date||!valM.colKey){renderEmptyWithModebar(el, 'Map Date and Value.', v);return;}
        var filtered=applyFilter(rows,v.filter);
        var data=aggregateRows(filtered,{mode:'aggregate',groupBy:[m.date],measures:[{colKey:valM.colKey,agg:valM.agg,asKey:'__v'}]});

        // Parse dates and build heatmap-like scatter
        var dates=[], vals=[], texts=[];
        var dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        for(var i=0;i<data.length;i++){
          var d=new Date(data[i][m.date]);
          if(isNaN(d.getTime())) continue;
          var val=toNumber(data[i].__v)||0;
          // week number from start of year
          var jan1=new Date(d.getFullYear(),0,1);
          var week=Math.floor(((d-jan1)/(86400000)+jan1.getDay())/7);
          var dow=d.getDay();
          dates.push(d);
          vals.push(val);
          texts.push(d.toISOString().slice(0,10)+': '+val.toLocaleString());
        }

        // Use scatter with date on x, day-of-week on y, size/color = value
        var xDates=dates.map(function(d){return d.toISOString().slice(0,10);});
        var yDows=dates.map(function(d){return dayNames[d.getDay()];});

        var trace={
          type:'heatmap',
          x:xDates, y:yDows, z:[vals],
          colorscale:v.options.colorscale||'YlOrRd',
          showscale:true, hovertext:texts
        };

        // Better approach: scatter for calendar
        trace = {
          type:'scatter', mode:'markers',
          x:xDates, y:yDows,
          marker:{size:12, color:vals, colorscale:v.options.colorscale||'YlOrRd', showscale:true, colorbar:{thickness:15}},
          text:texts, hovertemplate:'%{text}<extra></extra>'
        };

        var layout=layoutBase({margin:{l:50,r:16,t:4,b:42},
          yaxis:{categoryorder:'array', categoryarray:['Sat','Fri','Thu','Wed','Tue','Mon','Sun']}});
        if(v.title){layout.margin.t=4;}
        Plotly.newPlot(el,[trace],layout,plotlyCfg(v));
      }
    });

    function registryTypes(){
      return Object.keys(Registry).sort(function(a,b){
        var A=Registry[a].label||a, B=Registry[b].label||b;
        return A.localeCompare(B);
      });
    }

    // --- Legend hover highlight (v2 parity) ---
    function legendTraceIndicesForLegendHover(gd){
      var d = (gd && Array.isArray(gd.data)) ? gd.data : [];
      if(!d.length) return null;
      var idx=[];
      for(var i=0;i<d.length;i++){
        var tr=d[i];
        if(!tr) continue;
        var t=String(tr.type||'scatter');
        var eligible=(t==='bar' || t==='scatter' || t==='scattergl');
        if(!eligible) continue;
        var show = (tr.showlegend!==false) && (tr.visible!==false) && (tr.name!=null && String(tr.name)!=='');
        if(!show) continue;
        idx.push(i);
      }
      if(idx.length<2 || idx.length>60) return null;
      return idx;
    }

    function snapshotLegendHoverStyles(gd, idxs){
      var d = (gd && Array.isArray(gd.data)) ? gd.data : [];
      var snap={
        idxs: idxs.slice(),
        opacity: [],
        lineWidth: [],
        markerSize: [],
        markerLineWidth: [],
        markerLineColor: []
      };
      var scalarNumOrNull=function(v){ return (typeof v==='number' && Number.isFinite(v)) ? v : null; };
      for(var k=0;k<idxs.length;k++){
        var i=idxs[k];
        var tr=d[i]||{};
        snap.opacity.push((typeof tr.opacity==='number' && Number.isFinite(tr.opacity)) ? tr.opacity : 1);
        snap.lineWidth.push(scalarNumOrNull(tr&&tr.line&&tr.line.width));
        
        var ms = tr&&tr.marker&&tr.marker.size;
        snap.markerSize.push(Array.isArray(ms) ? null : scalarNumOrNull(ms));
        
        var mlw = tr&&tr.marker&&tr.marker.line&&tr.marker.line.width;
        snap.markerLineWidth.push(Array.isArray(mlw) ? null : scalarNumOrNull(mlw));
        var mlc = tr&&tr.marker&&tr.marker.line&&tr.marker.line.color;
        snap.markerLineColor.push((mlc==null) ? null : String(mlc));
      }
      return snap;
    }

    function legendTraceHighlight(gd, curveNumber){
      try{
        var idxs = legendTraceIndicesForLegendHover(gd);
        if(!idxs) return;

        var idx = Number.isFinite(curveNumber) ? curveNumber : null;
        if(idx==null || !gd.data || !gd.data[idx]) return;
        if(idxs.indexOf(idx)===-1) return;

        var now=Date.now();
        if(gd.__legendHoverLastIdx===idx && gd.__legendHoverLastTs && (now-gd.__legendHoverLastTs)<40) return;
        gd.__legendHoverLastIdx=idx;
        gd.__legendHoverLastTs=now;

        if(gd.__legendDimActive) legendTraceReset(gd);

        var hi = '#f59e0b';
        var snap = snapshotLegendHoverStyles(gd, idxs);
        gd.__legendDimActive=true;
        gd.__legendDimSnapshot=snap;
        Plotly.restyle(gd, {opacity:0.22}, idxs);

        var tr = gd.data[idx] || {};
        var t=String(tr.type||'scatter');
        var pos=snap.idxs.indexOf(idx);
        var upd={opacity:1};
        if(t==='bar'){
          upd['marker.line.width']=2.5;
          upd['marker.line.color']=hi;
        }else{
          var mode=String(tr.mode||'');
          if(mode.indexOf('lines')>=0){
            var base = (pos>=0 && typeof snap.lineWidth[pos]==='number') ? snap.lineWidth[pos] : (tr&&tr.line&&typeof tr.line.width==='number' ? tr.line.width : 2);
            upd['line.width']=Math.min(10, Math.max(2.8, (base||2)+1.6));
          }
          if(mode.indexOf('markers')>=0){
            var baseS = (pos>=0 && typeof snap.markerSize[pos]==='number') ? snap.markerSize[pos] : null;
            if(baseS!=null) upd['marker.size']=Math.min(22, Math.max(8, baseS+3));
            var baseLW = (pos>=0 && typeof snap.markerLineWidth[pos]==='number') ? snap.markerLineWidth[pos] : (tr&&tr.marker&&tr.marker.line&&typeof tr.marker.line.width==='number' ? tr.marker.line.width : null);
            if(baseLW!=null) upd['marker.line.width']=Math.min(6, Math.max(2.2, baseLW+0.8));
            if(tr&&tr.marker&&tr.marker.line) upd['marker.line.color']=hi;
          }
        }
        Plotly.restyle(gd, upd, [idx]);
      }catch(e){ /* ignore */ }
    }

    function legendTraceReset(gd){
      try{
        var snap = gd && gd.__legendDimSnapshot;
        if(!gd || !gd.__legendDimActive || !snap || !Array.isArray(snap.idxs)) return;
        Plotly.restyle(gd, {
          opacity: snap.opacity,
          'line.width': snap.lineWidth,
          'marker.size': snap.markerSize,
          'marker.line.width': snap.markerLineWidth,
          'marker.line.color': snap.markerLineColor
        }, snap.idxs);
        gd.__legendDimActive=false;
        gd.__legendDimSnapshot=null;
      }catch(e){ /* ignore */ }
    }

    function bindLegendHover(gd){
      if(!gd) return;
      /* Use direct DOM manipulation like LineTrend_v2 for reliability */
      var nodes = gd.querySelectorAll('.infolayer .legend .traces, .legend .traces');
      if(!nodes || !nodes.length) return;
      
      var d = gd.data || [];
      var legendTraceIdx = [];
      for(var i=0; i<d.length; i++){
        var tr = d[i];
        if(!tr) continue;
        var show = (tr.showlegend !== false) && (tr.visible !== false) && (tr.name != null && String(tr.name) !== '');
        if(show) legendTraceIdx.push(i);
      }
      
      nodes.forEach(function(node, i){
        try{
          var traceIdx = (i < legendTraceIdx.length) ? legendTraceIdx[i] : null;
          var tr = (traceIdx == null) ? null : d[traceIdx];
          var t = tr ? String(tr.type || 'scatter') : '';
          var eligible = (traceIdx != null) && (t === 'bar' || t === 'scatter' || t === 'scattergl' || t === 'box' || t === 'line');
          if(!eligible){
            node.onmouseenter = null;
            node.onmouseleave = null;
            return;
          }
          node.onmouseenter = function(){ legendTraceHighlight(gd, traceIdx); };
          node.onmouseleave = function(){ legendTraceReset(gd); };
        }catch(e){ /* ignore */ }
      });
    }

    // ---------------------------
    // App state
    // ---------------------------
    var STORAGE_KEY = 'vm-visual-manager-v1';

    function defaultState(){
      return {
        globals:{
          title: pvStr('data-report-title', 'Visual Manager'),
          subtitle: pvStr('data-report-subtitle', ''),
          theme: PV_THEME_DEFAULT,
          visualsPerRow: clamp(pvInt('data-visuals-per-row', 2), 1, 6),
          gridGap: clamp(pvInt('data-grid-gap', 10), 0, 40),
          cardHeight: clamp(pvInt('data-card-height', 320), 180, 1400),
          topGap: clamp(pvInt('data-top-gap', 6), 0, 30),
          sectionGap: clamp(pvInt('data-section-gap', 4), 0, 30),
          layoutMode: 'auto',
          customGrid: { cols: 6, rowHeight: 80, gridWidth: 0, gridHeight: 0, tiles: [] },
          gridBgColor: '',
          cardBorderColor: '',
          cardBorderRadius: 14,
          modebarIcons: {}
        },
        sections:{
          enabled:false,
          splitCol:'',
          current:'All'
        },
        data:{
          jsonText:''
        },
        visuals: []
      };
    }

    var STATE = defaultState();

    function loadState(){
      if(!PERSISTENCE_ENABLED) return;
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        var obj = JSON.parse(raw);
        if(obj && typeof obj==='object') STATE = obj;
      }catch(e){}
    }
    var _saveTimer = null;
    function saveState(){
      if(!PERSISTENCE_ENABLED) return;
      if(_saveTimer) clearTimeout(_saveTimer);
      _saveTimer = setTimeout(function(){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); }catch(e){}
      }, 500);
    }

    function ensureVisualDefaults(v){
      var def = Registry[v.type];
      if(!def) return v;
      var base = def.defaultVisual();
      // shallow merge preserving ids and user choices
      v.id = v.id || base.id;
      v.title = (v.title!=null)?v.title:base.title;
      v.show = (typeof v.show==='boolean')?v.show:true;
      v.showTitle = (typeof v.showTitle==='boolean')?v.showTitle:true;
      v.mapping = v.mapping || base.mapping || {};
      v.measures = v.measures || base.measures || {};
      v.options = v.options || base.options || {};
      v.transform = v.transform || base.transform || defaultTransform('raw');
      v.filter = v.filter || base.filter || defaultFilter();
      v.layout = v.layout || base.layout || {};
      return v;
    }

    /* --- Custom modebar icon paths (V2 template style) --- */
    var _I = function(p){ return {width:1000, height:1000, path:p}; };
    var vmIcons = {
      reset:    _I('M500 150 L900 450 V850 H650 V600 H350 V850 H100 V450 Z'),
      view:     _I('M160 820 H860 V860 H160 Z M220 820 V520 H300 V820 Z M360 820 V420 H440 V820 Z M500 820 V600 H580 V820 Z M210 520 L400 380 L540 560 L760 260'),
      table:    _I('M160 200 H840 V800 H160 Z M160 320 H840 M160 480 H840 M160 640 H840 M360 200 V800 M560 200 V800'),
      points:   _I('M200 500 A40 40 0 1 0 199 500 Z M400 500 A40 40 0 1 0 399 500 Z M600 500 A40 40 0 1 0 599 500 Z M800 500 A40 40 0 1 0 799 500 Z'),
      filter:   _I('M200 200 H800 L600 520 V800 H400 V520 Z'),
      remove:   _I('M260 260 L740 740 M740 260 L260 740'),
      status:   _I('M180 720 L420 520 L620 600 L820 300 M220 740 A30 30 0 1 0 221 740 M420 520 A30 30 0 1 0 421 520 M620 600 A30 30 0 1 0 621 600'),
      yAxis:    _I('M220 800 H860 M220 800 V200 M220 200 L160 260 M220 200 L280 260 M420 800 V360 M420 360 L360 420 M420 360 L480 420 M620 800 V520 M620 520 L560 580 M620 520 L680 580'),
      targets:  _I('M200 720 H800 M200 280 H800 M180 720 L220 720 M180 280 L220 280'),
      zoom:     _I('M420 200 A220 220 0 1 0 420 640 A220 220 0 1 0 420 200 Z M580 580 L820 820'),
      theme:    _I('M700 500 A200 200 0 1 1 300 500 A200 200 0 1 0 700 500 Z M500 100 A400 400 0 1 0 900 500 A250 250 0 0 1 500 100 Z'),
      download: _I('M500 180 V720 M500 720 L420 640 M500 720 L580 640'),
      fs:       _I('M140 180 L140 140 L380 140 L380 180 L180 180 L180 380 L140 380 Z M620 140 L860 140 L860 380 L820 380 L820 180 L620 180 Z M140 620 L180 620 L180 820 L380 820 L380 860 L140 860 Z M820 620 L860 620 L860 860 L620 860 L620 820 L820 820 Z'),
      settings: _I('M500 200 A300 300 0 1 0 500 800 A300 300 0 1 0 500 200 Z M500 350 A150 150 0 1 0 500 650 A150 150 0 1 0 500 350 Z M500 140 L540 220 L460 220 Z M580 180 L620 260 L560 300 Z M720 260 L760 340 L680 360 Z M800 400 L840 480 L760 520 Z M820 560 L840 640 L760 640 Z M800 720 L780 800 L720 760 Z M680 840 L640 900 L620 820 Z M540 900 L500 960 L460 900 Z M420 900 L380 840 L440 820 Z M300 840 L260 780 L340 760 Z M220 720 L180 640 L280 620 Z M180 560 L160 480 L240 480 Z M200 400 L180 320 L280 320 Z M260 260 L300 180 L340 240 Z')
    };

    // Modern toolbar icons (stroke-based SVG)
    var vmTbSvgs = {
      home: '<svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h5v-6h4v6h5V10"/></svg>',
      points: '<svg viewBox="0 0 24 24"><path d="M4 7h16"/><circle cx="7" cy="7" r="2"/><circle cx="12" cy="7" r="2"/><circle cx="17" cy="7" r="2"/><path d="M4 17h16"/><circle cx="7" cy="17" r="1.4"/><circle cx="12" cy="17" r="1.4"/><circle cx="17" cy="17" r="1.4"/></svg>',
      filter: '<svg viewBox="0 0 24 24"><path d="M4 5h16l-6 7v6l-4 1v-7z"/></svg>',
      status: '<svg viewBox="0 0 24 24"><path d="M4 18V6"/><path d="M4 18h16"/><path d="M7 14l3-3 3 2 4-5"/></svg>',
      yaxis: '<svg viewBox="0 0 24 24"><path d="M6 4v16"/><path d="M6 20h14"/><path d="M10 7h8"/><path d="M10 12h6"/><path d="M10 17h4"/></svg>',
      targets: '<svg viewBox="0 0 24 24"><path d="M4 7h16"/><path d="M4 12h10"/><path d="M4 17h16"/><circle cx="18" cy="12" r="2"/></svg>',
      zoommenu: '<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.2-4.2"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>',
      zoom: '<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.2-4.2"/></svg>',
      pan: '<svg viewBox="0 0 24 24"><path d="M12 2v20"/><path d="M2 12h20"/></svg>',
      select: '<svg viewBox="0 0 24 24"><path d="M4 4h6"/><path d="M4 4v6"/><path d="M20 4h-6"/><path d="M20 4v6"/><path d="M4 20h6"/><path d="M4 20v-6"/><path d="M20 20h-6"/><path d="M20 20v-6"/></svg>',
      lasso: '<svg viewBox="0 0 24 24"><path d="M7 7c-2 2-2 8 2 10s9-1 9-5-5-7-9-5"/><path d="M6 18c-1 1-1 3 1 4s4 0 5-1"/></svg>',
      autoscale: '<svg viewBox="0 0 24 24"><path d="M4 7V4h3"/><path d="M20 7V4h-3"/><path d="M4 17v3h3"/><path d="M20 17v3h-3"/><path d="M7 4l-3 3"/><path d="M17 4l3 3"/><path d="M7 20l-3-3"/><path d="M17 20l3-3"/></svg>',
      legend: '<svg viewBox="0 0 24 24"><path d="M4 6h10"/><path d="M4 12h16"/><path d="M4 18h13"/><circle cx="18" cy="6" r="2"/></svg>',
      export: '<svg viewBox="0 0 24 24"><path d="M12 3v10"/><path d="M8 7l4-4 4 4"/><path d="M5 14v6h14v-6"/></svg>',
      remove: '<svg viewBox="0 0 24 24"><path d="M6 7h12"/><path d="M9 7V5h6v2"/><path d="M8 7l1 14h6l1-14"/><path d="M10 11h4"/></svg>',
      settings: '<svg viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a7.8 7.8 0 0 0 .1-1l2-1.2-2-3.4-2.3.6a7.6 7.6 0 0 0-.8-.6l-.3-2.4H9.9l-.3 2.4c-.3.2-.6.4-.8.6l-2.3-.6-2 3.4 2 1.2a7.8 7.8 0 0 0 0 2l-2 1.2 2 3.4 2.3-.6c.3.2.5.4.8.6l.3 2.4h4.2l.3-2.4c.3-.2.6-.4.8-.6l2.3.6 2-3.4-2-1.2z"/></svg>',
      fs: '<svg viewBox="0 0 24 24"><path d="M8 3H3v5"/><path d="M16 3h5v5"/><path d="M8 21H3v-5"/><path d="M16 21h5v-5"/></svg>',
      more: '<svg viewBox="0 0 24 24"><circle cx="6" cy="12" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="18" cy="12" r="1.5"/></svg>'
    };

    function vmTbBtn(act, title, vid, isToggle){
      var p = isToggle ? ' aria-pressed="false"' : '';
      return '<button class="vm-tb-btn" data-act="'+escapeHtml(act)+'" data-vid="'+escapeHtml(vid)+'" title="'+escapeHtml(title)+'"'+p+'>'+(vmTbSvgs[act]||'<span class="vm-dot"></span>')+'</button>';
    }

    /* Helper: Reset table sorting and filter */
    function vmResetTable(vid){
      if(!STATE || !STATE.visuals) return;
      for(var i=0; i<STATE.visuals.length; i++){
        var v = STATE.visuals[i];
        if(v && v.id === vid && v.type === 'table'){
          /* Reset sorting */
          if(v.options){
            v.options.sortCol = '';
            v.options.sortDir = 'asc';
          }
          /* Reset filter */
          v.filter = defaultFilter();
          saveState();
          renderGrid();
          return;
        }
      }
    }
    
    /* Helper: Download table as CSV */
    function vmDownloadTableCSV(vid){
      if(!STATE || !STATE.visuals) return;
      var v = null;
      for(var i=0; i<STATE.visuals.length; i++){
        if(STATE.visuals[i] && STATE.visuals[i].id === vid){
          v = STATE.visuals[i];
          break;
        }
      }
      if(!v || v.type !== 'table') return;
      
      /* Get filtered data */
      var rows = (STATE && STATE.data) ? STATE.data : [];
      var filtered = applyFilter(rows, v.filter);
      if(!filtered.length) return;
      
      /* Get columns */
      var cols = (v.mapping && Array.isArray(v.mapping.cols) && v.mapping.cols.length)
        ? v.mapping.cols
        : Object.keys(filtered[0]||{});
      if(!cols.length) return;
      
      /* Build CSV */
      var csv = '';
      /* Header row */
      csv += cols.map(function(c){ return '"' + String(c||'').replace(/"/g, '""') + '"'; }).join(',') + '\n';
      /* Data rows */
      for(var r=0; r<filtered.length; r++){
        var row = filtered[r]||{};
        csv += cols.map(function(c){
          var val = row[c];
          if(val == null) return '';
          return '"' + String(val).replace(/"/g, '""') + '"';
        }).join(',') + '\n';
      }
      
      /* Download */
      var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      var link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = (v.title || 'table') + '.csv';
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    /* Default set of modebar icons (all enabled). Keys match vmIcons above. */
    var VM_DEFAULT_MODEBAR_ICONS = ['reset','points','filter','zoom','remove','download','fs','settings'];

    function allowedModebarIconsForType(type){
      /* Return list of icon keys that apply to this visual type */
      var t = String(type || '');
      var cartesianTypes = ['line','bar','scatter','histogram','box','stackedArea','stackedBar','lineBar','waterfall'];
      var allCharts = ['line','bar','pie','scatter','histogram','box','heatmap','waterfall','treemap','donut','funnel','sunburst','bubble','stackedArea','stackedBar','lineBar','radar','candlestick','ohlc','multiAxis','boxPlot','regHist','control','gantt','calendarHeatmap'];
      var kpiTypes = ['kpi','gauge','bullet','progress','scorecard','gaugePercent','donutPercent'];
      var dataTypes = ['table','pivot'];
      
      if(dataTypes.indexOf(t) >= 0){
        /* Table/Pivot: reset, download, fs, settings */
        return ['reset','download','fs','settings'];
      }
      if(kpiTypes.indexOf(t) >= 0){
        /* KPI visuals: minimal modebar */
        return ['download','fs','settings'];
      }
      if(cartesianTypes.indexOf(t) >= 0){
        /* Full modebar for cartesian */
        return ['reset','points','filter','zoom','remove','download','fs','settings'];
      }
      if(allCharts.indexOf(t) >= 0){
        /* Other charts: moderate modebar */
        return ['reset','download','fs','settings'];
      }
      /* Default: reasonable subset */
      return ['reset','download','fs','settings'];
    }

    function getVisualModebarIcons(v){
      var opts = (v && v.options) ? v.options : {};
      var gMb = (STATE && STATE.globals && STATE.globals.modebarIcons) ? STATE.globals.modebarIcons : {};
      var vMb = (opts.modebarIcons && typeof opts.modebarIcons === 'object') ? opts.modebarIcons : null;
      var allowed = allowedModebarIconsForType(v && v.type);
      var result = [];
      for(var i=0;i<VM_DEFAULT_MODEBAR_ICONS.length;i++){
        var k = VM_DEFAULT_MODEBAR_ICONS[i];
        /* Check if icon is allowed for this type */
        if(allowed.indexOf(k) < 0) continue;
        /* Settings icon respects SHOW_VISUAL_SETTINGS_ICON parameter */
        if(k === 'settings' && !SHOW_VISUAL_SETTINGS_ICON) continue;
        /* Per-visual override takes priority, then global, then default (all on) */
        var enabled = true;
        if(gMb[k] === false) enabled = false;
        if(vMb && vMb[k] === false) enabled = false;
        if(vMb && vMb[k] === true) enabled = true;
        if(enabled) result.push(k);
      }
      return result;
    }

    function plotlyCfg(v){
      // Keep Plotly native modebar OFF. We render a custom per-visual toolbar in the card header
      // and map actions to Plotly APIs so the UI stays consistent across OAS versions/browsers.
      return {
        displayModeBar: false,
        displaylogo: false,
        responsive: true,
        scrollZoom: false,
        doubleClick: 'reset'
      };
    }


    function isCartesianType(type){
      var t = String(type||'');
      return ['line','bar','scatter','histogram','box','heatmap','waterfall','stackedArea','stackedBar','lineBar','boxPlot','regHist','control','multiAxis','candlestick','ohlc','bubble'].indexOf(t)>=0;
    }

    function bizButtonsHtml(v){
      var vid = (v && v.id) ? String(v.id) : '';
      var html = '';
      var icons = getVisualModebarIcons(v);
      html += '<div class="vm-vtb" data-vid="'+escapeHtml(vid)+'">';
      if(icons.indexOf('reset')>=0) html += vmTbBtn('home','Reset',vid);
      if(icons.indexOf('points')>=0) html += vmTbBtn('points','Points / Labels / Styles',vid);
      if(icons.indexOf('filter')>=0) html += vmTbBtn('filter','Outliers',vid);
      if(icons.indexOf('zoom')>=0) html += vmTbBtn('zoommenu','Zoom controls',vid);
      if(icons.indexOf('remove')>=0) html += vmTbBtn('remove','Remove data point',vid,true);
      if(icons.indexOf('download')>=0) html += vmTbBtn('export','Download',vid);
      if(icons.indexOf('settings')>=0 && SHOW_VISUAL_SETTINGS_ICON){
        html += vmTbBtn('settings','Visual settings',vid);
      }
      if(icons.indexOf('fs')>=0) html += vmTbBtn('fs','Fullscreen',vid);
      html += '</div>';
      return html;
    }


    /* --- V2-style modebar helper functions --- */

    /* Find visual id from a Plotly graph div */
    function vmFindVisualIdByPlotDiv(gd){
      if(!gd) return null;
      /* Walk up from the Plotly div to find the parent card with data-vid */
      var el = gd;
      while(el){
        if(el.getAttribute && el.getAttribute('data-vid')) return el.getAttribute('data-vid');
        el = el.parentElement;
      }
      /* Fallback: match by id prefix */
      var divId = String(gd.id||'');
      for(var vi=0; vi<STATE.visuals.length; vi++){
        var v = STATE.visuals[vi];
        if(!v || !v.id) continue;
        if(divId.indexOf(v.id) >= 0) return v.id;
      }
      return null;
    }

    /* Menu management (LineTrend_v2 style) */
    /* Get modebar bounding rect for positioning menus */
    function btnRect(gd){
      if(!gd) return {right: innerWidth-8, bottom: 40, top: 8, left: 8};
      var modebar = gd.querySelector('.modebar');
      if(modebar) return modebar.getBoundingClientRect();
      /* Fallback: use the plot div itself */
      var rect = gd.getBoundingClientRect();
      return {right: rect.right - 8, bottom: rect.top + 40, top: rect.top + 8, left: rect.left + 8};
    }
    
    function vmCloseMenus(){
      document.querySelectorAll('.oas-pop').forEach(function(x){ x.remove(); });
    }
    
    var __vmOpenMenu=null;
    function vmToggleMenu(kind,build){
      console.log('[VM] vmToggleMenu called, kind:', kind, 'current:', __vmOpenMenu);
      if(__vmOpenMenu===kind){
        console.log('[VM] Closing menu (same kind)');
        vmCloseMenus();
        __vmOpenMenu=null;
        return;
      }
      vmCloseMenus();
      console.log('[VM] Building menu:', kind);
      build();
      __vmOpenMenu=kind;
      console.log('[VM] Menu built');
    }
    
    /* Listen for Escape key to close menus */
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){
        vmCloseMenus();
        __vmOpenMenu=null;
      }
    }, {passive:true});
    
    /* Close menu if clicking outside */
    document.addEventListener('mousedown', function(e){
      var pops = [].slice.call(document.querySelectorAll('.oas-pop'));
      if(pops.length && !pops.some(function(p){ return p.contains(e.target); })){
        vmCloseMenus();
        __vmOpenMenu=null;
      }
    }, {capture:true, passive:true});
    
    /* Place menu near anchor (LineTrend_v2 style positioning) */
    function vmPlaceMenu(pop, anchor){
      if(!pop) return;
      var r = anchor || {right: innerWidth-16, bottom: 48, top: 8};
      var w = pop.offsetWidth || 220, h = pop.offsetHeight || 100;
      var left = r.right - w - 4;
      var top = r.bottom + 6;
      /* If menu would go below viewport, position above */
      if(top + h > innerHeight - 10) top = r.top - h - 6;
      /* Keep menu visible horizontally */
      if(left < 6) left = 6;
      if(left + w > innerWidth - 6) left = innerWidth - w - 6;
      pop.style.left = Math.max(6, left) + 'px';
      pop.style.top = Math.max(6, top) + 'px';
    }
    
    /* Open View menu for quick chart type changes (LineTrend_v2 style) */
    function vmOpenViewMenu(vid, gd){
      vmToggleMenu('view', function(){
        var visual = null;
        for(var vi=0;vi<STATE.visuals.length;vi++){
          if(STATE.visuals[vi] && STATE.visuals[vi].id === vid){
            visual = STATE.visuals[vi];
            break;
          }
        }
        if(!visual) return;
        
        var vType = String(visual.type||'');
        var opts = visual.options || {};
        
        /* Only show view menu for types that support multiple chart types */
        var supportsMultiType = (vType === 'line' || vType === 'bar' || vType === 'histogram');
        if(!supportsMultiType) return;
        
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        
        var mainHtml = '';
        mainHtml += '<div class="hdr hdr-top"><span class="ttl">View Type</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        mainHtml += '<div class="body-inner">';
        mainHtml += '<div class="group">';
        
        if(vType === 'line'){
          var style = String(opts.style || 'line');
          var mode = String(opts.mode || 'lines+markers');
          var shape = String(opts.shape || 'spline');
          mainHtml += '<div class="hdr">Style</div>';
          mainHtml += '<div class="row">';
          mainHtml += '<label><input type="radio" name="vm-line-style" value="line" '+(style==='line'?'checked':'')+'> Line</label>';
          mainHtml += '<label><input type="radio" name="vm-line-style" value="area" '+(style==='area'?'checked':'')+'> Area</label>';
          mainHtml += '<label><input type="radio" name="vm-line-style" value="bar" '+(style==='bar'?'checked':'')+'> Bar</label>';
          mainHtml += '</div>';
          mainHtml += '<div class="hdr" style="margin-top:8px">Line Shape</div>';
          mainHtml += '<div class="row">';
          mainHtml += '<label><input type="radio" name="vm-line-shape" value="linear" '+(shape==='linear'?'checked':'')+'> Straight</label>';
          mainHtml += '<label><input type="radio" name="vm-line-shape" value="spline" '+(shape==='spline'?'checked':'')+'> Curved</label>';
          mainHtml += '</div>';
          mainHtml += '<div class="hdr" style="margin-top:8px">Mode</div>';
          mainHtml += '<div class="row">';
          mainHtml += '<label><input type="radio" name="vm-line-mode" value="lines" '+(mode==='lines'?'checked':'')+'> Lines</label>';
          mainHtml += '<label><input type="radio" name="vm-line-mode" value="markers" '+(mode==='markers'?'checked':'')+'> Markers</label>';
          mainHtml += '<label><input type="radio" name="vm-line-mode" value="lines+markers" '+(mode==='lines+markers'?'checked':'')+'> Both</label>';
          mainHtml += '</div>';
        } else if(vType === 'bar'){
          var barmode = String(opts.barmode || 'group');
          mainHtml += '<div class="hdr">Bar Mode</div>';
          mainHtml += '<div class="row">';
          mainHtml += '<label><input type="radio" name="vm-bar-mode" value="group" '+(barmode==='group'?'checked':'')+'> Grouped</label>';
          mainHtml += '<label><input type="radio" name="vm-bar-mode" value="stack" '+(barmode==='stack'?'checked':'')+'> Stacked</label>';
          mainHtml += '<label><input type="radio" name="vm-bar-mode" value="relative" '+(barmode==='relative'?'checked':'')+'> Relative</label>';
          mainHtml += '</div>';
        } else if(vType === 'histogram'){
          var showKDE = !!(opts.showKDE);
          mainHtml += '<div class="hdr">Display</div>';
          mainHtml += '<div class="row">';
          mainHtml += '<label><input type="checkbox" name="vm-hist-kde" '+(showKDE?'checked':'')+'> Show KDE (density)</label>';
          mainHtml += '</div>';
        }
        mainHtml += '</div>';
        mainHtml += '</div>'; // Close body-inner
        
        pop.innerHTML = mainHtml;
        
        /* Close button handler */
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn){
          closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu = null; };
        }
        
        /* Add change event listeners to all inputs for immediate updates */
        var inputs = pop.querySelectorAll('input[type="radio"], input[type="checkbox"]');
        for(var i=0; i<inputs.length; i++){
          inputs[i].addEventListener('change', function(){
            var changed = false;
            if(vType === 'line'){
              var styleInput = pop.querySelector('input[name="vm-line-style"]:checked');
              var shapeInput = pop.querySelector('input[name="vm-line-shape"]:checked');
              var modeInput = pop.querySelector('input[name="vm-line-mode"]:checked');
              if(styleInput){
                var styleVal = styleInput.value;
                if(styleVal !== opts.style) { opts.style = styleVal; changed = true; }
              }
              if(shapeInput){
                var shapeVal = shapeInput.value;
                if(shapeVal !== opts.shape) { opts.shape = shapeVal; changed = true; }
              }
              if(modeInput){
                var modeVal = modeInput.value;
                if(modeVal !== opts.mode) { opts.mode = modeVal; changed = true; }
              }
            } else if(vType === 'bar'){
              var barmodeInput = pop.querySelector('input[name="vm-bar-mode"]:checked');
              if(barmodeInput){
                var barmodeVal = barmodeInput.value;
                if(barmodeVal !== opts.barmode) { opts.barmode = barmodeVal; changed = true; }
              }
            } else if(vType === 'histogram'){
              var kdeCheck = pop.querySelector('input[name="vm-hist-kde"]');
              var kdeVal = !!(kdeCheck && kdeCheck.checked);
              if(kdeVal !== opts.showKDE) { opts.showKDE = kdeVal; changed = true; }
            }
            
            if(changed){
              applySettingChanges();
              redraw();
            }
          });
        }
        
        /* Add to DOM */
        document.body.appendChild(pop);
        
        /* Position menu near the modebar (LineTrend_v2 style) */
        setTimeout(function(){
          vmPlaceMenu(pop, btnRect(gd));
        }, 10);
      });
    }


    /* Toggle status table below a visual */
    function vmToggleStatusTable(vid, gd){
      var card = gd ? gd.closest('.card') : null;
      if(!card) return;
      var existing = card.querySelector('.vm-status-table');
      if(existing){
        existing.parentNode.removeChild(existing);
        return;
      }
      /* Build a simple descriptive stats table from visible Plotly data */
      var tbl = document.createElement('div');
      tbl.className = 'vm-status-table';
      tbl.style.cssText = 'padding:6px 10px;font-size:11px;border-top:1px solid var(--vm-border,#ddd);max-height:150px;overflow:auto;';
      var html = '<table style="width:100%;border-collapse:collapse;font-size:11px">';
      html += '<tr><th style="text-align:left;padding:2px 4px">Trace</th><th>N</th><th>Min</th><th>Max</th><th>Mean</th></tr>';
      try{
        var data = gd.data || [];
        for(var di=0;di<data.length;di++){
          var tr = data[di];
          var vals = tr.y || tr.x || tr.values || [];
          if(!vals || !vals.length) continue;
          var nums = [];
          for(var ni=0;ni<vals.length;ni++){ var nv=parseFloat(vals[ni]); if(isFinite(nv)) nums.push(nv); }
          if(!nums.length) continue;
          var sum=0; for(var si=0;si<nums.length;si++) sum+=nums[si];
          var mn=nums[0],mx=nums[0];
          for(var mi=1;mi<nums.length;mi++){ if(nums[mi]<mn)mn=nums[mi]; if(nums[mi]>mx)mx=nums[mi]; }
          var avg = sum/nums.length;
          var name = tr.name || ('Trace '+(di+1));
          html += '<tr><td style="padding:2px 4px">'+escapeHtml(name)+'</td><td style="text-align:center">'+nums.length+'</td><td style="text-align:center">'+mn.toFixed(2)+'</td><td style="text-align:center">'+mx.toFixed(2)+'</td><td style="text-align:center">'+avg.toFixed(2)+'</td></tr>';
        }
      }catch(e){}
      html += '</table>';
      tbl.innerHTML = html;
      card.appendChild(tbl);
    }

    /* CRITICAL: Apply setting changes and save state */
    function applySettingChanges(){
      try{
        saveState();
        /* No immediate renderGrid() here to avoid recursion - let calling function trigger render */
      }catch(e){
        console.error('applySettingChanges error:', e);
      }
    }

    /* Comprehensive Points/Labels/Legend menu (V2 template style) */
    function vmOpenPointsMenu(vid, gd){
      vmToggleMenu('points', function(){
        var visual = null;
        for(var vi=0;vi<STATE.visuals.length;vi++){
          if(STATE.visuals[vi] && STATE.visuals[vi].id === vid){
            visual = STATE.visuals[vi];
            break;
          }
        }
        if(!visual) return;
        
        var opts = visual.options || {};
        var pointsMode = String(opts.pointsMode || 'auto');
        var showLabels = !!(opts.showLabels);
        var gapsMode = String(opts.gapsMode || 'break');
        var showLegend = opts.showLegend !== false;
        var legendPos = String(opts.legendPos || 'auto');
        var hoverMode = String(opts.hoverMode || 'closest');
        
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        
        var html = '<div class="hdr hdr-top"><span class="ttl">Points • Labels • Legend</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        html += '<div class="body-inner">';
        
        html += '<div class="group">';
        html += '<div class="hdr">Points Display</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="pm" value="auto" '+(pointsMode==='auto'?'checked':'')+'><span>Auto</span></label>';
        html += '<label class="seg"><input type="radio" name="pm" value="none" '+(pointsMode==='none'?'checked':'')+'><span>None</span></label>';
        html += '<label class="seg"><input type="radio" name="pm" value="all" '+(pointsMode==='all'?'checked':'')+'><span>All</span></label>';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Data Labels</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="labels" value="0" '+(showLabels?'':'checked')+'><span>Off</span></label>';
        html += '<label class="seg"><input type="radio" name="labels" value="1" '+(showLabels?'checked':'')+'><span>On</span></label>';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Gaps Handling</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="gaps" value="break" '+(gapsMode==='break'?'checked':'')+'><span>Break</span></label>';
        html += '<label class="seg"><input type="radio" name="gaps" value="connect" '+(gapsMode==='connect'?'checked':'')+'><span>Connect</span></label>';
        html += '<label class="seg"><input type="radio" name="gaps" value="interpolate" '+(gapsMode==='interpolate'?'checked':'')+'><span>Interpolate</span></label>';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Legend</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="legshow" value="1" '+(showLegend?'checked':'')+'><span>Show</span></label>';
        html += '<label class="seg"><input type="radio" name="legshow" value="0" '+(showLegend?'':'checked')+'><span>Hide</span></label>';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Legend Position</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        var legOpts = ['auto','top','bottom','left','right'];
        for(var li=0;li<legOpts.length;li++){
          var lv = legOpts[li];
          var llbl = lv.charAt(0).toUpperCase() + lv.slice(1);
          html += '<label class="seg"><input type="radio" name="legpos" value="'+lv+'" '+(legendPos===lv?'checked':'')+'><span>'+llbl+'</span></label>';
        }
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Hover Mode</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="hover" value="closest" '+(hoverMode==='closest'?'checked':'')+'><span>Focused</span></label>';
        html += '<label class="seg"><input type="radio" name="hover" value="x" '+(hoverMode==='x'?'checked':'')+'><span>Compare</span></label>';
        html += '<label class="seg"><input type="radio" name="hover" value="x unified" '+(hoverMode==='x unified'?'checked':'')+'><span>Unified</span></label>';
        html += '</div>';
        html += '</div>'; // Close body-inner
        
        pop.innerHTML = html;
        
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn) closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu=null; };
        
        pop.addEventListener('change', function(e){
          var t = e.target;
          if(!t || !t.name) return;
          var changed = false;
          
          if(t.name==='pm'){ opts.pointsMode = t.value; changed = true; }
          else if(t.name==='labels'){ opts.showLabels = (t.value==='1'); changed = true; }
          else if(t.name==='gaps'){ opts.gapsMode = t.value; changed = true; }
          else if(t.name==='legshow'){ opts.showLegend = (t.value==='1'); changed = true; }
          else if(t.name==='legpos'){ opts.legendPos = t.value; changed = true; }
          else if(t.name==='hover'){ opts.hoverMode = t.value; changed = true; }
          
          if(changed){
            applySettingChanges();
            renderGrid();
          }
        });
        
        document.body.appendChild(pop);
        setTimeout(function(){ vmPlaceMenu(pop, btnRect(gd)); }, 10);
      });
    }
    
    /* Cycle points mode (legacy fallback) */
    function vmCyclePointsMode(vid, gd){
      vmOpenPointsMenu(vid, gd);
    }

    /* Toggle remove mode (show alert for now — can be extended) */
    function vmToggleRemoveMode(vid, gd){
      if(!gd) return;
      var attr = gd.getAttribute('data-remove-mode');
      if(attr === '1'){
        gd.setAttribute('data-remove-mode','0');
        gd.style.cursor = '';
      } else {
        gd.setAttribute('data-remove-mode','1');
        gd.style.cursor = 'crosshair';
      }
    }

    /* Comprehensive Status/Regression menu (V2 template style) */
    function vmOpenStatsMenu(vid, gd){
      vmToggleMenu('stats', function(){
        var visual = null;
        for(var vi=0;vi<STATE.visuals.length;vi++){
          if(STATE.visuals[vi] && STATE.visuals[vi].id === vid){
            visual = STATE.visuals[vi];
            break;
          }
        }
        if(!visual) return;
        
        var opts = visual.options || {};
        var statsMode = String(opts.statsMode || 'none');
        var statsScope = String(opts.statsScope || 'by-group');
        var showMA = !!(opts.showMovingAvg);
        var maWindow = parseInt(opts.maWindow || 3);
        
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        
        var html = '<div class="hdr hdr-top"><span class="ttl">Status Lines</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        html += '<div class="body-inner">';
        html += '<label class="seg"><input type="radio" name="mode" value="none" '+(statsMode==='none'?'checked':'')+'><span>None</span></label>';
        html += '<label class="seg"><input type="radio" name="mode" value="median" '+(statsMode==='median'?'checked':'')+'><span>Median</span></label>';
        html += '<label class="seg"><input type="radio" name="mode" value="regression" '+(statsMode==='regression'?'checked':'')+'><span>Regression</span></label>';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Scope</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="scope" value="by-group" '+(statsScope==='by-group'?'checked':'')+'><span>By Group</span></label>';
        html += '<label class="seg"><input type="radio" name="scope" value="all" '+(statsScope==='all'?'checked':'')+'><span>All Groups</span></label>';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Moving Average</div>';
        html += '<div class="row">';
        html += '<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" name="ma" '+(showMA?'checked':'')+'> Show MA</label>';
        html += '<input type="number" name="ma-window" min="2" max="100" value="'+maWindow+'" placeholder="Window" style="width:80px;padding:4px" '+(showMA?'':'disabled')+'>';
        html += '</div>';
        html += '</div>'; // Close body-inner
        
        pop.innerHTML = html;
        
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn) closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu=null; };
        
        var maCheck = pop.querySelector('input[name="ma"]');
        var maWin = pop.querySelector('input[name="ma-window"]');
        if(maCheck && maWin){
          maCheck.onchange = function(){ maWin.disabled = !maCheck.checked; };
        }
        
        pop.addEventListener('change', function(e){
          var t = e.target;
          if(!t) return;
          var changed = false;
          
          if(t.name==='mode'){ opts.statsMode = t.value; changed = true; }
          else if(t.name==='scope'){ opts.statsScope = t.value; changed = true; }
          else if(t.name==='ma'){ opts.showMovingAvg = t.checked; changed = true; }
          else if(t.name==='ma-window'){ opts.maWindow = parseInt(t.value)||3; changed = true; }
          
          if(changed){
            applySettingChanges();
            renderGrid();
          }
        });
        
        document.body.appendChild(pop);
        setTimeout(function(){ vmPlaceMenu(pop, btnRect(gd)); }, 10);
      });
    }
    
    /* Toggle stats overlay (legacy fallback) */
    function vmToggleStatsOverlay(vid, gd){
      vmOpenStatsMenu(vid, gd);
    }

    /* Comprehensive Y-Axis menu (V2 template style) */
    function vmOpenYAxisMenu(vid, gd){
      vmToggleMenu('yaxis', function(){
        var visual = null;
        for(var vi=0;vi<STATE.visuals.length;vi++){
          if(STATE.visuals[vi] && STATE.visuals[vi].id === vid){
            visual = STATE.visuals[vi];
            break;
          }
        }
        if(!visual) return;
        
        var opts = visual.options || {};
        var yMode = String(opts.yScaleMode || 'auto');
        var yMin = opts.yMin;
        var yMax = opts.yMax;
        
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        
        var html = '<div class="hdr hdr-top"><span class="ttl">Y-axis</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        html += '<div class="body-inner">';
        html += '<div class="group">';
        html += '<div class="hdr">Mode</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="ym" value="auto" '+(yMode==='auto'?'checked':'')+'><span>Auto</span></label>';
        html += '<label class="seg"><input type="radio" name="ym" value="zero" '+(yMode==='zero'?'checked':'')+'><span>0-based</span></label>';
        html += '<label class="seg"><input type="radio" name="ym" value="log" '+(yMode==='log'?'checked':'')+'><span>Log</span></label>';
        html += '<label class="seg"><input type="radio" name="ym" value="manual" '+(yMode==='manual'?'checked':'')+'><span>Manual</span></label>';
        html += '</div>';
        html += '<div class="hdr" style="margin-top:8px">Range</div>';
        html += '<div class="row"><input id="ymin" type="number" placeholder="Y min" value="'+(Number.isFinite(yMin)?yMin:'')+'" style="width:100px"></div>';
        html += '<div class="row"><input id="ymax" type="number" placeholder="Y max" value="'+(Number.isFinite(yMax)?yMax:'')+'" style="width:100px"></div>';
        html += '<div class="row" style="gap:6px">';
        html += '<button data-act="apply">Apply</button>';
        html += '<button data-act="clear">Clear</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>'; // Close body-inner
        
        pop.innerHTML = html;
        
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn) closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu=null; };
        
        pop.addEventListener('change', function(e){
          if(e.target.name==='ym'){
            opts.yScaleMode = e.target.value;
            if(opts.yScaleMode!=='manual'){ opts.yMin=null; opts.yMax=null; }
            applySettingChanges();
            renderGrid();
          }
        });
        
        pop.addEventListener('click', function(e){
          var act = e.target.getAttribute && e.target.getAttribute('data-act');
          if(!act) return;
          if(act==='apply'){
            var mi = parseFloat(pop.querySelector('#ymin').value);
            var ma = parseFloat(pop.querySelector('#ymax').value);
            opts.yMin = Number.isFinite(mi) ? mi : null;
            opts.yMax = Number.isFinite(ma) ? ma : null;
            opts.yScaleMode = 'manual';
            applySettingChanges();
            renderGrid();
            vmCloseMenus();
            __vmOpenMenu=null;
          } else if(act==='clear'){
            opts.yMin = null;
            opts.yMax = null;
            opts.yScaleMode = 'auto';
            applySettingChanges();
            renderGrid();
            vmCloseMenus();
            __vmOpenMenu=null;
          }
        });
        
        document.body.appendChild(pop);
        setTimeout(function(){ vmPlaceMenu(pop, btnRect(gd)); }, 10);
      });
    }
    
    /* Cycle Y-axis mode (legacy fallback) */
    function vmCycleYMode(gd){
      var vid = vmFindVisualIdByPlotDiv(gd);
      if(vid !== null) vmOpenYAxisMenu(vid, gd);
    }

    /* Comprehensive Targets menu (V2 template style) */
    function vmOpenTargetsMenu(vid, gd){
      vmToggleMenu('targets', function(){
        var visual = null;
        for(var vi=0;vi<STATE.visuals.length;vi++){
          if(STATE.visuals[vi] && STATE.visuals[vi].id === vid){
            visual = STATE.visuals[vi];
            break;
          }
        }
        if(!visual) return;
        
        var opts = visual.options || {};
        var targetStyle = opts.targetBand ? 'area' : 'line';
        var minTarget = opts.minTarget;
        var maxTarget = opts.maxTarget;
        
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        
        var html = '<div class="hdr hdr-top"><span class="ttl">Targets</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        html += '<div class="body-inner">';
        html += '<div class="group">';
        html += '<div class="hdr">Style</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="band" value="line" '+(targetStyle==='line'?'checked':'')+'><span>Line</span></label>';
        html += '<label class="seg"><input type="radio" name="band" value="area" '+(targetStyle==='area'?'checked':'')+'><span>Band</span></label>';
        html += '</div>';
        html += '<div class="hdr" style="margin-top:8px">Values</div>';
        html += '<div class="row"><input id="tg-min" type="number" placeholder="Min target" value="'+(Number.isFinite(minTarget)?minTarget:'')+'" style="width:140px"></div>';
        html += '<div class="row"><input id="tg-max" type="number" placeholder="Max target" value="'+(Number.isFinite(maxTarget)?maxTarget:'')+'" style="width:140px"></div>';
        html += '<div class="row" style="gap:6px">';
        html += '<button data-act="apply">Apply</button>';
        html += '<button data-act="clear">Clear</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>'; // Close body-inner
        
        pop.innerHTML = html;
        
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn) closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu=null; };
        
        pop.addEventListener('change', function(e){
          if(e.target.name==='band'){
            opts.targetBand = (e.target.value==='area');
            applySettingChanges();
            renderGrid();
          }
        });
        
        pop.addEventListener('click', function(e){
          var act = e.target.getAttribute && e.target.getAttribute('data-act');
          if(!act) return;
          if(act==='apply'){
            var mi = parseFloat(pop.querySelector('#tg-min').value);
            var ma = parseFloat(pop.querySelector('#tg-max').value);
            opts.minTarget = Number.isFinite(mi) ? mi : null;
            opts.maxTarget = Number.isFinite(ma) ? ma : null;
            opts.showTargets = true;
            applySettingChanges();
            renderGrid();
            vmCloseMenus();
            __vmOpenMenu=null;
          } else if(act==='clear'){
            opts.minTarget = null;
            opts.maxTarget = null;
            opts.showTargets = false;
            applySettingChanges();
            renderGrid();
            vmCloseMenus();
            __vmOpenMenu=null;
          }
        });
        
        document.body.appendChild(pop);
        setTimeout(function(){ vmPlaceMenu(pop, btnRect(gd)); }, 10);
      });
    }
    
    /* Toggle targets (legacy fallback) */
    function vmToggleTargets(vid, gd){
      vmOpenTargetsMenu(vid, gd);
    }

    /* Comprehensive Zoom Menu (V2 style) */
    function vmOpenZoomMenu(vid, gd){
      vmToggleMenu('zoom', function(){
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        
        var html = '<div class="hdr hdr-top"><span class="ttl">Zoom & Pan</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        html += '<div class="body-inner">';
        html += '<div class="group">';
        html += '<div class="hdr">Drag Mode</div>';
        html += '<div class="row" style="flex-wrap:wrap">';
        html += '<label class="seg"><input type="radio" name="drag" value="zoom"><span>Zoom</span></label>';
        html += '<label class="seg"><input type="radio" name="drag" value="pan" checked><span>Pan</span></label>';
        html += '</div>';
        html += '<div class="hdr" style="margin-top:8px">Actions</div>';
        html += '<div class="row" style="flex-direction:column;align-items:stretch">';
        html += '<button data-act="reset-axes">Reset Axes</button>';
        html += '<button data-act="autoscale">Autoscale</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>'; // Close body-inner
        
        pop.innerHTML = html;
        
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn) closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu=null; };
        
        pop.addEventListener('change', function(e){
          if(e.target.name==='drag'){
            try{ Plotly.relayout(gd, {dragmode: e.target.value}); }catch(ex){}
          }
        });
        
        pop.addEventListener('click', function(e){
          var act = e.target.getAttribute && e.target.getAttribute('data-act');
          if(!act) return;
          if(act==='reset-axes'){
            try{ Plotly.relayout(gd, {'xaxis.autorange':true,'yaxis.autorange':true}); }catch(ex){}
            vmCloseMenus();
            __vmOpenMenu=null;
          } else if(act==='autoscale'){
            try{ Plotly.relayout(gd, {autosize:true}); }catch(ex){}
            vmCloseMenus();
            __vmOpenMenu=null;
          }
        });
        
        document.body.appendChild(pop);
        setTimeout(function(){ vmPlaceMenu(pop, btnRect(gd)); }, 10);
      });
    }
    
    /* Cycle zoom mode (legacy fallback) */
    function vmCycleZoomMode(gd){
      vmOpenZoomMenu(vmFindVisualIdByPlotDiv(gd), gd);
    }

    /* Comprehensive Filter Menu (V2 style) */
    function vmShowQuickFilterDialog(vid, gd){
      vmToggleMenu('filter', function(){
        var visual = null;
        for(var i=0;i<STATE.visuals.length;i++){
          if(STATE.visuals[i] && STATE.visuals[i].id === vid){
            visual = STATE.visuals[i];
            break;
          }
        }
        if(!visual) return;
        
        var opts = visual.options || {};
        var filterCfg = visual.filter || {logic:'and', clauses:[]};
        
        var pop = document.createElement('div');
        pop.className = 'oas-pop';
        pop.style.minWidth = '320px';
        pop.style.maxWidth = '500px';
        
        var html = '<div class="hdr hdr-top"><span class="ttl">Filter Data</span><button class="xbtn" data-act="close" title="Close">×</button></div>';
        html += '<div class="body-inner">';
        html += '<div class="group">';
        
        /* Simple min/max filter for numeric columns */
        html += '<div class="hdr">Value Range</div>';
        html += '<div class="row">';
        html += '<input id="filter-min" type="number" placeholder="Min value" value="'+(Number.isFinite(opts.filterMin)?opts.filterMin:'')+'" style="width:120px">';
        html += '<input id="filter-max" type="number" placeholder="Max value" value="'+(Number.isFinite(opts.filterMax)?opts.filterMax:'')+'" style="width:120px">';
        html += '</div>';
        
        html += '<div class="hdr" style="margin-top:8px">Outliers</div>';
        html += '<div class="row">';
        html += '<label><input type="checkbox" id="filter-outliers" '+(opts.excludeOutliers?'checked':'')+'> Exclude outliers (IQR)</label>';
        html += '</div>';
        html += '<div class="row">';
        html += '<label><input type="checkbox" id="filter-extremes" '+(opts.excludeExtremes?'checked':'')+'> Exclude extremes (3×IQR)</label>';
        html += '</div>';
        
        var active = (Number.isFinite(opts.filterMin) || Number.isFinite(opts.filterMax) || opts.excludeOutliers || opts.excludeExtremes);
        html += '<div class="row" style="margin-top:8px;font-size:11px;color:var(--vm-sub)">';
        html += active ? '✓ Filters active' : 'No filters applied';
        html += '</div>';
        
        html += '<div class="row" style="gap:6px;margin-top:8px">';
        html += '<button data-act="apply">Apply</button>';
        html += '<button data-act="clear">Clear All</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>'; // Close body-inner
        
        pop.innerHTML = html;
        
        var closeBtn = pop.querySelector('[data-act="close"]');
        if(closeBtn) closeBtn.onclick = function(){ vmCloseMenus(); __vmOpenMenu=null; };
        
        pop.addEventListener('click', function(e){
          var act = e.target.getAttribute && e.target.getAttribute('data-act');
          if(!act) return;
          
          if(act==='apply'){
            var minVal = parseFloat(pop.querySelector('#filter-min').value);
            var maxVal = parseFloat(pop.querySelector('#filter-max').value);
            var outliers = pop.querySelector('#filter-outliers').checked;
            var extremes = pop.querySelector('#filter-extremes').checked;
            
            opts.filterMin = Number.isFinite(minVal) ? minVal : null;
            opts.filterMax = Number.isFinite(maxVal) ? maxVal : null;
            opts.excludeOutliers = outliers;
            opts.excludeExtremes = extremes;
            
            applySettingChanges();
            renderGrid();
            vmCloseMenus();
            __vmOpenMenu=null;
          } else if(act==='clear'){
            opts.filterMin = null;
            opts.filterMax = null;
            opts.excludeOutliers = false;
            opts.excludeExtremes = false;
            applySettingChanges();
            renderGrid();
            vmCloseMenus();
            __vmOpenMenu=null;
          }
        });
        
        /* Enter key support */
        var inputs = pop.querySelectorAll('input[type="number"]');
        for(var ii=0;ii<inputs.length;ii++){
          inputs[ii].addEventListener('keyup', function(e){
            if(e.key==='Enter'){
              var applyBtn = pop.querySelector('[data-act="apply"]');
              if(applyBtn) applyBtn.click();
            }
          });
        }
        
        document.body.appendChild(pop);
        setTimeout(function(){ vmPlaceMenu(pop, btnRect(gd)); }, 10);
      });
    }
    
    /* Legacy compatibility */
    function vmAddFilterCondition(conditionsContainer){
      /* Deprecated - kept for backwards compatibility */
    }
    
    function vmApplyQuickFilter(vid, filterDialog){
      /* Deprecated - kept for backwards compatibility */
      
      var conditionsHtml = '';
      var clauses = Array.isArray(filterCfg.clauses) ? filterCfg.clauses : [];
      
      for(var ci=0;ci<clauses.length;ci++){
        var c = clauses[ci];
        var colKey = c && c.colKey ? String(c.colKey) : '';
        var op = c && c.op ? String(c.op) : 'eq';
        var val = c && c.value != null ? String(c.value) : '';
        var val2 = c && c.value2 != null ? String(c.value2) : '';
        
        conditionsHtml += '<div style="padding:12px;background:var(--vm-bg-sec);border-radius:4px;margin-bottom:12px;border:1px solid var(--vm-border);">'
          + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center">'
          + '<select data-filter-col="'+ci+'" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border)">'
          + '<option value="">-- Select Column --</option>';
        
        for(var cj=0;cj<cols.length;cj++){
          conditionsHtml += '<option value="'+escapeHtml(cols[cj])+'" '+(cols[cj]===colKey?'selected':'')+'>'+escapeHtml(cols[cj])+'</option>';
        }
        
        conditionsHtml += '</select>'
          + '<select data-filter-op="'+ci+'" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border)">'
          + '<option value="eq" '+(op==='eq'?'selected':'')+'>Equals</option>'
          + '<option value="neq" '+(op==='neq'?'selected':'')+'>Not equals</option>'
          + '<option value="gt" '+(op==='gt'?'selected':'')+'>Greater than</option>'
          + '<option value="gte" '+(op==='gte'?'selected':'')+'>≥</option>'
          + '<option value="lt" '+(op==='lt'?'selected':'')+'>Less than</option>'
          + '<option value="lte" '+(op==='lte'?'selected':'')+'>≤</option>'
          + '<option value="contains" '+(op==='contains'?'selected':'')+'>Contains</option>'
          + '<option value="starts" '+(op==='starts'?'selected':'')+'>Starts with</option>'
          + '<option value="between" '+(op==='between'?'selected':'')+'>Between</option>'
          + '<option value="isnull" '+(op==='isnull'?'selected':'')+'>Is null</option>'
          + '<option value="notnull" '+(op==='notnull'?'selected':'')+'>Is not null</option>'
          + '</select>'
          + '<input type="text" data-filter-val="'+ci+'" placeholder="Value" value="'+escapeHtml(val)+'" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border)" />'
          + '<button class="btn" onclick="this.parentElement.parentElement.remove();" style="padding:4px 8px;margin:0">−</button>'
          + '</div>'
          + (op==='between'?('<div style="margin-top:8px"><input type="text" data-filter-val2="'+ci+'" placeholder="Value 2 (upper bound)" value="'+escapeHtml(val2)+'" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border);width:100%" /></div>'):'')
          + '</div>';
      }
      
      modal.innerHTML = ''
        + '<div style="margin-bottom:16px"><strong style="font-size:16px">Quick Filter: '+escapeHtml(visual.title||'Untitled')+'</strong></div>'
        + '<div style="font-size:12px;color:var(--vm-sub);margin-bottom:16px">Build filter conditions to refine your data in real-time.</div>'
        + '<div style="margin-bottom:12px">'
        + '<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">'
        + '<span style="font-size:12px;font-weight:500">Logic:</span>'
        + '<label style="margin:0"><input type="radio" name="filter-logic" value="and" '+(filterCfg.logic!=='or'?'checked':'')+' /> AND (all match)</label>'
        + '<label style="margin:0;margin-left:12px"><input type="radio" name="filter-logic" value="or" '+(filterCfg.logic==='or'?'checked':'')+' /> OR (any match)</label>'
        + '</div>'
        + '<div id="filter-conditions" style="margin-bottom:12px">'+conditionsHtml+'</div>'
        + '<button class="btn" onclick="vmAddFilterCondition(this.closest(\'div\'));" style="padding:6px 12px;width:100%;margin-bottom:12px">+ Add Condition</button>'
        + '</div>'
        + '<div style="display:flex;gap:8px;justify-content:flex-end">'
        + '<button class="btn" onclick="this.closest(\'div[style*=\\\"position:fixed\\\"]\').remove();" style="padding:8px 16px">Cancel</button>'
        + '<button class="btn primary" onclick="vmApplyQuickFilter(\''+escapeHtml(vid)+'\',this.closest(\'div[style*=\\\"position:fixed\\\"]\'));applySettingChanges();redraw();" style="padding:8px 16px">Apply Filter</button>'
        + '</div>';
      
      filterUI.appendChild(modal);
      filterUI.onclick = function(e){
        if(e.target === filterUI) filterUI.remove();
      };
      document.body.appendChild(filterUI);
    }
    
    function vmAddFilterCondition(conditionsContainer){
      var cond = document.createElement('div');
      cond.style.cssText = 'padding:12px;background:var(--vm-bg-sec);border-radius:4px;margin-bottom:12px;border:1px solid var(--vm-border);';
      
      var cols = Object.keys(currentRows()[0]||{}).sort();
      var nextIdx = (conditionsContainer.querySelectorAll('[data-filter-col]') || []).length;
      
      var html = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center">'
        + '<select data-filter-col="'+nextIdx+'" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border)">'
        + '<option value="">-- Select Column --</option>';
      
      for(var j=0;j<cols.length;j++){
        html += '<option value="'+escapeHtml(cols[j])+'">'+escapeHtml(cols[j])+'</option>';
      }
      
      html += '</select>'
        + '<select data-filter-op="'+nextIdx+'" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border)">'
        + '<option value="eq">Equals</option>'
        + '<option value="neq">Not equals</option>'
        + '<option value="gt">Greater than</option>'
        + '<option value="gte">≥</option>'
        + '<option value="lt">Less than</option>'
        + '<option value="lte">≤</option>'
        + '<option value="contains">Contains</option>'
        + '<option value="starts">Starts with</option>'
        + '<option value="between">Between</option>'
        + '<option value="isnull">Is null</option>'
        + '<option value="notnull">Is not null</option>'
        + '</select>'
        + '<input type="text" data-filter-val="'+nextIdx+'" placeholder="Value" style="padding:4px;border-radius:3px;border:1px solid var(--vm-border)" />'
        + '<button class="btn" onclick="this.parentElement.parentElement.remove();" style="padding:4px 8px;margin:0">−</button>'
        + '</div>';
      
      cond.innerHTML = html;
      conditionsContainer.querySelector('#filter-conditions').appendChild(cond);
    }
    
    function vmApplyQuickFilter(vid, filterDialog){
      var logic = filterDialog.querySelector('input[name="filter-logic"]:checked').value;
      var clauseElements = filterDialog.querySelectorAll('[data-filter-col]');
      var clauses = [];
      
      for(var i=0;i<clauseElements.length;i++){
        var colEl = filterDialog.querySelector('[data-filter-col="'+i+'"]');
        var opEl = filterDialog.querySelector('[data-filter-op="'+i+'"]');
        var valEl = filterDialog.querySelector('[data-filter-val="'+i+'"]');
        var val2El = filterDialog.querySelector('[data-filter-val2="'+i+'"]');
        
        var col = colEl ? colEl.value : '';
        var op = opEl ? opEl.value : 'eq';
        var val = valEl ? valEl.value : '';
        var val2 = val2El ? val2El.value : '';
        
        if(col && (val || op==='isnull' || op==='notnull')){
          var clause = {colKey: col, op: op, value: val};
          if(val2) clause.value2 = val2;
          clauses.push(clause);
        }
      }
      
      // Update the visual's filter
      var visual = null;
      for(var vi=0;vi<STATE.visuals.length;vi++){
        if(STATE.visuals[vi] && STATE.visuals[vi].id === vid){
          visual = STATE.visuals[vi];
          break;
        }
      }
      
      if(visual){
        visual.filter = {logic: logic, clauses: clauses};
      }
      
      filterDialog.remove();
    }

    // ---------------------------
    // UI rendering
    // ---------------------------
    var gridEl = q('#vm-grid');
    var pillEl = q('#vm-pill');

    function currentRows(){
      var rows = getRawRows();
      // If user pasted JSON in manager, prefer it
      if(STATE.data && STATE.data.jsonText && STATE.data.jsonText.trim()){
        var parsed = tryJsonParse(STATE.data.jsonText);
        if(Array.isArray(parsed)) rows = parsed;
      }
      return rows;
    }

    function buildCtx(){
      var rows = currentRows();
      var cols = inferColumns(rows);
      return {
        rows: rows,
        cols: cols,
        sections: {
          enabled: !!(STATE.sections && STATE.sections.enabled),
          splitCol: (STATE.sections && STATE.sections.splitCol) ? String(STATE.sections.splitCol) : '',
          current: (STATE.sections && STATE.sections.current) ? String(STATE.sections.current) : 'All'
        }
      };
    }

    function applyTheme(theme){
      var t = String(theme||'light').toLowerCase();
      if(t!=='dark' && t!=='paper') t='light';
      HOST.setAttribute('data-theme', t);
      STATE.globals = STATE.globals || {};
      STATE.globals.theme = t;
    }

    function setGridVars(visualCount){
      STATE.globals = STATE.globals || {};
      applyTheme(STATE.globals.theme || PV_THEME_DEFAULT);

      var cols = clamp(parseInt(STATE.globals.visualsPerRow||2,10)||2, 1, 6);
      var vCount = Math.max(0, parseInt(visualCount||0,10)||0);
      if(vCount>0) cols = Math.min(cols, vCount);
      var gapPx = clamp(parseInt(STATE.globals.gridGap||10,10)||10, 0, 40);
      HOST.style.setProperty('--vm-cols', String(cols));
      HOST.style.setProperty('--vm-gap', String(gapPx)+'px');
      HOST.style.setProperty('--vm-top-gap', String(clamp(parseInt(STATE.globals.topGap==null?6:STATE.globals.topGap,10)||0, 0, 30))+'px');
      HOST.style.setProperty('--vm-section-gap', String(clamp(parseInt(STATE.globals.sectionGap==null?4:STATE.globals.sectionGap,10)||0, 0, 30))+'px');

      // Appearance settings
      var gridBg = String(STATE.globals.gridBgColor || '').trim();
      var cardBc = String(STATE.globals.cardBorderColor || '').trim();
      var cardBr = STATE.globals.cardBorderRadius;
      if(gridBg){
        gridEl.style.background = gridBg;
        gridEl.style.padding = gapPx + 'px';
        gridEl.style.borderRadius = (cardBr != null ? cardBr : 14) + 'px';
      } else {
        gridEl.style.background = '';
        gridEl.style.padding = '';
        gridEl.style.borderRadius = '';
      }
      if(cardBc) HOST.style.setProperty('--vm-border', cardBc);
      else HOST.style.removeProperty('--vm-border');
      if(cardBr != null && cardBr !== 14){
        HOST.style.setProperty('--vm-radius', cardBr + 'px');
      } else {
        HOST.style.removeProperty('--vm-radius');
      }

      // Height rule:
      // - If visuals fit into a single row -> make cards fill available viewport height.
      // - Else -> use configured cardHeight.
      var rows = cols>0 ? Math.ceil(vCount / cols) : 0;
      var singleRow = (rows<=1 && vCount>0);

      var cardH = clamp(parseInt(STATE.globals.cardHeight||320,10)||320, 180, 1400);
      if(singleRow){
        // available height from top of HOST to viewport bottom
        var rect = HOST.getBoundingClientRect();
        var avail = Math.max(280, (window.innerHeight||800) - rect.top - 16);
        // subtract titlebar + paddings estimate
        var computed = Math.max(260, avail - 92);
        HOST.style.setProperty('--vm-card-h', computed+'px');
      }else{
        HOST.style.setProperty('--vm-card-h', cardH+'px');
      }
    }

    function renderGrid(){
      var rt = q('#vm-report-title');
      var rs = q('#vm-report-sub');
      if(rt) {
        rt.textContent = STATE.globals.title || 'Visual Manager';
        rt.style.textAlign = STATE.globals.titleAlign || 'left';
        rt.style.fontSize = (STATE.globals.titleSize || 24) + 'px';
        rt.style.color = STATE.globals.titleColor || '#111827';
        rt.style.fontWeight = STATE.globals.titleBold ? 'bold' : 'normal';
        rt.style.fontStyle = STATE.globals.titleItalic ? 'italic' : 'normal';
        rt.style.textDecoration = STATE.globals.titleUnderline ? 'underline' : 'none';
      }
      if(rs) {
        rs.textContent = STATE.globals.subtitle || '';
        rs.style.textAlign = STATE.globals.subtitleAlign || 'left';
        rs.style.fontSize = (STATE.globals.subtitleSize || 16) + 'px';
        rs.style.color = STATE.globals.subtitleColor || '#6b7280';
        rs.style.fontWeight = STATE.globals.subtitleBold ? 'bold' : 'normal';
        rs.style.fontStyle = STATE.globals.subtitleItalic ? 'italic' : 'normal';
        rs.style.textDecoration = STATE.globals.subtitleUnderline ? 'underline' : 'none';
      }
      
      // Handle report image
      var imgEl = q('#vm-report-image');
      if(imgEl){
        if(STATE.globals.imageUrl && STATE.globals.imageUrl.trim()){
          imgEl.src = STATE.globals.imageUrl;
          imgEl.style.display = '';
        } else {
          imgEl.style.display = 'none';
        }
      }
      
      // Apply titlebar radius
      var titlebar = q('.vm-titlebar');
      if(titlebar && STATE.globals.titlebarRadius){
        titlebar.style.borderRadius = STATE.globals.titlebarRadius + 'px';
      }
      
      // Show/hide Cols control based on layout mode
      var colsControl = q('#vm-cols-control');
      if(colsControl){
        colsControl.style.display = (STATE.globals.layoutMode === 'auto') ? '' : 'none';
      }

      var visuals = Array.isArray(STATE.visuals) ? STATE.visuals : [];
      visuals = visuals.filter(function(v){ return v && v.id; });
      STATE.visuals = visuals;

      setGridVars(visuals.length);

      if(!visuals.length){
        gridEl.innerHTML = ''
          + '<div class="empty" style="grid-column:1/-1">'
          + 'No visuals yet. Click <b>Visual Manager</b> ? Visuals ? Add visual.'
          + '</div>';
        return;
      }

      var ctx = buildCtx();

      if(pillEl){
        pillEl.style.display = SHOW_STATUS_PILL ? '' : 'none';
        if(SHOW_STATUS_PILL){
          pillEl.textContent = (ctx.rows ? ctx.rows.length : 0) + ' rows';
          if(ctx.cols && ctx.cols.length) pillEl.title = 'Data columns detected: ' + ctx.cols.length;
          else pillEl.title = 'No data columns detected. Check Narrative wiring for #box-data, or paste JSON in Visual Manager ? Data.';
        }
      }

      function cardsHtmlForSection(secKey){
        // Grouping: visuals with the same layout.group are stacked into one card.
        var groupMap = Object.create(null);
        var dataGroupMap = Object.create(null); // Support for data-based grouping (NEW)
        visuals.forEach(function(v0){
          var v = ensureVisualDefaults(v0);
          if(!v.show) return;
          var g = (v.layout && v.layout.group) ? String(v.layout.group||'').trim() : '';
          if(!g) return;
          (groupMap[g] = groupMap[g] || []).push(v);
        });

        function rowIdFor(v){
          return (v && v.layout && v.layout.row) ? String(v.layout.row||'').trim() : '';
        }

        // NEW FEATURE: Support for visual grouping by data column with separators and custom titles
        function getDataGroupKey(v){
          var dg = (v.layout && v.layout.dataGroup) ? String(v.layout.dataGroup||'').trim() : '';
          return dg;
        }
        
        function getGroupVisualElements(){
          // Collect all visible visuals and their data group assignments
          var allVisuals = [];
          var groupOrder = [];
          var seenGroups = {};
          
          visuals.forEach(function(v0){
            var v = ensureVisualDefaults(v0);
            if(!v.show) return;
            var dg = getDataGroupKey(v);
            if(dg){
              if(!seenGroups[dg]){
                seenGroups[dg] = true;
                groupOrder.push(dg);
              }
              (dataGroupMap[dg] = dataGroupMap[dg] || []).push(v);
            }
            allVisuals.push(v);
          });
          return {all: allVisuals, order: groupOrder, map: dataGroupMap};
        }

        function nInt(x, lo, hi){
          var n = parseInt(x,10);
          if(!isFinite(n)) n = 0;
          return clamp(n, lo, hi);
        }
        function nFloat(x, lo, hi){
          var n = parseFloat(x);
          if(!isFinite(n)) n = 0;
          return clamp(n, lo, hi);
        }

        function cardStyleBits(v, inRow, overrides){
          var lay = Object.assign({}, (v && v.layout) ? v.layout : {}, overrides||{});
          var colSpan = nInt(lay.colSpan||1, 1, 6);
          var minH = nInt(lay.minHeight||0, 0, 5000);
          var heightPx = nInt(lay.heightPx||0, 0, 5000);
          var widthPct = nFloat(lay.widthPct||0, 0, 100);
          var bits = [];
          if(!inRow && colSpan>1) bits.push('grid-column: span '+colSpan);
          if(minH>0) bits.push('min-height:'+minH+'px');
          if(heightPx>0) bits.push('height:'+heightPx+'px;min-height:'+heightPx+'px');
          if(inRow && widthPct>0) bits.push('flex:0 0 '+widthPct+'%;max-width:'+widthPct+'%');
          return bits;
        }

        function renderSingleCard(v, inRow){
          var bits = cardStyleBits(v, inRow);
          /* Add custom visual card styles */
          if(v.cardBgColor) bits.push('background:'+v.cardBgColor);
          if(v.cardBorderColor) bits.push('border-color:'+v.cardBorderColor);
          if(v.cardBorderWidth != null) bits.push('border-width:'+v.cardBorderWidth+'px');
          if(v.cardBorderRadius != null) bits.push('border-radius:'+v.cardBorderRadius+'px');
          
          var def = Registry[v.type];
          var typeLabel = def ? (def.label||v.type) : v.type;
          var ni = (def && def.implemented===false);
          var titleVisible = (v.showTitle !== false);
          var titleAlign = v.titleAlign || 'left';
          var titleSize = v.titleSize || 14;
          var titleColor = v.titleColor || '';
          var titleStyle = 'text-align:'+titleAlign+';font-size:'+titleSize+'px';
          if(titleColor) titleStyle += ';color:'+titleColor;
          // NEW: Add data-group-key attribute for collapse/expand functionality
          var dataGroupKey = getDataGroupKey(v);
          var groupKeyAttr = dataGroupKey ? (' data-group-key="'+escapeHtml(dataGroupKey)+'"') : '';
          return ''
            + '<div class="card" data-vid="'+escapeHtml(v.id)+'" data-sec="'+escapeHtml(secKey||'')+'"'+groupKeyAttr+' style="'+escapeHtml(bits.join(';'))+'">'
            + '  <div class="hdr">'
            + (SHOW_VISUAL_HEADER_TEXT ? ('    <div class="left"' + (titleVisible ? '' : ' style="visibility:hidden"') + '>'
                                    + '      <div class="title" title="'+escapeHtml(v.title||'')+'" style="'+titleStyle+'">'+escapeHtml(v.title||'')+'</div>'
            + '    </div>') : '    <div class="left"></div>')
            + '    <div class="right">'
            + bizButtonsHtml(v)
            + '    </div>'
            + '  </div>'
            + '  <div class="body">'
            + '    <div class="plot" data-vid="'+escapeHtml(v.id)+'" data-sec="'+escapeHtml(secKey||'')+'"></div>'
            + '  </div>'
            + '</div>';
        }

        function renderGroupCard(leader, kids, inRow){
          var groupId = (leader.layout && leader.layout.group) ? String(leader.layout.group||'').trim() : '';

          // Allow group card sizing to be driven by the leader, with fallbacks to kids.
          var leaderLay = leader.layout || {};
          var widthPct = nFloat(leaderLay.widthPct||0, 0, 100);
          var heightPx = nInt(leaderLay.heightPx||0, 0, 5000);
          for(var k=0;k<kids.length;k++){
            var kl = kids[k].layout || {};
            if(widthPct<=0) widthPct = nFloat(kl.widthPct||0, 0, 100);
            heightPx = Math.max(heightPx, nInt(kl.heightPx||0, 0, 5000));
          }

          var bits = cardStyleBits(leader, inRow, {widthPct: widthPct, heightPx: heightPx});
          if(!inRow){
            var gSpan = 1;
            for(var k0=0;k0<kids.length;k0++){
              var cs = nInt((kids[k0].layout && kids[k0].layout.colSpan)||1, 1, 6);
              gSpan = Math.max(gSpan, cs);
            }
            // Replace any existing grid-column rule.
            for(var bi=bits.length-1; bi>=0; bi--){
              if(String(bits[bi]).indexOf('grid-column:')===0) bits.splice(bi,1);
            }
            if(gSpan>1) bits.push('grid-column: span '+gSpan);
          }

          // NEW: Add data-group-key attribute for data-based group collapse/expand
          var dataGroupKey = getDataGroupKey(leader);
          var groupKeyAttr = dataGroupKey ? (' data-group-key="'+escapeHtml(dataGroupKey)+'"') : '';

          var h = ''
            + '<div class="card" data-group="'+escapeHtml(groupId)+'"'+groupKeyAttr+' style="'+escapeHtml(bits.join(';'))+'">'
            + '  <div class="hdr">'
            + (SHOW_VISUAL_HEADER_TEXT ? ('    <div class="left"' + (titleVisible ? '' : ' style="visibility:hidden"') + '>'
            + '      <span class="type">Group</span>'
            + '      <div class="title" title="'+escapeHtml(groupId)+'">'+escapeHtml(groupId)+'</div>'
            + '    </div>') : '    <div class="left"></div>')
            + '    <div class="right"></div>'
            + '  </div>'
            + '  <div class="group-body">';

          for(var kk=0;kk<kids.length;kk++){
            var kv = kids[kk];
            var defK = Registry[kv.type];
            var typeLabelK = defK ? (defK.label||kv.type) : kv.type;
            var niK = (defK && defK.implemented===false);
            var w = clamp(parseFloat((kv.layout && kv.layout.stackWeight)||1)||1, 0.25, 10);
            var kvTitleAlign = kv.titleAlign || 'left';
            var kvTitleSize = kv.titleSize || 14;
            var kvTitleStyle = 'text-align:'+kvTitleAlign+';font-size:'+kvTitleSize+'px';
            h += ''
              + '<div class="subvis" data-vid="'+escapeHtml(kv.id)+'" data-sec="'+escapeHtml(secKey||'')+'" style="flex:'+w+' 1 0">'
              + '  <div class="subhdr">'
              + (SHOW_VISUAL_HEADER_TEXT ? ('    <div class="left"' + (titleVisible ? '' : ' style="visibility:hidden"') + '>'
              + '      <span class="type">'+escapeHtml(typeLabelK)+'</span>'
              + (niK ? ' <span class="badge">NI</span>' : '')
              + '      <div class="title" title="'+escapeHtml(kv.title||'')+'" style="'+kvTitleStyle+'">'+escapeHtml(kv.title||typeLabelK)+'</div>'
              + '    </div>') : '    <div class="left"></div>')
              + '    <div class="right">'
              + bizButtonsHtml(kv)
              + '    </div>'
              + '  </div>'
              + '  <div class="subbody">'
              + '    <div class="plot" data-vid="'+escapeHtml(kv.id)+'" data-sec="'+escapeHtml(secKey||'')+'"></div>'
              + '  </div>'
              + '</div>';
          }

          h += ''
            + '  </div>'
            + '</div>';
          return h;
        }

        // Build ordered items (single visuals or group cards). Row id creates a flex row.
        var order = [];
        var rowBuckets = Object.create(null);
        var rowSeen = Object.create(null);
        var groupSeen = Object.create(null);
        
        // NEW: Track data groups for separator rendering
        var dataGroupElements = getGroupVisualElements();
        var currentDataGroup = null;

        function addToRow(rowId, item){
          (rowBuckets[rowId] = rowBuckets[rowId] || []).push(item);
          if(!rowSeen[rowId]){
            rowSeen[rowId] = true;
            order.push({kind:'row', rowId: rowId});
          }
        }

        for(var i=0;i<visuals.length;i++){
          var v = ensureVisualDefaults(visuals[i]);
          if(!v.show) continue;

          // NEW: Check for data group and add separator if group changed
          var vDataGroup = getDataGroupKey(v);
          if(vDataGroup && vDataGroup !== currentDataGroup){
            currentDataGroup = vDataGroup;
            // Add separator before new group
            var groupConfig = {
              groupKeyText: vDataGroup,
              groupTitle: (v.layout && v.layout.groupTitle) ? String(v.layout.groupTitle||'').trim() : '',
              groupSubtitle: (v.layout && v.layout.groupSubtitle) ? String(v.layout.groupSubtitle||'').trim() : '',
              separatorColor: (v.layout && v.layout.separatorColor) ? String(v.layout.separatorColor||'') : '#d1d5db',
              separatorHeight: parseInt((v.layout && v.layout.separatorHeight)||2, 10),
              collapsible: !!(v.layout && v.layout.groupCollapsible)
            };
            order.push({kind:'dataGroupSeparator', config: groupConfig});
          }

          var groupId = (v.layout && v.layout.group) ? String(v.layout.group||'').trim() : '';
          if(groupId){
            if(groupSeen[groupId]) continue;
            groupSeen[groupId] = true;
            var kids = groupMap[groupId] || [v];
            var r = rowIdFor(v);
            if(!r){
              for(var k=0;k<kids.length;k++){
                r = rowIdFor(kids[k]);
                if(r) break;
              }
            }
            var item = {kind:'group', leader:v, kids:kids};
            if(r) addToRow(r, item);
            else order.push(item);
            continue;
          }

          var r2 = rowIdFor(v);
          var item2 = {kind:'single', v:v};
          if(r2) addToRow(r2, item2);
          else order.push(item2);
        }

        var html = '';
        for(var oi=0;oi<order.length;oi++){
          var it = order[oi];
          
          // NEW: Render data group separators with titles and collapse controls
          if(it.kind==='dataGroupSeparator'){
            var cfg = it.config||{};
            var sepColId = 'sep-'+escapeHtml(cfg.groupKeyText).replace(/[^a-zA-Z0-9]/g,'_');
            var collHtml = '';
            if(cfg.collapsible){
              collHtml = '<button class="btn vm-group-toggle" data-group="'+escapeHtml(cfg.groupKeyText)+'" title="Toggle group visibility" style="margin-right:8px;padding:2px 8px;font-size:11px">▼</button>';
            }
            html += ''
              + '<div class="vm-group-separator" data-group="'+escapeHtml(cfg.groupKeyText)+'" style="grid-column:1/-1;border-top:'+cfg.separatorHeight+'px solid '+escapeHtml(cfg.separatorColor)+';margin:16px 0;padding-top:12px">'
              + '  <div style="display:flex;align-items:center;justify-content:space-between;padding:0 4px">'
              + '    <div>'
              + (cfg.groupTitle ? '      <div class="vm-group-title" style="font-weight:600;font-size:14px;color:#1f2937;margin-bottom:2px">'+escapeHtml(cfg.groupTitle)+'</div>' : '')
              + (cfg.groupSubtitle ? '      <div class="vm-group-subtitle" style="font-size:12px;color:#6b7280">'+escapeHtml(cfg.groupSubtitle)+'</div>' : '')
              + '    </div>'
              + '    <div>'+collHtml+'</div>'
              + '  </div>'
              + '</div>';
            continue;
          }
          
          if(it.kind==='row'){
            var rid = it.rowId;
            var items = rowBuckets[rid] || [];
            // NEW: Check if items in this row belong to a data group
            var rowDataGroupKey = '';
            for(var rii=0;rii<items.length;rii++){
              var itemCheck = items[rii];
              if(itemCheck.kind==='group'){
                var checkKey = getDataGroupKey(itemCheck.leader);
                if(checkKey){ rowDataGroupKey = checkKey; break; }
              }else if(itemCheck.v){
                var checkKey2 = getDataGroupKey(itemCheck.v);
                if(checkKey2){ rowDataGroupKey = checkKey2; break; }
              }
            }
            var rowGroupAttr = rowDataGroupKey ? (' data-group-key="'+escapeHtml(rowDataGroupKey)+'"') : '';
            html += '<div class="vm-row" data-row="'+escapeHtml(rid)+'"'+rowGroupAttr+'>';
            for(var ri=0;ri<items.length;ri++){
              var it2 = items[ri];
              html += (it2.kind==='group') ? renderGroupCard(it2.leader, it2.kids, true) : renderSingleCard(it2.v, true);
            }
            html += '</div>';
            continue;
          }
          html += (it.kind==='group') ? renderGroupCard(it.leader, it.kids, false) : renderSingleCard(it.v, false);
        }
        return html;
      }

      var html='';
      var isCustom = (STATE.globals.layoutMode === 'custom');

      if(isCustom){
        // Custom grid layout
        var cg = STATE.globals.customGrid || {};
        var cgCols = clamp(cg.cols||6, 1, 24);
        var cgRh = clamp(cg.rowHeight||80, 30, 300);
        var cgGw = clamp(cg.gridWidth||0, 0, 5000);
        var cgGh = clamp(cg.gridHeight||0, 0, 5000);
        var tiles = Array.isArray(cg.tiles) ? cg.tiles : [];
        gridEl.style.gridTemplateColumns = 'repeat('+cgCols+', 1fr)';
        gridEl.style.gridAutoRows = cgRh + 'px';
        gridEl.style.width = cgGw > 0 ? (cgGw + 'px') : '';
        gridEl.style.maxWidth = cgGw > 0 ? (cgGw + 'px') : '';
        gridEl.style.height = cgGh > 0 ? (cgGh + 'px') : '';
        gridEl.style.overflow = cgGh > 0 ? 'auto' : '';

        var rendered = {};
        for(var ti=0; ti<tiles.length; ti++){
          var t = tiles[ti];
          if(!t.vid || rendered[t.vid]) continue;
          rendered[t.vid] = true;
          var vObj = null;
          for(var vfi=0; vfi<visuals.length; vfi++){
            if(visuals[vfi].id === t.vid){ vObj = ensureVisualDefaults(visuals[vfi]); break; }
          }
          if(!vObj) continue;
          var defC = Registry[vObj.type];
          var typeLabelC = defC ? (defC.label||vObj.type) : vObj.type;
          var niC = (defC && defC.implemented===false);
          var titleVisC = (vObj.showTitle !== false);
          var gs = 'grid-column:'+(t.x+1)+'/span '+t.w+';grid-row:'+(t.y+1)+'/span '+t.h;
          gs += ';height:auto;min-height:0';
          html += '<div class="card" data-vid="'+escapeHtml(vObj.id)+'" data-sec="" style="'+escapeHtml(gs)+'">';
          html += '  <div class="hdr"' + (titleVisC ? '' : ' style="display:none"') + '>';
          html += (SHOW_VISUAL_HEADER_TEXT ? ('    <div class="left">'
            + '      <span class="type">'+escapeHtml(typeLabelC)+'</span>'
            + (niC ? ' <span class="badge">NI</span>' : '')
            + '      <div class="title" title="'+escapeHtml(vObj.title||'')+'">'+escapeHtml(vObj.title||typeLabelC)+'</div>'
            + '    </div>') : '    <div class="left"></div>');
          html += '    <div class="right">';
          html += bizButtonsHtml(vObj);
          html += '    </div></div>';
          html += '  <div class="body"><div class="plot" data-vid="'+escapeHtml(vObj.id)+'" data-sec=""></div></div>';
          html += '</div>';
        }
      } else {
        // Reset custom grid CSS overrides
        gridEl.style.gridTemplateColumns = '';
        gridEl.style.gridAutoRows = '';
        gridEl.style.width = '';
        gridEl.style.maxWidth = '';
        gridEl.style.height = '';
        gridEl.style.overflow = '';

      var secEnabled = !!(ctx.sections && ctx.sections.enabled && ctx.sections.splitCol);
      var secCol = secEnabled ? String(ctx.sections.splitCol) : '';
      var secList = [];
      if(secEnabled){
        var seen = Object.create(null);
        for(var rr=0;rr<(ctx.rows||[]).length;rr++){
          var sv = asString((ctx.rows[rr]||{})[secCol]);
          if(sv==='' || sv==null) sv = '(Blank)';
          if(seen[sv]) continue;
          seen[sv]=1;
          secList.push(sv);
        }
      }

      if(secEnabled && secList.length){
        for(var si=0;si<secList.length;si++){
          var secKey = secList[si];
          html += ''
            + '<div class="vm-section">'
            + '  <div class="vm-section-title">'+escapeHtml(secCol)+': '+escapeHtml(secKey)+'</div>'
            + '  <div class="grid vm-subgrid">'
            + cardsHtmlForSection(secKey)
            + '  </div>'
            + '</div>';
        }
      }else{
        html += cardsHtmlForSection('');
      }

      } // end else (auto mode)

      gridEl.innerHTML = html;

      // NEW FEATURE: Add event handlers for data group collapse/expand buttons
      var groupToggleButtons = gridEl.querySelectorAll('.vm-group-toggle');
      for(var gti=0;gti<groupToggleButtons.length;gti++){
        (function(btn){
          btn.onclick = function(e){
            e.stopPropagation();
            var groupKey = btn.getAttribute('data-group');
            if(!groupKey) return;
            
            // Find all cards in this group and toggle visibility
            var separator = gridEl.querySelector('.vm-group-separator[data-group="'+CSS.escape(groupKey)+'"]');
            var cardsInGroup = gridEl.querySelectorAll('.card[data-group-key="'+CSS.escape(groupKey)+'"]');
            var rowsInGroup = gridEl.querySelectorAll('.vm-row[data-group-key="'+CSS.escape(groupKey)+'"]');
            
            var isCollapsed = btn.classList.contains('collapsed');
            if(isCollapsed){
              // Expand
              btn.textContent = '▼';
              btn.classList.remove('collapsed');
              cardsInGroup.forEach(function(c){ c.style.display = ''; });
              rowsInGroup.forEach(function(r){ r.style.display = ''; });
            }else{
              // Collapse
              btn.textContent = '▶';
              btn.classList.add('collapsed');
              cardsInGroup.forEach(function(c){ c.style.display = 'none'; });
              rowsInGroup.forEach(function(r){ r.style.display = 'none'; });
            }
          };
        })(groupToggleButtons[gti]);
      }

      // Delegated to document click handler at end of file for performance

      // Render visuals (per plot element instance)
      var vById = Object.create(null);
      for(var vi=0;vi<visuals.length;vi++){
        var vv = ensureVisualDefaults(visuals[vi]);
        vById[vv.id] = vv;
      }

      // Precompute rows per section key
      var rowsBySec = Object.create(null);
      if(secEnabled && secCol){
        for(var rri=0;rri<(ctx.rows||[]).length;rri++){
          var row = ctx.rows[rri] || {};
          var key = asString(row[secCol]);
          if(key==='' || key==null) key='(Blank)';
          (rowsBySec[key] = rowsBySec[key] || []).push(row);
        }
      }

      var plots = gridEl.querySelectorAll('.plot[data-vid]');
      for(var pj=0;pj<plots.length;pj++){
        var pel = plots[pj];
        var vid = pel.getAttribute('data-vid');
        if(!vid) continue;
        var vObj = vById[vid];
        if(!vObj || !vObj.show) continue;
        var def2 = Registry[vObj.type];
        if(!def2 || !def2.render) continue;

        var secKey2 = String(pel.getAttribute('data-sec')||'');
        var rset = (secEnabled && secKey2) ? (rowsBySec[secKey2] || []) : (ctx.rows||[]);
        // In repeat-per-section mode, visuals are already filtered, so disable section-aware behavior.
        var ctx2 = ctx;
        if(secEnabled && secKey2){
          ctx2 = Object.assign({}, ctx, {
            rows: rset,
            sections: Object.assign({}, (ctx && ctx.sections) ? ctx.sections : {}, {enabled:false, splitCol:'', current:'All'})
          });
        }
        try{
          def2.render(vObj, rset, ctx2, pel);
          vmApplyRuntimeOptions(vObj, pel, ctx2);
        }catch(e){
          pel.innerHTML = '<div class="empty">Render error: <span style="font-family:var(--vm-mono)">'+escapeHtml(e && e.message ? e.message : String(e))+'</span></div>';
        }
      }
      
      /* Trigger Plotly resize after all plots are rendered to ensure proper dimensions */
      setTimeout(function(){
        try{
          var plots = gridEl.querySelectorAll('.js-plotly-plot');
          for(var rj=0;rj<plots.length;rj++){
            try{
              if(typeof Plotly !== 'undefined' && Plotly.Plots && Plotly.Plots.resize){
                Plotly.Plots.resize(plots[rj]);
              }
            }catch(e){}
          }
        }catch(e){}
      }, 50);
    }

    // ---------------------------
    // Custom Grid Designer helpers
    // ---------------------------
    function dgOverlap(a, b){
      return !(a.x + a.w <= b.x || b.x + b.w <= a.x || a.y + a.h <= b.y || b.y + b.h <= a.y);
    }
    function dgResolve(tiles, fixedIdx){
      var max = tiles.length * tiles.length + 30;
      while(max-- > 0){
        var pushed = false;
        for(var i=0;i<tiles.length;i++){
          for(var j=i+1;j<tiles.length;j++){
            if(!dgOverlap(tiles[i], tiles[j])) continue;
            var pushJ = true;
            if(j===fixedIdx) pushJ = false;
            else if(i===fixedIdx) pushJ = true;
            else pushJ = (tiles[j].y >= tiles[i].y);
            if(pushJ){ tiles[j].y = tiles[i].y + tiles[i].h; }
            else { tiles[i].y = tiles[j].y + tiles[j].h; }
            pushed = true;
          }
        }
        if(!pushed) break;
      }
    }
    function dgCompact(tiles, cols, fixedIdx){
      for(var i=0;i<tiles.length;i++){
        if(i===fixedIdx) continue;
        var t = tiles[i];
        while(t.y > 0){
          t.y--;
          var ok = true;
          for(var j=0;j<tiles.length;j++){
            if(j===i) continue;
            if(dgOverlap(t, tiles[j])){ ok=false; break; }
          }
          if(!ok){ t.y++; break; }
        }
      }
    }
    function dgMaxRow(tiles){
      var m=0;
      for(var i=0;i<tiles.length;i++) m = Math.max(m, tiles[i].y + tiles[i].h);
      return m;
    }
    function dgAutoLayout(visuals, cols){
      var tiles=[];
      for(var i=0;i<visuals.length;i++){
        var v = visuals[i];
        tiles.push({ vid: (v && v.id)?v.id:'', x: i%cols, y: Math.floor(i/cols), w: 1, h: 1 });
      }
      return tiles;
    }

    function initDesigner(canvasEl, cg, visuals, onChangeCallback){
      var dragState = null;

      function getCols(){ return clamp(cg.cols||6, 1, 24); }
      function getRh(){ return clamp(cg.rowHeight||80, 30, 300); }
      var tiles = cg.tiles;

      function render(){
        var cols = getCols(), rh = getRh();
        var maxR = Math.max(dgMaxRow(tiles), 2);
        canvasEl.style.height = ((maxR+1) * rh) + 'px';

        // Grid lines via SVG
        var linesEl = canvasEl.querySelector('.dg-lines');
        if(!linesEl){
          linesEl = document.createElement('div');
          linesEl.className = 'dg-lines';
          linesEl.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none';
          canvasEl.appendChild(linesEl);
        }
        var svg = '<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">';
        for(var c=0;c<=cols;c++){
          svg += '<line x1="'+(c/cols*100)+'%" y1="0" x2="'+(c/cols*100)+'%" y2="100%" stroke="currentColor" stroke-width="0.5" opacity="0.13"/>';
        }
        for(var r=0;r<=maxR+1;r++){
          svg += '<line x1="0" y1="'+(r*rh)+'" x2="100%" y2="'+(r*rh)+'" stroke="currentColor" stroke-width="0.5" opacity="0.13"/>';
        }
        svg += '</svg>';
        linesEl.innerHTML = svg;

        // Remove old tiles
        var old = canvasEl.querySelectorAll('.vm-dt');
        for(var o=0;o<old.length;o++) old[o].remove();

        // Render tiles
        for(var i=0;i<tiles.length;i++){
          var t = tiles[i];
          var el = document.createElement('div');
          el.className = 'vm-dt';
          el.setAttribute('data-tidx', String(i));
          el.style.left = (t.x / cols * 100) + '%';
          el.style.top = (t.y * rh) + 'px';
          el.style.width = (t.w / cols * 100) + '%';
          el.style.height = (t.h * rh) + 'px';

          var vIdx = -1;
          for(var vi=0;vi<visuals.length;vi++){
            if(visuals[vi] && visuals[vi].id === t.vid){ vIdx = vi; break; }
          }
          var vLabel = (vIdx >= 0) ? ('#' + (vIdx+1)) : '?';
          var vName = (vIdx >= 0) ? (visuals[vIdx].title || visuals[vIdx].type || '') : '';

          el.innerHTML = ''
            + '<div class="dt-h">'
            + '<span>' + escapeHtml(vLabel) + '</span>'
            + '<span style="font-weight:400;opacity:.7;overflow:hidden;text-overflow:ellipsis">' + escapeHtml(vName) + '</span>'
            + '<span class="dt-x" data-act="dt-remove" title="Remove tile">&#10005;</span>'
            + '</div>'
            + '<div class="dt-b">' + escapeHtml(vLabel) + '</div>'
            + '<div class="dt-r"></div>';
          canvasEl.appendChild(el);
        }
        if(onChangeCallback) onChangeCallback();
      }

      canvasEl.addEventListener('pointerdown', function(ev){
        var target = ev.target;
        // Remove tile
        if(target.getAttribute && target.getAttribute('data-act') === 'dt-remove'){
          var tile = target.closest('.vm-dt');
          if(tile){
            var idx = parseInt(tile.getAttribute('data-tidx'),10);
            if(idx >= 0 && idx < tiles.length){ tiles.splice(idx, 1); render(); }
          }
          return;
        }
        var tileEl = target.closest('.vm-dt');
        if(!tileEl) return;
        var idx = parseInt(tileEl.getAttribute('data-tidx'),10);
        if(isNaN(idx) || idx < 0 || idx >= tiles.length) return;

        var isResize = target.classList.contains('dt-r');
        var isDrag = !isResize && !!target.closest('.dt-h');
        if(!isDrag && !isResize) return;

        ev.preventDefault();
        tileEl.classList.add('active');
        var cols = getCols(), rh = getRh();
        var cw = canvasEl.clientWidth / cols;
        var orig = { x: tiles[idx].x, y: tiles[idx].y, w: tiles[idx].w, h: tiles[idx].h };
        dragState = { idx: idx, isResize: isResize, startX: ev.clientX, startY: ev.clientY, orig: orig, el: tileEl, cw: cw, cols: cols, rh: rh };
      });

      document.addEventListener('pointermove', function(ev){
        if(!dragState) return;
        ev.preventDefault();
        var ds = dragState;
        var dx = ev.clientX - ds.startX;
        var dy = ev.clientY - ds.startY;
        var t = tiles[ds.idx];
        if(ds.isResize){
          t.w = Math.max(1, Math.min(Math.round(ds.orig.w + dx / ds.cw), ds.cols - t.x));
          t.h = Math.max(1, Math.round(ds.orig.h + dy / ds.rh));
        } else {
          t.x = Math.max(0, Math.min(Math.round(ds.orig.x + dx / ds.cw), ds.cols - t.w));
          t.y = Math.max(0, Math.round(ds.orig.y + dy / ds.rh));
        }
        dgResolve(tiles, ds.idx);
        dgCompact(tiles, ds.cols, ds.idx);
        render();
      });

      document.addEventListener('pointerup', function(ev){
        if(!dragState) return;
        if(dragState.el) dragState.el.classList.remove('active');
        var cols = dragState.cols;
        var idx = dragState.idx;
        dragState = null;
        dgResolve(tiles, idx);
        dgCompact(tiles, cols, -1);
        render();
      });

      render();
      return { render: render };
    }

    // ---------------------------
    // Manager modal
    // ---------------------------
    var mgrBackdrop = q('#vm-manager-backdrop');
    var mgrBody = q('#vm-mgr-body');
    var mgrTabs = q('#vm-mgr-tabs');
    var mgrTab = 'layout';

    var mgrDraft = null;

    function openManager(){
      mgrDraft = deepClone(STATE);
      mgrTab = 'layout';
      renderManager();
      mgrBackdrop.style.display='block';
      mgrBackdrop.setAttribute('aria-hidden','false');
    }
    function closeManager(){
      mgrBackdrop.style.display='none';
      mgrBackdrop.setAttribute('aria-hidden','true');
      mgrDraft = null;
    }

    function renderManager(){
      var ctx = buildCtx();
      // tabs
      var tabEls = mgrTabs.querySelectorAll('.tab');
      for(var i=0;i<tabEls.length;i++){
        var t=tabEls[i];
        t.classList.toggle('active', t.getAttribute('data-tab')===mgrTab);
      }

      if(mgrTab==='layout'){
        var mode = mgrDraft.globals.layoutMode || 'auto';
        var g = mgrDraft.globals;
        var h = '';

        // === SECTION: General ===
        h += '<div class="section-hdr" data-section="general"><span class="arrow">&#9660;</span> General</div>'
          + '<div class="section-body" data-section="general">'
          + '<div class="form">'
          + '<div class="lbl">Report title</div>'
          + '<div><input id="mgr-title" value="'+escapeHtml(g.title||'')+'" /></div>'
          + '<div class="lbl" style="font-size:10px;margin-top:4px">Format</div>'
          + '<div class="row" style="gap:4px;margin-top:-6px;flex-wrap:wrap">'
          + '  <select id="mgr-title-align" style="width:60px;font-size:11px" title="Alignment">'
          + '    <option value="left" '+(g.titleAlign==='left'||!g.titleAlign?'selected':'')+'>L</option>'
          + '    <option value="center" '+(g.titleAlign==='center'?'selected':'')+'>C</option>'
          + '    <option value="right" '+(g.titleAlign==='right'?'selected':'')+'>R</option>'
          + '  </select>'
          + '  <input id="mgr-title-size" type="number" min="12" max="48" step="1" value="'+escapeHtml(String(g.titleSize||24))+'" style="width:50px;font-size:11px" placeholder="Sz" title="Size (px)" />'
          + '  <input id="mgr-title-color" type="color" value="'+(g.titleColor||'#111827')+'" style="width:38px;height:24px;cursor:pointer;padding:2px" title="Color" />'
          + '  <button id="mgr-title-bold" style="width:28px;height:24px;padding:2px;font-weight:bold;font-size:12px;background:'+(g.titleBold?'rgba(0,0,0,.15)':'var(--vm-input)')+';border:1px solid var(--vm-border);border-radius:6px;cursor:pointer">B</button>'
          + '  <button id="mgr-title-italic" style="width:28px;height:24px;padding:2px;font-style:italic;font-size:12px;background:'+(g.titleItalic?'rgba(0,0,0,.15)':'var(--vm-input)')+';border:1px solid var(--vm-border);border-radius:6px;cursor:pointer">I</button>'
          + '  <button id="mgr-title-underline" style="width:28px;height:24px;padding:2px;text-decoration:underline;font-size:12px;background:'+(g.titleUnderline?'rgba(0,0,0,.15)':'var(--vm-input)')+';border:1px solid var(--vm-border);border-radius:6px;cursor:pointer">U</button>'
          + '</div>'
          + '<div class="lbl" style="margin-top:8px">Subtitle</div>'
          + '<div><input id="mgr-sub" value="'+escapeHtml(g.subtitle||'')+'" /></div>'
          + '<div class="lbl" style="font-size:10px;margin-top:4px">Format</div>'
          + '<div class="row" style="gap:4px;margin-top:-6px;flex-wrap:wrap">'
          + '  <select id="mgr-subtitle-align" style="width:60px;font-size:11px" title="Alignment">'
          + '    <option value="left" '+(g.subtitleAlign==='left'||!g.subtitleAlign?'selected':'')+'>L</option>'
          + '    <option value="center" '+(g.subtitleAlign==='center'?'selected':'')+'>C</option>'
          + '    <option value="right" '+(g.subtitleAlign==='right'?'selected':'')+'>R</option>'
          + '  </select>'
          + '  <input id="mgr-subtitle-size" type="number" min="10" max="32" step="1" value="'+escapeHtml(String(g.subtitleSize||16))+'" style="width:50px;font-size:11px" placeholder="Sz" title="Size (px)" />'
          + '  <input id="mgr-subtitle-color" type="color" value="'+(g.subtitleColor||'#6b7280')+'" style="width:38px;height:24px;cursor:pointer;padding:2px" title="Color" />'
          + '  <button id="mgr-subtitle-bold" style="width:28px;height:24px;padding:2px;font-weight:bold;font-size:12px;background:'+(g.subtitleBold?'rgba(0,0,0,.15)':'var(--vm-input)')+';border:1px solid var(--vm-border);border-radius:6px;cursor:pointer">B</button>'
          + '  <button id="mgr-subtitle-italic" style="width:28px;height:24px;padding:2px;font-style:italic;font-size:12px;background:'+(g.subtitleItalic?'rgba(0,0,0,.15)':'var(--vm-input)')+';border:1px solid var(--vm-border);border-radius:6px;cursor:pointer">I</button>'
          + '  <button id="mgr-subtitle-underline" style="width:28px;height:24px;padding:2px;text-decoration:underline;font-size:12px;background:'+(g.subtitleUnderline?'rgba(0,0,0,.15)':'var(--vm-input)')+';border:1px solid var(--vm-border);border-radius:6px;cursor:pointer">U</button>'
          + '</div>'
          + '<div class="lbl" style="margin-top:8px">Report Image (Logo)</div>'
          + '<div><input id="mgr-image-url" type="text" value="'+escapeHtml(g.imageUrl||'')+'" placeholder="Image URL or data:image/..." /></div>'
          + '<div class="note" style="margin-top:4px">Optional image to display as logo before title (max width 80px)</div>'
          + '<div class="lbl" style="margin-top:8px">Titlebar Corner Radius (px)</div>'
          + '<div><input id="mgr-titlebar-radius" type="number" min="0" max="30" step="1" value="'+escapeHtml(String(g.titlebarRadius||14))+'" style="width:60px" placeholder="Radius" /></div>'
          + '</div></div>';

        // === SECTION: Layout Mode ===
        h += '<div class="section-hdr" data-section="layoutmode"><span class="arrow">&#9660;</span> Layout Mode <span class="s-badge">'+escapeHtml(mode==='custom'?'Custom Grid':'Automatic')+'</span></div>'
          + '<div class="section-body" data-section="layoutmode">'
          + '<div class="form">'
          + '<div class="lbl">Mode</div>'
          + '<div class="row">'
          + '  <select id="mgr-layout-mode" style="min-width:200px">'
          + '    <option value="auto" '+(mode==='auto'?'selected':'')+'>Automatic (responsive grid)</option>'
          + '    <option value="custom" '+(mode==='custom'?'selected':'')+'>Custom grid (drag &amp; resize)</option>'
          + '  </select>'
          + '</div>';

        if(mode === 'auto'){
          h += ''
            + '<div class="lbl">Visuals per row</div>'
            + '<div class="row">'
            + '  <input id="mgr-vpr" type="number" min="1" max="6" step="1" value="'+escapeHtml(String(g.visualsPerRow||2))+'" style="width:100px" />'
            + '  <span class="note">1�6 columns</span>'
            + '</div>'
            + '<div class="lbl">Card height (px)</div>'
            + '<div class="row">'
            + '  <input id="mgr-cardh" type="number" min="180" max="1400" step="10" value="'+escapeHtml(String(g.cardHeight||320))+'" style="width:100px" />'
            + '  <span class="note">Min height of each visual card</span>'
            + '</div>';
        } else {
          var cgd = g.customGrid || {cols:6, rowHeight:80, gridWidth:0, gridHeight:0, tiles:[]};
          g.customGrid = cgd;
          var draftVis = Array.isArray(mgrDraft.visuals) ? mgrDraft.visuals : [];
          if(!cgd.tiles.length && draftVis.length){
            cgd.tiles = dgAutoLayout(draftVis, cgd.cols);
          }
          h += ''
            + '<div class="lbl">Grid columns</div>'
            + '<div class="row">'
            + '  <input id="mgr-cg-cols" type="number" min="1" max="24" step="1" value="'+escapeHtml(String(cgd.cols||6))+'" style="width:100px" />'
            + '  <span class="note">Tiles snap to columns</span>'
            + '</div>'
            + '<div class="lbl">Column height (px)</div>'
            + '<div class="row">'
            + '  <input id="mgr-cg-rh" type="number" min="30" max="300" step="10" value="'+escapeHtml(String(cgd.rowHeight||80))+'" style="width:100px" />'
            + '  <span class="note">Tile height = column height � row span</span>'
            + '</div>'
            + '<div class="lbl">Grid width (px)</div>'
            + '<div class="row">'
            + '  <input id="mgr-cg-gw" type="number" min="0" max="5000" step="10" value="'+escapeHtml(String(cgd.gridWidth||0))+'" style="width:100px" />'
            + '  <span class="note">0 = 100% fluid</span>'
            + '</div>'
            + '<div class="lbl">Grid height (px)</div>'
            + '<div class="row">'
            + '  <input id="mgr-cg-gh" type="number" min="0" max="5000" step="10" value="'+escapeHtml(String(cgd.gridHeight||0))+'" style="width:100px" />'
            + '  <span class="note">0 = auto-expand</span>'
            + '</div>';
        }
        h += '</div></div>';

        // === SECTION: Spacing ===
        h += '<div class="section-hdr" data-section="spacing"><span class="arrow">&#9660;</span> Spacing</div>'
          + '<div class="section-body" data-section="spacing">'
          + '<div class="form">'
          + '<div class="lbl">Grid gap (px)</div>'
          + '<div class="row">'
          + '  <input id="mgr-gap" type="number" min="0" max="40" step="1" value="'+escapeHtml(String(g.gridGap||10))+'" style="width:100px" />'
          + '</div>'
          + '<div class="lbl">Top spacing (px)</div>'
          + '<div class="row">'
          + '  <input id="mgr-topgap" type="number" min="0" max="30" step="1" value="'+escapeHtml(String(g.topGap==null?6:g.topGap))+'" style="width:100px" />'
          + '  <span class="note">Above the grid</span>'
          + '</div>'
          + '<div class="lbl">Section spacing (px)</div>'
          + '<div class="row">'
          + '  <input id="mgr-secgap" type="number" min="0" max="30" step="1" value="'+escapeHtml(String(g.sectionGap==null?4:g.sectionGap))+'" style="width:100px" />'
          + '</div>'
          + '</div></div>';

        // === SECTION: Appearance ===
        h += '<div class="section-hdr" data-section="appearance"><span class="arrow">&#9660;</span> Appearance</div>'
          + '<div class="section-body" data-section="appearance">'
          + '<div class="form">'
          + '<div class="lbl">Theme</div>'
          + '<div class="row">'
          + '  <select id="mgr-theme" style="min-width:160px">'
          + '    <option value="light" '+((g.theme||PV_THEME_DEFAULT)==='light'?'selected':'')+'>Light</option>'
          + '    <option value="dark" '+((g.theme||PV_THEME_DEFAULT)==='dark'?'selected':'')+'>Dark</option>'
          + '    <option value="paper" '+((g.theme||PV_THEME_DEFAULT)==='paper'?'selected':'')+'>Paper</option>'
          + '  </select>'
          + '</div>'
          + '<div class="lbl">Grid background</div>'
          + '<div class="color-row">'
          + '  <input type="color" id="mgr-grid-bg" value="'+(g.gridBgColor||'#ffffff')+'" />'
          + '  <input type="text" id="mgr-grid-bg-txt" value="'+escapeHtml(g.gridBgColor||'')+'" placeholder="transparent" />'
          + '  <button class="btn" type="button" id="mgr-grid-bg-clear" style="padding:4px 8px;font-size:11px">Clear</button>'
          + '</div>'
          + '<div class="lbl">Card border color</div>'
          + '<div class="color-row">'
          + '  <input type="color" id="mgr-card-bc" value="'+(g.cardBorderColor||'#e5e7eb')+'" />'
          + '  <input type="text" id="mgr-card-bc-txt" value="'+escapeHtml(g.cardBorderColor||'')+'" placeholder="default" />'
          + '  <button class="btn" type="button" id="mgr-card-bc-clear" style="padding:4px 8px;font-size:11px">Clear</button>'
          + '</div>'
          + '<div class="lbl">Card border radius (px)</div>'
          + '<div class="row">'
          + '  <input id="mgr-card-br" type="number" min="0" max="40" step="1" value="'+escapeHtml(String(g.cardBorderRadius!=null?g.cardBorderRadius:14))+'" style="width:100px" />'
          + '  <span class="note">0 = sharp corners, 14 = default</span>'
          + '</div>'
          + '<div class="lbl">Palette (Light)</div>'
          + '<div class="row">'
          + '  <input id="mgr-pal-light" value="'+escapeHtml(String(g.paletteLight||''))+'" placeholder="#2563eb,#059669,#f59e0b" style="min-width:320px" />'
          + '</div>'
          + '<div class="lbl">Palette (Dark)</div>'
          + '<div class="row">'
          + '  <input id="mgr-pal-dark" value="'+escapeHtml(String(g.paletteDark||''))+'" placeholder="#93c5fd,#34d399,#fbbf24" style="min-width:320px" />'
          + '</div>'
          + '</div></div>';

        // === SECTION: Modebar Icons (global defaults) ===
        var gMb = (g.modebarIcons && typeof g.modebarIcons === 'object') ? g.modebarIcons : {};
        h += '<div class="section-hdr" data-section="modebar"><span class="arrow">&#9660;</span> Modebar Icons</div>'
          + '<div class="section-body" data-section="modebar">'
          + '<div class="form">'
          + '<div class="note" style="margin-bottom:8px">Control which icons are shown in the Plotly modebar across all visuals by default. Per-visual overrides can be set in each visual\'s Options tab.</div>';
        var mbDefNames = {reset:'Reset / Home', points:'Points / Labels / Styles', filter:'Outliers', zoom:'Zoom / Pan', remove:'Remove Point', download:'Download', fs:'Fullscreen'};
        for(var mbi=0; mbi<VM_DEFAULT_MODEBAR_ICONS.length; mbi++){
          var mbk = VM_DEFAULT_MODEBAR_ICONS[mbi];
          var mbChecked = (gMb[mbk] !== false) ? 'checked' : '';
          h += '<div class="row"><label class="note"><input type="checkbox" data-mgr-modebar="'+escapeHtml(mbk)+'" '+mbChecked+'> '+escapeHtml(mbDefNames[mbk]||mbk)+'</label></div>';
        }
        h += '</div></div>';

        // === SECTION: Sections ===
        h += '<div class="section-hdr" data-section="sections"><span class="arrow">&#9660;</span> Sections <span class="s-badge">'+(mgrDraft.sections.enabled?'ON':'OFF')+'</span></div>'
          + '<div class="section-body" data-section="sections">'
          + '<div class="form">'
          + '<div class="lbl">Enable</div>'
          + '<div class="row">'
          + '  <label class="note"><input id="mgr-sec-on" type="checkbox" '+(mgrDraft.sections.enabled?'checked':'')+'> Split visuals by a column value</label>'
          + '</div>'
          + '<div class="lbl">Split column</div>'
          + '<div><select id="mgr-sec-col">'
          + colOptionsHtml(ctx.cols, mgrDraft.sections.splitCol, true)
          + '</select></div>'
          + '</div></div>';

        // === SECTION: Grid Designer (only in custom mode) — placed last ===
        if(mode === 'custom'){
          h += '<div class="section-hdr" data-section="designer"><span class="arrow">&#9660;</span> Grid Designer <span class="s-badge">'+escapeHtml(String((g.customGrid&&g.customGrid.tiles?g.customGrid.tiles.length:0))+' tiles')+'</span></div>'
            + '<div class="section-body" data-section="designer">'
            + '<div class="row" style="justify-content:flex-end;gap:8px;margin-bottom:6px">'
            + '  <button class="btn" id="mgr-cg-auto" type="button">&#8634; Auto-layout</button>'
            + '  <button class="btn primary" id="mgr-cg-add" type="button">+ Add tile</button>'
            + '</div>'
            + '<div class="vm-dg" id="mgr-cg-canvas"></div>'
            + '<div style="margin-top:8px"><div class="lbl" style="margin-bottom:6px">Tile &#8594; Visual mapping</div>'
            + '<div id="mgr-cg-mapping"></div></div>'
            + '</div>';
        }

        mgrBody.innerHTML = h;

        // Wire collapsible sections
        mgrBody.querySelectorAll('.section-hdr').forEach(function(hdr){
          hdr.onclick = function(){
            var sec = hdr.getAttribute('data-section');
            var body = mgrBody.querySelector('.section-body[data-section="'+sec+'"]');
            if(!body) return;
            var isCollapsed = hdr.classList.contains('collapsed');
            if(isCollapsed){
              hdr.classList.remove('collapsed');
              body.classList.remove('collapsed');
              body.style.maxHeight = body.scrollHeight + 'px';
              setTimeout(function(){ body.style.maxHeight = 'none'; }, 260);
            } else {
              body.style.maxHeight = body.scrollHeight + 'px';
              requestAnimationFrame(function(){
                body.style.maxHeight = '0';
                hdr.classList.add('collapsed');
                body.classList.add('collapsed');
              });
            }
          };
          // Set initial max-height
          var sec = hdr.getAttribute('data-section');
          var body = mgrBody.querySelector('.section-body[data-section="'+sec+'"]');
          if(body) body.style.maxHeight = 'none';
        });

        // Wire color pickers (grid bg)
        var gridBgPicker = document.getElementById('mgr-grid-bg');
        var gridBgTxt = document.getElementById('mgr-grid-bg-txt');
        var gridBgClear = document.getElementById('mgr-grid-bg-clear');
        if(gridBgPicker && gridBgTxt){
          gridBgPicker.oninput = function(){ gridBgTxt.value = gridBgPicker.value; mgrDraft.globals.gridBgColor = gridBgPicker.value; };
          gridBgTxt.onchange = function(){ if(gridBgTxt.value) gridBgPicker.value = gridBgTxt.value; mgrDraft.globals.gridBgColor = String(gridBgTxt.value||'').trim(); };
        }
        if(gridBgClear) gridBgClear.onclick = function(){ if(gridBgTxt) gridBgTxt.value = ''; mgrDraft.globals.gridBgColor = ''; };

        // Wire color pickers (card border)
        var cardBcPicker = document.getElementById('mgr-card-bc');
        var cardBcTxt = document.getElementById('mgr-card-bc-txt');
        var cardBcClear = document.getElementById('mgr-card-bc-clear');
        if(cardBcPicker && cardBcTxt){
          cardBcPicker.oninput = function(){ cardBcTxt.value = cardBcPicker.value; mgrDraft.globals.cardBorderColor = cardBcPicker.value; };
          cardBcTxt.onchange = function(){ if(cardBcTxt.value) cardBcPicker.value = cardBcTxt.value; mgrDraft.globals.cardBorderColor = String(cardBcTxt.value||'').trim(); };
        }
        if(cardBcClear) cardBcClear.onclick = function(){ if(cardBcTxt) cardBcTxt.value = ''; mgrDraft.globals.cardBorderColor = ''; };

        // Wire palette inputs
        var palLight = document.getElementById('mgr-pal-light');
        var palDark = document.getElementById('mgr-pal-dark');
        if(palLight) palLight.onchange = function(){ mgrDraft.globals.paletteLight = String(palLight.value||'').trim(); };
        if(palDark) palDark.onchange = function(){ mgrDraft.globals.paletteDark = String(palDark.value||'').trim(); };

        // Wire layout mode change
        var modeSelEl = document.getElementById('mgr-layout-mode');
        if(modeSelEl){
          modeSelEl.onchange = function(){
            mgrDraft.globals.layoutMode = String(modeSelEl.value || 'auto');
            renderManager();
          };
        }

        // Wire section enable/column to instantly persist into mgrDraft
        var secOnLive = document.getElementById('mgr-sec-on');
        var secColLive = document.getElementById('mgr-sec-col');
        if(secOnLive){
          secOnLive.onchange = function(){
            mgrDraft.sections.enabled = !!secOnLive.checked;
          };
        }
        if(secColLive){
          secColLive.onchange = function(){
            mgrDraft.sections.splitCol = String(secColLive.value || '');
          };
        }

        // Also persist all layout text/number fields on change to avoid loss on tab switch
        var layoutLiveEls = [
          {id:'mgr-title', key:'title'},
          {id:'mgr-title-align', key:'titleAlign'},
          {id:'mgr-title-size', key:'titleSize', type:'int', min:12, max:48},
          {id:'mgr-title-color', key:'titleColor'},
          {id:'mgr-sub', key:'subtitle'},
          {id:'mgr-subtitle-align', key:'subtitleAlign'},
          {id:'mgr-subtitle-size', key:'subtitleSize', type:'int', min:10, max:32},
          {id:'mgr-subtitle-color', key:'subtitleColor'},
          {id:'mgr-vpr', key:'visualsPerRow', type:'int', min:1, max:6},
          {id:'mgr-gap', key:'gridGap', type:'int', min:0, max:40},
          {id:'mgr-topgap', key:'topGap', type:'int', min:0, max:30},
          {id:'mgr-secgap', key:'sectionGap', type:'int', min:0, max:30},
          {id:'mgr-cardh', key:'cardHeight', type:'int', min:180, max:1400},
          {id:'mgr-card-br', key:'cardBorderRadius', type:'int', min:0, max:40},
          {id:'mgr-pal-light', key:'paletteLight'},
          {id:'mgr-pal-dark', key:'paletteDark'}
        ];
        layoutLiveEls.forEach(function(cfg){
          var el = document.getElementById(cfg.id);
          if(!el) return;
          el.onchange = function(){
            if(cfg.type==='int'){
              mgrDraft.globals[cfg.key] = clamp(parseInt(el.value,10)||0, cfg.min, cfg.max);
            } else {
              mgrDraft.globals[cfg.key] = String(el.value||'');
            }
            renderManager();
          };
        });

        // Handle formatting buttons for title
        var btnTitleBold = document.getElementById('mgr-title-bold');
        if(btnTitleBold){
          btnTitleBold.onclick = function(ev){
            ev.preventDefault();
            mgrDraft.globals.titleBold = !mgrDraft.globals.titleBold;
            btnTitleBold.style.background = mgrDraft.globals.titleBold ? 'rgba(0,0,0,.15)' : 'var(--vm-input)';
            renderGrid();
          };
        }
        var btnTitleItalic = document.getElementById('mgr-title-italic');
        if(btnTitleItalic){
          btnTitleItalic.onclick = function(ev){
            ev.preventDefault();
            mgrDraft.globals.titleItalic = !mgrDraft.globals.titleItalic;
            btnTitleItalic.style.background = mgrDraft.globals.titleItalic ? 'rgba(0,0,0,.15)' : 'var(--vm-input)';
            renderGrid();
          };
        }
        var btnTitleUnderline = document.getElementById('mgr-title-underline');
        if(btnTitleUnderline){
          btnTitleUnderline.onclick = function(ev){
            ev.preventDefault();
            mgrDraft.globals.titleUnderline = !mgrDraft.globals.titleUnderline;
            btnTitleUnderline.style.background = mgrDraft.globals.titleUnderline ? 'rgba(0,0,0,.15)' : 'var(--vm-input)';
            renderGrid();
          };
        }

        // Handle formatting buttons for subtitle
        var btnSubBold = document.getElementById('mgr-subtitle-bold');
        if(btnSubBold){
          btnSubBold.onclick = function(ev){
            ev.preventDefault();
            mgrDraft.globals.subtitleBold = !mgrDraft.globals.subtitleBold;
            btnSubBold.style.background = mgrDraft.globals.subtitleBold ? 'rgba(0,0,0,.15)' : 'var(--vm-input)';
            renderGrid();
          };
        }
        var btnSubItalic = document.getElementById('mgr-subtitle-italic');
        if(btnSubItalic){
          btnSubItalic.onclick = function(ev){
            ev.preventDefault();
            mgrDraft.globals.subtitleItalic = !mgrDraft.globals.subtitleItalic;
            btnSubItalic.style.background = mgrDraft.globals.subtitleItalic ? 'rgba(0,0,0,.15)' : 'var(--vm-input)';
            renderGrid();
          };
        }
        var btnSubUnderline = document.getElementById('mgr-subtitle-underline');
        if(btnSubUnderline){
          btnSubUnderline.onclick = function(ev){
            ev.preventDefault();
            mgrDraft.globals.subtitleUnderline = !mgrDraft.globals.subtitleUnderline;
            btnSubUnderline.style.background = mgrDraft.globals.subtitleUnderline ? 'rgba(0,0,0,.15)' : 'var(--vm-input)';
            renderGrid();
          };
        }

        // Wire custom grid designer
        if(mode === 'custom'){
          var cgCanvas = document.getElementById('mgr-cg-canvas');
          var cgMapping = document.getElementById('mgr-cg-mapping');
          var cgColsIn = document.getElementById('mgr-cg-cols');
          var cgRhIn = document.getElementById('mgr-cg-rh');
          var cgGwIn = document.getElementById('mgr-cg-gw');
          var cgGhIn = document.getElementById('mgr-cg-gh');
          var cgDraft = mgrDraft.globals.customGrid;
          var draftVisuals = Array.isArray(mgrDraft.visuals) ? mgrDraft.visuals : [];

          if(cgColsIn) cgColsIn.onchange = function(){
            cgDraft.cols = clamp(parseInt(cgColsIn.value,10)||6, 1, 24);
            // Clamp tile x+w to new cols
            for(var ti=0;ti<cgDraft.tiles.length;ti++){
              var tt=cgDraft.tiles[ti];
              if(tt.x >= cgDraft.cols) tt.x = cgDraft.cols - 1;
              if(tt.x + tt.w > cgDraft.cols) tt.w = cgDraft.cols - tt.x;
            }
            dgResolve(cgDraft.tiles, -1);
            dgCompact(cgDraft.tiles, cgDraft.cols, -1);
            if(designerHandle) designerHandle.render();
          };
          if(cgRhIn) cgRhIn.onchange = function(){
            cgDraft.rowHeight = clamp(parseInt(cgRhIn.value,10)||80, 30, 300);
            if(designerHandle) designerHandle.render();
          };
          if(cgGwIn) cgGwIn.onchange = function(){
            cgDraft.gridWidth = clamp(parseInt(cgGwIn.value,10)||0, 0, 5000);
          };
          if(cgGhIn) cgGhIn.onchange = function(){
            cgDraft.gridHeight = clamp(parseInt(cgGhIn.value,10)||0, 0, 5000);
          };
          var autoBtn2 = document.getElementById('mgr-cg-auto');
          if(autoBtn2) autoBtn2.onclick = function(){
            cgDraft.tiles = dgAutoLayout(draftVisuals, cgDraft.cols);
            if(designerHandle) designerHandle.render();
          };

          var addTileBtn = document.getElementById('mgr-cg-add');
          if(addTileBtn) addTileBtn.onclick = function(){
            var nextY = dgMaxRow(cgDraft.tiles);
            cgDraft.tiles.push({ vid: '', x: 0, y: nextY, w: 1, h: 1 });
            if(designerHandle) designerHandle.render();
          };

          function renderTileMapping(){
            if(!cgMapping) return;
            var mh = '';
            for(var i=0;i<cgDraft.tiles.length;i++){
              var ti = cgDraft.tiles[i];
              mh += '<div class="row" style="margin-bottom:4px">'
                + '<span class="note" style="min-width:55px">Tile '+(i+1)+'</span>'
                + '<select data-tidx="'+i+'" style="min-width:240px">'
                + '<option value="">(empty)</option>';
              for(var vi=0;vi<draftVisuals.length;vi++){
                var vv = draftVisuals[vi];
                var defV = Registry[vv.type];
                var lbl = '#'+(vi+1)+': '+(vv.title || (defV?(defV.label||vv.type):vv.type));
                mh += '<option value="'+escapeHtml(vv.id)+'" '+(ti.vid===vv.id?'selected':'')+'>'+escapeHtml(lbl)+'</option>';
              }
              mh += '</select></div>';
            }
            cgMapping.innerHTML = mh;
            cgMapping.querySelectorAll('select[data-tidx]').forEach(function(sel){
              sel.onchange = function(){
                var idx = parseInt(sel.getAttribute('data-tidx'),10);
                if(idx >= 0 && idx < cgDraft.tiles.length){
                  cgDraft.tiles[idx].vid = String(sel.value || '');
                  if(designerHandle) designerHandle.render();
                }
              };
            });
          }

          var designerHandle = initDesigner(cgCanvas, cgDraft, draftVisuals, renderTileMapping);
          renderTileMapping();
        }

        return;
      }

      if(mgrTab==='visuals'){
        var vhtml='';
        var visuals = Array.isArray(mgrDraft.visuals)?mgrDraft.visuals:[];
        var types = registryTypes();
        var implCount = 0, niCount = 0;
        for(var tc=0;tc<types.length;tc++){var dc=Registry[types[tc]];if(dc&&dc.implemented===false)niCount++;else implCount++;}

        vhtml += '<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">'
          + '<div class="note">'+visuals.length+' visual'+(visuals.length!==1?'s':'')+' configured &nbsp; <span class="badge">'+implCount+' types available</span>'+(niCount?' <span class="badge">'+niCount+' coming soon</span>':'')+'</div>'
          + '<div class="row" style="gap:8px">'
          + '  <select id="mgr-add-type" style="min-width:240px">';
        
        // Group visuals by category
        var categories = {};
        var categoryOrder = ['Trends & Distribution', 'Comparisons', 'Parts of Whole', 'Performance Metrics', 'Relationships', 'Data Display', 'Other'];
        for(var t=0;t<types.length;t++){
          var key=types[t]; var defT=Registry[key];
          var cat = (defT && defT.category) ? defT.category : 'Other';
          categories[cat] = categories[cat] || {impl:[], ni:[]};
          if(defT && defT.implemented===false){
            categories[cat].ni.push({key:key, label:defT.label||key});
          } else {
            categories[cat].impl.push({key:key, label:defT.label||key});
          }
        }
        
        // Render categorized options
        for(var ci=0;ci<categoryOrder.length;ci++){
          var catName = categoryOrder[ci];
          var catData = categories[catName];
          if(!catData || (!catData.impl.length && !catData.ni.length)) continue;
          
          if(catData.impl.length){
            vhtml += '<optgroup label="'+escapeHtml(catName)+'">';
            for(var ci2=0;ci2<catData.impl.length;ci2++){
              var item = catData.impl[ci2];
              vhtml += '<option value="'+escapeHtml(item.key)+'">'+escapeHtml(item.label)+'</option>';
            }
            if(catData.ni.length){
              for(var ci3=0;ci3<catData.ni.length;ci3++){
                var niItem = catData.ni[ci3];
                vhtml += '<option value="'+escapeHtml(niItem.key)+'" disabled>'+escapeHtml(niItem.label+' (NI)')+'</option>';
              }
            }
            vhtml += '</optgroup>';
          }
        }
        
        vhtml += '  </select>'
          + '  <button class="btn primary" id="mgr-add-btn" type="button">+ Add</button>'
          + '</div></div>';

        if(!visuals.length){
          vhtml += '<div class="empty" style="margin:24px 0">No visuals yet. Choose a type above and click <b>+ Add</b>.</div>';
        } else {
          vhtml += '<div class="list">';
          for(var i=0;i<visuals.length;i++){
            var v = ensureVisualDefaults(visuals[i]);
            var def = Registry[v.type];
            var ni = (def && def.implemented===false);
            var showIcon = v.show ? '??' : '??';
            var showTitle = v.show ? 'Visible � click to hide' : 'Hidden � click to show';
            vhtml += ''
              + '<div class="list-item" data-vid="'+escapeHtml(v.id)+'" style="'+(v.show?'':'opacity:.5;border-style:dashed')+'">'
              + '  <div class="top">'
              + '    <div style="display:flex;align-items:center;gap:10px;min-width:0">'
              + '      <span class="badge" style="flex:0 0 auto">#'+(i+1)+'</span>'
              + '      <span class="badge" style="flex:0 0 auto">'+escapeHtml(def?def.label:v.type)+'</span>'
              + (ni?' <span class="badge" style="color:var(--vm-warn)">NI</span>':'')
              + '      <span style="font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+escapeHtml(v.title||'Untitled')+'</span>'
              + '    </div>'
              + '    <div class="actions" style="flex:0 0 auto">'
              + '      <button class="btn ico small" data-act="toggle" title="'+escapeHtml(showTitle)+'" type="button">'+showIcon+'</button>'
              + '      <button class="btn ico small" data-act="up" title="Move up" type="button">&#9650;</button>'
              + '      <button class="btn ico small" data-act="down" title="Move down" type="button">&#9660;</button>'
              + '      <button class="btn" data-act="dup" type="button" style="font-size:11px;padding:4px 8px">Clone</button>'
              + '      <button class="btn" data-act="del" type="button" style="font-size:11px;padding:4px 8px;border-color:rgba(251,113,133,.35)">&#10005;</button>'
              + '    </div>'
              + '  </div>'
              + '</div>';
          }
          vhtml += '</div>';
        }

        mgrBody.innerHTML = vhtml;

        var addBtn = document.getElementById('mgr-add-btn');
        addBtn.onclick = function(){
          var typeEl = document.getElementById('mgr-add-type');
          var typ = typeEl ? String(typeEl.value||'line') : 'line';
          var def = Registry[typ];
          if(!def) return;
          var v = def.defaultVisual();
          mgrDraft.visuals.push(v);
          renderManager();
        };

        // List actions
        mgrBody.querySelectorAll('.list-item').forEach(function(item){
          item.addEventListener('click', function(ev){
            var act = ev.target && ev.target.getAttribute && ev.target.getAttribute('data-act');
            if(!act) return;
            var vid = item.getAttribute('data-vid');
            var idx = mgrDraft.visuals.findIndex(function(x){return x && x.id===vid;});
            if(idx<0) return;
            if(act==='toggle'){
              mgrDraft.visuals[idx].show = !mgrDraft.visuals[idx].show;
              renderManager();
            }
            if(act==='up' && idx>0){ var tmp=mgrDraft.visuals[idx-1]; mgrDraft.visuals[idx-1]=mgrDraft.visuals[idx]; mgrDraft.visuals[idx]=tmp; renderManager(); }
            if(act==='down' && idx<mgrDraft.visuals.length-1){ var tmp2=mgrDraft.visuals[idx+1]; mgrDraft.visuals[idx+1]=mgrDraft.visuals[idx]; mgrDraft.visuals[idx]=tmp2; renderManager(); }
            if(act==='dup'){
              var copy = deepClone(mgrDraft.visuals[idx]);
              copy.id = uid();
              copy.title = (copy.title||'Visual') + ' (Copy)';
              mgrDraft.visuals.splice(idx+1,0,copy);
              renderManager();
            }
            if(act==='del'){
              mgrDraft.visuals.splice(idx,1);
              renderManager();
            }
          });
        });

        return;
      }

      if(mgrTab==='data'){
        var allRows = currentRows();
        var colList = (ctx && ctx.cols) ? ctx.cols : [];
        var dhtml = '';
        dhtml += '<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:10px">'
          + '<span class="badge" style="font-size:12px">'+allRows.length+' rows</span>'
          + '<span class="badge" style="font-size:12px">'+colList.length+' columns</span>'
          + (allRows.length ? '<span class="badge" style="background:rgba(22,163,74,.1);border-color:rgba(22,163,74,.25);color:#16a34a">Data loaded</span>' : '<span class="badge" style="background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.2);color:#dc2626">No data</span>')
          + '</div>';
        if(colList.length){
          dhtml += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">';
          for(var ci=0;ci<colList.length;ci++){
            dhtml += '<span class="badge">'+escapeHtml(colList[ci])+'</span>';
          }
          dhtml += '</div>';
        }
        dhtml += '<div class="sep"></div>'
          + '<div class="note" style="margin-bottom:6px">Paste a JSON array for local preview/testing. In Oracle Analytics, data auto-loads from <span class="badge">#box-data</span>.</div>'
          + '<textarea id="mgr-data" spellcheck="false" style="min-height:140px" placeholder="[ { &quot;col1&quot;: 123 }, ... ]">'+escapeHtml(mgrDraft.data.jsonText||'')+'</textarea>';
        mgrBody.innerHTML = dhtml;
        return;
      }

      if(mgrTab==='help'){
        mgrBody.innerHTML = ''
          + '<div class="section-hdr" data-section="h-about"><span class="arrow">&#9660;</span> About</div>'
          + '<div class="section-body" data-section="h-about">'
          + '<div class="note">Visual Manager is a unified OAS Narrative template supporting <b>33 Plotly visual types</b> with a registry pattern. Each visual has its own mapping, aggregation, filtering, and layout options. Configured via the modal tabs (Layout, Visuals, Data).</div>'
          + '</div>'
          + '<div class="section-hdr" data-section="h-types"><span class="arrow">&#9660;</span> Available Visual Types</div>'
          + '<div class="section-body" data-section="h-types">'
          + '<div class="note" style="line-height:2">'
          + '<b>Charts:</b> Line, Bar, Stacked Bar, Stacked Area, Pie, Donut, Scatter, Bubble, Funnel, Waterfall, Treemap, Sunburst, Heatmap, Histogram, Candlestick, OHLC, Radar/Spider<br>'
          + '<b>Distribution:</b> Box Plot (box/violin/strip), Regression + Histogram<br>'
          + '<b>KPI/Indicator:</b> KPI (number/gauge/bullet/progress), Scorecard (number+delta), Gauge, Bullet, Progress Bar<br>'
          + '<b>Combo:</b> Line+Bar (dual Y), Multi Y-Axis (dual Y)<br>'
          + '<b>Analytical:</b> Correlation Matrix, Control Chart (SPC), Calendar Heatmap<br>'
          + '<b>Data:</b> Table (conditional formatting, striped, compact), Pivot Table<br>'
          + '<b>Project:</b> Gantt Chart'
          + '</div></div>'
          + '<div class="section-hdr" data-section="h-recipes"><span class="arrow">&#9660;</span> Quick Recipes</div>'
          + '<div class="section-body" data-section="h-recipes">'
          + '<div class="note"><b>A. Custom grid dashboard:</b> Layout ? Mode = Custom grid ? Set columns ? Drag/resize tiles ? Map tiles to visuals.</div>'
          + '<div class="note"><b>B. Grouped stacking:</b> Auto mode ? Per-visual Advanced tab ? Same Group ID ? Adjust Stack weight for proportional heights.</div>'
          + '<div class="note"><b>C. Multi-axis combo:</b> Add a Line+Bar or Multi Y visual ? Map X, left Y measure, right Y measure ? Dual Y-axis auto-configured.</div>'
          + '<div class="note"><b>D. Financial charts:</b> Add Candlestick/OHLC ? Map X (date), Open, High, Low, Close.</div>'
          + '<div class="note"><b>E. Radar/Spider:</b> Add Radar ? Map Theta (categories), Series (optional split), R (value).</div>'
          + '<div class="note"><b>F. Grid appearance:</b> Layout ? Appearance ? Set grid background, card border color/radius.</div>'
          + '<div class="note"><b>G. Sections:</b> Layout ? Sections ? Enable ? Choose split column ? Each value becomes a sub-grid.</div>'
          + '<div class="note"><b>H. Table conditional formatting:</b> Add Table ? Options ? Conditional Formatting ? Add rules (column, operator, threshold, colors).</div>'
          + '<div class="note"><b>I. Pivot table:</b> Add Pivot ? Map Row header, Column header, and Value measure ? Auto-generates cross-tab with heat coloring.</div>'
          + '<div class="note"><b>J. Control chart:</b> Add Control Chart ? Map X (sequence), Y (measure) ? Auto-calculates mean, UCL, LCL with out-of-control markers.</div>'
          + '<div class="note"><b>K. Correlation matrix:</b> Add Correlation ? Select 2+ numeric columns ? Pearson correlations rendered as annotated heatmap.</div>'
          + '<div class="note"><b>L. Gantt chart:</b> Add Gantt ? Map Task name, Start date, End date, optional Group (color) ? Horizontal bar timeline.</div>'
          + '</div>'
          + '<div class="section-hdr" data-section="h-config"><span class="arrow">&#9660;</span> Config (Import/Export)</div>'
          + '<div class="section-body" data-section="h-config">'
          + '<textarea id="mgr-config-io" spellcheck="false" style="min-height:180px">'+escapeHtml(JSON.stringify(mgrDraft, null, 2))+'</textarea>'
          + '<div class="row" style="justify-content:flex-end;margin-top:8px">'
          + '  <button class="btn" id="mgr-config-copy" type="button">Copy to clipboard</button>'
          + '  <button class="btn" id="mgr-config-load" type="button">Load from textbox</button>'
          + '  <button class="btn" id="mgr-config-reset" type="button" style="border-color: rgba(251,113,133,.35)">Reset all</button>'
          + '  <button class="btn" id="mgr-config-clear" type="button" style="border-color: rgba(251,113,133,.35)">Clear saved state</button>'
          + '</div>'
          + '</div>';

        // Wire collapsible sections in help tab
        mgrBody.querySelectorAll('.section-hdr').forEach(function(hdr){
          hdr.onclick = function(){
            var sec = hdr.getAttribute('data-section');
            var body = mgrBody.querySelector('.section-body[data-section="'+sec+'"]');
            if(!body) return;
            var isCollapsed = hdr.classList.contains('collapsed');
            if(isCollapsed){
              hdr.classList.remove('collapsed');
              body.classList.remove('collapsed');
              body.style.maxHeight = body.scrollHeight + 'px';
              setTimeout(function(){ body.style.maxHeight = 'none'; }, 260);
            } else {
              body.style.maxHeight = body.scrollHeight + 'px';
              requestAnimationFrame(function(){
                body.style.maxHeight = '0';
                hdr.classList.add('collapsed');
                body.classList.add('collapsed');
              });
            }
          };
          var sec = hdr.getAttribute('data-section');
          var body = mgrBody.querySelector('.section-body[data-section="'+sec+'"]');
          if(body) body.style.maxHeight = 'none';
        });

        // wire help actions (re-rendered per tab)
        var copyBtn = q('#mgr-config-copy');
        var loadBtn = q('#mgr-config-load');
        var resetBtn = q('#mgr-config-reset');
        var clearBtn = q('#mgr-config-clear');
        var ioEl = q('#mgr-config-io');
        if(copyBtn){
          copyBtn.onclick = function(){
            try{ navigator.clipboard.writeText(String(ioEl ? ioEl.value : JSON.stringify(mgrDraft, null, 2))); }catch(e){ }
          };
        }
        if(loadBtn){
          loadBtn.onclick = function(){
            var txt = String(ioEl ? ioEl.value : '').trim();
            if(!txt) return;
            var obj = tryJsonParse(txt);
            if(!obj) return;
            mgrDraft = obj;
            // jump back to Layout after loading
            mgrTab = 'layout';
            renderManager();
          };
        }
        if(resetBtn){
          resetBtn.onclick = function(){
            mgrDraft = defaultState();
            mgrTab = 'layout';
            renderManager();
          };
        }
        if(clearBtn){
          clearBtn.onclick = function(){
            try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
            mgrDraft = defaultState();
            mgrTab = 'layout';
            renderManager();
          };
        }
        return;
      }
    }

    mgrTabs.addEventListener('click', function(ev){
      var t = ev.target && ev.target.getAttribute && ev.target.getAttribute('data-tab');
      if(!t) return;
      mgrTab = t;
      renderManager();
    });

    var btnMgr = q('#vm-btn-manager');
    if(btnMgr){
      btnMgr.onclick = function(){
        if(!SHOW_TITLEBAR_MANAGER) return;
        openManager();
      };
      if(!SHOW_TITLEBAR_MANAGER) btnMgr.style.display='none';
    }
    var btnMgrClose = q('#vm-manager-close');
    var btnMgrCancel = q('#vm-manager-cancel');
    if(btnMgrClose) btnMgrClose.onclick = closeManager;
    if(btnMgrCancel) btnMgrCancel.onclick = closeManager;

    var btnMgrApply = q('#vm-manager-apply');
    if(btnMgrApply) btnMgrApply.onclick = function(){
      // read draft fields from current tab UIs
      if(!mgrDraft) return;
      // layout
      var titleEl = q('#mgr-title');
      var subEl = q('#mgr-sub');
      var vprEl = q('#mgr-vpr');
      var gapEl = q('#mgr-gap');
      var topGapEl = q('#mgr-topgap');
      var secGapEl = q('#mgr-secgap');
      var cardHEl = q('#mgr-cardh');
      var themeEl = q('#mgr-theme');
      var secOnEl = q('#mgr-sec-on');
      var secColEl = q('#mgr-sec-col');
      if(titleEl) mgrDraft.globals.title = String(titleEl.value||'');
      if(subEl) mgrDraft.globals.subtitle = String(subEl.value||'');
      var imgUrlEl = q('#mgr-image-url');
      var radiusEl = q('#mgr-titlebar-radius');
      if(imgUrlEl) mgrDraft.globals.imageUrl = String(imgUrlEl.value||'');
      if(radiusEl) mgrDraft.globals.titlebarRadius = clamp(parseInt(radiusEl.value,10)||14, 0, 30);
      if(vprEl) mgrDraft.globals.visualsPerRow = clamp(parseInt(vprEl.value,10)||2, 1, 6);
      if(gapEl) mgrDraft.globals.gridGap = clamp(parseInt(gapEl.value,10)||10, 0, 40);
      if(topGapEl) mgrDraft.globals.topGap = clamp(parseInt(topGapEl.value,10)||0, 0, 30);
      if(secGapEl) mgrDraft.globals.sectionGap = clamp(parseInt(secGapEl.value,10)||0, 0, 30);
      if(cardHEl) mgrDraft.globals.cardHeight = clamp(parseInt(cardHEl.value,10)||320, 180, 1400);
      if(themeEl) mgrDraft.globals.theme = String(themeEl.value||PV_THEME_DEFAULT||'light');
      // layout mode + custom grid (designer already mutates mgrDraft.globals.customGrid)
      var modeEl2 = q('#mgr-layout-mode');
      if(modeEl2) mgrDraft.globals.layoutMode = String(modeEl2.value || 'auto');
      var cgColsEl2 = q('#mgr-cg-cols');
      var cgRhEl2 = q('#mgr-cg-rh');
      if(cgColsEl2){
        mgrDraft.globals.customGrid = mgrDraft.globals.customGrid || {cols:6,rowHeight:80,gridWidth:0,gridHeight:0,tiles:[]};
        mgrDraft.globals.customGrid.cols = clamp(parseInt(cgColsEl2.value,10)||6, 1, 24);
      }
      if(cgRhEl2){
        mgrDraft.globals.customGrid = mgrDraft.globals.customGrid || {cols:6,rowHeight:80,gridWidth:0,gridHeight:0,tiles:[]};
        mgrDraft.globals.customGrid.rowHeight = clamp(parseInt(cgRhEl2.value,10)||80, 30, 300);
      }
      var cgGwEl2 = q('#mgr-cg-gw');
      var cgGhEl2 = q('#mgr-cg-gh');
      if(cgGwEl2){
        mgrDraft.globals.customGrid = mgrDraft.globals.customGrid || {cols:6,rowHeight:80,gridWidth:0,gridHeight:0,tiles:[]};
        mgrDraft.globals.customGrid.gridWidth = clamp(parseInt(cgGwEl2.value,10)||0, 0, 5000);
      }
      if(cgGhEl2){
        mgrDraft.globals.customGrid = mgrDraft.globals.customGrid || {cols:6,rowHeight:80,gridWidth:0,gridHeight:0,tiles:[]};
        mgrDraft.globals.customGrid.gridHeight = clamp(parseInt(cgGhEl2.value,10)||0, 0, 5000);
      }
      if(secOnEl) mgrDraft.sections.enabled = !!secOnEl.checked;
      if(secColEl) mgrDraft.sections.splitCol = String(secColEl.value||'');

      // appearance
      var gridBgTxtEl = q('#mgr-grid-bg-txt');
      var cardBcTxtEl = q('#mgr-card-bc-txt');
      var cardBrEl = q('#mgr-card-br');
      var palLightEl = q('#mgr-pal-light');
      var palDarkEl = q('#mgr-pal-dark');
      if(gridBgTxtEl) mgrDraft.globals.gridBgColor = String(gridBgTxtEl.value||'').trim();
      if(cardBcTxtEl) mgrDraft.globals.cardBorderColor = String(cardBcTxtEl.value||'').trim();
      if(cardBrEl) mgrDraft.globals.cardBorderRadius = clamp(parseInt(cardBrEl.value,10)||0, 0, 40);
      if(palLightEl) mgrDraft.globals.paletteLight = String(palLightEl.value||'').trim();
      if(palDarkEl) mgrDraft.globals.paletteDark = String(palDarkEl.value||'').trim();

      // modebar icons (global defaults)
      var mgrMbEls = mgrBody.querySelectorAll('input[data-mgr-modebar]');
      if(mgrMbEls && mgrMbEls.length){
        var gmbMap = {};
        mgrMbEls.forEach(function(inp){
          var ik = inp.getAttribute('data-mgr-modebar');
          if(ik) gmbMap[ik] = !!inp.checked;
        });
        mgrDraft.globals.modebarIcons = gmbMap;
      }

      // data
      var dataEl = q('#mgr-data');
      if(dataEl) mgrDraft.data.jsonText = String(dataEl.value||'');

      STATE = mgrDraft;
      saveState();
      closeManager();
      if(vprSel) vprSel.value = String(clamp(parseInt(STATE.globals.visualsPerRow||2,10)||2, 1, 6));
      renderGrid();
    };

    // ---------------------------
    // Per-visual settings modal
    // ---------------------------
    var visBackdrop = q('#vm-visual-backdrop');
    var visBody = q('#vm-vis-body');
    var visTabs = q('#vm-vis-tabs');
    var visTab = 'mapping';
    var visDraft = null;
    var visId = null;

    var _visRenderTimer = null;
    function renderVisualSettingsDebounced(){
      if(_visRenderTimer) clearTimeout(_visRenderTimer);
      _visRenderTimer = setTimeout(function(){
        renderVisualSettings();
      }, 50); // small delay to batch rapid changes
    }
    
    function openVisualSettings(id, tab){
      var idx = STATE.visuals.findIndex(function(v){return v && v.id===id;});
      if(idx<0) return;
      visId = id;
      visDraft = deepClone(ensureVisualDefaults(STATE.visuals[idx]));
      visTab = (tab === 'filter' || tab === 'options' || tab === 'layout') ? tab : 'mapping';
      renderVisualSettings();
      visBackdrop.style.display='block';
      visBackdrop.setAttribute('aria-hidden','false');
    }
    function closeVisualSettings(){
      visBackdrop.style.display='none';
      visBackdrop.setAttribute('aria-hidden','true');
      visDraft=null; visId=null;
    }

    function renderFilterUI(v, ctx){
      var cols = ctx.cols;
      var f = v.filter || defaultFilter();
      var html='';
      html += '<div class="note">Filter is applied before aggregation. Logic: ';
      html += '<select data-filter="logic" style="min-width:140px">'
        + '<option value="and" '+(f.logic!=='or'?'selected':'')+'>AND</option>'
        + '<option value="or" '+(f.logic==='or'?'selected':'')+'>OR</option>'
        + '</select>'
        + '</div>';
      html += '<div class="sep"></div>';
      html += '<div class="list">';
      var clauses = Array.isArray(f.clauses)?f.clauses:[];
      if(!clauses.length){
        html += '<div class="empty">No filter clauses. Add one below.</div>';
      } else {
        for(var i=0;i<clauses.length;i++){
          var c=clauses[i]||{};
          html += '<div class="list-item" data-clause="'+i+'">'
            + '<div class="row">'
            + '<select data-filter="colKey" style="min-width:220px">'+colOptionsHtml(cols, c.colKey, true)+'</select>'
            + '<select data-filter="op" style="min-width:170px">'+FilterOps.map(function(op){
                return '<option value="'+op.key+'" '+(op.key===c.op?'selected':'')+'>'+escapeHtml(op.label)+'</option>';
              }).join('')+'</select>'
            + '<input data-filter="value" value="'+escapeHtml(c.value||'')+'" placeholder="value" style="min-width:180px" />'
            + '<input data-filter="value2" value="'+escapeHtml(c.value2||'')+'" placeholder="and" style="min-width:180px" />'
            + '<button class="btn" data-act="del-clause" style="border-color: rgba(251,113,133,.35)">Remove</button>'
            + '</div>'
            + '<div class="note" style="margin-top:6px">Tip: for numeric compare, values are parsed as numbers when possible. Count is non-null count.</div>'
            + '</div>';
        }
      }
      html += '</div>';
      html += '<div class="sep"></div>';
      html += '<button class="btn primary" data-act="add-clause">Add clause</button>';
      return html;
    }

    var visDetailsOpenCache = {};
    function renderVisualSettings(){
      var ctx = buildCtx();
      var def = Registry[visDraft.type];
      
      /* Backup open state of collapsible sections before re-rendering */
      if(visBody){
        visBody.querySelectorAll('details').forEach(function(d){
          var sum = d.querySelector('summary');
          if(sum) visDetailsOpenCache[sum.textContent.trim()] = d.open;
        });
      }

      var ttl = q('#vm-vis-ttl');
      if(ttl) ttl.textContent = (def?def.label:visDraft.type) + (def && def.implemented===false ? ' (Not implemented)' : '') + ' Settings';

      // tabs
      var tabs = visTabs.querySelectorAll('.tab');
      for(var i=0;i<tabs.length;i++){
        var t=tabs[i];
        t.classList.toggle('active', t.getAttribute('data-tab')===visTab);
      }

      var html='';
      html += '<div class="form">'
        + '<div class="lbl">Title</div>'
        + '<div><input data-core="title" value="'+escapeHtml(visDraft.title||'')+'" /></div>'
        + '<div class="row" style="margin-top:6px"><label class="note"><input type="checkbox" data-core="showTitle" '+(visDraft.showTitle!==false?'checked':'')+'> Show visual title in card header</label></div>'
        + '<div class="row" style="gap:8px;margin-top:8px">'
        + '  <select data-core="titleAlign" style="width:80px">'
        + '    <option value="left" '+(visDraft.titleAlign==='left'||!visDraft.titleAlign?'selected':'')+'>Left</option>'
        + '    <option value="center" '+(visDraft.titleAlign==='center'?'selected':'')+'>Center</option>'
        + '    <option value="right" '+(visDraft.titleAlign==='right'?'selected':'')+'>Right</option>'
        + '  </select>'
        + '  <input data-core="titleSize" type="number" min="10" max="28" step="1" value="'+escapeHtml(String(visDraft.titleSize||14))+'" style="width:60px" placeholder="Size" />'
        + '  <span class="note" style="font-size:11px">Title alignment and size (px)</span>'
        + '</div>'
        + '<div class="row" style="gap:8px;margin-top:8px">'
        + '  <span class="note">Title color</span>'
        + '  <input data-core="titleColor" type="color" value="'+(visDraft.titleColor||'#111827')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
        + '</div>'
        + '</div>';
      html += '<div class="sep"></div>';
      html += '<div class="form">'
        + '<div class="lbl">Card Appearance</div>'
        + '<div class="row" style="gap:8px">'
        + '  <span class="note">Background</span>'
        + '  <input data-core="cardBgColor" type="color" value="'+(visDraft.cardBgColor||'#ffffff')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
        + '  <span class="note">Border</span>'
        + '  <input data-core="cardBorderColor" type="color" value="'+(visDraft.cardBorderColor||'#e5e7eb')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
        + '</div>'
        + '<div class="row" style="margin-top:6px;gap:8px">'
        + '  <span class="note">Border width (px)</span>'
        + '  <input data-core="cardBorderWidth" type="number" min="0" max="10" step="1" value="'+(visDraft.cardBorderWidth!=null?visDraft.cardBorderWidth:1)+'" style="width:60px" />'
        + '  <span class="note">Radius (px)</span>'
        + '  <input data-core="cardBorderRadius" type="number" min="0" max="30" step="1" value="'+(visDraft.cardBorderRadius!=null?visDraft.cardBorderRadius:10)+'" style="width:60px" />'
        + '</div>'
        + '</div>';
      html += '<div class="sep"></div>';

      function detOpen(title, def){
        var open = (visDetailsOpenCache[title] != null) ? visDetailsOpenCache[title] : def;
        return open ? ' open' : '';
      }

      if(visTab==='mapping'){
        if(!ctx.cols || !ctx.cols.length){
          html += '<div class="empty">No data columns detected. Verify Narrative wiring for <span class="badge">#box-data</span> or use Visual Manager ? Data (test override).</div>';
          html += '<div class="sep"></div>';
        }
        html += '<details class="vm-sec"'+detOpen('Mapping', true)+'>'
             + '<summary class="lbl" style="font-weight:700;cursor:pointer">Mapping</summary>'
             + '<div style="margin-top:8px">'
             + def.buildMappingUI(visDraft, ctx)
             + '</div></details>';
      } else if(visTab==='options'){
        html += '<details class="vm-sec"'+detOpen('Chart Options', true)+'>'
             + '<summary class="lbl" style="font-weight:700;cursor:pointer">Chart Options</summary>'
             + '<div style="margin-top:8px">'
             + def.buildOptionsUI(visDraft, ctx)
             + '</div></details>';

        // --- Chart Type / View (limited to compatible types) ---
        var typeChoices = (function(cur){
          cur = String(cur||'');
          if(cur==='line') return ['line','area','bar','scatter'];
          if(cur==='bar') return ['bar','line','area'];
          if(cur==='scatter') return ['scatter','line'];
          if(cur==='histogram') return ['histogram','bar'];
          if(cur==='box') return ['box','scatter'];
          return [cur];
        })(visDraft.type);
        if(typeChoices.length > 1){
          html += '<div class="sep"></div>';
          html += '<details '+detOpen('Chart Type / View', true)+'>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Chart Type / View</summary>';
          html += '<div class="form" style="margin-top:8px">';
          html += '<div class="row" style="gap:8px;align-items:center">'
               + '  <select data-core="type" style="min-width:200px">'
               + typeChoices.map(function(t){
                    var sel = (t===visDraft.type) ? ' selected' : '';
                    return '<option value="'+escapeHtml(t)+'"'+sel+'>'+escapeHtml(t.charAt(0).toUpperCase()+t.slice(1))+'</option>';
                  }).join('')
               + '  </select>'
               + '  <span class="note">Only compatible types are listed.</span>'
               + '</div>';
          html += '</div>';
          html += '</details>';
        }

        // --- Statistics / Regression ---
        html += '<div class="sep"></div>';
        html += '<details '+detOpen('Statistics / Regression', false)+'>';
        html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Statistics / Regression</summary>';
        html += '<div class="form" style="margin-top:8px">';
        html += '<div class="row" style="gap:8px">'
              + '  <select data-opt="statsMode" style="min-width:220px">'
              + '    <option value="none" '+((visDraft.options.statsMode||'none')==='none'?'selected':'')+'>None</option>'
              + '    <option value="mean" '+(visDraft.options.statsMode==='mean'?'selected':'')+'>Mean (Y)</option>'
              + '    <option value="median" '+(visDraft.options.statsMode==='median'?'selected':'')+'>Median (Y)</option>'
              + '    <option value="regression" '+(visDraft.options.statsMode==='regression'?'selected':'')+'>Regression Line</option>'
              + '    <option value="ci" '+(visDraft.options.statsMode==='ci'?'selected':'')+'>95% CI (approx)</option>'
              + '  </select>'
              + '</div>';
        html += '<div class="note">Statistics are drawn on supported cartesian charts.</div>';
        html += '</div>';
        html += '</details>';

          // --- Legend & Tooltip ---
          html += '<div class="sep"></div>';
          html += '<details '+detOpen('Legend & Tooltip', false)+'>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Legend & Tooltip</summary>';
          html += '<div class="form" style="margin-top:8px">';
            html += '<div class="row" style="gap:8px;align-items:center">'
              + '  <select data-opt="showLegend" style="min-width:140px">'
              + '    <option value="true" '+(visDraft.options.showLegend!==false?'selected':'')+'>Show</option>'
              + '    <option value="false" '+(visDraft.options.showLegend===false?'selected':'')+'>Hide</option>'
              + '  </select>'
              + '  <select data-opt="legendPos" style="min-width:160px">'
              + '    <option value="auto" '+((visDraft.options.legendPos||'auto')==='auto'?'selected':'')+'>Auto</option>'
              + '    <option value="top" '+(visDraft.options.legendPos==='top'?'selected':'')+'>Top</option>'
              + '    <option value="bottom" '+(visDraft.options.legendPos==='bottom'?'selected':'')+'>Bottom</option>'
              + '    <option value="left" '+(visDraft.options.legendPos==='left'?'selected':'')+'>Left</option>'
              + '    <option value="right" '+(visDraft.options.legendPos==='right'?'selected':'')+'>Right</option>'
              + '  </select>'
              + '</div>';
          html += '<div class="row" style="gap:8px;align-items:center">'
              + '  <select data-opt="hoverMode" style="min-width:180px">'
            + '    <option value="closest" '+((visDraft.options.hoverMode||'closest')==='closest'?'selected':'')+'>Tooltip: Closest</option>'
            + '    <option value="x" '+(visDraft.options.hoverMode==='x'?'selected':'')+'>Tooltip: Compare (x)</option>'
            + '    <option value="x unified" '+(visDraft.options.hoverMode==='x unified'?'selected':'')+'>Tooltip: Unified (x)</option>'
            + '  </select>'
            + '</div>';
          html += '</div>';
          html += '</details>';

          // --- Data Labels ---
          html += '<div class="sep"></div>';
          html += '<details '+detOpen('Data Labels', false)+'>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Data Labels</summary>';
          html += '<div class="form" style="margin-top:8px">';
          html += '<div class="row"><label class="note"><input type="checkbox" data-opt="labelsOn" '+(visDraft.options.labelsOn?'checked':'')+'> Show labels</label></div>';
          html += '<div class="row" style="gap:8px;align-items:center">'
            + '  <input data-opt="labelDecimals" type="number" min="0" max="6" step="1" placeholder="Decimals" value="'+escapeHtml(String(visDraft.options.labelDecimals!=null?visDraft.options.labelDecimals:''))+'" style="width:90px" />'
            + '  <input data-opt="labelPrefix" placeholder="Prefix" value="'+escapeHtml(String(visDraft.options.labelPrefix||''))+'" style="width:120px" />'
            + '  <input data-opt="labelSuffix" placeholder="Suffix" value="'+escapeHtml(String(visDraft.options.labelSuffix||''))+'" style="width:120px" />'
            + '</div>';
            html += '<div class="row" style="gap:8px;align-items:center;margin-top:6px">'
              + '  <select data-opt="labelCfOp" style="min-width:120px">'
              + '    <option value="">No threshold</option>'
              + '    <option value="gt" '+(visDraft.options.labelCfOp==='gt'?'selected':'')+'>Value &gt;</option>'
              + '    <option value="gte" '+(visDraft.options.labelCfOp==='gte'?'selected':'')+'>Value &gt;=</option>'
              + '    <option value="lt" '+(visDraft.options.labelCfOp==='lt'?'selected':'')+'>Value &lt;</option>'
              + '    <option value="lte" '+(visDraft.options.labelCfOp==='lte'?'selected':'')+'>Value &lt;=</option>'
              + '    <option value="eq" '+(visDraft.options.labelCfOp==='eq'?'selected':'')+'>Value =</option>'
              + '    <option value="neq" '+(visDraft.options.labelCfOp==='neq'?'selected':'')+'>Value !=</option>'
              + '  </select>'
              + '  <input data-opt="labelCfVal" placeholder="Threshold" value="'+escapeHtml(String(visDraft.options.labelCfVal!=null?visDraft.options.labelCfVal:''))+'" style="width:120px" />'
              + '  <input data-opt="labelCfColor" type="color" value="'+(visDraft.options.labelCfColor||'#ef4444')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
              + '</div>';
          html += '</div>';
          html += '</details>';

            // --- Sort & Order ---
            html += '<div class="sep"></div>';
            html += '<details '+detOpen('Sort & Order', false)+'>';
            html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Sort & Order</summary>';
            html += '<div class="form" style="margin-top:8px">';
            html += '<div class="row" style="gap:8px;align-items:center">'
              + '  <select data-opt="sortBy" style="min-width:160px">'
              + '    <option value="none" '+((visDraft.options.sortBy||'none')==='none'?'selected':'')+'>None</option>'
              + '    <option value="x" '+(visDraft.options.sortBy==='x'?'selected':'')+'>By X</option>'
              + '    <option value="y" '+(visDraft.options.sortBy==='y'?'selected':'')+'>By Y</option>'
              + '  </select>'
              + '  <select data-opt="sortDir" style="min-width:140px">'
              + '    <option value="asc" '+((visDraft.options.sortDir||'asc')==='asc'?'selected':'')+'>Ascending</option>'
              + '    <option value="desc" '+(visDraft.options.sortDir==='desc'?'selected':'')+'>Descending</option>'
              + '  </select>'
              + '</div>';
            html += '</div>';
            html += '</details>';

        // --- Axis / Scale ---
        if(isCartesianType(visDraft.type)){
          html += '<div class="sep"></div>';
          html += '<details '+detOpen('Axes / Scale', false)+'>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Axes / Scale</summary>';
          html += '<div class="form" style="margin-top:8px">';
          var yMode = visDraft.options.yScaleMode || 'auto';
          html += '<div class="row" style="gap:8px;align-items:center">'
                + '  <select data-opt="yScaleMode" style="min-width:180px">'
                + '    <option value="auto" '+(yMode==='auto'?'selected':'')+'>Auto</option>'
                + '    <option value="zero" '+(yMode==='zero'?'selected':'')+'>0-based</option>'
                + '    <option value="log" '+(yMode==='log'?'selected':'')+'>Log</option>'
                + '    <option value="manual" '+(yMode==='manual'?'selected':'')+'>Manual</option>'
                + '  </select>'
                + '  <input data-opt="yMin" type="number" placeholder="Y min" value="'+(Number.isFinite(visDraft.options.yMin)?visDraft.options.yMin:'')+'" style="width:110px" />'
                + '  <input data-opt="yMax" type="number" placeholder="Y max" value="'+(Number.isFinite(visDraft.options.yMax)?visDraft.options.yMax:'')+'" style="width:110px" />'
                + '</div>';
          html += '<div class="row" style="gap:8px;margin-top:6px">'
                + '  <select data-opt="dragMode" style="min-width:180px">'
                + '    <option value="zoom" '+((visDraft.options.dragMode||'zoom')==='zoom'?'selected':'')+'>Zoom</option>'
                + '    <option value="pan" '+(visDraft.options.dragMode==='pan'?'selected':'')+'>Pan</option>'
                + '  </select>'
                + '  <span class="note">Default interaction mode.</span>'
                + '</div>';
          html += '</div>';
          html += '</details>';
        }

        // --- Axis Ticks & Formatting ---
        if(isCartesianType(visDraft.type)){
          html += '<div class="sep"></div>';
          html += '<details '+detOpen('Axis Ticks & Formatting', false)+'>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Axis Ticks & Formatting</summary>';
          html += '<div class="form" style="margin-top:8px">';
          
          /* New specific type dropdowns */
          html += '<div class="row" style="gap:8px;align-items:center;margin-bottom:8px">'
                + '  <div style="flex:1"><div class="note">X Axis Format</div>'
                + '  <select data-opt="xTickType" style="width:100%">'
                + '    <option value="none" '+((visDraft.options.xTickType||'none')==='none'?'selected':'')+'>Auto / Manual</option>'
                + '    <option value="number" '+(visDraft.options.xTickType==='number'?'selected':'')+'>Number</option>'
                + '    <option value="percent" '+(visDraft.options.xTickType==='percent'?'selected':'')+'>Percentage</option>'
                + '    <option value="si" '+(visDraft.options.xTickType==='si'?'selected':'')+'>Units (K,M,G)</option>'
                + '    <option value="date" '+(visDraft.options.xTickType==='date'?'selected':'')+'>Date/Time</option>'
                + '  </select></div>'
                + '  <div style="width:60px"><div class="note">Dec.</div>'
                + '  <input data-opt="xTickDecimals" type="number" min="0" max="6" value="'+escapeHtml(String(visDraft.options.xTickDecimals!=null?visDraft.options.xTickDecimals:''))+'" style="width:100%" /></div>'
                + '</div>';
                
          html += '<div class="row" style="gap:8px;align-items:center;margin-bottom:8px">'
                + '  <div style="flex:1"><div class="note">Y Axis Format</div>'
                + '  <select data-opt="yTickType" style="width:100%">'
                + '    <option value="none" '+((visDraft.options.yTickType||'none')==='none'?'selected':'')+'>Auto / Manual</option>'
                + '    <option value="number" '+(visDraft.options.yTickType==='number'?'selected':'')+'>Number</option>'
                + '    <option value="percent" '+(visDraft.options.yTickType==='percent'?'selected':'')+'>Percentage</option>'
                + '    <option value="si" '+(visDraft.options.yTickType==='si'?'selected':'')+'>Units (K,M,G)</option>'
                + '  </select></div>'
                + '  <div style="width:60px"><div class="note">Dec.</div>'
                + '  <input data-opt="yTickDecimals" type="number" min="0" max="6" value="'+escapeHtml(String(visDraft.options.yTickDecimals!=null?visDraft.options.yTickDecimals:''))+'" style="width:100%" /></div>'
                + '</div>';

          html += '<div class="row" style="gap:8px;align-items:center">'
                + '  <input data-opt="xTickFormat" placeholder="Manual X (e.g. %Y)" value="'+escapeHtml(String(visDraft.options.xTickFormat||''))+'" style="min-width:200px" title="Custom Plotly tickformat string" />'
                + '  <input data-opt="yTickFormat" placeholder="Manual Y (e.g. .2s)" value="'+escapeHtml(String(visDraft.options.yTickFormat||''))+'" style="min-width:200px" title="Custom Plotly tickformat string" />'
                + '</div>';
          html += '<div class="row" style="gap:8px;align-items:center;margin-top:6px">'
                + '  <input data-opt="xTickCount" type="number" min="2" max="50" placeholder="X tick count" value="'+escapeHtml(String(visDraft.options.xTickCount||''))+'" style="width:120px" />'
                + '  <input data-opt="yTickCount" type="number" min="2" max="50" placeholder="Y tick count" value="'+escapeHtml(String(visDraft.options.yTickCount||''))+'" style="width:120px" />'
                + '  <input data-opt="xTickAngle" type="number" min="-90" max="90" placeholder="X tick angle" value="'+escapeHtml(String(visDraft.options.xTickAngle||''))+'" style="width:120px" />'
                + '</div>';
          html += '</div>';
          html += '</details>';
        }

          // --- Target Lines / Bands ---
        if(isCartesianType(visDraft.type)){
          html += '<div class="sep"></div>';
          html += '<details>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Target Lines / Bands</summary>';
          html += '<div class="form" style="margin-top:8px">';
            html += '<div class="row" style="gap:8px;align-items:center">'
              + '  <select data-opt="targetMode" style="min-width:160px">'
              + '    <option value="manual" '+((visDraft.options.targetMode||'manual')==='manual'?'selected':'')+'>Manual</option>'
              + '    <option value="columns" '+(visDraft.options.targetMode==='columns'?'selected':'')+'>From columns</option>'
              + '  </select>'
              + '  <select data-opt="targetMinCol" style="min-width:180px">'
              + '    <option value="">Min column (optional)</option>'
              + colOptionsHtml(ctx.cols, visDraft.options.targetMinCol, true)
              + '  </select>'
              + '  <select data-opt="targetMaxCol" style="min-width:180px">'
              + '    <option value="">Max column (optional)</option>'
              + colOptionsHtml(ctx.cols, visDraft.options.targetMaxCol, true)
              + '  </select>'
              + '</div>';
          html += '<div class="row" style="gap:8px;align-items:center">'
                + '  <select data-opt="targetStyle" style="min-width:160px">'
                + '    <option value="line" '+((visDraft.options.targetStyle||'line')==='line'?'selected':'')+'>Line</option>'
                + '    <option value="band" '+(visDraft.options.targetStyle==='band'?'selected':'')+'>Band</option>'
                + '  </select>'
              + '  <select data-opt="targetDash" style="min-width:140px">'
              + '    <option value="solid" '+((visDraft.options.targetDash||'dash')==='solid'?'selected':'')+'>Solid</option>'
              + '    <option value="dash" '+((visDraft.options.targetDash||'dash')==='dash'?'selected':'')+'>Dashed</option>'
              + '    <option value="dot" '+(visDraft.options.targetDash==='dot'?'selected':'')+'>Dotted</option>'
              + '    <option value="dashdot" '+(visDraft.options.targetDash==='dashdot'?'selected':'')+'>Dash-dot</option>'
              + '  </select>'
              + '  <input data-opt="targetColor" type="color" value="'+(visDraft.options.targetColor||'#dc2626')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
                + '</div>';
            html += '<div class="row" style="gap:8px;align-items:center">'
              + '  <input data-opt="targetMin" type="number" placeholder="Value / Min" value="'+(Number.isFinite(visDraft.options.targetMin)?visDraft.options.targetMin:'')+'" style="width:120px" />'
              + '  <input data-opt="targetMax" type="number" placeholder="Max" value="'+(Number.isFinite(visDraft.options.targetMax)?visDraft.options.targetMax:'')+'" style="width:120px" />'
              + '</div>';
          html += '<div class="note">Single value draws a line. Min + max draws a band.</div>';
          html += '</div>';
          html += '</details>';
        }

        // --- Reference Lines ---
        if(isCartesianType(visDraft.type)){
          html += '<div class="sep"></div>';
          html += '<details>';
          html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Reference Lines</summary>';
          html += '<div class="form" style="margin-top:8px">';
          var refs = Array.isArray(visDraft.options.refLines) ? visDraft.options.refLines : [];
          if(!refs.length){
            html += '<div class="note">No reference lines. Add one below.</div>';
          } else {
            for(var ri=0; ri<refs.length; ri++){
              var rr = refs[ri] || {};
              html += '<div class="list-item" data-refline="'+ri+'" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;padding:6px 8px;border:1px solid var(--vm-border);border-radius:8px;background:var(--vm-input2);margin-bottom:6px">'
                    + '<input data-refline-name value="'+escapeHtml(String(rr.label||''))+'" placeholder="Label" style="width:140px" />'
                    + '<input data-refline-val type="number" value="'+escapeHtml(String(isFinite(rr.value)?rr.value:''))+'" placeholder="Value" style="width:110px" />'
                    + '<select data-refline-dash style="width:110px">'
                    + '  <option value="solid" '+(rr.dash==='solid'?'selected':'')+'>Solid</option>'
                    + '  <option value="dash" '+((rr.dash||'dash')==='dash'?'selected':'')+'>Dashed</option>'
                    + '  <option value="dot" '+(rr.dash==='dot'?'selected':'')+'>Dotted</option>'
                    + '  <option value="dashdot" '+(rr.dash==='dashdot'?'selected':'')+'>Dash-dot</option>'
                    + '</select>'
                    + '<input data-refline-color type="color" value="'+(rr.color||'#111827')+'" style="width:32px;height:26px;cursor:pointer;border:1px solid var(--vm-border);border-radius:4px" />'
                    + '<button class="btn danger" data-act="del-refline" style="padding:2px 8px;font-size:11px">×</button>'
                    + '</div>';
            }
          }
          html += '<button class="btn" data-act="add-refline" style="margin-top:4px;font-size:12px">+ Add reference line</button>';
          html += '</div>';
          html += '</details>';
        }

        // --- Palette ---
        html += '<div class="sep"></div>';
        html += '<details>';
        html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Palette</summary>';
        html += '<div class="form" style="margin-top:8px">';
        html += '<div class="note">Comma-separated hex colors. Leave blank to use global palette.</div>';
        html += '<input data-opt="palette" value="'+escapeHtml(String(visDraft.options.palette||''))+'" placeholder="#2563eb,#059669,#f59e0b" style="min-width:320px" />';
        html += '</div>';
        html += '</details>';

        // --- Outliers (Filter toggle) ---
        html += '<div class="sep"></div>';
        html += '<details>';
        html += '<summary class="lbl" style="font-weight:700;cursor:pointer">Outliers</summary>';
        html += '<div class="form" style="margin-top:8px">';
        html += '<div class="row"><label class="note"><input type="checkbox" data-opt="excludeOutliers" '+(visDraft.options.excludeOutliers?'checked':'')+'> Exclude outliers (IQR)</label></div>';
        html += '</div>';
        html += '</details>';

        /* --- Axis Settings (Cartesian only) --- */
        if(isCartesianType(visDraft.type)){
          html += '<div class="sep"></div>';
          html += '<div class="form">';
          html += '<div class="lbl" style="font-weight:700">Axis Settings</div>';
          var opts = visDraft.options || {};
          html += '<div class="row" style="gap:12px; align-items:flex-end;">'
                + '  <div>'
                + '    <div class="note">X Axis Title</div>'
                + '    <input data-opt="xTitle" placeholder="Auto" value="'+escapeHtml(opts.xTitle||'')+'" style="width:140px" />'
                + '  </div>'
                + '  <div>'
                + '    <div class="note">Y Axis Title</div>'
                + '    <input data-opt="yTitle" placeholder="Auto" value="'+escapeHtml(opts.yTitle||'')+'" style="width:140px" />'
                + '  </div>'
                + '</div>';
          
          html += '<div class="row" style="gap:12px; margin-top:8px; align-items:flex-end;">'
                + '  <div>'
                + '    <div class="note">Title Font Size</div>'
                + '    <input data-opt="axisTitleFontSize" type="number" min="8" max="32" placeholder="Auto" value="'+escapeHtml(String(opts.axisTitleFontSize||''))+'" style="width:80px" />'
                + '  </div>'
                + '  <div>'
                + '    <div class="note">Title Color</div>'
                + '    <div class="row">'
                + '      <input data-opt="axisTitleFontColor" type="color" value="'+(opts.axisTitleFontColor||'#4b5563')+'" style="width:36px;height:28px;cursor:pointer;border:1px solid var(--vm-border);border-radius:6px" />'
                + '    </div>'
                + '  </div>'
                + '</div>';
          html += '</div>';
        }

        /* --- Modebar icons section (common to all visuals) --- */
        html += '<div class="sep"></div>';
        html += '<div class="form">';
        html += '<div class="lbl" style="font-weight:700">Modebar Icons</div>';
        html += '<div class="note" style="margin-bottom:8px">Control which icons appear in the Plotly modebar for this visual. Only applicable icons are shown.</div>';
        var mbIcons = (visDraft.options && visDraft.options.modebarIcons) ? visDraft.options.modebarIcons : {};
        var mbNames = {reset:'Reset / Home', points:'Points / Labels / Styles', filter:'Outliers', zoom:'Zoom / Pan', remove:'Remove Point', download:'Download', fs:'Fullscreen', settings:'Settings'};
        /* Get list of icons applicable to this visual type */
        var applicableIcons = allowedModebarIconsForType(visDraft.type);
        for(var mi=0; mi<applicableIcons.length; mi++){
          var mk = applicableIcons[mi];
          /* Skip settings icon - it's controlled by parameter only */
          if(mk === 'settings') continue;
          var checked = (mbIcons[mk] !== false) ? 'checked' : '';
          html += '<div class="row"><label class="note"><input type="checkbox" data-modebar-icon="'+escapeHtml(mk)+'" '+checked+'> '+escapeHtml(mbNames[mk]||mk)+'</label></div>';
        }
        html += '<div class="note" style="margin-top:8px;font-style:italic;color:var(--vm-sub)">Note: Settings icon visibility is controlled by the PV_VM_ShowVisualSettingsIcon parameter.</div>';
        html += '</div>';

        /* --- Conditional Formatting (common to all visuals except table which has its own) --- */
        if(visDraft.type !== 'table'){
        html += '<div class="sep"></div>';
        html += '<div class="form">';
        html += '<div class="lbl" style="font-weight:700">Conditional Formatting</div>';
        html += '<div class="note" style="margin-bottom:8px">Apply colors based on data conditions. For charts: bar/marker color changes. For tables: cell highlighting.</div>';
        var visCfRules = Array.isArray(visDraft.options.cfRules) ? visDraft.options.cfRules : [];
        var cfCols = ctx.cols || [];
        for(var cri=0; cri<visCfRules.length; cri++){
          var crule = visCfRules[cri]||{};
          html += '<div class="list-item" data-viscf-rule="'+cri+'" style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;padding:6px 8px;margin:0 0 4px;border:1px solid var(--vm-border);border-radius:8px;background:var(--vm-input2)">'
            + '<select data-viscf="col" style="min-width:110px">'
            + '<option value="">Column...</option>';
          for(var cci=0;cci<cfCols.length;cci++){
            var cfCol = cfCols[cci];
            var cfKey = (typeof cfCol === 'object' && cfCol.key) ? cfCol.key : String(cfCol||'');
            var cfLabel = (typeof cfCol === 'object' && cfCol.label) ? cfCol.label : cfKey;
            html += '<option value="'+escapeHtml(cfKey)+'" '+(crule.col===cfKey?'selected':'')+'>'+escapeHtml(cfLabel)+'</option>';
          }
          html += '</select>'
            + '<select data-viscf="op" style="width:80px">'
            + '<option value="gt" '+(crule.op==='gt'?'selected':'')+'>&#62;</option>'
            + '<option value="gte" '+(crule.op==='gte'?'selected':'')+'>=</option>'
            + '<option value="lt" '+(crule.op==='lt'?'selected':'')+'>&#60;</option>'
            + '<option value="lte" '+(crule.op==='lte'?'selected':'')+'>=</option>'
            + '<option value="eq" '+(crule.op==='eq'?'selected':'')+'>=</option>'
            + '<option value="neq" '+(crule.op==='neq'?'selected':'')+'>&ne;</option>'
            + '<option value="between" '+(crule.op==='between'?'selected':'')+'>Between</option>'
            + '<option value="contains" '+(crule.op==='contains'?'selected':'')+'>Contains</option>'
            + '<option value="notcontains" '+(crule.op==='notcontains'?'selected':'')+'>Not Contains</option>'
            + '<option value="startswith" '+(crule.op==='startswith'?'selected':'')+'>Starts With</option>'
            + '<option value="endswith" '+(crule.op==='endswith'?'selected':'')+'>Ends With</option>'
            + '<option value="isblank" '+(crule.op==='isblank'?'selected':'')+'>Is Blank</option>'
            + '<option value="notblank" '+(crule.op==='notblank'?'selected':'')+'>Not Blank</option>'
            + '</select>'
            + '<input data-viscf="val1" type="text" value="'+escapeHtml(String(crule.val1!=null?crule.val1:''))+'" placeholder="value" style="width:80px" />'
            + '<input data-viscf="val2" type="text" value="'+escapeHtml(String(crule.val2!=null?crule.val2:''))+'" placeholder="value2" style="width:80px;display:'+(crule.op==='between'?'':'none')+'" />'
            + '<span class="note">Bg</span>'
            + '<input data-viscf="bg" type="color" value="'+(crule.bg||'#fca5a5')+'" style="width:30px;height:24px;cursor:pointer;border:1px solid var(--vm-border);border-radius:4px" />'
            + '<span class="note">Text</span>'
            + '<input data-viscf="fg" type="color" value="'+(crule.fg||'#111827')+'" style="width:30px;height:24px;cursor:pointer;border:1px solid var(--vm-border);border-radius:4px" />'
            + '<span class="note">Apply to</span>'
            + '<select data-viscf="applyTo" style="width:80px">'
            + '<option value="cell" '+(crule.applyTo==='cell'||!crule.applyTo?'selected':'')+'>Cell</option>'
            + '<option value="row" '+(crule.applyTo==='row'?'selected':'')+'>Row</option>'
            + '<option value="bar" '+(crule.applyTo==='bar'?'selected':'')+'>Bar/Marker</option>'
            + '</select>'
            + '<button class="btn danger" data-act="del-viscf" style="padding:2px 8px;font-size:11px" title="Remove rule">&#10005;</button>'
            + '</div>';
        }
        html += '<button class="btn" data-act="add-viscf" style="margin-top:4px;font-size:12px">+ Add Rule</button>';
        html += '</div>';
        } /* end if not table */

      } else if(visTab==='filter'){
        html += '<details class="vm-sec"'+detOpen('Filter', false)+'>'
             + '<summary class="lbl" style="font-weight:700;cursor:pointer">Filter</summary>'
             + '<div style="margin-top:8px">'
             + renderFilterUI(visDraft, ctx)
             + '</div></details>';
      } else {
        var lay = visDraft.layout || {};
        html += '<details class="vm-sec"'+detOpen('Advanced Layout', false)+'>'
          + '<summary class="lbl" style="font-weight:700;cursor:pointer">Advanced Layout</summary>'
          + '<div class="form" style="margin-top:8px">'
          + '<div class="note" style="margin-bottom:10px">These settings apply in <b>Automatic</b> layout mode. In Custom grid mode, tile position &amp; size is set in the grid designer.</div>'

          + '<div class="lbl">Fixed height (px)</div>'
          + '<div class="row">'
          + '  <input type="number" min="0" max="5000" step="10" data-layout="heightPx" value="'+escapeHtml(String(lay.heightPx||0))+'" style="width:110px" />'
          + '  <span class="note">0 = use global height rule. Non-zero forces this visual card height.</span>'
          + '</div>'
          + '<div class="lbl">Min height override (px)</div>'
          + '<div class="row">'
          + '  <input type="number" min="0" max="5000" step="10" data-layout="minHeight" value="'+escapeHtml(String(lay.minHeight||0))+'" style="width:110px" />'
          + '  <span class="note">0 = use global height rule.</span>'
          + '</div>'
          + '<div class="lbl">Group (stack)</div>'
          + '<div class="row">'
          + '  <input data-layout="group" value="'+escapeHtml(String(lay.group||''))+'" placeholder="e.g. KPI_1" style="min-width:220px" />'
          + '  <span class="note">Same group id ? visuals stack vertically in one card.</span>'
          + '</div>'
          + '<div class="lbl">Stack weight</div>'
          + '<div class="row">'
          + '  <input type="number" min="0.25" max="10" step="0.25" data-layout="stackWeight" value="'+escapeHtml(String(lay.stackWeight||1))+'" style="width:110px" />'
          + '  <span class="note">Inside a group: higher weight gets more height.</span>'
          + '</div>'
          + '</div></details>';
      }

      visBody.innerHTML = html;

      // wire filter actions
      visBody.querySelectorAll('[data-act="add-clause"]').forEach(function(btn){
        btn.onclick = function(){
          visDraft.filter = visDraft.filter || defaultFilter();
          visDraft.filter.clauses = visDraft.filter.clauses || [];
          visDraft.filter.clauses.push({colKey:'',op:'eq',value:'',value2:''});
          renderVisualSettings();
        };
      });
      visBody.querySelectorAll('[data-act="del-clause"]').forEach(function(btn){
        btn.onclick = function(){
          var item = btn.closest('.list-item');
          var idx = item ? parseInt(item.getAttribute('data-clause'),10) : -1;
          if(idx>=0){
            visDraft.filter.clauses.splice(idx,1);
            renderVisualSettings();
          }
        };
      });

      // auto-hide value2 unless between
      visBody.querySelectorAll('select[data-filter="op"]').forEach(function(sel){
        var wrap = sel.closest('.list-item');
        if(!wrap) return;
        var v2 = wrap.querySelector('input[data-filter="value2"]');
        if(!v2) return;
        v2.style.display = (String(sel.value)==='between') ? '' : 'none';
      });

      // Wire conditional formatting add/delete (table type)
      visBody.querySelectorAll('[data-act="add-cf"]').forEach(function(btn){
        btn.onclick = function(){
          visDraft.options = visDraft.options || {};
          visDraft.options.cfRules = visDraft.options.cfRules || [];
          visDraft.options.cfRules.push({col:'', op:'gt', val1:'', val2:'', bg:'#fca5a5', fg:'#111827'});
          renderVisualSettings();
        };
      });
      visBody.querySelectorAll('[data-act="del-cf"]').forEach(function(btn){
        btn.onclick = function(){
          var item = btn.closest('.list-item');
          var idx = item ? parseInt(item.getAttribute('data-cf-rule'),10) : -1;
          if(idx>=0){
            visDraft.options.cfRules.splice(idx,1);
            renderVisualSettings();
          }
        };
      });
      // auto-show val2 for CF "between" and hide val1/val2 for isblank/notblank
      visBody.querySelectorAll('select[data-cf="op"]').forEach(function(sel){
        var wrap = sel.closest('.list-item');
        if(!wrap) return;
        var v1 = wrap.querySelector('input[data-cf="val1"]');
        var v2 = wrap.querySelector('input[data-cf="val2"]');
        function updateCfVis(){
          var op = String(sel.value);
          if(v1) v1.style.display = (op==='isblank'||op==='notblank') ? 'none' : '';
          if(v2) v2.style.display = (op==='between') ? '' : 'none';
        }
        updateCfVis();
        sel.onchange = updateCfVis;
      });

      // Wire conditional formatting add/delete (common viscf section for charts)
      visBody.querySelectorAll('[data-act="add-viscf"]').forEach(function(btn){
        btn.onclick = function(){
          visDraft.options = visDraft.options || {};
          visDraft.options.cfRules = visDraft.options.cfRules || [];
          visDraft.options.cfRules.push({col:'', op:'gt', val1:'', val2:'', bg:'#fca5a5', fg:'#111827', applyTo:'bar'});
          renderVisualSettings();
        };
      });
      visBody.querySelectorAll('[data-act="del-viscf"]').forEach(function(btn){
        btn.onclick = function(){
          var item = btn.closest('.list-item');
          var idx = item ? parseInt(item.getAttribute('data-viscf-rule'),10) : -1;
          if(idx>=0){
            visDraft.options.cfRules.splice(idx,1);
            renderVisualSettings();
          }
        };
      });

      // Wire reference lines add/delete
      visBody.querySelectorAll('[data-act="add-refline"]').forEach(function(btn){
        btn.onclick = function(){
          visDraft.options = visDraft.options || {};
          visDraft.options.refLines = visDraft.options.refLines || [];
          visDraft.options.refLines.push({label:'', value:'', color:'#111827', dash:'dash'});
          renderVisualSettings();
        };
      });
      visBody.querySelectorAll('[data-act="del-refline"]').forEach(function(btn){
        btn.onclick = function(){
          var item = btn.closest('.list-item');
          var idx = item ? parseInt(item.getAttribute('data-refline'),10) : -1;
          if(idx>=0){
            visDraft.options.refLines.splice(idx,1);
            renderVisualSettings();
          }
        };
      });
      
      // Wire multi-select checkbox badges to update dynamically
      visBody.querySelectorAll('input[type="checkbox"][data-map-multi]').forEach(function(cb){
        cb.onchange = function(){
          var keyName = cb.getAttribute('data-map-multi');
          if(!keyName) return;
          
          // Find the checkbox list container
          var listContainer = cb.closest('div[style*="max-height"]');
          if(!listContainer) return;
          var fieldContainer = listContainer.parentElement;
          if(!fieldContainer) return;
          
          // Find badge container (should always exist now)
          var badgeContainer = fieldContainer.querySelector('div[style*="flex-wrap"]');
          if(!badgeContainer) return;
          
          // Get all checkboxes for this field
          var allCbs = listContainer.querySelectorAll('input[type="checkbox"][data-map-multi="'+keyName+'"]');
          var selected = [];
          allCbs.forEach(function(checkbox){
            if(checkbox.checked && checkbox.value){
              var label = checkbox.nextElementSibling ? checkbox.nextElementSibling.textContent.trim() : checkbox.value;
              selected.push({value: checkbox.value, label: label});
            }
          });
          
          // Rebuild badge display
          badgeContainer.innerHTML = '';
          if(selected.length > 0){
            badgeContainer.style.display = 'flex';
            for(var i=0; i<selected.length; i++){
              var badge = document.createElement('span');
              badge.style.cssText = 'display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.3);border-radius:6px;font-size:11px;font-weight:600;color:var(--vm-text)';
              badge.textContent = '✓ ' + selected[i].label;
              badgeContainer.appendChild(badge);
            }
          } else {
            badgeContainer.style.display = 'none';
          }
        };
      });
      // auto-show val2 for viscf "between" & auto-hide val1/val2 for isblank/notblank
      visBody.querySelectorAll('select[data-viscf="op"]').forEach(function(sel){
        var wrap = sel.closest('.list-item');
        if(!wrap) return;
        var v1 = wrap.querySelector('input[data-viscf="val1"]');
        var v2 = wrap.querySelector('input[data-viscf="val2"]');
        function updateVis(){
          var op = String(sel.value);
          if(v1) v1.style.display = (op==='isblank'||op==='notblank') ? 'none' : '';
          if(v2) v2.style.display = (op==='between') ? '' : 'none';
        }
        updateVis();
        sel.onchange = updateVis;
      });
    }

    visTabs.addEventListener('click', function(ev){
      var t = ev.target && ev.target.getAttribute && ev.target.getAttribute('data-tab');
      if(!t) return;
      visTab = t;
      renderVisualSettings();
    });

    var btnVisClose = q('#vm-visual-close');
    var btnVisCancel = q('#vm-visual-cancel');
    if(btnVisClose) btnVisClose.onclick = closeVisualSettings;
    if(btnVisCancel) btnVisCancel.onclick = closeVisualSettings;

    var btnVisApply = q('#vm-visual-apply');
    if(btnVisApply) btnVisApply.onclick = function(){
      if(!visDraft || !visId) return;

      // core title
      var titleEl = visBody.querySelector('input[data-core="title"]');
      if(titleEl) visDraft.title = String(titleEl.value||'');
      var showTitleEl = visBody.querySelector('input[data-core="showTitle"]');
      if(showTitleEl) visDraft.showTitle = !!showTitleEl.checked;
      var titleAlignEl = visBody.querySelector('select[data-core="titleAlign"]');
      if(titleAlignEl) visDraft.titleAlign = String(titleAlignEl.value||'left');
      var typeEl = visBody.querySelector('select[data-core="type"]');
      if(typeEl) visDraft.type = String(typeEl.value||visDraft.type||'');
      var titleSizeEl = visBody.querySelector('input[data-core="titleSize"]');
      if(titleSizeEl) visDraft.titleSize = clamp(parseInt(titleSizeEl.value,10)||14, 10, 28);
      var titleColorEl = visBody.querySelector('input[data-core="titleColor"]');
      if(titleColorEl) visDraft.titleColor = String(titleColorEl.value||'');
      
      // card appearance
      var cardBgEl = visBody.querySelector('input[data-core="cardBgColor"]');
      if(cardBgEl) visDraft.cardBgColor = String(cardBgEl.value||'');
      var cardBorderColorEl = visBody.querySelector('input[data-core="cardBorderColor"]');
      if(cardBorderColorEl) visDraft.cardBorderColor = String(cardBorderColorEl.value||'');
      var cardBorderWidthEl = visBody.querySelector('input[data-core="cardBorderWidth"]');
      if(cardBorderWidthEl) visDraft.cardBorderWidth = clamp(parseInt(cardBorderWidthEl.value,10)||1, 0, 10);
      var cardBorderRadiusEl = visBody.querySelector('input[data-core="cardBorderRadius"]');
      if(cardBorderRadiusEl) visDraft.cardBorderRadius = clamp(parseInt(cardBorderRadiusEl.value,10)||10, 0, 30);

      // mapping
      var mapEls = visBody.querySelectorAll('select[data-map]');
      mapEls.forEach(function(sel){
        var k = sel.getAttribute('data-map');
        visDraft.mapping = visDraft.mapping || {};
        visDraft.mapping[k] = String(sel.value||'');
      });

      // mapping (multi) - handle both checkboxes and select elements
      var mapMultiEls = visBody.querySelectorAll('select[data-map-multi]');
      mapMultiEls.forEach(function(sel){
        var k = sel.getAttribute('data-map-multi');
        visDraft.mapping = visDraft.mapping || {};
        var arr=[];
        for(var i=0;i<sel.options.length;i++){
          var opt = sel.options[i];
          if(opt && opt.selected) arr.push(String(opt.value||''));
        }
        visDraft.mapping[k] = arr.filter(function(x){ return !!x; });
      });
      
      var mapMultiCheckboxes = visBody.querySelectorAll('input[type="checkbox"][data-map-multi]');
      var checkboxGroups = {};
      mapMultiCheckboxes.forEach(function(cb){
        var k = cb.getAttribute('data-map-multi');
        if(!checkboxGroups[k]) checkboxGroups[k] = [];
        if(cb.checked) checkboxGroups[k].push(String(cb.value||''));
      });
      for(var gk in checkboxGroups){
        visDraft.mapping = visDraft.mapping || {};
        visDraft.mapping[gk] = checkboxGroups[gk];
      }

      // measures
      var measEls = visBody.querySelectorAll('[data-measure]');
      measEls.forEach(function(el){
        var key = el.getAttribute('data-measure');
        var part = el.getAttribute('data-part');
        visDraft.measures = visDraft.measures || {};
        visDraft.measures[key] = visDraft.measures[key] || {colKey:'',agg:'sum'};
        if(part==='col') visDraft.measures[key].colKey = String(el.value||'');
        if(part==='agg') visDraft.measures[key].agg = String(el.value||'sum');
        if(part==='dec'){
          var dv = String(el.value||'').trim();
          visDraft.measures[key].decimals = (dv !== '' && isFinite(parseInt(dv,10))) ? clamp(parseInt(dv,10), 0, 10) : null;
        }
        
        if(part==='color'){
           var clr = String(el.value||'');
           visDraft.measures[key].color = (clr && clr!=='#000000') ? clr : null;
        }
      });

      // transform mode removed - visuals now use automatic mode detection
      // (If needed, transform configuration is handled per-visual in render functions)

      // options
      var optEls = visBody.querySelectorAll('[data-opt]');
      optEls.forEach(function(el){
        var k = el.getAttribute('data-opt');
        visDraft.options = visDraft.options || {};
        if(el.type==='checkbox'){
          if(k==='donut'){
            visDraft.options.hole = el.checked ? 0.45 : 0;
          }else{
            visDraft.options[k] = !!el.checked;
          }
        }else{
          if(k==='showLegend'){
            visDraft.options.showLegend = (String(el.value||'') !== 'false');
            return;
          }
          if(k==='yMin' || k==='yMax' || k==='targetMin' || k==='targetMax'){
            var n = parseFloat(String(el.value||''));
            visDraft.options[k] = isFinite(n) ? n : null;
          } else if(k==='labelDecimals' || k==='xTickDecimals' || k==='yTickDecimals'){
            var nd = parseInt(String(el.value||''),10);
            visDraft.options[k] = isFinite(nd) ? nd : null;
          } else if(k==='labelCfVal' || k==='xTickCount' || k==='yTickCount' || k==='xTickAngle'){
            var nv = parseFloat(String(el.value||''));
            visDraft.options[k] = isFinite(nv) ? nv : null;
          } else {
            visDraft.options[k] = String(el.value||'');
          }
        }
      });

      // options (special): per-column widths
      var colwEls = visBody.querySelectorAll('input[data-opt-colw]');
      
      // options (special): per-column alignments
      var colAlEls = visBody.querySelectorAll('[data-opt-colalign]');

      // options (special): modebar icon toggles
      var mbEls = visBody.querySelectorAll('input[data-modebar-icon]');
      if(mbEls && mbEls.length){
        visDraft.options = visDraft.options || {};
        var mbMap = {};
        mbEls.forEach(function(inp){
          var ik = inp.getAttribute('data-modebar-icon');
          if(ik) mbMap[ik] = !!inp.checked;
        });
        visDraft.options.modebarIcons = mbMap;
      }

      if(colwEls && colwEls.length){
        visDraft.options = visDraft.options || {};
        var map = {};
        colwEls.forEach(function(inp){
          var key = inp.getAttribute('data-opt-colw');
          if(!key) return;
          var raw = String(inp.value||'').trim();
          if(!raw){ return; }
          var w = parseInt(raw,10);
          if(isFinite(w) && w>0) map[String(key)] = w;
        });
        visDraft.options.colWidths = map;
      }
      
      // options (special): per-column alignments
      if(colAlEls && colAlEls.length){
        visDraft.options = visDraft.options || {};
        var calMap = {};
        colAlEls.forEach(function(inp){
          var key = inp.getAttribute('data-opt-colalign');
          if(!key) return;
          var val = String(inp.value||'');
          if(val) calMap[String(key)] = val;
        });
        visDraft.options.colAligns = calMap;
      }

      // options (special): conditional formatting rules (table-specific data-cf)
      var cfItems = visBody.querySelectorAll('.list-item[data-cf-rule]');
      if(cfItems && cfItems.length){
        visDraft.options = visDraft.options || {};
        var rules = [];
        cfItems.forEach(function(item){
          var colEl = item.querySelector('select[data-cf="col"]');
          var opEl = item.querySelector('select[data-cf="op"]');
          var v1El = item.querySelector('input[data-cf="val1"]');
          var v2El = item.querySelector('input[data-cf="val2"]');
          var bgEl = item.querySelector('input[data-cf="bg"]');
          var fgEl = item.querySelector('input[data-cf="fg"]');
          var icon1El = item.querySelector('select[data-cf="icon1"]');
          var icon2El = item.querySelector('select[data-cf="icon2"]');
          var apEl = item.querySelector('select[data-cf="applyTo"]');
          rules.push({
            col: colEl ? String(colEl.value||'') : '',
            op: opEl ? String(opEl.value||'gt') : 'gt',
            val1: v1El ? String(v1El.value||'') : '',
            val2: v2El ? String(v2El.value||'') : '',
            bg: bgEl ? String(bgEl.value||'#fca5a5') : '#fca5a5',
            fg: fgEl ? String(fgEl.value||'#111827') : '#111827',
            icon1: icon1El ? String(icon1El.value||'') : '',
            icon2: icon2El ? String(icon2El.value||'') : '',
            applyTo: apEl ? String(apEl.value||'cell') : 'cell'
          });
        });
        visDraft.options.cfRules = rules;
      }

      // options (special): conditional formatting rules (common viscf for chart types)
      var viscfItems = visBody.querySelectorAll('.list-item[data-viscf-rule]');
      if(viscfItems && viscfItems.length){
        visDraft.options = visDraft.options || {};
        var vrules = [];
        viscfItems.forEach(function(item){
          var colEl = item.querySelector('select[data-viscf="col"]');
          var opEl = item.querySelector('select[data-viscf="op"]');
          var v1El = item.querySelector('input[data-viscf="val1"]');
          var v2El = item.querySelector('input[data-viscf="val2"]');
          var bgEl = item.querySelector('input[data-viscf="bg"]');
          var fgEl = item.querySelector('input[data-viscf="fg"]');
          var apEl = item.querySelector('select[data-viscf="applyTo"]');
          vrules.push({
            col: colEl ? String(colEl.value||'') : '',
            op: opEl ? String(opEl.value||'gt') : 'gt',
            val1: v1El ? String(v1El.value||'') : '',
            val2: v2El ? String(v2El.value||'') : '',
            bg: bgEl ? String(bgEl.value||'#fca5a5') : '#fca5a5',
            fg: fgEl ? String(fgEl.value||'#111827') : '#111827',
            applyTo: apEl ? String(apEl.value||'bar') : 'bar'
          });
        });
        visDraft.options.cfRules = vrules;
      }

      // options (special): reference lines
      var refItems = visBody.querySelectorAll('.list-item[data-refline]');
      if(refItems && refItems.length){
        visDraft.options = visDraft.options || {};
        var rlines = [];
        refItems.forEach(function(item){
          var nameEl = item.querySelector('input[data-refline-name]');
          var valEl = item.querySelector('input[data-refline-val]');
          var dashEl = item.querySelector('select[data-refline-dash]');
          var colEl = item.querySelector('input[data-refline-color]');
          var val = parseFloat(String(valEl ? valEl.value : ''));
          rlines.push({
            label: nameEl ? String(nameEl.value||'') : '',
            value: isFinite(val) ? val : null,
            dash: dashEl ? String(dashEl.value||'dash') : 'dash',
            color: colEl ? String(colEl.value||'#111827') : '#111827'
          });
        });
        visDraft.options.refLines = rlines;
      } else if(visDraft.options && visDraft.options.refLines){
        visDraft.options.refLines = [];
      }

      // filter
      if(visTab==='filter' || visBody.querySelector('[data-filter]')){
        var logicEl = visBody.querySelector('select[data-filter="logic"]');
        visDraft.filter = visDraft.filter || defaultFilter();
        if(logicEl) visDraft.filter.logic = String(logicEl.value||'and');

        // clauses
        var clauseItems = visBody.querySelectorAll('.list-item[data-clause]');
        var clauses=[];
        clauseItems.forEach(function(item){
          var colEl = item.querySelector('select[data-filter="colKey"]');
          var opEl = item.querySelector('select[data-filter="op"]');
          var v1 = item.querySelector('input[data-filter="value"]');
          var v2 = item.querySelector('input[data-filter="value2"]');
          clauses.push({
            colKey: colEl?String(colEl.value||''):'',
            op: opEl?String(opEl.value||'eq'):'eq',
            value: v1?String(v1.value||''):'',
            value2: v2?String(v2.value||''):''
          });
        });
        visDraft.filter.clauses = clauses;
      }

      // layout
      var layoutEls = visBody.querySelectorAll('[data-layout]');
      if(layoutEls && layoutEls.length){
        visDraft.layout = visDraft.layout || {};
        layoutEls.forEach(function(el){
          var k = el.getAttribute('data-layout');
          if(!k) return;
          if(k==='minHeight'){
            visDraft.layout.minHeight = clamp(parseInt(String(el.value||'0'),10)||0, 0, 5000);
            return;
          }
          if(k==='stackWeight'){
            var w = parseFloat(String(el.value||'1'));
            visDraft.layout.stackWeight = clamp(isFinite(w)?w:1, 0.25, 10);
            return;
          }
          if(k==='heightPx'){
            visDraft.layout.heightPx = clamp(parseInt(String(el.value||'0'),10)||0, 0, 5000);
            return;
          }
          visDraft.layout[k] = String(el.value||'');
        });
        if(visDraft.layout.group) visDraft.layout.group = String(visDraft.layout.group).trim();
      }

      // Write back
      var idx = STATE.visuals.findIndex(function(v){return v && v.id===visId;});
      if(idx>=0){
        visDraft = ensureVisualDefaults(visDraft);
        STATE.visuals[idx] = visDraft;
        saveState();
        closeVisualSettings();
        if(visTab==='layout') renderGrid();
        else vmRenderSingle(visId);
      }
    };

    // ---------------------------
    // Top-level event handlers
    // ---------------------------
    function getPlotElFromHost(hostEl){
      try{
        if(!hostEl) return null;
        // Preferred: plot lives inside the card/subvis host.
        var p = hostEl.querySelector('.plot');
        if(p) return p;
        // Back-compat fallback: older templates used #plot_<vid>.
        var vid = hostEl.getAttribute ? hostEl.getAttribute('data-vid') : null;
        if(vid) return q('#plot_' + String(vid));
        return null;
      }catch(e){
        return null;
      }
    }
    function relayoutDragmode(plotEl, mode){
      try{ Plotly.relayout(plotEl, {dragmode: mode}); }catch(e){}
    }

    function setPressedInHost(hostEl, activeAct){
      try{
        if(!hostEl || !hostEl.querySelectorAll) return;
        var acts = ['biz-zoom','biz-pan','biz-select','biz-lasso'];
        for(var i=0;i<acts.length;i++){
          var btn = hostEl.querySelector('button[data-act="'+acts[i]+'"]');
          if(btn) btn.setAttribute('aria-pressed', (acts[i]===activeAct)?'true':'false');
        }
      }catch(e){}
    }
    function resetAxes(plotEl){
      try{
        Plotly.relayout(plotEl, {
          'xaxis.autorange': true,
          'yaxis.autorange': true,
          'yaxis2.autorange': true
        });
      }catch(e){}
    }
    function downloadPlotImage(plotEl, filename){
      try{ Plotly.downloadImage(plotEl, {format:'png', filename: filename || 'visual'}); }catch(e){}
    }

    gridEl.addEventListener('click', function(ev){
      var target = ev.target;
      if(!target) return;
      var btn = (target.closest && target.closest('button')) ? target.closest('button') : target;
      if(!btn || !btn.getAttribute) return;

      // Fallback handler for custom toolbar buttons (if document handler doesn't fire)
      if(btn.classList && btn.classList.contains('vm-tb-btn')){
        if(ev.__vmHandled) return;
        var vId = btn.getAttribute('data-vid');
        var act2 = btn.getAttribute('data-act');
        if(vmHandleToolbarClick(btn, vId, act2)){
          ev.__vmHandled = true;
          ev.preventDefault(); ev.stopPropagation();
          return;
        }
      }
      
      /* Handle table modebar buttons */
      var vmIcon = btn.getAttribute('data-vm-icon');
      if(vmIcon){
        console.log('[VM] Table modebar icon clicked:', vmIcon);
        var vid = btn.getAttribute('data-vid');
        console.log('[VM] Visual ID:', vid);
        if(vid){
          var visual = STATE.visuals.find(function(v){ return v && v.id === vid; });
          if(visual){
            console.log('[VM] Found visual, processing action');
            if(vmIcon==='reset'){ vmResetTable(vid); return; }
            if(vmIcon==='filter'){ vmShowQuickFilterDialog(vid, null); return; }
            if(vmIcon==='download'){ vmDownloadTableCSV(vid);  return; }
            if(vmIcon==='fs'){ toggleVisualFullscreen(vid); return; }
            if(vmIcon==='settings'){ openVisualSettings(vid); return; }
          } else {
            console.error('[VM] Visual not found for ID:', vid);
          }
        }
        return;
      }
      
      var act = btn.getAttribute('data-act');
      if(!act) return;

      var host = btn.closest('[data-vid]');
      var vid = host ? host.getAttribute('data-vid') : null;

      if(act==='vis-settings'){
        if(!SHOW_VISUAL_SETTINGS_ICON) return;
        if(vid) openVisualSettings(vid);
        return;
      }

      if(act.indexOf('biz-')===0){
        if(!SHOW_BUSINESS_CONTROLS) return;
        var plotEl = getPlotElFromHost(host);
        if(!plotEl) return;
        if(act==='biz-zoom'){ relayoutDragmode(plotEl, 'zoom'); setPressedInHost(host, 'biz-zoom'); }
        if(act==='biz-pan'){ relayoutDragmode(plotEl, 'pan'); setPressedInHost(host, 'biz-pan'); }
        if(act==='biz-select'){ relayoutDragmode(plotEl, 'select'); setPressedInHost(host, 'biz-select'); }
        if(act==='biz-lasso'){ relayoutDragmode(plotEl, 'lasso'); setPressedInHost(host, 'biz-lasso'); }
        if(act==='biz-reset') resetAxes(plotEl);
        if(act==='biz-download'){
          var vObj = (STATE.visuals||[]).find(function(x){return x && x.id===vid;});
          var fn = vObj ? String(vObj.title||vObj.type||'visual') : 'visual';
          fn = fn.replace(/[^a-z0-9\-_]+/gi,'_').slice(0,80);
          downloadPlotImage(plotEl, fn);
        }
        return;
      }
    });

    function downloadBlob(filename, mime, blob){
      try{
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){
          try{ URL.revokeObjectURL(url); }catch(e){}
          try{ a.remove(); }catch(e){}
        }, 200);
      }catch(e){}
    }

    function rowsToCsv(rows){
      rows = Array.isArray(rows) ? rows : [];
      if(!rows.length) return '';
      var cols = Object.keys(rows[0]||{});
      var esc = function(v){
        var s = (v==null)?'':String(v);
        if(/[\n\r",]/.test(s)) s = '"'+s.replace(/"/g,'""')+'"';
        return s;
      };
      var out=[];
      out.push(cols.map(esc).join(','));
      for(var i=0;i<rows.length;i++){
        var r=rows[i]||{};
        out.push(cols.map(function(k){ return esc(r[k]); }).join(','));
      }
      return out.join('\n');
    }

    function ensureXLSX(){
      if(window.XLSX) return Promise.resolve();
      return ensureScriptOnce('XLSX', [
        '/analyticsRes/vendor/export/xlsx.full.min.js',
        '/analyticsRes/vendor/export/xlsx.min.js',
        '/analyticsRes/vendor/export/xlsx.core.min.js',
        'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'
      ]);
    }
    function ensureHtml2Canvas(){
      if(window.html2canvas) return Promise.resolve();
      return ensureScriptOnce('html2canvas', [
        '/analyticsRes/vendor/export/html2canvas.min.js',
        'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'
      ]);
    }
    function ensureJsPDF(){
      if(window.jspdf && window.jspdf.jsPDF) return Promise.resolve();
      return ensureScriptOnce('jspdf', [
        '/analyticsRes/vendor/export/jspdf.umd.min.js',
        'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'
      ]);
    }

    function downloadCsv(){
      var rows = currentRows();
      var csv = rowsToCsv(rows);
      downloadBlob('narrative_data.csv', 'text/csv;charset=utf-8', new Blob([csv], {type:'text/csv;charset=utf-8'}));
    }

    function downloadXlsx(){
      var rows = currentRows();
      return ensureXLSX().then(function(){
        try{
          var ws = window.XLSX.utils.json_to_sheet(rows);
          var wb = window.XLSX.utils.book_new();
          window.XLSX.utils.book_append_sheet(wb, ws, 'Data');
          // Prefer blob download to avoid file dialog restrictions in some OAS embeds
          var out = window.XLSX.write(wb, {bookType:'xlsx', type:'array'});
          downloadBlob('narrative_data.xlsx', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
        }catch(e){
          // fallback to CSV
          downloadCsv();
        }
      });
    }

    function downloadAllVisualsPdf(){
      return ensureHtml2Canvas().then(ensureJsPDF).then(function(){
        var gridEl = q('#vm-grid');
        if(!gridEl) return;
        
        var jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
        if(!jsPDF) return;

        /* Capture the entire grid to maintain layout */
        return window.html2canvas(gridEl, {
          backgroundColor: document.body.style.backgroundColor || '#ffffff',
          scale: 2,
          logging: false,
          useCORS: true,
          allowTaint: true
        }).then(function(canvas){
          var imgData = canvas.toDataURL('image/png');
          var imgWidth = canvas.width;
          var imgHeight = canvas.height;
          
          /* Calculate PDF page dimensions - A4 landscape */
          var doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
          var pageWidth = doc.internal.pageSize.getWidth();
          var pageHeight = doc.internal.pageSize.getHeight();
          var margin = 40;
          var maxWidth = pageWidth - (margin * 2);
          var maxHeight = pageHeight - (margin * 2);
          
          /* Scale to fit width, then split vertically if needed */
          var scale = maxWidth / imgWidth;
          var scaledWidth = imgWidth * scale;
          var scaledHeight = imgHeight * scale;
          
          /* If fits on one page, add it */
          if(scaledHeight <= maxHeight){
            var x = margin;
            var y = (pageHeight - scaledHeight) / 2;
            doc.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);
          } else {
            /* Split across multiple pages vertically */
            var pageCount = Math.ceil(scaledHeight / maxHeight);
            var sourceHeightPerPage = imgHeight / pageCount;
            
            for(var i = 0; i < pageCount; i++){
              if(i > 0) doc.addPage();
              
              /* Create a temporary canvas for this page slice */
              var sliceCanvas = document.createElement('canvas');
              sliceCanvas.width = imgWidth;
              sliceCanvas.height = sourceHeightPerPage;
              var sliceCtx = sliceCanvas.getContext('2d');
              
              /* Draw the slice from the original canvas */
              sliceCtx.drawImage(
                canvas,
                0, i * sourceHeightPerPage, imgWidth, sourceHeightPerPage,
                0, 0, imgWidth, sourceHeightPerPage
              );
              
              var sliceData = sliceCanvas.toDataURL('image/png');
              var sliceScaledHeight = sourceHeightPerPage * scale;
              doc.addImage(sliceData, 'PNG', margin, margin, scaledWidth, sliceScaledHeight);
            }
          }
          
          /* Add metadata */
          doc.setProperties({
            title: 'Visual Dashboard Report',
            subject: 'Generated from Visual Manager',
            author: 'Visual Manager',
            creator: 'Visual Manager'
          });
          
          doc.save('dashboard-report.pdf');
        });
      }).catch(function(err){
        console.error('PDF generation error:', err);
        alert('Failed to generate PDF. Please try again.');
      });
    }

    function cycleTheme(){
      var cur = String(STATE.globals.theme||PV_THEME_DEFAULT||'light').toLowerCase();
      var next = (cur==='light') ? 'dark' : (cur==='dark' ? 'paper' : 'light');
      applyTheme(next);
      saveState();
      renderGrid();
    }

    function toggleFullscreen(){
      try{
        var el = HOST;
        var doc = document;
        if(doc.fullscreenElement){ doc.exitFullscreen(); return; }
        if(el.requestFullscreen) el.requestFullscreen();
      }catch(e){}
    }

    function toggleVisualFullscreen(vid){
      try{
        var cardEl = q('.card[data-vid="'+vid+'"]');
        if(!cardEl) return;
        if(cardEl.classList.contains('vm-full')){
          cardEl.classList.remove('vm-full');
          var plotDiv = cardEl.querySelector('.js-plotly-plot');
          if(plotDiv && typeof Plotly !== 'undefined') {
            setTimeout(function(){ 
              Plotly.Plots.resize(plotDiv);
              /* Re-apply modebar visibility after resize */
              var modebar = plotDiv.querySelector('.modebar');
              if(modebar){
                modebar.style.display = 'block';
                modebar.style.visibility = 'visible';
                modebar.style.opacity = '1';
              }
            }, 100);
          }
        } else {
          cardEl.classList.add('vm-full');
          var plotDiv = cardEl.querySelector('.js-plotly-plot');
          if(plotDiv && typeof Plotly !== 'undefined') {
            setTimeout(function(){ 
              Plotly.Plots.resize(plotDiv);
              /* Re-apply modebar visibility after resize */
              var modebar = plotDiv.querySelector('.modebar');
              if(modebar){
                modebar.style.display = 'block';
                modebar.style.visibility = 'visible';
                modebar.style.opacity = '1';
              }
            }, 100);
          }
        }
      }catch(e){}
    }

    var vprSel = q('#vm-vpr');
    if(vprSel) vprSel.onchange = function(){
      var n = clamp(parseInt(String(vprSel.value||'2'),10)||2, 1, 6);
      STATE.globals.visualsPerRow = n;
      saveState();
      renderGrid();
    };
    var btnTheme = q('#vm-btn-theme');
    if(btnTheme) btnTheme.onclick = cycleTheme;
    // Downloads are handled by the single titlebar download menu
    var btnFs = q('#vm-btn-fullscreen');
    if(btnFs) btnFs.onclick = toggleFullscreen;

    // Close modals on backdrop click
    mgrBackdrop.addEventListener('click', function(ev){ if(ev.target===mgrBackdrop) closeManager(); });
    visBackdrop.addEventListener('click', function(ev){ if(ev.target===visBackdrop) closeVisualSettings(); });

    function initAfterPlotly(){
      if(CLEAR_PERSISTENCE_ONLOAD){
        try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
      }
      loadState();

      // upgrade older saved state
      STATE.globals = STATE.globals || {};
      if(!STATE.globals.theme) STATE.globals.theme = PV_THEME_DEFAULT;
      if(!STATE.globals.cardHeight) STATE.globals.cardHeight = clamp(pvInt('data-card-height', 320), 180, 1400);
      if(STATE.globals.gridGap==null) STATE.globals.gridGap = clamp(pvInt('data-grid-gap', 10), 0, 40);
      if(STATE.globals.topGap==null) STATE.globals.topGap = clamp(pvInt('data-top-gap', 6), 0, 30);
      if(STATE.globals.sectionGap==null) STATE.globals.sectionGap = clamp(pvInt('data-section-gap', 4), 0, 30);
      if(!STATE.globals.layoutMode) STATE.globals.layoutMode = 'auto';
      if(!STATE.globals.customGrid) STATE.globals.customGrid = { cols: 6, rowHeight: 80, tiles: [] };
      if(!STATE.globals.title) STATE.globals.title = pvStr('data-report-title','Visual Manager');
      if(STATE.globals.subtitle==null) STATE.globals.subtitle = pvStr('data-report-subtitle','');
      if(!STATE.globals.imageUrl) STATE.globals.imageUrl = '';
      if(!STATE.globals.titlebarRadius) STATE.globals.titlebarRadius = 14;
      applyTheme(STATE.globals.theme);

      if(vprSel) vprSel.value = String(clamp(parseInt(STATE.globals.visualsPerRow||2,10)||2, 1, 6));

      // Seed a few visuals on first run
      if(!Array.isArray(STATE.visuals) || !STATE.visuals.length){
        STATE.visuals = [
          Registry.line.defaultVisual(),
          Registry.bar.defaultVisual(),
          Registry.pie.defaultVisual(),
          Registry.scatter.defaultVisual()
        ];
        saveState();
      }

      renderGrid();
    }

    // Per-visual toolbar bindings (custom header toolbar -> Plotly API)
    var activeVid = null;

    function vmGetPlotDivByVid(vid){
      try{
        var card = gridEl.querySelector('.card[data-vid="'+cssEscape(vid)+'"]');
        if(!card) return null;
        var plot = card.querySelector('.plot[data-vid]');
        return plot || null;
      }catch(e){ return null; }
    }

    // Lightweight per-visual re-render to avoid full-grid flicker
    function vmRenderSingle(vid){
      try{
        var plotEl = vmGetPlotDivByVid(vid);
        if(!plotEl) return;
        var visuals = Array.isArray(STATE.visuals) ? STATE.visuals : [];
        var v = null;
        for(var i=0;i<visuals.length;i++){ if(visuals[i] && String(visuals[i].id)===String(vid)){ v = ensureVisualDefaults(visuals[i]); break; } }
        if(!v || !v.show) return;

        var ctx = buildCtx();
        var secKey = plotEl.getAttribute('data-sec') || '';
        var secEnabled = !!(ctx.sections && ctx.sections.enabled && ctx.sections.splitCol);
        var rows = ctx.rows || [];
        if(secEnabled && secKey){
          var col = String(ctx.sections.splitCol);
          rows = rows.filter(function(r){
            var val = asString((r||{})[col]);
            if(val===''||val==null) val='(Blank)';
            return val===secKey;
          });
          ctx = Object.assign({}, ctx, { rows: rows, sections: {enabled:false, splitCol:'', current:'All'} });
        }

        var def = Registry[v.type];
        if(def && typeof def.render === 'function'){
          def.render(v, rows, ctx, plotEl);
          vmApplyRuntimeOptions(v, plotEl, ctx);
          // Resize after render for stability
          setTimeout(function(){ try{ if(window.Plotly && plotEl.querySelector){ var gd=plotEl.querySelector('.js-plotly-plot'); if(gd) Plotly.Plots.resize(gd); } }catch(e){} }, 20);
          // Re-attach remove-point handler if active
          if(vmRemoveActive[v.id]){
            var gdAct = plotEl.querySelector('.js-plotly-plot');
            if(gdAct) vmAttachRemoveHandler(gdAct, v.id);
          }
        }
      }catch(e){ console.error('vmRenderSingle error', e); }
    }

    // Remove-point handling (per visual)
    var vmRemoveActive = Object.create(null);
    function vmAttachRemoveHandler(gd, vid){
      if(!gd || !window.Plotly) return;
      if(gd.__vmRemoveCb){ try{ gd.removeListener('plotly_click', gd.__vmRemoveCb); }catch(_){ } }
      var cb = function(ev){
        try{
          var pt = ev && ev.points && ev.points[0];
          if(!pt) return;
          var v = vmFindVisual(vid);
          if(!v) return;
          v.options = v.options || {};
          v.options.removedPoints = v.options.removedPoints || [];
          var key = JSON.stringify([pt.x, pt.y, (pt.data && pt.data.name) ? pt.data.name : pt.curveNumber||0]);
          if(v.options.removedPoints.indexOf(key) < 0){
            v.options.removedPoints.push(key);
            saveState();
            vmRenderSingle(vid);
          }
        }catch(_){ }
      };
      gd.__vmRemoveCb = cb;
      try{ gd.on('plotly_click', cb); }catch(_){ }
    }
    function vmToggleRemoveMode(vid){
      var on = !vmRemoveActive[vid];
      vmRemoveActive[vid] = on;
      var card = gridEl.querySelector('.card[data-vid="'+cssEscape(vid)+'"]');
      if(card){ card.classList.toggle('vm-remove-mode', on); }
      var btn = card ? card.querySelector('.vm-tb-btn[data-act="remove"]') : null;
      if(btn && btn.hasAttribute('aria-pressed')) btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      var gd = vmGetPlotDivByVid(vid);
      if(!gd) return;
      var plot = gd.querySelector ? gd.querySelector('.js-plotly-plot') : null;
      if(on){
        vmAttachRemoveHandler(plot||gd, vid);
      } else {
        if(plot && plot.__vmRemoveCb){ try{ plot.removeListener('plotly_click', plot.__vmRemoveCb); }catch(_){ } plot.__vmRemoveCb=null; }
      }
    }

    function vmSetToggle(card, act){
      if(!card) return;
      var btns = card.querySelectorAll('.vm-tb-btn[aria-pressed]');
      for(var i=0;i<btns.length;i++){
        var b=btns[i];
        b.setAttribute('aria-pressed', (b.getAttribute('data-act')===act) ? 'true' : 'false');
      }
    }

    function vmCloseMenus(exceptVid){
      try{
        var menus = gridEl.querySelectorAll('.vm-menu.open');
        for(var i=0;i<menus.length;i++){
          var m=menus[i];
          var v = m.getAttribute('data-vid');
          if(exceptVid && v===exceptVid) continue;
          m.classList.remove('open');
        }
      }catch(e){}
    }

    function vmToggleMenu(vid){
      var menu = q('#vm-menu-'+vid);
      if(!menu) return;
      var open = menu.classList.contains('open');
      vmCloseMenus();
      if(!open){
        menu.classList.add('open');
        // close on outside click
        setTimeout(function(){
          window.addEventListener('click', function(ev){
            try{
              if(!menu.contains(ev.target)){
                var card = gridEl.querySelector('.card[data-vid="'+cssEscape(vid)+'"]');
                if(card && card.contains(ev.target)) return; // clicking inside card but outside menu handled by grid click
                menu.classList.remove('open');
              }
            }catch(e){}
          }, {capture:true, once:true});
        },0);
      }
    }

    function vmDownloadText(filename, text){
      try{
        var blob = new Blob([text], {type:'application/json;charset=utf-8'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ try{ URL.revokeObjectURL(url); a.remove(); }catch(e){} }, 200);
      }catch(e){}
    }

    function vmDoAction(vid, act){
      var gd = vmGetPlotDivByVid(vid);
      var card = gd ? gd.closest('.card') : null;

      // Theme / non-plot actions
      if(act==='toggle-theme'){
        try{
          STATE.globals.theme = (STATE.globals.theme==='dark') ? 'light' : 'dark';
          applyTheme();
          saveState();
          renderGrid();
        }catch(e){}
        return;
      }
      if(act==='shortcuts'){
        alert('Keyboard shortcuts (active visual):\nZ Zoom\nP Pan\nS Select\nL Lasso\nA Autoscale\nR Reset\nG Legend\nF Fullscreen\nE Export PNG');
        return;
      }

      if(!gd || !window.Plotly) return;

      try{
        if(act==='home' || act==='reset'){
          Plotly.relayout(gd, {'xaxis.autorange':true,'yaxis.autorange':true,'yaxis2.autorange':true});
        } else if(act==='autoscale'){
          Plotly.relayout(gd, {'xaxis.autorange':true,'yaxis.autorange':true,'yaxis2.autorange':true});
        } else if(act==='zoom'){
          Plotly.relayout(gd, {dragmode:'zoom'});
          vmSetToggle(card,'zoom');
        } else if(act==='pan'){
          Plotly.relayout(gd, {dragmode:'pan'});
          vmSetToggle(card,'pan');
        } else if(act==='select'){
          Plotly.relayout(gd, {dragmode:'select'});
          vmSetToggle(card,'select');
        } else if(act==='lasso'){
          Plotly.relayout(gd, {dragmode:'lasso'});
          vmSetToggle(card,'lasso');
        } else if(act==='legend'){
          // cycle legend position: right -> bottom -> left -> top -> off -> right ...
          var vv = vmFindVisual(vid);
          vv.options = vv.options || {};
          var cur = String(vv.options.legendPos || 'right');
          var order = ['right','bottom','left','top','off'];
          var ni = (order.indexOf(cur)+1);
          if(ni<0) ni = 0;
          ni = ni % order.length;
          var nxt = order[ni];
          vv.options.legendPos = nxt;
          vv.options.showLegend = (nxt !== 'off');
          saveState();

          if(nxt==='off'){
            Plotly.relayout(gd, {showlegend:false});
          }else{
            Plotly.relayout(gd, objAssign({showlegend:true}, vmLegendLayoutFor(nxt)));
          }
        } else if(act==='export' || act==='more'){
          vmToggleMenu(vid);
        } else if(act==='export-png'){
          Plotly.downloadImage(gd, {format:'png', filename: (vid||'visual')});
        } else if(act==='export-svg'){
          Plotly.downloadImage(gd, {format:'svg', filename: (vid||'visual')});
        } else if(act==='export-json'){
          var payload = {data: gd.data || [], layout: gd.layout || {}};
          vmDownloadText((vid||'visual')+'.json', JSON.stringify(payload, null, 2));
        } else if(act==='fs'){
          try{
            var el = card || gd;
            if(el.requestFullscreen) el.requestFullscreen();
            else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            else if(el.msRequestFullscreen) el.msRequestFullscreen();
          }catch(e){}
        }
      }catch(e){}
    }

    // Track active visual (for keyboard shortcuts)
    gridEl.addEventListener('pointerenter', function(e){
      try{
        var card = e.target && e.target.closest ? e.target.closest('.card[data-vid]') : null;
        if(card) activeVid = card.getAttribute('data-vid');
      }catch(_){}
    }, true);

    
    // ---------------------------
    // Per-visual popover menus (enterprise modebar)
    // ---------------------------
    function vmPopEl(){
      var el = document.getElementById('vm-pop');
      if(el) return el;
      el = document.createElement('div');
      el.id = 'vm-pop';
      el.className = 'vm-pop';
      el.setAttribute('aria-hidden','true');
      document.body.appendChild(el);
      return el;
    }
    function vmPopClose(){
      var pop = vmPopEl();
      if(!pop) return;
      pop.classList.remove('open');
      pop.setAttribute('aria-hidden','true');
      pop.innerHTML = '';
      pop.__vid = null;
      pop.__act = null;
    }
    
    function vmResetVisual(vid){
      var v = vmFindVisual(vid);
      if(!v) return;
      // Reset options to default but keep mapping/measures
      if(v.defaultVisual){
         var def = v.defaultVisual();
         v.options = def.options || {};
         // Preserve some keys if needed, but "Reset" usually means FULL reset of view options
         // We should probably keep things like title?
         // For now, let's just clear specific view options
         v.options.zoom = null;
         v.options.pan = null;
         v.filter = null;
         v.options.yMin = null; 
         v.options.yMax = null;
         v.options.showLegend = true;
         v.options.statsMode = 'none';
        v.options.removedPoints = [];
        vmRemoveActive[v.id] = false;
      }
      saveState();
      renderGrid();
    }

    function vmToggleTheme(){
      var current = HOST.getAttribute('data-theme') || STATE.globals.theme || 'light';
      var next = (current==='dark') ? 'light' : 'dark';
      STATE.globals.theme = next;
      applyTheme(next);
      saveState();
      renderGrid();
    }

    function vmCloseOverlays(){
      try{ document.querySelectorAll('.vm-menu.open').forEach(function(x){ x.classList.remove('open'); }); }catch(e){}
      try{ document.querySelectorAll('.oas-pop').forEach(function(x){ x.remove(); }); }catch(e){}
      vmPopClose();
    }

    function vmFindVisual(vid){
      if(!STATE || !STATE.visuals) return null;
      for(var i=0;i<STATE.visuals.length;i++){
        var v = STATE.visuals[i];
        if(v && String(v.id)===String(vid)) return v;
      }
      return null;
    }

    function vmMappedColumns(vis){
      var out = [];
      function pushCol(c){
        if(c==null) return;
        if(typeof c === 'object'){
          if(c.colKey) { pushCol(c.colKey); return; }
          if(c.key) { pushCol(c.key); return; }
          if(c.field) { pushCol(c.field); return; }
          for(var kk in c){
            if(!c.hasOwnProperty(kk)) continue;
            var vv = c[kk];
            if(kk==='colKey' || kk==='key' || kk==='field') pushCol(vv);
            else if(Array.isArray(vv) || (vv && typeof vv==='object')) pushCol(vv);
          }
          return;
        }
        var s = String(c);
        if(!s) return;
        if(out.indexOf(s)<0) out.push(s);
      }
      if(!vis) return out;
      if(vis.mapping){ for(var k in vis.mapping) pushCol(vis.mapping[k]); }
      if(vis.measures){ for(var mk in vis.measures) pushCol(vis.measures[mk]); }
      out = out.filter(function(x){ return x && x!=='[object Object]'; });
      return out;
    }

    function vmPopHdr(title){
      return '<div class="pop-h"><div class="t">'+escapeHtml(title)+'</div><button class="x" data-pop-x="1" title="Close">&#10005;</button></div>';
    }

    function vmChip(id,label,on){
      return '<div class="chip'+(on?' on':'')+'" data-chip="'+escapeHtml(id)+'">'+escapeHtml(label)+'</div>';
    }

    function vmPositionPop(btn){
      var pop = vmPopEl(); if(!pop) return;
      var r = btn.getBoundingClientRect();
      var top = r.bottom + 8;
      var left = Math.max(8, Math.min(r.right - 320, window.innerWidth - 368));
      if(top + 280 > window.innerHeight) top = Math.max(8, r.top - 280);
      pop.style.top = top + 'px';
      pop.style.left = left + 'px';
    }

    function vmOpenPopover(vid, act, btnEl){
      var pop = vmPopEl();
      if(!pop) return;
      
      if(pop.__vid===vid && pop.__act===act && pop.classList.contains('open')){
        vmPopClose(); return;
      }
      
      try{ document.querySelectorAll('.vm-menu.open').forEach(function(x){ x.classList.remove('open'); }); }catch(e){}
      try{ document.querySelectorAll('.oas-pop').forEach(function(x){ x.remove(); }); }catch(e){}
      
      pop.__vid = vid;
      pop.__act = act;

      var v = vmFindVisual(vid);
      var cols = vmMappedColumns(v);
      v.options = v.options || {};

      var html = '';
      if(act==='points'){
        html += vmPopHdr('Points / Labels / Styles');
        html += '<div class="sec"><div class="lbl">Points</div><div class="row">'
              + vmChip('pts-auto','Auto', !v.options.pointsMode || v.options.pointsMode==='auto')
              + vmChip('pts-none','None', v.options.pointsMode==='none')
              + vmChip('pts-all','All', v.options.pointsMode==='all')
              + '</div></div>';
        html += '<div class="sec"><div class="lbl">Labels</div><div class="row">'
              + vmChip('lbl-off','Off', !v.options.labelsOn)
              + vmChip('lbl-on','On', v.options.labelsOn)
              + '</div></div>';
        html += '<div class="sec"><div class="lbl">Gaps</div><div class="row">'
              + vmChip('gap-break','Break', !v.options.gapMode || v.options.gapMode==='gap-break')
              + vmChip('gap-connect','Connect', v.options.gapMode==='gap-connect')
              + vmChip('gap-interp','Interpolate', v.options.gapMode==='gap-interp')
              + '</div></div>';
        html += '<div class="sec"><div class="lbl">Legend</div><div class="row">'
              + vmChip('leg-show','Show', v.options.showLegend!==false)
              + vmChip('leg-hide','Hide', v.options.showLegend===false)
              + vmChip('leg-bottom','Bottom', v.options.legendPos==='bottom')
              + vmChip('leg-right','Right', v.options.legendPos==='right')
              + '</div></div>';
      } else if(act==='filter'){
        var fOut = !!(v.options && v.options.excludeOutliers);
        html += vmPopHdr('Outliers');
        html += '<div class="sec"><label><input type="checkbox" id="vmf-outlier-chk"'+(fOut?' checked':'')+'> Exclude Outliers (IQR)</label></div>';
        html += '<div class="btns"><button class="btn-sm ghost" data-pop-act="filter-clear">Clear</button><button class="btn-sm" data-pop-act="filter-apply">Apply</button></div>';
      } else if(act==='zoommenu'){
        html += vmPopHdr('Zoom / Pan Controls');
        html += '<div class="sec"><div class="lbl">Mode</div><div class="row">'
              + vmChip('pan-on','Pan (Hand)', v.options.dragMode==='pan')
              + vmChip('pan-off','Zoom (Box)', !v.options.dragMode || v.options.dragMode==='zoom')
              + '</div></div>';
        html += '<div class="sec"><div class="lbl">Actions</div><div class="row">'
              + vmChip('zx-reset','Reset Zoom', false)
              + '</div></div>';
      } else if(act==='export'){
        html += vmPopHdr('Export Visual');
        html += '<div class="sec"><div class="lbl">Image</div><div class="row">'
              + '<button class="btn-sm" data-pop-act="exp-png">PNG Image</button>'
              + '<button class="btn-sm" data-pop-act="exp-svg">SVG Vector</button>'
              + '</div></div>';
        html += '<div class="sec"><div class="lbl">Data</div><div class="row">'
              + '<button class="btn-sm" data-pop-act="exp-csv">CSV Data</button>'
              + '<button class="btn-sm" data-pop-act="exp-json">JSON Spec</button>'
              + '</div></div>';
      }

      pop.innerHTML = html;
      pop.classList.add('open');
      pop.setAttribute('aria-hidden','false');
      vmPositionPop(btnEl);
    }

    // Shared handler for toolbar buttons (used by document + grid fallbacks)
    function vmHandleToolbarClick(btn, vid, act){
      if(!vid || !act) return false;

      if(['points','filter','zoommenu','export'].indexOf(act)>=0){
        vmOpenPopover(vid, act, btn);
      } else {
        vmCloseOverlays();
        if(act==='theme'){ vmToggleTheme(); }
        else if(act==='reset'){ vmResetVisual(vid); }
        else if(act==='settings'){ openVisualSettings(vid); }
        else if(act==='remove'){ vmToggleRemoveMode(vid); }
        else if(act==='fs'){
          if(document.fullscreenElement) { document.exitFullscreen(); }
          else {
            var card = document.querySelector('.card[data-vid="'+vid+'"]');
            if(card && card.requestFullscreen) card.requestFullscreen();
          }
        }
        else { vmDoAction(vid, act); }
      }
      return true;
    }

    // Global Click Listener for Toolbar, Popovers, and Chips
    document.addEventListener('click', function(e){
      var t = e.target;
      var btn = t.closest ? t.closest('.vm-tb-btn') : null; // Toolbar button
      var pop = document.getElementById('vm-pop');
      var isPopOpen = pop && pop.classList.contains('open');

      // 1. Handle Toolbar Button Clicks
      if(btn){
        var vid = btn.getAttribute('data-vid');
        var act = btn.getAttribute('data-act');
        if(vmHandleToolbarClick(btn, vid, act)){
          e.__vmHandled = true;
          e.preventDefault(); e.stopPropagation();
          return;
        }
      }

      // 2. Handle Popover Chips
      var chip = t.closest ? t.closest('.chip') : null;
      if(chip && isPopOpen && pop.__vid){
         var vid = pop.__vid;
         var act = pop.__act;
         var idc = chip.getAttribute('data-chip');
         var v = vmFindVisual(vid);
         if(v){
           v.options = v.options || {};

           // Helper to update chip UI classes locally for instant feedback
           var chips = pop.querySelectorAll('.chip');
           var pfx = idc.split('-')[0]+'-';
           chips.forEach(function(c){ if(c.getAttribute('data-chip').indexOf(pfx)===0) c.classList.remove('on'); });
           chip.classList.add('on');

           var changed = false;
           var needsRender = false;

           // Chart type
           if(idc.indexOf('type-')===0){
             var newType = idc.substring(5);
             if(newType !== v.type){
               v.type = newType; // line, bar, scatter, area
               changed = true; needsRender = true;
             }
           }

           // Points density
           if(idc.indexOf('pts-')===0){
             var nextPts = (idc==='pts-auto'?'auto':(idc==='pts-none'?'none':'all'));
             if(nextPts !== v.options.pointsMode){
               v.options.pointsMode = nextPts;
               changed = true;
               // Optimization: restyle instead of full render
               try{
                  var gdPts = vmGetPlotDivByVid(vid);
                  if(gdPts){
                    var mode = (idc==='pts-none')?'lines':(idc==='pts-all')?'lines+markers':null;
                    if(mode){ Plotly.restyle(gdPts, {mode: mode}); needsRender = false; }
                    else needsRender = true;
                  } else { needsRender = true; }
               }catch(e){ needsRender = true; }
             }
           }

           // Outlier visibility/removal
           if(idc.indexOf('out-')===0){
             if(idc==='out-show' && v.options.showOutliers!==true){ v.options.showOutliers=true; changed=true; needsRender=true; }
             if(idc==='out-hide' && v.options.showOutliers!==false){ v.options.showOutliers=false; changed=true; needsRender=true; }
             if(idc==='out-remove' && v.options.excludeOutliers!==true){ v.options.excludeOutliers = true; changed=true; needsRender=true; }
           }

           // Labels toggle
           if(idc.indexOf('lbl-')===0){
             var nextLbl = (idc==='lbl-on');
             if(nextLbl !== !!v.options.labelsOn){ v.options.labelsOn = nextLbl; changed=true; needsRender=true; }
           }

           // Gap handling (requires rebuild)
           if(idc.indexOf('gap-')===0){
             if(idc !== v.options.gapMode){ v.options.gapMode = idc; changed=true; needsRender=true; }
           }

           // Legend handling (use relayout when possible)
           if(idc.indexOf('leg-')===0){
             var prevShow = v.options.showLegend;
             var prevPos = v.options.legendPos;
             if(idc==='leg-show' || idc==='leg-hide'){
               var nextShow = (idc==='leg-show');
               if(nextShow!==prevShow){ v.options.showLegend = nextShow; changed=true; }
               v.options.legendPos = v.options.legendPos; // keep
             } else {
               var nextPos = idc.replace('leg-','');
               if(nextPos!==prevPos || prevShow===false){ v.options.legendPos = nextPos; v.options.showLegend = true; changed=true; }
             }
             try{
               var gdLeg = vmGetPlotDivByVid(vid);
               if(gdLeg){
                  var upd = {};
                  if(v.options.showLegend===false) upd.showlegend = false;
                  else {
                    upd.showlegend = true;
                    Object.assign(upd, vmLegendLayoutFor(v.options.legendPos));
                  }
                  Plotly.relayout(gdLeg, upd);
                  needsRender = false;
               }
             }catch(e){ needsRender = true; }
           }

           // Stats overlay (needs rebuild)
           if(idc.indexOf('st-')===0){
             var nextStat = idc.replace('st-','');
             if(nextStat !== v.options.statsMode){ v.options.statsMode = nextStat; changed=true; needsRender=true; }
           }

           // Y-axis scale shortcuts; prefer relayout to avoid full render
           if(idc.indexOf('y-')===0){
             var nextY = idc.replace('y-','');
             if(nextY !== v.options.yScaleMode){
               v.options.yScaleMode = nextY; changed=true;
               try{
                 var gdY = vmGetPlotDivByVid(vid);
                 if(gdY){
                   var updY = {};
                   if(nextY==='auto') { updY['yaxis.type']='linear'; updY['yaxis.rangemode']=null; updY['yaxis.autorange']=true; }
                   else if(nextY==='zero'){ updY['yaxis.type']='linear'; updY['yaxis.rangemode']='tozero'; updY['yaxis.autorange']=true; }
                   else if(nextY==='log'){ updY['yaxis.type']='log'; updY['yaxis.autorange']=true; }
                   Plotly.relayout(gdY, updY);
                   needsRender = false;
                 } else { needsRender = true; }
               }catch(e){ needsRender = true; }
             }
           }

           // Target style (requires rebuild to draw shapes)
           if(idc.indexOf('tg-')===0){
             var nextTg = idc.replace('tg-','');
             if(nextTg !== v.options.targetStyle){ v.options.targetStyle = nextTg; changed=true; needsRender=true; }
           }

           // Drag/zoom mode
           if(idc.indexOf('pan-')===0){
             var nextDrag = (idc==='pan-on')?'pan':'zoom';
             if(nextDrag !== v.options.dragMode){ v.options.dragMode = nextDrag; changed=true; }
             var gdPan = vmGetPlotDivByVid(vid);
             if(gdPan) Plotly.relayout(gdPan, {dragmode: v.options.dragMode});
             needsRender = needsRender || false; // keep lightweight
           }

           // Zoom reset
           if(idc==='zx-reset'){
             var gdZ = vmGetPlotDivByVid(vid);
             if(gdZ) Plotly.relayout(gdZ, {'xaxis.autorange':true, 'yaxis.autorange':true});
             needsRender = needsRender || false;
           }

           if(changed){
             saveState();
             if(needsRender) vmRenderSingle(vid);
           }
         }
      }

      // 3. Handle Popover Action Buttons (Apply/Clear/Index Export)
      var popBtn = t.closest ? t.closest('[data-pop-act]') : null;
      if(popBtn && isPopOpen && pop.__vid){
         var vid = pop.__vid;
         var act = pop.__act;
         var actBtn = popBtn.getAttribute('data-pop-act');
         var v = vmFindVisual(vid);
         var gd = vmGetPlotDivByVid(vid);

        if(actBtn.indexOf('exp-')===0 && gd){
            if(actBtn==='exp-png') Plotly.downloadImage(gd, {format:'png',filename:'visual'});
            if(actBtn==='exp-svg') Plotly.downloadImage(gd, {format:'svg',filename:'visual'});
            if(actBtn==='exp-json') vmDownloadText('visual.json', JSON.stringify({data:gd.data, layout:gd.layout},null,2));
            if(actBtn==='exp-csv') { /* simple csv export logic */ }
            vmPopClose();
            e.preventDefault(); e.stopPropagation();
            return;
         }

         if(v){
            if(actBtn==='filter-clear'){
              v.filter = null;
              if(v.options) v.options.excludeOutliers = false;
              saveState();
              vmRenderSingle(vid);
              vmPopClose();
            }
            if(actBtn==='filter-apply'){
              var outChk = pop.querySelector('#vmf-outlier-chk');
              if(outChk && outChk.checked) v.options.excludeOutliers = true;
              else v.options.excludeOutliers = false;
              v.filter = null; // keep filter menu outlier-only
              saveState();
              vmRenderSingle(vid);
              vmPopClose();
            }
         }
      }

      // 4. Close Popover if clicking outside
      if(isPopOpen && !pop.contains(t) && !t.closest('.vm-tb-btn')){
        vmPopClose();
      }
      
      // Close popover close button
      var x = t.closest ? t.closest('[data-pop-x]') : null;
      if(x) vmPopClose();

    }, true);


    // Keyboard shortcuts (active visual)
    window.addEventListener('keydown', function(ev){
      try{
        if(!activeVid) return;
        if(ev.target && (ev.target.tagName==='INPUT' || ev.target.tagName==='TEXTAREA')) return;
        var k = String(ev.key||'').toLowerCase();
        if(k==='z'){ vmDoAction(activeVid,'zoom'); ev.preventDefault(); }
        else if(k==='p'){ vmDoAction(activeVid,'pan'); ev.preventDefault(); }
        else if(k==='s'){ vmDoAction(activeVid,'select'); ev.preventDefault(); }
        else if(k==='l'){ vmDoAction(activeVid,'lasso'); ev.preventDefault(); }
        else if(k==='a'){ vmDoAction(activeVid,'autoscale'); ev.preventDefault(); }
        else if(k==='r'){ vmDoAction(activeVid,'home'); ev.preventDefault(); }
        else if(k==='g'){ vmDoAction(activeVid,'legend'); ev.preventDefault(); }
        else if(k==='f'){ vmDoAction(activeVid,'fs'); ev.preventDefault(); }
        else if(k==='e'){ vmDoAction(activeVid,'export-png'); ev.preventDefault(); }
        else if(k==='?'){ vmDoAction(activeVid,'shortcuts'); ev.preventDefault(); }
      }catch(e){}
    }, true);

    // Titlebar downloads dropdown
    var dlBtn = q('#vm-btn-download');
    var dlMenu = null;
    function closeDlMenu(){
      if(dlMenu){
        try{ dlMenu.remove(); }catch(e){}
        dlMenu=null;
      }
    }
    function openDlMenu(anchor){
      closeDlMenu();
      dlMenu = document.createElement('div');
      dlMenu.style.position='fixed';
      dlMenu.style.zIndex='9999';
      dlMenu.style.minWidth='160px';
      dlMenu.style.padding='6px';
      dlMenu.style.border='1px solid var(--vm-border)';
      dlMenu.style.borderRadius='12px';
      dlMenu.style.background='var(--vm-card)';
      dlMenu.style.boxShadow='var(--vm-shadow)';
      dlMenu.innerHTML = ''
        + '<button class="btn" style="width:100%;justify-content:flex-start" data-dl="xlsx">Raw data (Excel)</button>'
        + '<button class="btn" style="width:100%;justify-content:flex-start" data-dl="pdf">Visuals (PDF)</button>';
      document.body.appendChild(dlMenu);
      var r = anchor.getBoundingClientRect();
      dlMenu.style.left = Math.max(8, Math.min((window.innerWidth-8)-(dlMenu.offsetWidth||180), r.left)) + 'px';
      dlMenu.style.top = (r.bottom + 6) + 'px';

      dlMenu.querySelectorAll('button[data-dl]').forEach(function(b){
        b.onclick = function(){
          var k = b.getAttribute('data-dl');
          closeDlMenu();
          if(k==='xlsx') downloadXlsx();
          if(k==='pdf') downloadAllVisualsPdf();
        };
      });
      setTimeout(function(){
        window.addEventListener('click', onDocClick, {capture:true, once:true});
      },0);
    }
    function onDocClick(ev){
      if(!dlMenu) return;
      if(dlMenu.contains(ev.target) || (dlBtn && dlBtn.contains(ev.target))) return;
      closeDlMenu();
    }
    if(dlBtn) dlBtn.onclick = function(ev){
      ev.stopPropagation();
      if(dlMenu) closeDlMenu();
      else openDlMenu(dlBtn);
    };

    // Resize handling
    window.addEventListener('resize', function(){
      // Plotly responsive usually handles it, but this stabilizes nested layouts.
      try{
        var cards = gridEl.querySelectorAll('.plot');
        cards.forEach(function(p){ try{ Plotly.Plots.resize(p); }catch(e){} });
      }catch(e){}
    });

    ensurePlotly().then(initAfterPlotly).catch(function(e){
      try{
        if(gridEl){
          gridEl.innerHTML = '<div class="empty" style="grid-column:1/-1">Plotly failed to load. '+escapeHtml(e && e.message ? e.message : String(e))+'</div>';
        }
      }catch(_){ }
    });

  })();
  </script>
</div>